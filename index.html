<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathAmaia Pro - App Educativa MatemÃ¡ticas v2.0</title>
    
    <!-- PWA Support -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="MathAmaia">
    
    <!-- Firebase (descomentar si usas backend) -->
    <!-- <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="firebase-setup.js"></script> -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .app-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 2.5em;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .curriculum-badge {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin: 5px;
            display: inline-block;
        }

        .user-info {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }

        .level-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .level-badge {
            background: linear-gradient(45deg, #ff6b6b, #ffd93d);
            color: white;
            padding: 8px 15px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .points {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            padding: 8px 15px;
            border-radius: 25px;
            font-weight: bold;
        }

        .screen {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            min-height: 400px;
        }

        .hidden {
            display: none;
        }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ffd93d);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }

        .btn.active {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            transform: scale(1.05);
        }

        /* Selector de Unidades TemÃ¡ticas */
        .unit-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .unit-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .unit-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }

        .unit-card.locked {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .unit-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .unit-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .unit-description {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .unit-progress {
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            height: 8px;
            margin-top: 15px;
            overflow: hidden;
        }

        .unit-progress-fill {
            background: #4CAF50;
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* Pregunta Interactiva */
        .question-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 20px;
            margin: 20px 0;
            text-align: center;
            font-size: 1.3em;
        }

        .interactive-question {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .math-input-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .math-input {
            width: 80px;
            height: 50px;
            border: 3px solid #667eea;
            border-radius: 10px;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            background: rgba(255,255,255,0.9);
        }

        .math-input:focus {
            outline: none;
            border-color: #ff6b6b;
            background: white;
        }

        .math-symbol {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        /* Modelo de Barras Interactivo */
        .bar-canvas-container {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            min-height: 200px;
            position: relative;
        }

        .bar-tools {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .bar-tool {
            background: linear-gradient(45deg, #ff6b6b, #ffd93d);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .bar-tool:hover {
            transform: scale(1.05);
        }

        .bar-tool.active {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .drawing-bar {
            height: 40px;
            margin: 5px 0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: grab;
            position: relative;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .drawing-bar:active {
            cursor: grabbing;
        }

        .bar-flamenco { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .bar-volley { background: linear-gradient(45deg, #3498db, #2980b9); }
        .bar-caballos { background: linear-gradient(45deg, #8b4513, #654321); }
        .bar-gimnasia { background: linear-gradient(45deg, #9b59b6, #8e44ad); }
        .bar-neutral { background: linear-gradient(45deg, #95a5a6, #7f8c8d); }

        .bar-label-input {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            text-align: center;
            border: none;
            background: rgba(255,255,255,0.9);
            border-radius: 5px;
            padding: 2px;
        }

        /* EvaluaciÃ³n Interactiva */
        .evaluation-container {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .step-checker {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #ffd93d;
        }

        .step-checker.correct {
            border-left-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .step-checker.incorrect {
            border-left-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }

        /* Logros y Progreso */
        .achievements {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }

        .achievement {
            background: linear-gradient(45deg, #ffd700, #ffed4a);
            color: #333;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .progress-bar {
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            height: 12px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* CurrÃ­culum Tracker */
        .curriculum-tracker {
            background: rgba(46, 204, 113, 0.1);
            border: 2px solid #2ecc71;
            border-radius: 15px;
            padding: 15px;
            margin: 20px 0;
        }

        .curriculum-objective {
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .curriculum-objective.completed {
            background: rgba(46, 204, 113, 0.2);
            color: #27ae60;
        }

        .curriculum-objective.in-progress {
            background: rgba(241, 196, 15, 0.2);
            color: #f39c12;
        }

        .curriculum-objective.pending {
            background: rgba(149, 165, 166, 0.2);
            color: #7f8c8d;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .unit-selector {
                grid-template-columns: 1fr;
            }
            
            .logo {
                font-size: 2em;
            }

            .math-input-container {
                flex-direction: column;
                gap: 10px;
            }

            .bar-tools {
                flex-direction: column;
                align-items: center;
            }

            .user-info {
                flex-direction: column;
                gap: 15px;
            }
        }

        /* Animaciones */
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .bounce {
            animation: bounce 0.6s;
        }

        @keyframes glow {
            0% { box-shadow: 0 0 5px rgba(255, 107, 107, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 107, 107, 0.8); }
            100% { box-shadow: 0 0 5px rgba(255, 107, 107, 0.5); }
        }

        .glow {
            animation: glow 2s infinite;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Tooltips */
        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            white-space: nowrap;
            z-index: 1000;
            font-size: 0.8em;
        }

        /* Estilos de personalizaciÃ³n */
        .personalization-step {
            animation: slideIn 0.5s ease;
        }

        .interest-btn {
            transition: all 0.3s ease;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 1em;
        }

        .interest-btn:hover {
            transform: scale(1.05);
        }

        .interest-btn.active {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        /* Estilos de feedback */
        .feedback-question {
            background: rgba(255,255,255,0.5);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .feedback-question h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .feedback-textarea {
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .feedback-textarea:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
        }

        /* Estilos para el espacio de trabajo */
        .workspace {
            background: #fffef0;
            border: 2px dashed #ffd93d;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
        }

        .workspace-title {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .workspace-canvas {
            display: block;
            margin: 0 auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .workspace-tools {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .workspace-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .workspace-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .workspace-btn.clear {
            background: linear-gradient(45deg, #ff6b6b, #ee5a50);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div class="logo">ğŸŒŸ MathAmaia Pro ğŸŒŸ</div>
            <p style="color: white; font-size: 1.2em;">CurrÃ­culum Nacional de Chile + MÃ©todo Singapur</p>
            <div>
                <span class="curriculum-badge">ğŸ“š 4Â° BÃ¡sico</span>
                <span class="curriculum-badge">ğŸ‡¸ğŸ‡¬ MÃ©todo Singapur</span>
                <span class="curriculum-badge">ğŸ‡¨ğŸ‡± MINEDUC</span>
            </div>
        </div>

        <div class="user-info">
            <div class="level-info">
                <div class="level-badge" id="levelBadge">Unidad 1</div>
                <div class="points" id="pointsDisplay">0 puntos</div>
                <div class="curriculum-badge" id="currentObjective">NÃºmeros hasta 10.000</div>
            </div>
            <div class="achievements" id="achievements">
                <!-- Logros aparecerÃ¡n aquÃ­ -->
            </div>
        </div>

        <!-- Pantalla de Bienvenida -->
        <div id="welcomeScreen" class="screen">
            <div style="text-align: center;">
                <h1>Â¡Hola Amaia! ğŸ‘‹</h1>
                <p style="font-size: 1.2em; margin: 20px 0;">Â¡Bienvenida a MathAmaia Pro! Tu asistente matemÃ¡tico que sigue el currÃ­culum nacional de Chile.</p>
                
                <div class="curriculum-tracker">
                    <h3>ğŸ¯ Objetivos de Cuarto BÃ¡sico</h3>
                    <p>Vamos a dominar todas las matemÃ¡ticas que necesitas este aÃ±o:</p>
                    <ul style="text-align: left; margin: 15px 0;">
                        <li>âœ… NÃºmeros hasta 10.000</li>
                        <li>âœ… MultiplicaciÃ³n y DivisiÃ³n</li>
                        <li>âœ… Fracciones y Decimales</li>
                        <li>âœ… GeometrÃ­a y MediciÃ³n</li>
                        <li>âœ… Datos y Probabilidades</li>
                    </ul>
                </div>

                <p>Â¿Lista para comenzar tu aventura matemÃ¡tica?</p>
                <button class="btn glow" onclick="showUnitSelector()">Â¡Empecemos! ğŸš€</button>
                <button class="btn btn-secondary" onclick="startPersonalization()" style="margin-left: 10px;">
                    ğŸ¨ Configurar mis gustos
                </button>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="showFeedbackSurvey()" style="font-size: 0.9em;">
                        ğŸ“ Dar mi opiniÃ³n sobre la app
                    </button>
                    <button class="btn btn-secondary" onclick="resetProgress()" style="font-size: 0.9em; margin-left: 10px;">
                        ğŸ”„ Reiniciar progreso
                    </button>
                </div>
            </div>
        </div>

        <!-- Selector de Unidades TemÃ¡ticas -->
        <div id="unitSelectorScreen" class="screen hidden">
            <h2 style="text-align: center; margin-bottom: 30px;">Selecciona tu Unidad de Aprendizaje ğŸ“š</h2>
            
            <div class="unit-selector">
                <div class="unit-card" onclick="selectUnit('numeros')" data-unit="numeros">
                    <div class="unit-icon">ğŸ”¢</div>
                    <div class="unit-title">NÃºmeros y Operaciones</div>
                    <div class="unit-description">NÃºmeros hasta 10.000, multiplicaciÃ³n, divisiÃ³n, cÃ¡lculo mental</div>
                    <div class="unit-progress">
                        <div class="unit-progress-fill" style="width: 20%"></div>
                    </div>
                </div>

                <div class="unit-card" onclick="selectUnit('fracciones')" data-unit="fracciones">
                    <div class="unit-icon">ğŸ•</div>
                    <div class="unit-title">Fracciones y Decimales</div>
                    <div class="unit-description">Fracciones propias, nÃºmeros mixtos, decimales hasta centÃ©simas</div>
                    <div class="unit-progress">
                        <div class="unit-progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <div class="unit-card" onclick="selectUnit('geometria')" data-unit="geometria">
                    <div class="unit-icon">ğŸ“</div>
                    <div class="unit-title">GeometrÃ­a</div>
                    <div class="unit-description">Figuras 2D y 3D, simetrÃ­a, Ã¡ngulos, transformaciones</div>
                    <div class="unit-progress">
                        <div class="unit-progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <div class="unit-card" onclick="selectUnit('medicion')" data-unit="medicion">
                    <div class="unit-icon">ğŸ“</div>
                    <div class="unit-title">MediciÃ³n</div>
                    <div class="unit-description">Tiempo, longitud, Ã¡rea, volumen, perÃ­metro</div>
                    <div class="unit-progress">
                        <div class="unit-progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <div class="unit-card" onclick="selectUnit('algebra')" data-unit="algebra">
                    <div class="unit-icon">ğŸ“Š</div>
                    <div class="unit-title">Patrones y Ãlgebra</div>
                    <div class="unit-description">Patrones numÃ©ricos, ecuaciones simples, tablas</div>
                    <div class="unit-progress">
                        <div class="unit-progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <div class="unit-card" onclick="selectUnit('datos')" data-unit="datos">
                    <div class="unit-icon">ğŸ“ˆ</div>
                    <div class="unit-title">Datos y Probabilidades</div>
                    <div class="unit-description">GrÃ¡ficos, encuestas, experimentos aleatorios</div>
                    <div class="unit-progress">
                        <div class="unit-progress-fill" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-secondary" onclick="showPersonalization()">âš™ï¸ Configurar Perfil</button>
                <button class="btn" onclick="showWelcome()">ğŸ  Inicio</button>
            </div>
        </div>

        <!-- Pantalla de ejercicios -->
        <div id="exerciseScreen" class="screen hidden">
            <!-- Los ejercicios se cargarÃ¡n dinÃ¡micamente aquÃ­ -->
        </div>

        <!-- Pantalla de resultados -->
        <div id="resultsScreen" class="screen hidden">
            <div style="text-align: center;">
                <h2 id="resultTitle">Â¡Felicitaciones! ğŸ‰</h2>
                <div class="achievement" style="font-size: 3em; margin: 20px;">ğŸ†</div>
                <p id="resultMessage" style="font-size: 1.2em; margin: 20px;"></p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                </div>
                <button class="btn" onclick="showUnitSelector()">Continuar Aprendiendo ğŸ“š</button>
                <button class="btn btn-secondary" onclick="showWelcome()">Volver al Inicio ğŸ </button>
            </div>
        </div>

        <!-- Pantalla de feedback -->
        <div id="feedbackScreen" class="screen hidden">
            <div style="text-align: center;">
                <h2>Â¡Tu opiniÃ³n es importante! ğŸ“</h2>
                <p style="font-size: 1.1em; margin: 20px;">AyÃºdanos a mejorar MathAmaia Pro</p>
            </div>

            <div class="interactive-question">
                <form id="feedbackForm">
                    <!-- Pregunta 1: DiversiÃ³n -->
                    <div class="feedback-question">
                        <h3>1. Â¿QuÃ© tan divertida te parece la aplicaciÃ³n? ğŸ®</h3>
                        <div style="display: flex; justify-content: center; gap: 20px; margin: 20px 0;">
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('fun', 'ğŸ˜', 'Me encanta')">
                                ğŸ˜<br>Me encanta
                            </button>
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('fun', 'ğŸ˜Š', 'Es divertida')">
                                ğŸ˜Š<br>Es divertida
                            </button>
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('fun', 'ğŸ˜', 'EstÃ¡ bien')">
                                ğŸ˜<br>EstÃ¡ bien
                            </button>
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('fun', 'ğŸ˜•', 'PodrÃ­a mejorar')">
                                ğŸ˜•<br>PodrÃ­a mejorar
                            </button>
                        </div>
                    </div>

                    <!-- Pregunta 2: Dificultad -->
                    <div class="feedback-question">
                        <h3>2. Â¿CÃ³mo te parecen los ejercicios? ğŸ“š</h3>
                        <div style="display: flex; justify-content: center; gap: 20px; margin: 20px 0;">
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('difficulty', 'ğŸŒŸ', 'Muy fÃ¡ciles')">
                                ğŸŒŸ<br>Muy fÃ¡ciles
                            </button>
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('difficulty', 'ğŸ‘', 'Perfectos')">
                                ğŸ‘<br>Perfectos
                            </button>
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('difficulty', 'ğŸ¤”', 'Un poco difÃ­ciles')">
                                ğŸ¤”<br>Un poco difÃ­ciles
                            </button>
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('difficulty', 'ğŸ˜°', 'Muy difÃ­ciles')">
                                ğŸ˜°<br>Muy difÃ­ciles
                            </button>
                        </div>
                    </div>

                    <!-- Pregunta 3: Colores y diseÃ±o -->
                    <div class="feedback-question">
                        <h3>3. Â¿Te gustan los colores y el diseÃ±o? ğŸ¨</h3>
                        <div style="display: flex; justify-content: center; gap: 20px; margin: 20px 0;">
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('design', 'ğŸŒˆ', 'Me encantan')">
                                ğŸŒˆ<br>Me encantan
                            </button>
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('design', 'ğŸ¨', 'EstÃ¡n bien')">
                                ğŸ¨<br>EstÃ¡n bien
                            </button>
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('design', 'ğŸ–Œï¸', 'PodrÃ­an mejorar')">
                                ğŸ–Œï¸<br>PodrÃ­an mejorar
                            </button>
                        </div>
                    </div>

                    <!-- Pregunta 4: QuÃ© mÃ¡s te gustÃ³ -->
                    <div class="feedback-question">
                        <h3>4. Â¿QuÃ© es lo que mÃ¡s te gustÃ³? âœ¨</h3>
                        <textarea id="likedMost" class="feedback-textarea" 
                                  placeholder="CuÃ©ntame quÃ© fue lo mÃ¡s divertido o Ãºtil..."
                                  style="width: 100%; min-height: 100px; padding: 15px; border-radius: 10px; 
                                         border: 2px solid #667eea; font-size: 1em; font-family: inherit;"></textarea>
                    </div>

                    <!-- Pregunta 5: QuÃ© cambiarÃ­as -->
                    <div class="feedback-question">
                        <h3>5. Â¿QuÃ© cambiarÃ­as o agregarÃ­as? ğŸš€</h3>
                        <textarea id="wouldChange" class="feedback-textarea" 
                                  placeholder="Â¿Tienes ideas para hacer la app aÃºn mejor?"
                                  style="width: 100%; min-height: 100px; padding: 15px; border-radius: 10px; 
                                         border: 2px solid #667eea; font-size: 1em; font-family: inherit;"></textarea>
                    </div>

                    <!-- Pregunta 6: RecomendarÃ­as -->
                    <div class="feedback-question">
                        <h3>6. Â¿Le recomendarÃ­as esta app a tus amigos? ğŸ‘«</h3>
                        <div style="display: flex; justify-content: center; gap: 20px; margin: 20px 0;">
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('recommend', 'ğŸ’¯', 'SÃ­, definitivamente')">
                                ğŸ’¯<br>Â¡SÃ­, definitivamente!
                            </button>
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('recommend', 'ğŸ‘', 'Probablemente sÃ­')">
                                ğŸ‘<br>Probablemente sÃ­
                            </button>
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('recommend', 'ğŸ¤·', 'No estoy segura')">
                                ğŸ¤·<br>No estoy segura
                            </button>
                        </div>
                    </div>

                    <!-- Botones de acciÃ³n -->
                    <div style="text-align: center; margin-top: 30px;">
                        <button type="button" class="btn glow" onclick="submitFeedback()">
                            Enviar mi opiniÃ³n ğŸ“®
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="showWelcome()">
                            Volver al inicio ğŸ 
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Pantalla de personalizaciÃ³n -->
        <div id="personalizationScreen" class="screen hidden">
            <div style="text-align: center;">
                <h2>Â¡Personalicemos tu experiencia, Amaia! ğŸ¨</h2>
                <p style="font-size: 1.1em; margin: 20px;">CuÃ©ntame sobre tus gustos para hacer las matemÃ¡ticas mÃ¡s divertidas</p>
            </div>

            <div class="interactive-question">
                <div id="personalizationStep1" class="personalization-step">
                    <h3>Â¿CuÃ¡les son tus actividades favoritas? ğŸ¯</h3>
                    <p style="color: #666; font-size: 0.9em;">Puedes elegir todas las que quieras</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;">
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'deportes', 'flamenco', 'ğŸ’ƒ')">
                            ğŸ’ƒ Flamenco
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'deportes', 'volley', 'ğŸ')">
                            ğŸ Volley
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'deportes', 'gimnasia', 'ğŸ¤¸â€â™€ï¸')">
                            ğŸ¤¸â€â™€ï¸ Gimnasia
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'deportes', 'caballos', 'ğŸ´')">
                            ğŸ´ Caballos
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'deportes', 'futbol', 'âš½')">
                            âš½ FÃºtbol
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'deportes', 'natacion', 'ğŸŠâ€â™€ï¸')">
                            ğŸŠâ€â™€ï¸ NataciÃ³n
                        </button>
                    </div>
                    <button class="btn" onclick="nextPersonalizationStep()" style="margin-top: 20px;">
                        Siguiente â¡ï¸
                    </button>
                </div>

                <div id="personalizationStep2" class="personalization-step hidden">
                    <h3>Â¿QuÃ© otras cosas te gustan? ğŸ¨</h3>
                    <p style="color: #666; font-size: 0.9em;">Elige todas las que quieras</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;">
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'hobbies', 'musica', 'ğŸµ')">
                            ğŸµ MÃºsica
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'hobbies', 'arte', 'ğŸ¨')">
                            ğŸ¨ Arte
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'hobbies', 'lectura', 'ğŸ“š')">
                            ğŸ“š Lectura
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'hobbies', 'videojuegos', 'ğŸ®')">
                            ğŸ® Videojuegos
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'hobbies', 'cocinar', 'ğŸ‘©â€ğŸ³')">
                            ğŸ‘©â€ğŸ³ Cocinar
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'hobbies', 'bailar', 'ğŸ’ƒ')">
                            ğŸ’ƒ Bailar
                        </button>
                    </div>
                    <button class="btn" onclick="nextPersonalizationStep()" style="margin-top: 20px;">
                        Siguiente â¡ï¸
                    </button>
                </div>

                <div id="personalizationStep3" class="personalization-step hidden">
                    <h3>Â¿QuÃ© mÃ¡s te interesa? ğŸŒŸ</h3>
                    <p style="color: #666; font-size: 0.9em;">Puedes elegir varias opciones</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;">
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'intereses', 'familia', 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦')">
                            ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Familia
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'intereses', 'amigos', 'ğŸ‘«')">
                            ğŸ‘« Amigos
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'intereses', 'naturaleza', 'ğŸŒ³')">
                            ğŸŒ³ Naturaleza
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'intereses', 'tecnologia', 'ğŸ’»')">
                            ğŸ’» TecnologÃ­a
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'intereses', 'viajes', 'âœˆï¸')">
                            âœˆï¸ Viajes
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'intereses', 'mascotas', 'ğŸ¾')">
                            ğŸ¾ Mascotas
                        </button>
                    </div>
                    <button class="btn" onclick="nextPersonalizationStep()" style="margin-top: 20px;">
                        Siguiente â¡ï¸
                    </button>
                </div>

                <div id="personalizationStep4" class="personalization-step hidden">
                    <h3>Â¿CuÃ¡les son tus animales favoritos? ğŸ¾</h3>
                    <p style="color: #666; font-size: 0.9em;">Puedes elegir todos los que te gusten</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;">
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'animales', 'perros', 'ğŸ•')">
                            ğŸ• Perros
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'animales', 'gatos', 'ğŸ±')">
                            ğŸ± Gatos
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'animales', 'caballos', 'ğŸ´')">
                            ğŸ´ Caballos
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'animales', 'delfines', 'ğŸ¬')">
                            ğŸ¬ Delfines
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'animales', 'pajaros', 'ğŸ¦œ')">
                            ğŸ¦œ PÃ¡jaros
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'animales', 'conejos', 'ğŸ°')">
                            ğŸ° Conejos
                        </button>
                    </div>
                    <button class="btn" onclick="nextPersonalizationStep()" style="margin-top: 20px;">
                        Siguiente â¡ï¸
                    </button>
                </div>

                <div id="personalizationStep5" class="personalization-step hidden">
                    <h3>Â¿QuÃ© comidas te encantan? ğŸ½ï¸</h3>
                    <p style="color: #666; font-size: 0.9em;">Elige todas tus favoritas</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;">
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'comidas', 'pizza', 'ğŸ•')">
                            ğŸ• Pizza
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'comidas', 'helado', 'ğŸ¦')">
                            ğŸ¦ Helado
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'comidas', 'frutas', 'ğŸ“')">
                            ğŸ“ Frutas
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'comidas', 'galletas', 'ğŸª')">
                            ğŸª Galletas
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'comidas', 'pasta', 'ğŸ')">
                            ğŸ Pasta
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'comidas', 'chocolate', 'ğŸ«')">
                            ğŸ« Chocolate
                        </button>
                    </div>
                    <button class="btn" onclick="nextPersonalizationStep()" style="margin-top: 20px;">
                        Siguiente â¡ï¸
                    </button>
                </div>

                <div id="personalizationSummary" class="personalization-step hidden">
                    <h3>Â¡Perfecto! Ya sÃ© mÃ¡s sobre ti ğŸŒŸ</h3>
                    <div class="curriculum-tracker" style="text-align: left;">
                        <p>Tus intereses:</p>
                        <div id="interestsSummary" style="display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0;">
                            <!-- Los intereses seleccionados aparecerÃ¡n aquÃ­ -->
                        </div>
                    </div>
                    <p style="margin: 20px 0;">Â¡Ahora las matemÃ¡ticas serÃ¡n mucho mÃ¡s divertidas con ejemplos sobre las cosas que te gustan!</p>
                    <button class="btn glow" onclick="finishPersonalization()">Â¡Empezar a Aprender! ğŸš€</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Estado de la aplicaciÃ³n
        let appState = {
            currentScreen: 'welcome',
            currentUnit: null,
            currentExercise: 0,
            points: 0,
            achievements: [],
            progress: {
                numeros: 20,
                fracciones: 0,
                geometria: 0,
                medicion: 0,
                algebra: 0,
                datos: 0
            },
            subStageProgress: {
                numeros: { current: 1, completed: 0, questionsInStage: 0 },
                fracciones: { current: 1, completed: 0, questionsInStage: 0 },
                geometria: { current: 1, completed: 0, questionsInStage: 0 },
                medicion: { current: 1, completed: 0, questionsInStage: 0 },
                algebra: { current: 1, completed: 0, questionsInStage: 0 },
                datos: { current: 1, completed: 0, questionsInStage: 0 }
            },
            exercises: [],
            correctAnswers: 0,
            totalQuestions: 0,
            interests: {},
            personalizationStep: 1,
            hasPersonalized: false,
            feedback: {}
        };

        // Ejercicios por unidad
        const exerciseDatabase = {
            numeros: [
                // Ejercicios simples de suma
                {
                    type: 'simple-operation',
                    question: '25 + 13 = ?',
                    answer: 38,
                    explanation: 'Recuerda sumar primero las unidades, luego las decenas'
                },
                {
                    type: 'simple-operation',
                    question: '46 + 32 = ?',
                    answer: 78,
                    explanation: 'Separa las unidades y decenas para sumar mÃ¡s fÃ¡cil'
                },
                {
                    type: 'simple-operation',
                    question: '150 + 50 = ?',
                    answer: 200,
                    explanation: 'Cuando sumas nÃºmeros redondos, es mÃ¡s fÃ¡cil'
                },
                // Ejercicios simples de resta
                {
                    type: 'simple-operation',
                    question: '85 - 23 = ?',
                    answer: 62,
                    explanation: 'En la resta, tambiÃ©n separa unidades y decenas'
                },
                {
                    type: 'simple-operation',
                    question: '100 - 45 = ?',
                    answer: 55,
                    explanation: 'Cuando restas de 100, piensa en cuÃ¡nto falta para llegar a 100'
                },
                // Ejercicios simples de multiplicaciÃ³n
                {
                    type: 'simple-operation',
                    question: '5 Ã— 6 = ?',
                    answer: 30,
                    explanation: 'Recuerda la tabla del 5 o del 6'
                },
                {
                    type: 'simple-operation',
                    question: '7 Ã— 8 = ?',
                    answer: 56,
                    explanation: 'Este es un nÃºmero de la tabla del 7 y del 8'
                },
                {
                    type: 'simple-operation',
                    question: '10 Ã— 12 = ?',
                    answer: 120,
                    explanation: 'Multiplicar por 10 es agregar un cero'
                },
                {
                    type: 'comparison',
                    question: 'Â¿CuÃ¡l nÃºmero es mayor?',
                    options: ['3.457', '3.547'],
                    correct: 1,
                    explanation: 'Compara los nÃºmeros posiciÃ³n por posiciÃ³n, empezando por los dÃ©cimos'
                },
                {
                    type: 'comparison',
                    question: 'Â¿CuÃ¡l nÃºmero es mayor?',
                    options: ['8.234', '8.243'],
                    correct: 1,
                    explanation: 'Si los dÃ©cimos son iguales, compara los centÃ©simos'
                },
                {
                    type: 'comparison',
                    question: 'Â¿CuÃ¡l nÃºmero es mayor?',
                    options: ['5.672', '5.627'],
                    correct: 0,
                    explanation: 'FÃ­jate bien en la posiciÃ³n de los dÃ©cimos'
                },
                {
                    type: 'decomposition',
                    question: 'DescompÃ³n el nÃºmero 4567',
                    answer: {
                        miles: 4,
                        centenas: 5,
                        decenas: 6,
                        unidades: 7
                    },
                    explanation: 'Separa cada dÃ­gito segÃºn su valor posicional'
                },
                {
                    type: 'decomposition',
                    question: 'DescompÃ³n el nÃºmero 8203',
                    answer: {
                        miles: 8,
                        centenas: 2,
                        decenas: 0,
                        unidades: 3
                    },
                    explanation: 'No olvides que el 0 tambiÃ©n tiene un valor posicional'
                },
                {
                    type: 'multiplication',
                    question: '23 Ã— 15 = ?',
                    method: 'singapore',
                    answer: 345,
                    steps: [
                        '23 Ã— 10 = 230',
                        '23 Ã— 5 = 115',
                        '230 + 115 = 345'
                    ]
                },
                {
                    type: 'multiplication',
                    question: '34 Ã— 12 = ?',
                    method: 'singapore',
                    answer: 408,
                    steps: [
                        '34 Ã— 10 = 340',
                        '34 Ã— 2 = 68',
                        '340 + 68 = 408'
                    ]
                },
                {
                    type: 'division',
                    question: '156 Ã· 12 = ?',
                    answer: 13,
                    method: 'singapore',
                    visual: true
                },
                {
                    type: 'division',
                    question: '144 Ã· 16 = ?',
                    answer: 9,
                    method: 'singapore',
                    visual: true
                },
                {
                    type: 'word-problem',
                    question: 'Amaia tiene 2350 stickers. Si regala 478 a su amiga, Â¿cuÃ¡ntos le quedan?',
                    answer: 1872,
                    method: 'bar-model'
                },
                {
                    type: 'word-problem',
                    question: 'En el colegio de Amaia hay 1245 estudiantes. Si llegan 356 estudiantes nuevos, Â¿cuÃ¡ntos estudiantes hay en total?',
                    answer: 1601,
                    method: 'bar-model'
                },
                // MÃ¡s ejercicios simples - Sub-etapa 2
                {
                    type: 'simple-operation',
                    question: '234 + 156 = ?',
                    answer: 390,
                    explanation: 'Usa el algoritmo de suma columna por columna'
                },
                {
                    type: 'simple-operation',
                    question: '678 - 234 = ?',
                    answer: 444,
                    explanation: 'Resta columna por columna, pidiendo prestado si es necesario'
                },
                {
                    type: 'simple-operation',
                    question: '9 Ã— 7 = ?',
                    answer: 63,
                    explanation: 'Piensa en la tabla del 9 o del 7'
                },
                {
                    type: 'simple-operation',
                    question: '420 + 380 = ?',
                    answer: 800,
                    explanation: 'Estos nÃºmeros suman exactamente 800'
                },
                {
                    type: 'simple-operation',
                    question: '1000 - 650 = ?',
                    answer: 350,
                    explanation: 'Restamos: 1000 - 650 = 350'
                },
                // ComparaciÃ³n de nÃºmeros - Sub-etapa 2
                {
                    type: 'comparison',
                    question: 'Â¿CuÃ¡l nÃºmero es mayor?',
                    options: ['4.789', '4.798'],
                    correct: 1,
                    explanation: '4.798 es mayor porque al comparar centÃ©simos: 9 > 8'
                },
                {
                    type: 'comparison',
                    question: 'Â¿CuÃ¡l nÃºmero es menor?',
                    options: ['2.345', '2.354'],
                    correct: 0,
                    explanation: '2.345 es menor porque al comparar centÃ©simos: 4 < 5'
                },
                // DescomposiciÃ³n - Sub-etapa 2
                {
                    type: 'decomposition',
                    question: 'DescompÃ³n el nÃºmero 3729',
                    answer: {
                        miles: 3,
                        centenas: 7,
                        decenas: 2,
                        unidades: 9
                    },
                    explanation: '3729 = 3000 + 700 + 20 + 9'
                },
                {
                    type: 'decomposition',
                    question: 'DescompÃ³n el nÃºmero 5046',
                    answer: {
                        miles: 5,
                        centenas: 0,
                        decenas: 4,
                        unidades: 6
                    },
                    explanation: '5046 = 5000 + 0 + 40 + 6'
                },
                // MultiplicaciÃ³n mÃ©todo Singapur - Sub-etapa 3
                {
                    type: 'multiplication',
                    question: '18 Ã— 14 = ?',
                    method: 'singapore',
                    answer: 252,
                    steps: [
                        '18 Ã— 10 = 180',
                        '18 Ã— 4 = 72',
                        '180 + 72 = 252'
                    ]
                },
                {
                    type: 'multiplication',
                    question: '26 Ã— 13 = ?',
                    method: 'singapore',
                    answer: 338,
                    steps: [
                        '26 Ã— 10 = 260',
                        '26 Ã— 3 = 78',
                        '260 + 78 = 338'
                    ]
                },
                {
                    type: 'multiplication',
                    question: '45 Ã— 11 = ?',
                    method: 'singapore',
                    answer: 495,
                    steps: [
                        '45 Ã— 10 = 450',
                        '45 Ã— 1 = 45',
                        '450 + 45 = 495'
                    ]
                },
                // DivisiÃ³n mÃ©todo Singapur - Sub-etapa 3
                {
                    type: 'division',
                    question: '168 Ã· 14 = ?',
                    answer: 12,
                    method: 'singapore',
                    visual: true
                },
                {
                    type: 'division',
                    question: '195 Ã· 15 = ?',
                    answer: 13,
                    method: 'singapore',
                    visual: true
                },
                {
                    type: 'division',
                    question: '216 Ã· 18 = ?',
                    answer: 12,
                    method: 'singapore',
                    visual: true
                },
                // Problemas de palabras - Sub-etapa 3
                {
                    type: 'word-problem',
                    question: 'Amaia colecciona cartas. Tiene 567 cartas y su hermano le regala 234 mÃ¡s. Â¿CuÃ¡ntas cartas tiene ahora?',
                    answer: 801,
                    method: 'bar-model'
                },
                {
                    type: 'word-problem',
                    question: 'En una tienda hay 892 chocolates. Si venden 347, Â¿cuÃ¡ntos chocolates quedan?',
                    answer: 545,
                    method: 'bar-model'
                },
                {
                    type: 'word-problem',
                    question: 'Un libro tiene 324 pÃ¡ginas. Si Amaia ya leyÃ³ 189 pÃ¡ginas, Â¿cuÃ¡ntas le faltan por leer?',
                    answer: 135,
                    method: 'bar-model'
                },
                // Ejercicios mixtos - Sub-etapa 4
                {
                    type: 'simple-operation',
                    question: '6 Ã— 8 = ?',
                    answer: 48,
                    explanation: '6 Ã— 8 = 48'
                },
                {
                    type: 'simple-operation',
                    question: '72 Ã· 9 = ?',
                    answer: 8,
                    explanation: '72 Ã· 9 = 8'
                },
                {
                    type: 'simple-operation',
                    question: '456 + 234 = ?',
                    answer: 690,
                    explanation: 'Sumamos: 456 + 234 = 690'
                },
                {
                    type: 'simple-operation',
                    question: '900 - 475 = ?',
                    answer: 425,
                    explanation: 'Restamos: 900 - 475 = 425'
                },
                {
                    type: 'comparison',
                    question: 'Â¿CuÃ¡l nÃºmero es mayor?',
                    options: ['6.123', '6.132'],
                    correct: 1,
                    explanation: '6.132 es mayor porque al comparar centÃ©simos: 3 > 2'
                },
                {
                    type: 'comparison',
                    question: 'Â¿CuÃ¡l nÃºmero es menor?',
                    options: ['7.456', '7.465'],
                    correct: 0,
                    explanation: '7.456 es menor porque al comparar centÃ©simos: 5 < 6'
                },
                // DescomposiciÃ³n avanzada - Sub-etapa 4
                {
                    type: 'decomposition',
                    question: 'DescompÃ³n el nÃºmero 9.876',
                    answer: {
                        miles: 9,
                        centenas: 8,
                        decenas: 7,
                        unidades: 6
                    },
                    explanation: '9.876 = 9000 + 800 + 70 + 6'
                },
                {
                    type: 'decomposition',
                    question: 'DescompÃ³n el nÃºmero 6.205',
                    answer: {
                        miles: 6,
                        centenas: 2,
                        decenas: 0,
                        unidades: 5
                    },
                    explanation: '6.205 = 6000 + 200 + 0 + 5'
                },
                // MultiplicaciÃ³n avanzada - Sub-etapa 5
                {
                    type: 'multiplication',
                    question: '37 Ã— 16 = ?',
                    method: 'singapore',
                    answer: 592,
                    steps: [
                        '37 Ã— 10 = 370',
                        '37 Ã— 6 = 222',
                        '370 + 222 = 592'
                    ]
                },
                {
                    type: 'multiplication',
                    question: '29 Ã— 18 = ?',
                    method: 'singapore',
                    answer: 522,
                    steps: [
                        '29 Ã— 10 = 290',
                        '29 Ã— 8 = 232',
                        '290 + 232 = 522'
                    ]
                },
                {
                    type: 'multiplication',
                    question: '42 Ã— 15 = ?',
                    method: 'singapore',
                    answer: 630,
                    steps: [
                        '42 Ã— 10 = 420',
                        '42 Ã— 5 = 210',
                        '420 + 210 = 630'
                    ]
                },
                // DivisiÃ³n avanzada - Sub-etapa 5
                {
                    type: 'division',
                    question: '224 Ã· 16 = ?',
                    answer: 14,
                    method: 'singapore',
                    visual: true
                },
                {
                    type: 'division',
                    question: '270 Ã· 18 = ?',
                    answer: 15,
                    method: 'singapore',
                    visual: true
                },
                {
                    type: 'division',
                    question: '252 Ã· 14 = ?',
                    answer: 18,
                    method: 'singapore',
                    visual: true
                },
                // Problemas complejos - Sub-etapa 5
                {
                    type: 'word-problem',
                    question: 'En una biblioteca hay 2.456 libros. Si prestan 789 libros, Â¿cuÃ¡ntos quedan en la biblioteca?',
                    answer: 1667,
                    method: 'bar-model'
                },
                {
                    type: 'word-problem',
                    question: 'Una escuela tiene 1.234 estudiantes. Si cada estudiante dona 2 lÃ¡pices, Â¿cuÃ¡ntos lÃ¡pices recolectan en total?',
                    answer: 2468,
                    method: 'bar-model'
                },
                {
                    type: 'word-problem',
                    question: 'Amaia ahorra $345 cada mes. Â¿CuÃ¡nto dinero habrÃ¡ ahorrado despuÃ©s de 6 meses?',
                    answer: 2070,
                    method: 'bar-model'
                },
                // Ejercicios de repaso - Completar 75
                {
                    type: 'simple-operation',
                    question: '789 + 211 = ?',
                    answer: 1000,
                    explanation: 'Sumamos: 789 + 211 = 1000'
                },
                {
                    type: 'simple-operation',
                    question: '1234 - 567 = ?',
                    answer: 667,
                    explanation: 'Restamos: 1234 - 567 = 667'
                },
                {
                    type: 'simple-operation',
                    question: '15 Ã— 6 = ?',
                    answer: 90,
                    explanation: '15 Ã— 6 = 90'
                },
                {
                    type: 'simple-operation',
                    question: '81 Ã· 9 = ?',
                    answer: 9,
                    explanation: '81 Ã· 9 = 9'
                },
                {
                    type: 'comparison',
                    question: 'Â¿CuÃ¡l nÃºmero es mayor?',
                    options: ['9.876', '9.867'],
                    correct: 0,
                    explanation: '9.876 es mayor porque al comparar centÃ©simos: 7 > 6'
                },
                {
                    type: 'word-problem',
                    question: 'Un autobÃºs lleva 48 pasajeros. En la primera parada bajan 17 y suben 23. Â¿CuÃ¡ntos pasajeros hay ahora?',
                    answer: 54,
                    method: 'bar-model'
                },
                {
                    type: 'multiplication',
                    question: '53 Ã— 12 = ?',
                    method: 'singapore',
                    answer: 636,
                    steps: [
                        '53 Ã— 10 = 530',
                        '53 Ã— 2 = 106',
                        '530 + 106 = 636'
                    ]
                },
                {
                    type: 'simple-operation',
                    question: '2500 + 1500 = ?',
                    answer: 4000,
                    explanation: 'Sumamos: 2500 + 1500 = 4000'
                },
                {
                    type: 'simple-operation',
                    question: '3000 - 1750 = ?',
                    answer: 1250,
                    explanation: 'Restamos: 3000 - 1750 = 1250'
                },
                {
                    type: 'word-problem',
                    question: 'En una granja hay 234 gallinas y 156 patos. Â¿CuÃ¡ntas aves hay en total?',
                    answer: 390,
                    method: 'bar-model'
                }
            ],
            fracciones: [
                {
                    type: 'fraction-visual',
                    question: 'Â¿QuÃ© fracciÃ³n estÃ¡ coloreada?',
                    visual: 'pizza',
                    parts: 8,
                    colored: 3,
                    answer: '3/8'
                },
                {
                    type: 'fraction-visual',
                    question: 'Â¿QuÃ© fracciÃ³n estÃ¡ coloreada?',
                    visual: 'pizza',
                    parts: 6,
                    colored: 4,
                    answer: '4/6'
                },
                {
                    type: 'fraction-comparison',
                    question: 'Â¿CuÃ¡l fracciÃ³n es mayor?',
                    options: ['2/3', '3/4'],
                    correct: 1,
                    visual: true
                },
                {
                    type: 'fraction-comparison',
                    question: 'Â¿CuÃ¡l fracciÃ³n es menor?',
                    options: ['1/2', '3/5'],
                    correct: 0,
                    visual: true
                },
                {
                    type: 'fraction-addition',
                    question: '1/4 + 2/4 = ?',
                    answer: '3/4',
                    visual: 'bars'
                },
                {
                    type: 'fraction-addition',
                    question: '2/5 + 1/5 = ?',
                    answer: '3/5',
                    visual: 'bars'
                },
                {
                    type: 'mixed-numbers',
                    question: 'Convierte 7/4 a nÃºmero mixto',
                    answer: '1 3/4',
                    visual: true
                },
                {
                    type: 'mixed-numbers',
                    question: 'Convierte 11/3 a nÃºmero mixto',
                    answer: '3 2/3',
                    visual: true
                },
                {
                    type: 'decimal-fraction',
                    question: 'Escribe 0.25 como fracciÃ³n',
                    answer: '1/4',
                    explanation: 'Convierte el decimal a fracciÃ³n usando 100 como denominador, luego simplifica'
                },
                {
                    type: 'decimal-fraction',
                    question: 'Escribe 0.5 como fracciÃ³n',
                    answer: '1/2',
                    explanation: 'Piensa: 0.5 significa 5 dÃ©cimos, luego simplifica la fracciÃ³n'
                },
                // MÃ¡s ejercicios de fracciones - Sub-etapa 1 continuaciÃ³n
                {
                    type: 'fraction-visual',
                    question: 'Â¿QuÃ© fracciÃ³n estÃ¡ coloreada?',
                    visual: 'pizza',
                    parts: 4,
                    colored: 1,
                    answer: '1/4'
                },
                {
                    type: 'fraction-visual',
                    question: 'Â¿QuÃ© fracciÃ³n estÃ¡ coloreada?',
                    visual: 'pizza',
                    parts: 5,
                    colored: 2,
                    answer: '2/5'
                },
                {
                    type: 'fraction-comparison',
                    question: 'Â¿CuÃ¡l fracciÃ³n es mayor?',
                    options: ['1/3', '1/4'],
                    correct: 0,
                    visual: true
                },
                {
                    type: 'fraction-comparison',
                    question: 'Â¿CuÃ¡l fracciÃ³n es menor?',
                    options: ['2/5', '3/5'],
                    correct: 0,
                    visual: true
                },
                {
                    type: 'fraction-addition',
                    question: '1/3 + 1/3 = ?',
                    answer: '2/3',
                    visual: 'bars'
                },
                // Sub-etapa 2: Fracciones equivalentes
                {
                    type: 'fraction-equivalent',
                    question: 'Â¿CuÃ¡l es equivalente a 1/2?',
                    options: ['2/4', '1/3', '2/3', '1/4'],
                    correct: 0,
                    explanation: '1/2 = 2/4 porque 1Ã—2=2 y 2Ã—2=4'
                },
                {
                    type: 'fraction-equivalent',
                    question: 'Â¿CuÃ¡l es equivalente a 2/3?',
                    options: ['4/6', '3/4', '2/5', '1/3'],
                    correct: 0,
                    explanation: '2/3 = 4/6 porque 2Ã—2=4 y 3Ã—2=6'
                },
                {
                    type: 'fraction-equivalent',
                    question: 'Â¿CuÃ¡l es equivalente a 3/4?',
                    options: ['6/8', '4/6', '3/5', '2/4'],
                    correct: 0,
                    explanation: '3/4 = 6/8 porque 3Ã—2=6 y 4Ã—2=8'
                },
                {
                    type: 'fraction-simplify',
                    question: 'Simplifica 4/8',
                    answer: '1/2',
                    explanation: '4/8 = 1/2 (dividimos por 4)'
                },
                {
                    type: 'fraction-simplify',
                    question: 'Simplifica 6/9',
                    answer: '2/3',
                    explanation: '6/9 = 2/3 (dividimos por 3)'
                },
                {
                    type: 'fraction-simplify',
                    question: 'Simplifica 10/15',
                    answer: '2/3',
                    explanation: '10/15 = 2/3 (dividimos por 5)'
                },
                {
                    type: 'fraction-addition',
                    question: '1/6 + 2/6 = ?',
                    answer: '3/6',
                    visual: 'bars'
                },
                {
                    type: 'fraction-addition',
                    question: '3/8 + 2/8 = ?',
                    answer: '5/8',
                    visual: 'bars'
                },
                {
                    type: 'fraction-subtraction',
                    question: '3/4 - 1/4 = ?',
                    answer: '2/4',
                    visual: 'bars'
                },
                {
                    type: 'fraction-subtraction',
                    question: '5/6 - 2/6 = ?',
                    answer: '3/6',
                    visual: 'bars'
                },
                // Sub-etapa 3: NÃºmeros mixtos
                {
                    type: 'mixed-numbers',
                    question: 'Convierte 9/4 a nÃºmero mixto',
                    answer: '2 1/4',
                    visual: true
                },
                {
                    type: 'mixed-numbers',
                    question: 'Convierte 13/5 a nÃºmero mixto',
                    answer: '2 3/5',
                    visual: true
                },
                {
                    type: 'mixed-numbers',
                    question: 'Convierte 17/6 a nÃºmero mixto',
                    answer: '2 5/6',
                    visual: true
                },
                {
                    type: 'mixed-to-improper',
                    question: 'Convierte 1 2/3 a fracciÃ³n impropia',
                    answer: '5/3',
                    explanation: '1 2/3 = (1Ã—3+2)/3 = 5/3'
                },
                {
                    type: 'mixed-to-improper',
                    question: 'Convierte 2 1/4 a fracciÃ³n impropia',
                    answer: '9/4',
                    explanation: '2 1/4 = (2Ã—4+1)/4 = 9/4'
                },
                {
                    type: 'mixed-to-improper',
                    question: 'Convierte 3 2/5 a fracciÃ³n impropia',
                    answer: '17/5',
                    explanation: '3 2/5 = (3Ã—5+2)/5 = 17/5'
                },
                {
                    type: 'decimal-fraction',
                    question: 'Escribe 0.75 como fracciÃ³n',
                    answer: '3/4',
                    explanation: '0.75 = 75/100 = 3/4'
                },
                {
                    type: 'decimal-fraction',
                    question: 'Escribe 0.2 como fracciÃ³n',
                    answer: '1/5',
                    explanation: '0.2 = 2/10 = 1/5'
                },
                {
                    type: 'decimal-fraction',
                    question: 'Escribe 0.4 como fracciÃ³n',
                    answer: '2/5',
                    explanation: '0.4 = 4/10 = 2/5'
                },
                {
                    type: 'fraction-to-decimal',
                    question: 'Escribe 1/4 como decimal',
                    answer: 0.25,
                    explanation: '1/4 = 0.25'
                },
                // Sub-etapa 4: Fracciones en contexto
                {
                    type: 'fraction-word-problem',
                    question: 'Amaia comiÃ³ 2/8 de una pizza y su hermano 3/8. Â¿CuÃ¡nto comieron en total?',
                    answer: '5/8',
                    visual: 'pizza'
                },
                {
                    type: 'fraction-word-problem',
                    question: 'De 12 lÃ¡pices, 3 son rojos. Â¿QuÃ© fracciÃ³n de los lÃ¡pices son rojos?',
                    answer: '3/12',
                    simplifiedAnswer: '1/4'
                },
                {
                    type: 'fraction-word-problem',
                    question: 'En una clase hay 20 estudiantes. Si 5 usan lentes, Â¿quÃ© fracciÃ³n usa lentes?',
                    answer: '5/20',
                    simplifiedAnswer: '1/4'
                },
                {
                    type: 'fraction-comparison',
                    question: 'Â¿CuÃ¡l es mayor: 3/5 o 2/3?',
                    options: ['3/5', '2/3'],
                    correct: 1,
                    visual: true
                },
                {
                    type: 'fraction-comparison',
                    question: 'Â¿CuÃ¡l es menor: 4/7 o 3/5?',
                    options: ['4/7', '3/5'],
                    correct: 0,
                    visual: true
                },
                {
                    type: 'fraction-addition',
                    question: '2/7 + 3/7 = ?',
                    answer: '5/7',
                    visual: 'bars'
                },
                {
                    type: 'fraction-addition',
                    question: '1/9 + 4/9 = ?',
                    answer: '5/9',
                    visual: 'bars'
                },
                {
                    type: 'fraction-subtraction',
                    question: '7/8 - 3/8 = ?',
                    answer: '4/8',
                    visual: 'bars'
                },
                {
                    type: 'fraction-subtraction',
                    question: '6/7 - 2/7 = ?',
                    answer: '4/7',
                    visual: 'bars'
                },
                {
                    type: 'mixed-numbers',
                    question: 'Convierte 15/4 a nÃºmero mixto',
                    answer: '3 3/4',
                    visual: true
                },
                // Sub-etapa 5: Fracciones avanzadas
                {
                    type: 'fraction-multiplication',
                    question: '1/2 Ã— 1/3 = ?',
                    answer: '1/6',
                    explanation: '1Ã—1=1, 2Ã—3=6, entonces 1/6'
                },
                {
                    type: 'fraction-multiplication',
                    question: '2/3 Ã— 1/4 = ?',
                    answer: '2/12',
                    simplifiedAnswer: '1/6'
                },
                {
                    type: 'fraction-multiplication',
                    question: '3/4 Ã— 2/5 = ?',
                    answer: '6/20',
                    simplifiedAnswer: '3/10'
                },
                {
                    type: 'fraction-of-number',
                    question: 'Â¿CuÃ¡nto es 1/2 de 20?',
                    answer: 10,
                    explanation: '1/2 Ã— 20 = 10'
                },
                {
                    type: 'fraction-of-number',
                    question: 'Â¿CuÃ¡nto es 1/4 de 16?',
                    answer: 4,
                    explanation: '1/4 Ã— 16 = 4'
                },
                {
                    type: 'fraction-of-number',
                    question: 'Â¿CuÃ¡nto es 2/3 de 12?',
                    answer: 8,
                    explanation: '2/3 Ã— 12 = 8'
                },
                {
                    type: 'fraction-of-number',
                    question: 'Â¿CuÃ¡nto es 3/5 de 15?',
                    answer: 9,
                    explanation: '3/5 Ã— 15 = 9'
                },
                {
                    type: 'decimal-to-percent',
                    question: 'Convierte 0.5 a porcentaje',
                    answer: '50%',
                    explanation: '0.5 Ã— 100 = 50%'
                },
                {
                    type: 'decimal-to-percent',
                    question: 'Convierte 0.25 a porcentaje',
                    answer: '25%',
                    explanation: '0.25 Ã— 100 = 25%'
                },
                {
                    type: 'decimal-to-percent',
                    question: 'Convierte 0.75 a porcentaje',
                    answer: '75%',
                    explanation: '0.75 Ã— 100 = 75%'
                },
                {
                    type: 'fraction-order',
                    question: 'Ordena de menor a mayor: 1/2, 1/3, 1/4',
                    answer: '1/4, 1/3, 1/2',
                    explanation: 'Cuando el numerador es 1, menor denominador = mayor fracciÃ³n'
                },
                {
                    type: 'fraction-order',
                    question: 'Ordena de mayor a menor: 2/5, 3/5, 1/5',
                    answer: '3/5, 2/5, 1/5',
                    explanation: 'Con igual denominador, mayor numerador = mayor fracciÃ³n'
                },
                {
                    type: 'mixed-addition',
                    question: '1 1/2 + 1/2 = ?',
                    answer: '2',
                    explanation: '1 1/2 + 1/2 = 1 2/2 = 2'
                },
                {
                    type: 'mixed-addition',
                    question: '2 1/3 + 1/3 = ?',
                    answer: '2 2/3',
                    explanation: '2 1/3 + 1/3 = 2 2/3'
                },
                {
                    type: 'fraction-word-problem',
                    question: 'Si Amaia leyÃ³ 3/4 de un libro de 80 pÃ¡ginas, Â¿cuÃ¡ntas pÃ¡ginas leyÃ³?',
                    answer: 60,
                    explanation: '3/4 Ã— 80 = 60 pÃ¡ginas'
                },
                // Ejercicios de repaso para completar 75
                {
                    type: 'fraction-visual',
                    question: 'Â¿QuÃ© fracciÃ³n estÃ¡ coloreada?',
                    visual: 'pizza',
                    parts: 10,
                    colored: 3,
                    answer: '3/10'
                },
                {
                    type: 'fraction-visual',
                    question: 'Â¿QuÃ© fracciÃ³n estÃ¡ coloreada?',
                    visual: 'pizza',
                    parts: 12,
                    colored: 4,
                    answer: '4/12'
                },
                {
                    type: 'fraction-simplify',
                    question: 'Simplifica 8/12',
                    answer: '2/3',
                    explanation: '8/12 = 2/3 (dividimos por 4)'
                },
                {
                    type: 'fraction-simplify',
                    question: 'Simplifica 15/20',
                    answer: '3/4',
                    explanation: '15/20 = 3/4 (dividimos por 5)'
                },
                {
                    type: 'decimal-fraction',
                    question: 'Escribe 0.6 como fracciÃ³n',
                    answer: '3/5',
                    explanation: '0.6 = 6/10 = 3/5'
                },
                {
                    type: 'decimal-fraction',
                    question: 'Escribe 0.8 como fracciÃ³n',
                    answer: '4/5',
                    explanation: '0.8 = 8/10 = 4/5'
                },
                {
                    type: 'mixed-numbers',
                    question: 'Convierte 19/6 a nÃºmero mixto',
                    answer: '3 1/6',
                    visual: true
                },
                {
                    type: 'mixed-numbers',
                    question: 'Convierte 23/7 a nÃºmero mixto',
                    answer: '3 2/7',
                    visual: true
                },
                {
                    type: 'fraction-addition',
                    question: '4/9 + 2/9 = ?',
                    answer: '6/9',
                    visual: 'bars'
                },
                {
                    type: 'fraction-subtraction',
                    question: '8/9 - 5/9 = ?',
                    answer: '3/9',
                    visual: 'bars'
                },
                {
                    type: 'fraction-comparison',
                    question: 'Â¿CuÃ¡l fracciÃ³n es mayor?',
                    options: ['5/6', '4/5'],
                    correct: 0,
                    visual: true
                },
                {
                    type: 'fraction-word-problem',
                    question: 'En una bolsa hay 24 dulces. Si 1/3 son de fresa, Â¿cuÃ¡ntos dulces de fresa hay?',
                    answer: 8,
                    explanation: '1/3 Ã— 24 = 8 dulces'
                },
                {
                    type: 'fraction-word-problem',
                    question: 'Un tanque tiene capacidad para 60 litros. Si estÃ¡ lleno a 2/5, Â¿cuÃ¡ntos litros tiene?',
                    answer: 24,
                    explanation: '2/5 Ã— 60 = 24 litros'
                }
            ],
            geometria: [
                {
                    type: 'shape-identification',
                    question: 'Â¿CuÃ¡ntos triÃ¡ngulos ves en esta figura?',
                    visual: 'complex-shape',
                    answer: 5
                },
                {
                    type: 'symmetry',
                    question: 'Dibuja la lÃ­nea de simetrÃ­a',
                    interactive: true,
                    shape: 'butterfly'
                },
                {
                    type: 'angles',
                    question: 'Â¿QuÃ© tipo de Ã¡ngulo es este?',
                    angle: 90,
                    options: ['Agudo', 'Recto', 'Obtuso'],
                    correct: 1
                },
                {
                    type: '3d-shapes',
                    question: 'Â¿CuÃ¡ntas caras tiene un cubo?',
                    answer: 6,
                    visual: true
                },
                {
                    type: 'perimeter',
                    question: 'Calcula el perÃ­metro del rectÃ¡ngulo',
                    width: 5,
                    height: 3,
                    answer: 16
                },
                // Sub-etapa 1 continuaciÃ³n - IdentificaciÃ³n de figuras
                {
                    type: 'shape-identification',
                    question: 'Â¿CuÃ¡ntos cuadrados ves en esta figura?',
                    visual: 'grid-pattern',
                    answer: 9
                },
                {
                    type: 'shape-identification',
                    question: 'Â¿CuÃ¡ntos cÃ­rculos hay en total?',
                    visual: 'circle-pattern',
                    answer: 7
                },
                {
                    type: 'shape-properties',
                    question: 'Â¿CuÃ¡ntos lados tiene un pentÃ¡gono?',
                    answer: 5,
                    explanation: 'Recuerda que "penta" significa 5 en griego'
                },
                {
                    type: 'shape-properties',
                    question: 'Â¿CuÃ¡ntos vÃ©rtices tiene un triÃ¡ngulo?',
                    answer: 3,
                    explanation: 'Cuenta las esquinas o puntos donde se unen las lÃ­neas'
                },
                {
                    type: 'shape-properties',
                    question: 'Â¿CuÃ¡ntos lados tiene un hexÃ¡gono?',
                    answer: 6,
                    explanation: 'Piensa en el significado de "hexa" para recordar'
                },
                {
                    type: 'shape-comparison',
                    question: 'Â¿QuÃ© figura tiene mÃ¡s lados?',
                    options: ['TriÃ¡ngulo', 'Cuadrado', 'PentÃ¡gono', 'CÃ­rculo'],
                    correct: 2,
                    explanation: 'Compara cuÃ¡ntos lados tiene cada figura'
                },
                {
                    type: 'shape-comparison',
                    question: 'Â¿CuÃ¡l figura NO tiene lados rectos?',
                    options: ['Cuadrado', 'TriÃ¡ngulo', 'CÃ­rculo', 'RectÃ¡ngulo'],
                    correct: 2,
                    explanation: 'Piensa en quÃ© figura es completamente curva'
                },
                {
                    type: 'angles',
                    question: 'Â¿QuÃ© tipo de Ã¡ngulo es este?',
                    angle: 45,
                    options: ['Agudo', 'Recto', 'Obtuso'],
                    correct: 0
                },
                {
                    type: 'angles',
                    question: 'Â¿QuÃ© tipo de Ã¡ngulo es este?',
                    angle: 120,
                    options: ['Agudo', 'Recto', 'Obtuso'],
                    correct: 2
                },
                // Sub-etapa 2 - SimetrÃ­a y transformaciones
                {
                    type: 'symmetry',
                    question: 'Â¿CuÃ¡ntas lÃ­neas de simetrÃ­a tiene un cuadrado?',
                    answer: 4,
                    visual: 'square'
                },
                {
                    type: 'symmetry',
                    question: 'Â¿CuÃ¡ntas lÃ­neas de simetrÃ­a tiene un cÃ­rculo?',
                    answer: 'infinitas',
                    options: ['1', '2', '4', 'infinitas'],
                    correct: 3
                },
                {
                    type: 'symmetry',
                    question: 'Â¿Esta letra tiene simetrÃ­a vertical?',
                    letter: 'A',
                    options: ['SÃ­', 'No'],
                    correct: 0
                },
                {
                    type: 'symmetry',
                    question: 'Â¿Esta letra tiene simetrÃ­a horizontal?',
                    letter: 'C',
                    options: ['SÃ­', 'No'],
                    correct: 0
                },
                {
                    type: 'transformation',
                    question: 'Si giras un cuadrado 90Â°, Â¿quÃ© figura obtienes?',
                    options: ['TriÃ¡ngulo', 'Cuadrado', 'RectÃ¡ngulo', 'Rombo'],
                    correct: 1,
                    explanation: 'Cuando giras una figura, su forma bÃ¡sica no cambia'
                },
                {
                    type: 'transformation',
                    question: 'Â¿QuÃ© transformaciÃ³n se aplicÃ³: mover, rotar o reflejar?',
                    visual: 'translation',
                    options: ['Mover', 'Rotar', 'Reflejar'],
                    correct: 0
                },
                {
                    type: 'pattern-geometric',
                    question: 'Â¿QuÃ© figura sigue en el patrÃ³n? â—‹ â–¡ â–³ â—‹ â–¡ ?',
                    options: ['â—‹', 'â–¡', 'â–³', 'â—‡'],
                    correct: 2
                },
                {
                    type: 'pattern-geometric',
                    question: 'Â¿QuÃ© figura falta? â–¡ â–¡ â—‹ â–¡ â–¡ â—‹ â–¡ ? â—‹',
                    options: ['â–¡', 'â—‹', 'â–³', 'â—‡'],
                    correct: 0
                },
                {
                    type: 'coordinates',
                    question: 'En una cuadrÃ­cula, Â¿quÃ© estÃ¡ en la posiciÃ³n (2,3)?',
                    visual: 'grid-with-objects',
                    options: ['ğŸŒŸ', 'ğŸ ', 'ğŸŒ³', 'ğŸš—'],
                    correct: 0
                },
                {
                    type: 'coordinates',
                    question: 'Si te mueves 2 a la derecha y 1 arriba desde (1,1), Â¿dÃ³nde estÃ¡s?',
                    answer: '(3,2)',
                    options: ['(2,3)', '(3,2)', '(3,3)', '(2,2)'],
                    correct: 1
                },
                // Sub-etapa 3 - Figuras 3D
                {
                    type: '3d-shapes',
                    question: 'Â¿CuÃ¡ntas caras tiene una pirÃ¡mide de base cuadrada?',
                    answer: 5,
                    visual: true
                },
                {
                    type: '3d-shapes',
                    question: 'Â¿CuÃ¡ntos vÃ©rtices tiene un cubo?',
                    answer: 8,
                    visual: true
                },
                {
                    type: '3d-shapes',
                    question: 'Â¿CuÃ¡ntas aristas tiene un cubo?',
                    answer: 12,
                    visual: true
                },
                {
                    type: '3d-shapes',
                    question: 'Â¿QuÃ© forma tienen las caras de un cubo?',
                    options: ['TriÃ¡ngulos', 'Cuadrados', 'CÃ­rculos', 'RectÃ¡ngulos'],
                    correct: 1
                },
                {
                    type: '3d-shapes',
                    question: 'Â¿CuÃ¡ntas bases tiene un cilindro?',
                    answer: 2,
                    visual: true
                },
                {
                    type: '3d-shapes',
                    question: 'Â¿QuÃ© figura 3D puede rodar?',
                    options: ['Cubo', 'PirÃ¡mide', 'Cilindro', 'Prisma'],
                    correct: 2
                },
                {
                    type: '3d-to-2d',
                    question: 'Si despliegas un cubo, Â¿cuÃ¡ntos cuadrados obtienes?',
                    answer: 6,
                    visual: 'cube-net'
                },
                {
                    type: '3d-to-2d',
                    question: 'Â¿QuÃ© figura 2D forma la base de un cono?',
                    options: ['Cuadrado', 'TriÃ¡ngulo', 'CÃ­rculo', 'RectÃ¡ngulo'],
                    correct: 2
                },
                {
                    type: 'volume-concept',
                    question: 'Â¿CuÃ¡l figura puede contener mÃ¡s agua?',
                    options: ['Cubo pequeÃ±o', 'Cubo grande', 'Hoja de papel', 'Moneda'],
                    correct: 1
                },
                {
                    type: 'surface-area',
                    question: 'Si pintas todas las caras de un cubo, Â¿cuÃ¡ntas caras pintas?',
                    answer: 6
                },
                // Sub-etapa 4 - PerÃ­metros y Ã¡reas
                {
                    type: 'perimeter',
                    question: 'Calcula el perÃ­metro del cuadrado de lado 7 cm',
                    side: 7,
                    answer: 28
                },
                {
                    type: 'perimeter',
                    question: 'Calcula el perÃ­metro del rectÃ¡ngulo',
                    width: 8,
                    height: 4,
                    answer: 24
                },
                {
                    type: 'perimeter',
                    question: 'El perÃ­metro de un cuadrado es 20 cm. Â¿CuÃ¡nto mide cada lado?',
                    answer: 5
                },
                {
                    type: 'perimeter',
                    question: 'Calcula el perÃ­metro del triÃ¡ngulo equilÃ¡tero de lado 6 cm',
                    side: 6,
                    answer: 18
                },
                {
                    type: 'area-concept',
                    question: 'Â¿CuÃ¡ntos cuadrados de 1 cm caben en un rectÃ¡ngulo de 3Ã—4 cm?',
                    answer: 12
                },
                {
                    type: 'area-concept',
                    question: 'Â¿QuÃ© figura tiene mayor Ã¡rea?',
                    options: ['Cuadrado de 5Ã—5', 'RectÃ¡ngulo de 4Ã—6', 'Cuadrado de 4Ã—4'],
                    correct: 0,
                    explanation: '5Ã—5=25, 4Ã—6=24, 4Ã—4=16'
                },
                {
                    type: 'perimeter-vs-area',
                    question: 'Dos rectÃ¡ngulos tienen el mismo perÃ­metro. Â¿Tienen la misma Ã¡rea?',
                    options: ['Siempre', 'Nunca', 'A veces'],
                    correct: 2
                },
                {
                    type: 'composite-shapes',
                    question: 'Si unes dos cuadrados de lado 3 cm, Â¿cuÃ¡l es el perÃ­metro de la figura?',
                    answer: 18,
                    explanation: 'Al unir los cuadrados, comparten un lado'
                },
                {
                    type: 'shape-decomposition',
                    question: 'Â¿En cuÃ¡ntos triÃ¡ngulos puedes dividir un hexÃ¡gono?',
                    answer: 6,
                    explanation: 'Desde el centro a cada vÃ©rtice se forman 6 triÃ¡ngulos',
                    visual: 'hexagon'
                },
                {
                    type: 'shape-decomposition',
                    question: 'Â¿CuÃ¡ntos rectÃ¡ngulos puedes formar con 12 cuadrados?',
                    options: ['2', '3', '4', '5'],
                    correct: 2,
                    explanation: '1Ã—12, 2Ã—6, 3Ã—4, 4Ã—3'
                },
                // Sub-etapa 5 - Problemas y aplicaciones
                {
                    type: 'geometry-word-problem',
                    question: 'Amaia quiere poner una cerca alrededor de su jardÃ­n cuadrado de 5 m de lado. Â¿CuÃ¡ntos metros de cerca necesita?',
                    answer: 20
                },
                {
                    type: 'geometry-word-problem',
                    question: 'Una ventana rectangular mide 2 m de alto y 1 m de ancho. Â¿CuÃ¡l es su perÃ­metro?',
                    answer: 6
                },
                {
                    type: 'geometry-word-problem',
                    question: 'Un cuadro tiene forma de hexÃ¡gono regular con lados de 10 cm. Â¿CuÃ¡l es su perÃ­metro?',
                    answer: 60
                },
                {
                    type: 'geometry-word-problem',
                    question: 'Si cortas una pizza circular en 8 partes iguales, Â¿quÃ© forma tiene cada pedazo?',
                    options: ['Cuadrado', 'TriÃ¡ngulo', 'Sector circular', 'RectÃ¡ngulo'],
                    correct: 2
                },
                {
                    type: 'spatial-reasoning',
                    question: 'Si doblas un papel cuadrado por la mitad, Â¿quÃ© figura obtienes?',
                    options: ['TriÃ¡ngulo', 'RectÃ¡ngulo', 'Cuadrado mÃ¡s pequeÃ±o', 'CÃ­rculo'],
                    correct: 1
                },
                {
                    type: 'spatial-reasoning',
                    question: 'Â¿CuÃ¡ntos cubos de 1 cmÂ³ necesitas para llenar una caja de 2Ã—3Ã—4 cm?',
                    answer: 24
                },
                {
                    type: 'tessellation',
                    question: 'Â¿CuÃ¡l figura puede cubrir completamente un piso sin dejar espacios?',
                    options: ['CÃ­rculos', 'PentÃ¡gonos', 'Cuadrados', 'Ã“valos'],
                    correct: 2
                },
                {
                    type: 'tessellation',
                    question: 'Â¿Pueden los triÃ¡ngulos equilÃ¡teros cubrir un piso sin espacios?',
                    options: ['SÃ­', 'No'],
                    correct: 0
                },
                {
                    type: 'measurement-estimation',
                    question: 'Â¿CuÃ¡l es aproximadamente el largo de tu lÃ¡piz?',
                    options: ['15 mm', '15 cm', '15 m', '15 km'],
                    correct: 1
                },
                {
                    type: 'measurement-estimation',
                    question: 'Â¿CuÃ¡l es aproximadamente el ancho de una puerta?',
                    options: ['80 mm', '80 cm', '80 m', '80 km'],
                    correct: 1
                },
                // Ejercicios adicionales para completar 75
                {
                    type: 'shape-properties',
                    question: 'Â¿Todos los lados de un rombo son iguales?',
                    options: ['SÃ­', 'No'],
                    correct: 0
                },
                {
                    type: 'shape-properties',
                    question: 'Â¿Un rectÃ¡ngulo puede ser un cuadrado?',
                    options: ['SÃ­', 'No'],
                    correct: 0,
                    explanation: 'Un cuadrado es un rectÃ¡ngulo especial con todos los lados iguales'
                },
                {
                    type: 'angles',
                    question: 'Â¿CuÃ¡ntos Ã¡ngulos rectos tiene un rectÃ¡ngulo?',
                    answer: 4
                },
                {
                    type: 'angles',
                    question: 'La suma de los Ã¡ngulos de un triÃ¡ngulo es:',
                    options: ['90Â°', '180Â°', '270Â°', '360Â°'],
                    correct: 1
                },
                {
                    type: 'line-types',
                    question: 'Â¿CÃ³mo se llaman las lÃ­neas que nunca se cruzan?',
                    options: ['Perpendiculares', 'Paralelas', 'Diagonales', 'Curvas'],
                    correct: 1
                },
                {
                    type: 'line-types',
                    question: 'Â¿CÃ³mo se llaman las lÃ­neas que forman un Ã¡ngulo de 90Â°?',
                    options: ['Perpendiculares', 'Paralelas', 'Diagonales', 'Horizontales'],
                    correct: 0
                },
                {
                    type: 'shape-identification',
                    question: 'Â¿CuÃ¡ntos rectÃ¡ngulos hay en una ventana con cruz en el medio?',
                    visual: 'window-cross',
                    answer: 5
                },
                {
                    type: 'perimeter',
                    question: 'Si el perÃ­metro de un triÃ¡ngulo equilÃ¡tero es 21 cm, Â¿cuÃ¡nto mide cada lado?',
                    answer: 7
                },
                {
                    type: 'composite-shapes',
                    question: 'Si unes 5 cuadrados en lÃ­nea, Â¿cuÃ¡ntos lados tiene el perÃ­metro de la figura?',
                    answer: 12
                },
                {
                    type: 'geometry-word-problem',
                    question: 'Amaia camina alrededor de una cancha rectangular 2 veces. Si la cancha mide 20m Ã— 10m, Â¿cuÃ¡nto camina?',
                    answer: 120,
                    explanation: 'PerÃ­metro = 2Ã—(20+10) = 60m, dos vueltas = 120m'
                }
            ],
            medicion: [
                // Ejercicios de tiempo
                {
                    type: 'simple-operation',
                    question: 'Â¿CuÃ¡ntos minutos hay en 2 horas?',
                    answer: 120,
                    explanation: '1 hora = 60 minutos, entonces 2 horas = 2 Ã— 60 = 120 minutos'
                },
                {
                    type: 'simple-operation',
                    question: 'Â¿CuÃ¡ntos segundos hay en 3 minutos?',
                    answer: 180,
                    explanation: 'Recuerda: 1 minuto = 60 segundos. Multiplica por 3'
                },
                {
                    type: 'time-conversion',
                    question: 'Si son las 14:30, Â¿quÃ© hora es en formato de 12 horas?',
                    answer: '2:30 PM',
                    options: ['2:30 AM', '2:30 PM', '4:30 PM', '12:30 PM'],
                    correct: 1
                },
                // Ejercicios de longitud
                {
                    type: 'simple-operation',
                    question: 'Â¿CuÃ¡ntos centÃ­metros hay en 3 metros?',
                    answer: 300,
                    explanation: 'Piensa: 1 metro = 100 cm. Â¿CÃ³mo convertir 3 metros?'
                },
                {
                    type: 'simple-operation',
                    question: 'Â¿CuÃ¡ntos milÃ­metros hay en 5 centÃ­metros?',
                    answer: 50,
                    explanation: 'Recuerda la relaciÃ³n: 1 cm = 10 mm'
                },
                // Ejercicios de Ã¡rea
                {
                    type: 'area',
                    question: 'Calcula el Ã¡rea de un cuadrado de 4 cm de lado',
                    side: 4,
                    answer: 16,
                    unit: 'cmÂ²'
                },
                {
                    type: 'area',
                    question: 'Calcula el Ã¡rea de un rectÃ¡ngulo de 6 cm de largo y 3 cm de ancho',
                    length: 6,
                    width: 3,
                    answer: 18,
                    unit: 'cmÂ²'
                },
                // Ejercicios de volumen
                {
                    type: 'volume',
                    question: 'Â¿CuÃ¡ntos litros hay en 2000 mililitros?',
                    answer: 2,
                    explanation: 'Piensa en cuÃ¡ntos grupos de 1000 ml hay en 2000 ml'
                },
                // Ejercicios de masa
                {
                    type: 'simple-operation',
                    question: 'Â¿CuÃ¡ntos gramos hay en 3 kilogramos?',
                    answer: 3000,
                    explanation: 'Usa la conversiÃ³n bÃ¡sica: 1 kg = 1000 g'
                },
                {
                    type: 'mass-comparison',
                    question: 'Â¿QuÃ© es mÃ¡s pesado?',
                    options: ['500 gramos', '1 kilogramo'],
                    correct: 1,
                    explanation: 'Compara 1 kg con 500 g usando la conversiÃ³n'
                },
                // Sub-etapa 2 - Tiempo y calendario
                {
                    type: 'simple-operation',
                    question: 'Â¿CuÃ¡ntas horas hay en un dÃ­a?',
                    answer: 24,
                    explanation: 'Este es un dato que debes memorizar'
                },
                {
                    type: 'simple-operation',
                    question: 'Â¿CuÃ¡ntos dÃ­as hay en una semana?',
                    answer: 7,
                    explanation: 'Cuenta los dÃ­as desde lunes hasta domingo'
                },
                {
                    type: 'simple-operation',
                    question: 'Â¿CuÃ¡ntos meses tiene un aÃ±o?',
                    answer: 12,
                    explanation: 'Cuenta desde enero hasta diciembre'
                },
                {
                    type: 'time-calculation',
                    question: 'Si son las 9:30 AM y pasan 2 horas, Â¿quÃ© hora serÃ¡?',
                    answer: '11:30 AM',
                    options: ['10:30 AM', '11:30 AM', '12:30 PM', '1:30 PM'],
                    correct: 1
                },
                {
                    type: 'time-calculation',
                    question: 'Una pelÃ­cula dura 90 minutos. Â¿CuÃ¡ntas horas y minutos son?',
                    answer: '1 hora 30 minutos',
                    options: ['1 hora', '1 hora 30 minutos', '2 horas', '2 horas 30 minutos'],
                    correct: 1
                },
                {
                    type: 'calendar',
                    question: 'Si hoy es lunes 15, Â¿quÃ© dÃ­a serÃ¡ el lunes prÃ³ximo?',
                    answer: 22,
                    explanation: 'Suma 7 dÃ­as a la fecha actual'
                },
                {
                    type: 'calendar',
                    question: 'Â¿CuÃ¡ntos dÃ­as tiene febrero en un aÃ±o normal?',
                    answer: 28,
                    explanation: 'Febrero es el mes mÃ¡s corto del aÃ±o'
                },
                {
                    type: 'calendar',
                    question: 'Â¿CuÃ¡les meses tienen 31 dÃ­as?',
                    options: ['Enero, Marzo, Mayo', 'Febrero, Abril, Junio', 'Todos los meses', 'NingÃºn mes'],
                    correct: 0,
                    explanation: 'Usa la regla de los nudillos para recordar'
                },
                {
                    type: 'time-word-problem',
                    question: 'Amaia estudia 45 minutos cada dÃ­a. Â¿CuÃ¡ntos minutos estudia en 4 dÃ­as?',
                    answer: 180,
                    explanation: 'Multiplica los minutos diarios por el nÃºmero de dÃ­as'
                },
                {
                    type: 'time-word-problem',
                    question: 'Un partido de fÃºtbol dura 90 minutos. Si hay 15 minutos de descanso, Â¿cuÃ¡nto dura en total?',
                    answer: 105,
                    explanation: 'Suma el tiempo del partido mÃ¡s el descanso'
                },
                // Sub-etapa 3 - Longitud avanzada
                {
                    type: 'simple-operation',
                    question: 'Â¿CuÃ¡ntos metros hay en 1 kilÃ³metro?',
                    answer: 1000,
                    explanation: 'Kilo significa 1000'
                },
                {
                    type: 'simple-operation',
                    question: 'Â¿CuÃ¡ntos centÃ­metros hay en 2.5 metros?',
                    answer: 250,
                    explanation: 'Para convertir metros a cm, multiplica por 100'
                },
                {
                    type: 'length-conversion',
                    question: 'Convierte 3500 metros a kilÃ³metros',
                    answer: 3.5,
                    explanation: 'Para convertir metros a km, divide por 1000'
                },
                {
                    type: 'length-conversion',
                    question: 'Convierte 45 milÃ­metros a centÃ­metros',
                    answer: 4.5,
                    explanation: 'Para convertir mm a cm, divide por 10'
                },
                {
                    type: 'length-comparison',
                    question: 'Â¿QuÃ© es mÃ¡s largo?',
                    options: ['2.5 metros', '240 centÃ­metros', '2450 milÃ­metros', 'Son iguales'],
                    correct: 2,
                    explanation: 'Convierte todo a la misma unidad para comparar'
                },
                {
                    type: 'length-estimation',
                    question: 'Â¿CuÃ¡l es la altura aproximada de una puerta?',
                    options: ['50 cm', '2 metros', '5 metros', '10 metros'],
                    correct: 1
                },
                {
                    type: 'length-estimation',
                    question: 'Â¿CuÃ¡l es el ancho aproximado de un libro?',
                    options: ['20 mm', '20 cm', '20 m', '20 km'],
                    correct: 1
                },
                {
                    type: 'length-word-problem',
                    question: 'Una cuerda mide 5 metros. Si cortas 175 centÃ­metros, Â¿cuÃ¡ntos centÃ­metros quedan?',
                    answer: 325,
                    explanation: 'Convierte a centÃ­metros y luego resta'
                },
                {
                    type: 'length-word-problem',
                    question: 'Amaia camina 250 metros hasta la escuela. Â¿CuÃ¡ntos metros camina en 5 dÃ­as (ida y vuelta)?',
                    answer: 2500,
                    explanation: 'Ida y vuelta = Ã— 2, durante 5 dÃ­as = Ã— 5'
                },
                {
                    type: 'perimeter-measurement',
                    question: 'Una mesa cuadrada tiene lados de 80 cm. Â¿CuÃ¡l es su perÃ­metro en metros?',
                    answer: 3.2,
                    explanation: 'PerÃ­metro = suma de todos los lados, luego convierte a metros'
                },
                // Sub-etapa 4 - Ãrea y volumen
                {
                    type: 'area',
                    question: 'Calcula el Ã¡rea de un cuadrado de 5 cm de lado',
                    side: 5,
                    answer: 25,
                    unit: 'cmÂ²'
                },
                {
                    type: 'area',
                    question: 'Calcula el Ã¡rea de un rectÃ¡ngulo de 7 cm de largo y 4 cm de ancho',
                    length: 7,
                    width: 4,
                    answer: 28,
                    unit: 'cmÂ²'
                },
                {
                    type: 'area',
                    question: 'Un piso cuadrado tiene Ã¡rea de 36 mÂ². Â¿CuÃ¡nto mide cada lado?',
                    answer: 6,
                    explanation: '6 Ã— 6 = 36'
                },
                {
                    type: 'area-comparison',
                    question: 'Â¿QuÃ© tiene mayor Ã¡rea?',
                    options: ['Cuadrado de 6Ã—6', 'RectÃ¡ngulo de 5Ã—8', 'RectÃ¡ngulo de 4Ã—9', 'Son iguales'],
                    correct: 1,
                    explanation: '6Ã—6=36, 5Ã—8=40, 4Ã—9=36'
                },
                {
                    type: 'volume',
                    question: 'Â¿CuÃ¡ntos mililitros hay en 1.5 litros?',
                    answer: 1500,
                    explanation: '1.5 Ã— 1000 = 1500 mililitros'
                },
                {
                    type: 'volume',
                    question: 'Â¿CuÃ¡ntos litros hay en 3000 mililitros?',
                    answer: 3,
                    explanation: '3000 Ã· 1000 = 3 litros'
                },
                {
                    type: 'volume-comparison',
                    question: 'Â¿QuÃ© contiene mÃ¡s lÃ­quido?',
                    options: ['2 litros', '1500 ml', '2.5 litros', '2200 ml'],
                    correct: 2,
                    explanation: '2.5 litros = 2500 ml, es el mayor'
                },
                {
                    type: 'capacity-estimation',
                    question: 'Â¿CuÃ¡l es la capacidad aproximada de una botella de agua?',
                    options: ['50 ml', '500 ml', '5 litros', '50 litros'],
                    correct: 1
                },
                {
                    type: 'capacity-estimation',
                    question: 'Â¿CuÃ¡l es la capacidad aproximada de una tina de baÃ±o?',
                    options: ['20 litros', '200 litros', '2000 litros', '20000 litros'],
                    correct: 1
                },
                {
                    type: 'volume-word-problem',
                    question: 'Una jarra tiene 2 litros de jugo. Si sirves 250 ml en cada vaso, Â¿cuÃ¡ntos vasos puedes llenar?',
                    answer: 8,
                    explanation: '2 litros = 2000 ml, 2000 Ã· 250 = 8 vasos'
                },
                // Sub-etapa 5 - Masa y peso avanzado
                {
                    type: 'simple-operation',
                    question: 'Â¿CuÃ¡ntos gramos hay en 2.5 kilogramos?',
                    answer: 2500,
                    explanation: '2.5 Ã— 1000 = 2500 gramos'
                },
                {
                    type: 'simple-operation',
                    question: 'Â¿CuÃ¡ntos kilogramos son 4500 gramos?',
                    answer: 4.5,
                    explanation: '4500 Ã· 1000 = 4.5 kilogramos'
                },
                {
                    type: 'mass-conversion',
                    question: 'Â¿CuÃ¡ntos gramos hay en 3 kg 250 g?',
                    answer: 3250,
                    explanation: '3000 + 250 = 3250 gramos'
                },
                {
                    type: 'mass-comparison',
                    question: 'Â¿QuÃ© pesa mÃ¡s?',
                    options: ['3.2 kg', '3150 g', '3 kg 180 g', 'Son iguales'],
                    correct: 0,
                    explanation: '3.2 kg = 3200 g, es el mayor'
                },
                {
                    type: 'mass-estimation',
                    question: 'Â¿CuÃ¡l es el peso aproximado de un lÃ¡piz?',
                    options: ['10 g', '100 g', '1 kg', '10 kg'],
                    correct: 0
                },
                {
                    type: 'mass-estimation',
                    question: 'Â¿CuÃ¡l es el peso aproximado de una mochila escolar llena?',
                    options: ['300 g', '3 kg', '30 kg', '300 kg'],
                    correct: 1
                },
                {
                    type: 'mass-word-problem',
                    question: 'Una bolsa de manzanas pesa 2.5 kg. Si cada manzana pesa 250 g, Â¿cuÃ¡ntas manzanas hay?',
                    answer: 10,
                    explanation: '2.5 kg = 2500 g, 2500 Ã· 250 = 10 manzanas'
                },
                {
                    type: 'mass-word-problem',
                    question: 'Amaia compra 750 g de queso y 1.25 kg de jamÃ³n. Â¿CuÃ¡nto pesan en total en gramos?',
                    answer: 2000,
                    explanation: 'Convierte todo a gramos y suma'
                },
                {
                    type: 'temperature',
                    question: 'Â¿CuÃ¡l es la temperatura normal del cuerpo humano?',
                    options: ['27Â°C', '37Â°C', '47Â°C', '57Â°C'],
                    correct: 1
                },
                {
                    type: 'temperature',
                    question: 'Â¿A quÃ© temperatura hierve el agua?',
                    options: ['0Â°C', '50Â°C', '100Â°C', '200Â°C'],
                    correct: 2
                },
                // Ejercicios mixtos para completar 75
                {
                    type: 'mixed-units',
                    question: 'Un maratÃ³n mide 42 km 195 m. Â¿CuÃ¡ntos metros son en total?',
                    answer: 42195,
                    explanation: 'Convierte kilÃ³metros a metros y suma'
                },
                {
                    type: 'mixed-units',
                    question: 'Una receta necesita 1 L 250 ml de leche. Â¿CuÃ¡ntos mililitros son?',
                    answer: 1250,
                    explanation: 'Convierte litros a mililitros y suma'
                },
                {
                    type: 'time-zones',
                    question: 'Si en Chile son las 3:00 PM, y en EspaÃ±a son 5 horas mÃ¡s, Â¿quÃ© hora es allÃ¡?',
                    answer: '8:00 PM',
                    options: ['6:00 PM', '7:00 PM', '8:00 PM', '9:00 PM'],
                    correct: 2
                },
                {
                    type: 'speed-concept',
                    question: 'Si caminas 4 km en 1 hora, Â¿cuÃ¡ntos km caminas en 3 horas?',
                    answer: 12,
                    explanation: 'Multiplica velocidad por tiempo'
                },
                {
                    type: 'measurement-tools',
                    question: 'Â¿Con quÃ© instrumento mides la temperatura?',
                    options: ['Regla', 'Balanza', 'TermÃ³metro', 'Reloj'],
                    correct: 2
                },
                {
                    type: 'measurement-tools',
                    question: 'Â¿Con quÃ© instrumento mides el peso?',
                    options: ['Regla', 'Balanza', 'TermÃ³metro', 'Reloj'],
                    correct: 1
                },
                {
                    type: 'practical-measurement',
                    question: 'Para medir el largo de tu escritorio, Â¿quÃ© unidad usarÃ­as?',
                    options: ['MilÃ­metros', 'CentÃ­metros', 'Metros', 'KilÃ³metros'],
                    correct: 1
                },
                {
                    type: 'practical-measurement',
                    question: 'Para medir la distancia entre ciudades, Â¿quÃ© unidad usarÃ­as?',
                    options: ['MilÃ­metros', 'CentÃ­metros', 'Metros', 'KilÃ³metros'],
                    correct: 3
                },
                {
                    type: 'measurement-word-problem',
                    question: 'La clase de Amaia empieza a las 8:00 AM y termina a las 1:30 PM. Â¿CuÃ¡nto dura?',
                    answer: '5 horas 30 minutos',
                    options: ['4 horas 30 minutos', '5 horas', '5 horas 30 minutos', '6 horas'],
                    correct: 2
                },
                {
                    type: 'measurement-word-problem',
                    question: 'Un tanque vacÃ­o pesa 5 kg. Lleno de agua pesa 25 kg. Â¿CuÃ¡ntos kg de agua contiene?',
                    answer: 20,
                    explanation: 'Resta el peso vacÃ­o del peso lleno'
                },
                {
                    type: 'unit-relationships',
                    question: '1 metro cÃºbico de agua pesa aproximadamente:',
                    options: ['10 kg', '100 kg', '1000 kg', '10000 kg'],
                    correct: 2,
                    explanation: 'Recuerda: 1 metro cÃºbico de agua es muy pesado'
                },
                {
                    type: 'measurement-challenge',
                    question: 'Si un paso tuyo mide 60 cm, Â¿cuÃ¡ntos pasos necesitas para recorrer 30 metros?',
                    answer: 50,
                    explanation: 'Convierte a centÃ­metros y divide por el tamaÃ±o del paso'
                },
                {
                    type: 'measurement-challenge',
                    question: 'Una piscina mide 25 m de largo. Si nadas 8 largos, Â¿cuÃ¡ntos metros nadaste?',
                    answer: 200,
                    explanation: 'Multiplica la longitud por el nÃºmero de largos'
                },
                {
                    type: 'measurement-challenge',
                    question: 'Si un bebÃ© nace pesando 3 kg 200 g y aumenta 800 g, Â¿cuÃ¡ntos kg pesa ahora?',
                    answer: 4,
                    explanation: 'Convierte a gramos, suma y convierte de vuelta a kilogramos'
                }
            ],
            algebra: [
                // Patrones numÃ©ricos
                {
                    type: 'pattern-next',
                    question: 'Completa el patrÃ³n: 2, 4, 6, 8, ?',
                    pattern: [2, 4, 6, 8],
                    answer: 10,
                    explanation: 'Busca quÃ© se le suma a cada nÃºmero para obtener el siguiente'
                },
                {
                    type: 'pattern-next',
                    question: 'Completa el patrÃ³n: 5, 10, 15, 20, ?',
                    pattern: [5, 10, 15, 20],
                    answer: 25,
                    explanation: 'Observa cÃ³mo crecen los nÃºmeros'
                },
                {
                    type: 'pattern-next',
                    question: 'Completa el patrÃ³n: 100, 90, 80, 70, ?',
                    pattern: [100, 90, 80, 70],
                    answer: 60,
                    explanation: 'Nota que los nÃºmeros van disminuyendo'
                },
                // Patrones geomÃ©tricos
                {
                    type: 'pattern-visual',
                    question: 'Â¿CuÃ¡ntos cÃ­rculos habrÃ¡ en la figura 5?',
                    description: 'Figura 1: ğŸ”µ, Figura 2: ğŸ”µğŸ”µ, Figura 3: ğŸ”µğŸ”µğŸ”µ',
                    answer: 5,
                    explanation: 'Observa la relaciÃ³n entre el nÃºmero de figura y la cantidad'
                },
                // Ecuaciones simples
                {
                    type: 'simple-equation',
                    question: 'Si 3 + __ = 8, Â¿cuÃ¡l es el nÃºmero que falta?',
                    answer: 5,
                    explanation: 'Piensa: Â¿quÃ© nÃºmero sumado a 3 da 8?'
                },
                {
                    type: 'simple-equation',
                    question: 'Si __ - 4 = 6, Â¿cuÃ¡l es el nÃºmero que falta?',
                    answer: 10,
                    explanation: 'Piensa: Â¿de quÃ© nÃºmero resto 4 para obtener 6?'
                },
                {
                    type: 'simple-equation',
                    question: 'Si 5 Ã— __ = 20, Â¿cuÃ¡l es el nÃºmero que falta?',
                    answer: 4,
                    explanation: 'Piensa: Â¿quÃ© nÃºmero multiplicado por 5 da 20?'
                },
                // Problemas de balanza
                {
                    type: 'balance',
                    question: 'Si 2 manzanas pesan lo mismo que 6 naranjas, y 1 manzana pesa 150g, Â¿cuÃ¡nto pesa 1 naranja?',
                    answer: 50,
                    unit: 'gramos'
                },
                // Funciones simples
                {
                    type: 'function-machine',
                    question: 'La mÃ¡quina suma 3. Si entra 7, Â¿quÃ© sale?',
                    input: 7,
                    operation: '+3',
                    answer: 10
                },
                {
                    type: 'function-machine',
                    question: 'La mÃ¡quina multiplica por 2. Si entra 6, Â¿quÃ© sale?',
                    input: 6,
                    operation: 'Ã—2',
                    answer: 12
                },
                // Sub-etapa 2 - MÃ¡s patrones
                {
                    type: 'pattern-next',
                    question: 'Completa el patrÃ³n: 3, 6, 9, 12, ?',
                    pattern: [3, 6, 9, 12],
                    answer: 15,
                    explanation: 'FÃ­jate en la diferencia entre nÃºmeros consecutivos'
                },
                {
                    type: 'pattern-next',
                    question: 'Completa el patrÃ³n: 1, 2, 4, 8, ?',
                    pattern: [1, 2, 4, 8],
                    answer: 16,
                    explanation: 'Observa cÃ³mo cada nÃºmero se relaciona con el anterior'
                },
                {
                    type: 'pattern-next',
                    question: 'Completa el patrÃ³n: 50, 45, 40, 35, ?',
                    pattern: [50, 45, 40, 35],
                    answer: 30,
                    explanation: 'Los nÃºmeros disminuyen de manera regular'
                },
                {
                    type: 'pattern-next',
                    question: 'Completa el patrÃ³n: 1, 4, 7, 10, ?',
                    pattern: [1, 4, 7, 10],
                    answer: 13,
                    explanation: 'El patrÃ³n suma 3 cada vez'
                },
                {
                    type: 'pattern-rule',
                    question: 'Â¿CuÃ¡l es la regla del patrÃ³n? 7, 14, 21, 28',
                    options: ['Sumar 7', 'Multiplicar por 2', 'Sumar 14', 'Restar 7'],
                    correct: 0,
                    explanation: 'Cada nÃºmero suma 7 al anterior'
                },
                {
                    type: 'pattern-visual',
                    question: 'Â¿CuÃ¡ntos triÃ¡ngulos habrÃ¡ en la figura 6?',
                    description: 'Figura 1: â–³, Figura 2: â–³â–³, Figura 3: â–³â–³â–³',
                    answer: 6,
                    explanation: 'Cada figura tiene tantos triÃ¡ngulos como su nÃºmero'
                },
                {
                    type: 'pattern-visual',
                    question: 'Â¿CuÃ¡ntos cuadrados habrÃ¡ en la figura 4?',
                    description: 'Figura 1: â–¡â–¡, Figura 2: â–¡â–¡â–¡â–¡, Figura 3: â–¡â–¡â–¡â–¡â–¡â–¡',
                    answer: 8,
                    explanation: 'Cada figura tiene el doble de cuadrados que su nÃºmero'
                },
                {
                    type: 'growing-pattern',
                    question: 'Los palitos forman figuras: Fig 1: 3 palitos, Fig 2: 5 palitos, Fig 3: 7 palitos. Â¿CuÃ¡ntos en Fig 4?',
                    answer: 9,
                    explanation: 'Cada figura agrega 2 palitos mÃ¡s'
                },
                {
                    type: 'pattern-table',
                    question: 'Si la entrada es 5 y la salida es 15, Â¿cuÃ¡l es la regla?',
                    options: ['Ã—2', 'Ã—3', '+10', 'Ã—4'],
                    correct: 1,
                    explanation: '5 Ã— 3 = 15'
                },
                {
                    type: 'pattern-missing',
                    question: 'Encuentra el nÃºmero que falta: 2, 5, __, 11, 14',
                    answer: 8,
                    explanation: 'El patrÃ³n suma 3 cada vez: 2+3=5, 5+3=8, 8+3=11'
                },
                // Sub-etapa 3 - Ecuaciones y relaciones
                {
                    type: 'simple-equation',
                    question: 'Si 7 + __ = 15, Â¿cuÃ¡l es el nÃºmero que falta?',
                    answer: 8,
                    explanation: '7 + 8 = 15'
                },
                {
                    type: 'simple-equation',
                    question: 'Si __ - 9 = 11, Â¿cuÃ¡l es el nÃºmero que falta?',
                    answer: 20,
                    explanation: '20 - 9 = 11'
                },
                {
                    type: 'simple-equation',
                    question: 'Si 4 Ã— __ = 24, Â¿cuÃ¡l es el nÃºmero que falta?',
                    answer: 6,
                    explanation: '4 Ã— 6 = 24'
                },
                {
                    type: 'simple-equation',
                    question: 'Si __ Ã· 3 = 9, Â¿cuÃ¡l es el nÃºmero que falta?',
                    answer: 27,
                    explanation: '27 Ã· 3 = 9'
                },
                {
                    type: 'balance',
                    question: 'Si 3 canicas pesan lo mismo que 9 clips, y 1 canica pesa 6g, Â¿cuÃ¡nto pesa 1 clip?',
                    answer: 2,
                    unit: 'gramos'
                },
                {
                    type: 'balance',
                    question: 'En una balanza: 2 cubos = 10 esferas. Si 1 esfera pesa 3g, Â¿cuÃ¡nto pesa 1 cubo?',
                    answer: 15,
                    unit: 'gramos'
                },
                {
                    type: 'double-equation',
                    question: 'Si A + B = 10 y A = 6, Â¿cuÃ¡nto vale B?',
                    answer: 4,
                    explanation: '6 + B = 10, entonces B = 4'
                },
                {
                    type: 'double-equation',
                    question: 'Si X - Y = 5 y X = 12, Â¿cuÃ¡nto vale Y?',
                    answer: 7,
                    explanation: '12 - Y = 5, entonces Y = 7'
                },
                {
                    type: 'inequality',
                    question: 'Â¿QuÃ© nÃºmero hace verdadera la expresiÃ³n? __ < 7',
                    options: ['5', '7', '8', '9'],
                    correct: 0,
                    explanation: '5 es menor que 7'
                },
                {
                    type: 'inequality',
                    question: 'Â¿QuÃ© nÃºmero hace verdadera la expresiÃ³n? 15 > __',
                    options: ['20', '18', '15', '12'],
                    correct: 3,
                    explanation: '15 es mayor que 12'
                },
                // Sub-etapa 4 - Funciones y relaciones
                {
                    type: 'function-machine',
                    question: 'La mÃ¡quina resta 4. Si entra 11, Â¿quÃ© sale?',
                    input: 11,
                    operation: '-4',
                    answer: 7
                },
                {
                    type: 'function-machine',
                    question: 'La mÃ¡quina multiplica por 3. Si entra 5, Â¿quÃ© sale?',
                    input: 5,
                    operation: 'Ã—3',
                    answer: 15
                },
                {
                    type: 'function-machine',
                    question: 'La mÃ¡quina divide por 2. Si entra 16, Â¿quÃ© sale?',
                    input: 16,
                    operation: 'Ã·2',
                    answer: 8
                },
                {
                    type: 'function-machine',
                    question: 'La mÃ¡quina suma 7. Si entra 8, Â¿quÃ© sale?',
                    input: 8,
                    operation: '+7',
                    answer: 15
                },
                {
                    type: 'function-reverse',
                    question: 'Una mÃ¡quina suma 5. Si sale 13, Â¿quÃ© entrÃ³?',
                    output: 13,
                    operation: '+5',
                    answer: 8
                },
                {
                    type: 'function-reverse',
                    question: 'Una mÃ¡quina multiplica por 4. Si sale 20, Â¿quÃ© entrÃ³?',
                    output: 20,
                    operation: 'Ã—4',
                    answer: 5
                },
                {
                    type: 'coordinate-pattern',
                    question: 'Los puntos siguen un patrÃ³n: (1,2), (2,4), (3,6). Â¿CuÃ¡l es el siguiente?',
                    answer: '(4,8)',
                    options: ['(4,7)', '(4,8)', '(5,8)', '(4,9)'],
                    correct: 1
                },
                {
                    type: 'input-output-table',
                    question: 'Entrada: 3â†’9, 4â†’12, 5â†’15. Â¿QuÃ© sale si entra 7?',
                    answer: 21,
                    explanation: 'La regla es multiplicar por 3'
                },
                {
                    type: 'two-step-function',
                    question: 'La mÃ¡quina multiplica por 2 y luego suma 1. Si entra 4, Â¿quÃ© sale?',
                    answer: 9,
                    explanation: '4Ã—2=8, 8+1=9'
                },
                {
                    type: 'two-step-function',
                    question: 'La mÃ¡quina suma 3 y luego divide por 2. Si entra 5, Â¿quÃ© sale?',
                    answer: 4,
                    explanation: '5+3=8, 8Ã·2=4'
                },
                // Sub-etapa 5 - Problemas algebraicos
                {
                    type: 'age-problem',
                    question: 'Juan tiene 8 aÃ±os. Su hermana tiene 3 aÃ±os mÃ¡s. Â¿CuÃ¡ntos aÃ±os tiene su hermana?',
                    answer: 11,
                    explanation: '8 + 3 = 11 aÃ±os'
                },
                {
                    type: 'age-problem',
                    question: 'MarÃ­a tiene 12 aÃ±os. Es 4 aÃ±os mayor que Pedro. Â¿CuÃ¡ntos aÃ±os tiene Pedro?',
                    answer: 8,
                    explanation: '12 - 4 = 8 aÃ±os'
                },
                {
                    type: 'money-problem',
                    question: 'Tienes $50. Gastas $23. Â¿CuÃ¡nto te queda?',
                    answer: 27,
                    explanation: '50 - 23 = 27'
                },
                {
                    type: 'money-problem',
                    question: 'Ahorras $15 cada semana. Â¿CuÃ¡nto tendrÃ¡s en 4 semanas?',
                    answer: 60,
                    explanation: 'Multiplica cantidad por tiempo'
                },
                {
                    type: 'distribution-problem',
                    question: '24 dulces se reparten entre 6 niÃ±os por igual. Â¿CuÃ¡ntos recibe cada uno?',
                    answer: 4,
                    explanation: 'Divide la cantidad total entre el nÃºmero de personas'
                },
                {
                    type: 'distribution-problem',
                    question: 'Si 5 amigos comparten 35 stickers por igual, Â¿cuÃ¡ntos recibe cada uno?',
                    answer: 7,
                    explanation: 'Usa la divisiÃ³n para repartir equitativamente'
                },
                {
                    type: 'perimeter-algebra',
                    question: 'Un rectÃ¡ngulo tiene ancho 5 cm y perÃ­metro 24 cm. Â¿CuÃ¡l es su largo?',
                    answer: 7,
                    explanation: 'Usa la fÃ³rmula del perÃ­metro y despeja el largo'
                },
                {
                    type: 'number-puzzle',
                    question: 'Piensa un nÃºmero. Si lo duplicas y sumas 6, obtienes 20. Â¿CuÃ¡l es el nÃºmero?',
                    answer: 7,
                    explanation: 'Traduce las palabras a nÃºmeros y resuelve'
                },
                {
                    type: 'sequence-sum',
                    question: 'Â¿CuÃ¡l es la suma de los primeros 5 nÃºmeros pares? (2+4+6+8+10)',
                    answer: 30,
                    explanation: 'Suma todos los nÃºmeros pares'
                },
                {
                    type: 'sequence-sum',
                    question: 'Â¿CuÃ¡l es la suma de los nÃºmeros del 1 al 5?',
                    answer: 15,
                    explanation: 'Suma todos los nÃºmeros consecutivos'
                },
                // Ejercicios adicionales para completar 75
                {
                    type: 'pattern-geometric-shapes',
                    question: 'El patrÃ³n es: estrella, cÃ­rculo, estrella, cÃ­rculo, estrella, ?',
                    options: ['Estrella', 'CÃ­rculo', 'Cuadrado', 'TriÃ¡ngulo'],
                    correct: 1
                },
                {
                    type: 'pattern-colors',
                    question: 'El patrÃ³n es: rojo, azul, verde, rojo, azul, ?',
                    options: ['Rojo', 'Azul', 'Verde', 'Amarillo'],
                    correct: 2
                },
                {
                    type: 'letter-pattern',
                    question: 'Completa el patrÃ³n: A, C, E, G, ?',
                    options: ['H', 'I', 'J', 'K'],
                    correct: 1,
                    explanation: 'Observa quÃ© letras se omiten en el patrÃ³n'
                },
                {
                    type: 'mixed-operations',
                    question: 'Si 3 Ã— __ + 2 = 14, Â¿cuÃ¡l es el nÃºmero?',
                    answer: 4,
                    explanation: 'Primero multiplica, luego suma 2'
                },
                {
                    type: 'pattern-multiplication',
                    question: 'Completa: 3Ã—1=3, 3Ã—2=6, 3Ã—3=9, 3Ã—4=?',
                    answer: 12,
                    explanation: 'ContinÃºa la tabla del 3'
                },
                {
                    type: 'word-equation',
                    question: 'El doble de un nÃºmero mÃ¡s 5 es 13. Â¿CuÃ¡l es el nÃºmero?',
                    answer: 4,
                    explanation: 'El doble de un nÃºmero significa multiplicar por 2'
                },
                {
                    type: 'comparison-algebra',
                    question: 'Ana tiene X dulces. Luis tiene 3 mÃ¡s que Ana. Si Luis tiene 10, Â¿cuÃ¡ntos tiene Ana?',
                    answer: 7,
                    explanation: 'Si Luis tiene 3 mÃ¡s que Ana, resta 3 a lo que tiene Luis'
                },
                {
                    type: 'time-algebra',
                    question: 'Un viaje dura X horas. Si sales a las 9 AM y llegas a las 2 PM, Â¿cuÃ¡nto durÃ³?',
                    answer: 5,
                    explanation: 'Cuenta las horas desde la salida hasta la llegada'
                },
                {
                    type: 'pattern-skip-counting',
                    question: 'Cuenta de 4 en 4: 4, 8, 12, 16, ?',
                    answer: 20,
                    explanation: 'Agrega 4 al Ãºltimo nÃºmero'
                },
                {
                    type: 'algebraic-thinking',
                    question: 'Si todos los gatos tienen 4 patas, Â¿cuÃ¡ntas patas tienen 5 gatos?',
                    answer: 20,
                    explanation: 'Multiplica el nÃºmero de gatos por las patas de cada uno'
                },
                {
                    type: 'algebraic-thinking',
                    question: 'Si cada caja tiene 6 lÃ¡pices, Â¿cuÃ¡ntos lÃ¡pices hay en 8 cajas?',
                    answer: 48,
                    explanation: 'Multiplica el nÃºmero de cajas por los lÃ¡pices en cada una'
                },
                {
                    type: 'pattern-decreasing',
                    question: 'Completa el patrÃ³n: 40, 32, 24, 16, ?',
                    answer: 8,
                    explanation: 'Los nÃºmeros disminuyen de forma constante'
                },
                {
                    type: 'function-composition',
                    question: 'Primero suma 2, luego multiplica por 3. Si entra 4, Â¿quÃ© sale?',
                    answer: 18,
                    explanation: 'Aplica las operaciones en orden: primero suma, luego multiplica'
                },
                {
                    type: 'pattern-challenge',
                    question: 'Completa: 1, 1, 2, 3, 5, 8, ?',
                    answer: 13,
                    explanation: 'Observa cÃ³mo se forma cada nÃºmero usando los anteriores'
                },
                {
                    type: 'algebra-word-problem',
                    question: 'En una fila hay niÃ±os y niÃ±as. Hay 5 niÃ±as mÃ¡s que niÃ±os. Si hay 8 niÃ±os, Â¿cuÃ¡ntas niÃ±as hay?',
                    answer: 13,
                    explanation: 'Si hay 5 mÃ¡s niÃ±as que niÃ±os, suma 5 al nÃºmero de niÃ±os'
                }
            ],
            datos: [
                // GrÃ¡ficos de barras
                {
                    type: 'bar-graph',
                    question: 'SegÃºn el grÃ¡fico, Â¿cuÃ¡ntos estudiantes prefieren el fÃºtbol?',
                    data: {
                        'FÃºtbol': 8,
                        'BÃ¡squetbol': 5,
                        'Tenis': 3,
                        'NataciÃ³n': 4
                    },
                    answer: 8
                },
                {
                    type: 'bar-graph',
                    question: 'Â¿CuÃ¡l es el deporte menos preferido?',
                    data: {
                        'FÃºtbol': 8,
                        'BÃ¡squetbol': 5,
                        'Tenis': 3,
                        'NataciÃ³n': 4
                    },
                    options: ['FÃºtbol', 'BÃ¡squetbol', 'Tenis', 'NataciÃ³n'],
                    correct: 2
                },
                // Pictogramas
                {
                    type: 'pictogram',
                    question: 'Si cada ğŸ representa 2 manzanas, Â¿cuÃ¡ntas manzanas hay en total? ğŸğŸğŸğŸğŸ',
                    symbol: 'ğŸ',
                    value: 2,
                    count: 5,
                    answer: 10
                },
                // Tablas de frecuencia
                {
                    type: 'frequency-table',
                    question: 'Â¿CuÃ¡ntos estudiantes sacaron nota 6?',
                    table: {
                        'Nota 7': 5,
                        'Nota 6': 8,
                        'Nota 5': 3,
                        'Nota 4': 2
                    },
                    answer: 8
                },
                // Media, mediana y moda
                {
                    type: 'simple-operation',
                    question: 'Calcula el promedio de: 4, 6, 8',
                    answer: 6,
                    explanation: 'Suma todos los nÃºmeros y divide por cuÃ¡ntos hay'
                },
                {
                    type: 'mode',
                    question: 'Â¿CuÃ¡l es la moda en: 2, 3, 3, 4, 3, 5?',
                    data: [2, 3, 3, 4, 3, 5],
                    answer: 3,
                    explanation: 'Busca el nÃºmero que aparece mÃ¡s veces en la lista'
                },
                // Probabilidad simple
                {
                    type: 'probability',
                    question: 'Si lanzas una moneda, Â¿cuÃ¡l es la probabilidad de obtener cara?',
                    options: ['1/2', '1/3', '1/4', '2/3'],
                    correct: 0,
                    explanation: 'En una moneda hay dos opciones igualmente probables'
                },
                {
                    type: 'probability',
                    question: 'En una bolsa hay 3 bolas rojas y 2 azules. Â¿QuÃ© color es mÃ¡s probable sacar?',
                    options: ['Rojo', 'Azul', 'Igual probabilidad'],
                    correct: 0,
                    explanation: 'Compara cuÃ¡ntas bolas de cada color hay'
                },
                // OrganizaciÃ³n de datos
                {
                    type: 'data-organization',
                    question: 'Ordena de menor a mayor: 15, 8, 23, 12, 19',
                    answer: '8, 12, 15, 19, 23',
                    options: ['8, 12, 15, 19, 23', '23, 19, 15, 12, 8', '8, 15, 12, 19, 23', '12, 8, 15, 23, 19'],
                    correct: 0
                },
                // InterpretaciÃ³n de datos
                {
                    type: 'data-interpretation',
                    question: 'Si 20 estudiantes respondieron una encuesta y 12 dijeron que les gusta la pizza, Â¿cuÃ¡ntos NO les gusta?',
                    answer: 8,
                    explanation: 'Resta los que les gusta del total'
                },
                // Sub-etapa 1 continuaciÃ³n - InterpretaciÃ³n de grÃ¡ficos
                {
                    type: 'bar-graph',
                    question: 'SegÃºn el grÃ¡fico, Â¿cuÃ¡ntos estudiantes prefieren helado de chocolate?',
                    data: {
                        'Chocolate': 12,
                        'Vainilla': 7,
                        'Frutilla': 5,
                        'LimÃ³n': 3
                    },
                    answer: 12
                },
                {
                    type: 'bar-graph',
                    question: 'Â¿CuÃ¡l es la diferencia entre el sabor mÃ¡s y menos preferido?',
                    data: {
                        'Chocolate': 12,
                        'Vainilla': 7,
                        'Frutilla': 5,
                        'LimÃ³n': 3
                    },
                    answer: 9,
                    explanation: 'Resta el mayor nÃºmero del menor'
                },
                {
                    type: 'simple-operation',
                    question: 'Â¿CuÃ¡ntos estudiantes fueron encuestados en total?',
                    answer: 27,
                    explanation: 'Suma todos los valores del grÃ¡fico'
                },
                {
                    type: 'pictogram',
                    question: 'Si cada ğŸ€ representa 3 pelotas, Â¿cuÃ¡ntas hay? ğŸ€ğŸ€ğŸ€ğŸ€',
                    symbol: 'ğŸ€',
                    value: 3,
                    count: 4,
                    answer: 12
                },
                {
                    type: 'pictogram',
                    question: 'Si cada â­ vale 5 puntos, Â¿cuÃ¡ntos puntos hay? â­â­â­â­â­â­',
                    symbol: 'â­',
                    value: 5,
                    count: 6,
                    answer: 30
                },
                // Sub-etapa 2 - Tablas y organizaciÃ³n de datos
                {
                    type: 'frequency-table',
                    question: 'Â¿CuÃ¡ntos dÃ­as lloviÃ³ en la semana?',
                    table: {
                        'Lunes': 'Sol',
                        'Martes': 'Lluvia',
                        'MiÃ©rcoles': 'Sol',
                        'Jueves': 'Lluvia',
                        'Viernes': 'Lluvia',
                        'SÃ¡bado': 'Sol',
                        'Domingo': 'Sol'
                    },
                    answer: 3,
                    explanation: 'Cuenta cuÃ¡ntos dÃ­as aparece "Lluvia"'
                },
                {
                    type: 'frequency-table',
                    question: 'Â¿CuÃ¡l es el color favorito mÃ¡s popular?',
                    table: {
                        'Azul': 9,
                        'Rojo': 6,
                        'Verde': 4,
                        'Amarillo': 5
                    },
                    options: ['Azul', 'Rojo', 'Verde', 'Amarillo'],
                    correct: 0
                },
                {
                    type: 'data-organization',
                    question: 'Ordena de mayor a menor: 45, 23, 67, 34, 56',
                    answer: '67, 56, 45, 34, 23',
                    options: ['67, 56, 45, 34, 23', '23, 34, 45, 56, 67', '45, 23, 67, 34, 56', '56, 67, 45, 23, 34'],
                    correct: 0
                },
                {
                    type: 'data-organization',
                    question: 'Ordena alfabÃ©ticamente: perro, gato, conejo, ave',
                    answer: 'ave, conejo, gato, perro',
                    options: ['ave, conejo, gato, perro', 'perro, gato, conejo, ave', 'gato, ave, perro, conejo', 'conejo, ave, gato, perro'],
                    correct: 0
                },
                {
                    type: 'simple-operation',
                    question: 'Si en una tabla hay 5 filas y 4 columnas, Â¿cuÃ¡ntas celdas hay?',
                    answer: 20,
                    explanation: 'Multiplica filas por columnas'
                },
                {
                    type: 'bar-graph',
                    question: 'Â¿CuÃ¡ntos libros leyÃ³ MarÃ­a?',
                    data: {
                        'Juan': 5,
                        'MarÃ­a': 8,
                        'Pedro': 6,
                        'Ana': 7
                    },
                    answer: 8
                },
                {
                    type: 'bar-graph',
                    question: 'Â¿QuiÃ©n leyÃ³ menos libros?',
                    data: {
                        'Juan': 5,
                        'MarÃ­a': 8,
                        'Pedro': 6,
                        'Ana': 7
                    },
                    options: ['Juan', 'MarÃ­a', 'Pedro', 'Ana'],
                    correct: 0
                },
                {
                    type: 'simple-operation',
                    question: 'Â¿CuÃ¡ntos libros leyeron entre todos?',
                    answer: 26,
                    explanation: 'Suma todos los libros leÃ­dos por cada persona'
                },
                {
                    type: 'pictogram',
                    question: 'Si cada ğŸŒ³ representa 10 Ã¡rboles, Â¿cuÃ¡ntos hay? ğŸŒ³ğŸŒ³ğŸŒ³ğŸŒ³ğŸŒ³ğŸŒ³ğŸŒ³',
                    symbol: 'ğŸŒ³',
                    value: 10,
                    count: 7,
                    answer: 70
                },
                // Sub-etapa 3 - Medidas de tendencia central
                {
                    type: 'simple-operation',
                    question: 'Calcula el promedio de: 10, 20, 30',
                    answer: 20,
                    explanation: 'Suma todos los nÃºmeros y divide por cuÃ¡ntos hay'
                },
                {
                    type: 'simple-operation',
                    question: 'Calcula el promedio de: 5, 7, 9, 11',
                    answer: 8,
                    explanation: 'El promedio se calcula sumando y dividiendo por la cantidad'
                },
                {
                    type: 'mode',
                    question: 'Â¿CuÃ¡l es la moda en: 4, 5, 5, 6, 5, 7, 8?',
                    data: [4, 5, 5, 6, 5, 7, 8],
                    answer: 5,
                    explanation: 'Cuenta cuÃ¡ntas veces aparece cada nÃºmero'
                },
                {
                    type: 'mode',
                    question: 'Â¿CuÃ¡l es la moda en: 10, 12, 12, 15, 15, 15, 20?',
                    data: [10, 12, 12, 15, 15, 15, 20],
                    answer: 15,
                    explanation: 'Busca el nÃºmero que mÃ¡s se repite'
                },
                {
                    type: 'simple-operation',
                    question: 'Encuentra la mediana de: 3, 5, 7, 9, 11',
                    answer: 7,
                    explanation: 'La mediana es el valor del centro cuando estÃ¡n ordenados'
                },
                {
                    type: 'simple-operation',
                    question: 'Encuentra la mediana de: 2, 4, 6, 8',
                    answer: 5,
                    explanation: 'Con cantidad par de datos, promedia los dos del centro'
                },
                {
                    type: 'data-interpretation',
                    question: 'Si el promedio de 4 notas es 6, Â¿cuÃ¡l es la suma de las notas?',
                    answer: 24,
                    explanation: 'Si conoces el promedio, multiplica por la cantidad de datos'
                },
                {
                    type: 'simple-operation',
                    question: 'El promedio de edad de 3 hermanos es 10 aÃ±os. Â¿CuÃ¡ntos aÃ±os suman entre todos?',
                    answer: 30,
                    explanation: 'Multiplica el promedio por la cantidad de personas'
                },
                {
                    type: 'frequency-table',
                    question: 'Â¿CuÃ¡l es la temperatura mÃ¡s frecuente?',
                    table: {
                        '20Â°C': 3,
                        '22Â°C': 5,
                        '24Â°C': 2,
                        '25Â°C': 1
                    },
                    options: ['20Â°C', '22Â°C', '24Â°C', '25Â°C'],
                    correct: 1
                },
                {
                    type: 'data-organization',
                    question: 'Si ordenas estos nÃºmeros, Â¿cuÃ¡l queda en el medio? 15, 8, 23, 12, 19',
                    answer: 15,
                    explanation: 'Ordena los nÃºmeros y encuentra el del centro'
                },
                {
                    type: 'range',
                    question: 'Â¿CuÃ¡l es el rango de: 3, 7, 2, 9, 5?',
                    answer: 7,
                    explanation: 'El rango es la diferencia entre el mayor y menor valor'
                },
                {
                    type: 'range',
                    question: 'Â¿CuÃ¡l es el rango de temperaturas: 18Â°C, 25Â°C, 20Â°C, 30Â°C?',
                    answer: 12,
                    explanation: 'Resta la temperatura mÃ¡s baja de la mÃ¡s alta'
                },
                {
                    type: 'simple-operation',
                    question: 'Si 5 amigos tienen estas edades: 9, 10, 11, 10, 10. Â¿CuÃ¡l es la edad mÃ¡s comÃºn?',
                    answer: 10,
                    explanation: 'Busca la edad que mÃ¡s se repite'
                },
                {
                    type: 'data-interpretation',
                    question: 'En una clase de 30 estudiantes, si el promedio de altura es 140 cm, Â¿cuÃ¡l es la suma de todas las alturas?',
                    answer: 4200,
                    explanation: 'Multiplica el promedio por el nÃºmero de estudiantes'
                },
                {
                    type: 'comparison',
                    question: 'Â¿QuÃ© conjunto tiene mayor promedio: [4,6,8] o [5,5,5]?',
                    options: ['[4,6,8]', '[5,5,5]', 'Son iguales'],
                    correct: 0,
                    explanation: 'Calcula el promedio de cada conjunto y compara'
                },
                // Sub-etapa 4 - Probabilidad y predicciones
                {
                    type: 'probability',
                    question: 'Si lanzas un dado, Â¿cuÃ¡l es la probabilidad de sacar un 6?',
                    options: ['1/6', '1/3', '1/2', '2/6'],
                    correct: 0,
                    explanation: 'En un dado hay 6 posibilidades, una favorable'
                },
                {
                    type: 'probability',
                    question: 'En una bolsa hay 4 canicas rojas y 6 azules. Â¿QuÃ© fracciÃ³n representa las rojas?',
                    options: ['4/10', '6/10', '4/6', '10/4'],
                    correct: 0,
                    explanation: 'Cuenta las canicas rojas y divide por el total'
                },
                {
                    type: 'probability',
                    question: 'Si giras una ruleta dividida en 4 partes iguales (rojo, azul, verde, amarillo), Â¿quÃ© probabilidad hay de caer en rojo?',
                    options: ['1/4', '1/2', '1/3', '2/4'],
                    correct: 0
                },
                {
                    type: 'simple-operation',
                    question: 'Si lanzas 2 monedas, Â¿cuÃ¡ntos resultados posibles hay?',
                    answer: 4,
                    explanation: 'Cuenta todas las combinaciones posibles'
                },
                {
                    type: 'data-interpretation',
                    question: 'Si de 50 personas, 30 usan lentes, Â¿quÃ© porcentaje NO usa lentes?',
                    answer: 40,
                    explanation: 'Calcula quÃ© porcentaje representa 20 de 50'
                },
                {
                    type: 'prediction',
                    question: 'Si en 10 lanzamientos saliÃ³ cara 6 veces, Â¿cuÃ¡ntas caras esperarÃ­as en 20 lanzamientos?',
                    answer: 12,
                    explanation: 'Usa la proporciÃ³n observada para predecir'
                },
                {
                    type: 'probability',
                    question: 'Â¿QuÃ© es mÃ¡s probable al lanzar un dado: sacar par o impar?',
                    options: ['Par', 'Impar', 'Igual probabilidad'],
                    correct: 2,
                    explanation: 'Cuenta cuÃ¡ntos nÃºmeros pares e impares hay'
                },
                {
                    type: 'simple-operation',
                    question: 'Si la probabilidad de lluvia es 3/4, Â¿quÃ© probabilidad hay de que NO llueva?',
                    answer: '1/4',
                    options: ['1/4', '3/4', '1/2', '2/4'],
                    correct: 0
                },
                {
                    type: 'data-interpretation',
                    question: 'Si 8 de cada 10 estudiantes aprueban, Â¿cuÃ¡ntos aprobarÃ­an de 30 estudiantes?',
                    answer: 24,
                    explanation: 'Aplica la misma proporciÃ³n al nuevo grupo'
                },
                {
                    type: 'probability',
                    question: 'En una caja hay 5 chocolates con leche y 5 sin leche. Si sacas uno sin mirar, Â¿quÃ© probabilidad hay de que sea con leche?',
                    options: ['1/2', '1/5', '5/5', '5/10'],
                    correct: 0
                },
                {
                    type: 'spinner',
                    question: 'Una ruleta tiene 3 secciones rojas y 1 azul. Â¿Es mÃ¡s probable caer en rojo o azul?',
                    options: ['Rojo', 'Azul', 'Igual probabilidad'],
                    correct: 0,
                    explanation: 'Compara cuÃ¡ntas secciones tiene cada color'
                },
                {
                    type: 'data-interpretation',
                    question: 'Si el 25% de 40 estudiantes usa mochila azul, Â¿cuÃ¡ntos estudiantes son?',
                    answer: 10,
                    explanation: 'Calcula el 25% de 40 estudiantes'
                },
                {
                    type: 'probability',
                    question: 'Si sacas una carta de una baraja de 52, Â¿quÃ© es mÃ¡s probable: sacar un corazÃ³n o un as?',
                    options: ['CorazÃ³n', 'As', 'Igual probabilidad'],
                    correct: 0,
                    explanation: 'Compara cuÃ¡ntas cartas de cada tipo hay'
                },
                {
                    type: 'simple-operation',
                    question: 'Si la probabilidad de ganar es 2/5, Â¿cuÃ¡l es la probabilidad de perder?',
                    answer: '3/5',
                    options: ['3/5', '2/5', '1/5', '4/5'],
                    correct: 0
                },
                {
                    type: 'prediction',
                    question: 'Si una planta crece 2 cm por semana, Â¿cuÃ¡nto crecerÃ¡ en 6 semanas?',
                    answer: 12,
                    explanation: 'Multiplica el crecimiento semanal por las semanas'
                },
                // Sub-etapa 5 - Problemas y aplicaciones
                {
                    type: 'data-word-problem',
                    question: 'Amaia hizo una encuesta sobre mascotas. 15 tienen perro, 8 tienen gato y 5 tienen ambos. Â¿CuÃ¡ntos tienen solo perro?',
                    answer: 10,
                    explanation: 'Resta los que tienen ambos del total de perros'
                },
                {
                    type: 'data-word-problem',
                    question: 'En un campeonato, el equipo A anotÃ³: 3, 2, 4, 5, 1 goles. Â¿CuÃ¡l fue su promedio de goles?',
                    answer: 3,
                    explanation: 'Suma todos los goles y divide por los partidos'
                },
                {
                    type: 'survey-design',
                    question: 'Para saber el deporte favorito de tu curso, Â¿cuÃ¡ntas preguntas necesitas hacer a cada estudiante?',
                    answer: 1,
                    options: ['1', '2', '5', '10'],
                    correct: 0
                },
                {
                    type: 'data-collection',
                    question: 'Â¿CuÃ¡l es la mejor forma de registrar las respuestas de una encuesta?',
                    options: ['Memoria', 'Tabla', 'Adivinar', 'No registrar'],
                    correct: 1
                },
                {
                    type: 'graph-interpretation',
                    question: 'Si un grÃ¡fico muestra ventas crecientes cada mes, Â¿quÃ© conclusiÃ³n puedes sacar?',
                    options: ['El negocio va mal', 'El negocio va bien', 'No se puede saber', 'Las ventas bajan'],
                    correct: 1
                },
                {
                    type: 'data-word-problem',
                    question: 'Una tienda vendiÃ³: Lunes 20, Martes 25, MiÃ©rcoles 15, Jueves 30, Viernes 35 helados. Â¿QuÃ© dÃ­a vendiÃ³ mÃ¡s?',
                    options: ['Lunes', 'Martes', 'Jueves', 'Viernes'],
                    correct: 3
                },
                {
                    type: 'simple-operation',
                    question: 'Â¿CuÃ¡ntos helados vendiÃ³ la tienda en total la semana?',
                    answer: 125,
                    explanation: 'Suma las ventas de todos los dÃ­as'
                },
                {
                    type: 'data-comparison',
                    question: 'Equipo A: 45, 50, 48 puntos. Equipo B: 46, 47, 49 puntos. Â¿QuÃ© equipo tiene mejor promedio?',
                    options: ['Equipo A', 'Equipo B', 'Empate'],
                    correct: 0,
                    explanation: 'Calcula el promedio de cada equipo y compara'
                },
                {
                    type: 'simple-operation',
                    question: 'Si graficas las edades de 5 amigos (8, 9, 9, 10, 11), Â¿cuÃ¡l edad aparecerÃ­a mÃ¡s alta en un grÃ¡fico de barras?',
                    answer: 9,
                    explanation: 'En un grÃ¡fico de barras, busca la barra mÃ¡s alta'
                },
                {
                    type: 'data-interpretation',
                    question: 'En un pictograma de flores, si cada ğŸŒ» = 5 flores y hay 8 sÃ­mbolos, Â¿cuÃ¡ntas flores hay?',
                    answer: 40,
                    explanation: 'Multiplica el nÃºmero de sÃ­mbolos por el valor de cada uno'
                },
                {
                    type: 'schedule-analysis',
                    question: 'Si practicas piano: L-15min, M-20min, X-15min, J-25min, V-20min. Â¿CuÃ¡l es tu tiempo promedio?',
                    answer: 19,
                    explanation: 'Suma todos los tiempos y divide por los dÃ­as'
                },
                {
                    type: 'voting',
                    question: 'En una votaciÃ³n: Pizza-12, Hamburguesa-8, Tacos-5. Â¿CuÃ¡ntos votos de diferencia hay entre el 1Â° y 2Â° lugar?',
                    answer: 4,
                    explanation: 'Resta los votos del segundo lugar del primero'
                },
                {
                    type: 'trend-analysis',
                    question: 'Las temperaturas de la semana: 20Â°, 22Â°, 24Â°, 26Â°, 28Â°. Â¿QuÃ© tendencia observas?',
                    options: ['Aumenta', 'Disminuye', 'Se mantiene', 'Variable'],
                    correct: 0
                },
                {
                    type: 'data-word-problem',
                    question: 'En la biblioteca hay 100 libros. 40% son cuentos, 30% son cÃ³mics y el resto son revistas. Â¿CuÃ¡ntas revistas hay?',
                    answer: 30,
                    explanation: 'Resta los porcentajes conocidos del total'
                },
                {
                    type: 'conclusion',
                    question: 'Si 9 de 10 estudiantes prefieren recreo largo, Â¿quÃ© deberÃ­as recomendar al director?',
                    options: ['Recreo mÃ¡s corto', 'Recreo mÃ¡s largo', 'Sin recreo', 'No cambiar'],
                    correct: 1
                }
            ]
        };

        // Funciones de navegaciÃ³n
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(screenId + 'Screen').classList.remove('hidden');
            appState.currentScreen = screenId;
            updateUI();
        }

        function showWelcome() {
            showScreen('welcome');
        }

        function showUnitSelector() {
            showScreen('unitSelector');
        }

        function selectUnit(unit) {
            appState.currentUnit = unit;
            appState.currentExercise = 0;
            appState.correctAnswers = 0;
            appState.exercises = exerciseDatabase[unit] || [];
            appState.totalQuestions = appState.exercises.length;
            
            // Inicializar o actualizar el progreso de sub-etapas
            if (!appState.subStageProgress[unit]) {
                appState.subStageProgress[unit] = { current: 1, completed: 0, questionsInStage: 0 };
            }
            
            // Calcular en quÃ© sub-etapa estamos basado en el progreso guardado
            const exercisesPerStage = 15;
            const completedExercises = Math.floor((appState.progress[unit] / 100) * appState.totalQuestions);
            appState.subStageProgress[unit].current = Math.floor(completedExercises / exercisesPerStage) + 1;
            appState.subStageProgress[unit].questionsInStage = completedExercises % exercisesPerStage;
            
            if (appState.exercises.length > 0) {
                showExercise();
            }
        }

        function showExercise() {
            showScreen('exercise');
            const exercise = appState.exercises[appState.currentExercise];
            renderExercise(exercise);
            // El canvas se inicializa solo cuando el usuario muestra la pizarra
        }

        function renderExercise(exercise) {
            const container = document.getElementById('exerciseScreen');
            const subStage = appState.subStageProgress[appState.currentUnit];
            const currentQuestionInStage = (appState.currentExercise % 15) + 1;
            const totalStages = Math.ceil(appState.totalQuestions / 15);
            
            let html = `
                <div class="exercise-header" style="text-align: center; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <button class="btn btn-secondary" onclick="confirmExitExercise()" style="font-size: 0.9em; padding: 8px 16px;">
                            ğŸ  Volver al inicio
                        </button>
                        <div style="text-align: center;">
                            <h2 style="margin: 0;">Sub-etapa ${subStage.current} de ${totalStages}</h2>
                            <p style="margin: 5px 0; font-size: 0.9em; color: #667eea;">
                                Pregunta ${currentQuestionInStage} de 15
                            </p>
                        </div>
                        <div style="width: 150px;"></div>
                    </div>
                    <div class="sub-stage-indicator" style="display: flex; gap: 5px; justify-content: center; margin-bottom: 10px;">
                        ${Array.from({length: totalStages}, (_, i) => `
                            <div style="
                                width: 30px; 
                                height: 30px; 
                                border-radius: 50%; 
                                display: flex; 
                                align-items: center; 
                                justify-content: center;
                                font-weight: bold;
                                font-size: 0.9em;
                                background: ${i < subStage.completed ? 'linear-gradient(45deg, #2ecc71, #27ae60)' : 
                                            i === subStage.current - 1 ? 'linear-gradient(45deg, #667eea, #764ba2)' : 
                                            '#e0e0e0'};
                                color: ${i <= subStage.current - 1 ? 'white' : '#999'};
                            ">
                                ${i + 1}
                            </div>
                        `).join('')}
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${(currentQuestionInStage / 15) * 100}%"></div>
                    </div>
                </div>
                
                <!-- Espacio de trabajo para Amaia (colapsable) -->
                <div class="workspace-container" style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="toggleWorkspace()" style="width: 100%; margin-bottom: 10px;">
                        <span id="workspaceToggleText">ğŸ“ Mostrar pizarra de trabajo</span>
                    </button>
                    <div class="workspace" id="workspaceArea" style="display: none;">
                        <div class="workspace-title">
                            <span>âœï¸ Mi pizarra de trabajo</span>
                            <div>
                                <button class="workspace-btn" onclick="changeColor('black')" style="background: #333;">ğŸ–¤</button>
                                <button class="workspace-btn" onclick="changeColor('blue')" style="background: #4169E1;">ğŸ’™</button>
                                <button class="workspace-btn" onclick="changeColor('red')" style="background: #DC143C;">â¤ï¸</button>
                                <button class="workspace-btn" onclick="changeColor('green')" style="background: #228B22;">ğŸ’š</button>
                                <button class="workspace-btn clear" onclick="clearCanvas()">ğŸ—‘ï¸ Limpiar</button>
                            </div>
                        </div>
                        <canvas id="workspaceCanvas" class="workspace-canvas" 
                                width="800" height="200"
                                style="background: white; border-radius: 10px; cursor: crosshair; width: 100%; touch-action: none;">
                        </canvas>
                        <div class="workspace-tools">
                            <button class="workspace-btn" onclick="setMode('draw')" id="drawMode" style="background: linear-gradient(45deg, #667eea, #764ba2);">âœï¸ Dibujar</button>
                            <button class="workspace-btn" onclick="setMode('text')" id="textMode">ğŸ“ Texto</button>
                            <button class="workspace-btn" onclick="insertText('+')">+</button>
                            <button class="workspace-btn" onclick="insertText('-')">âˆ’</button>
                            <button class="workspace-btn" onclick="insertText('Ã—')">Ã—</button>
                            <button class="workspace-btn" onclick="insertText('Ã·')">Ã·</button>
                            <button class="workspace-btn" onclick="insertText('=')">ï¼</button>
                        </div>
                        <div class="workspace-tools" style="margin-top: 5px;">
                            <button class="workspace-btn" onclick="insertText('0')">0</button>
                            <button class="workspace-btn" onclick="insertText('1')">1</button>
                            <button class="workspace-btn" onclick="insertText('2')">2</button>
                            <button class="workspace-btn" onclick="insertText('3')">3</button>
                            <button class="workspace-btn" onclick="insertText('4')">4</button>
                            <button class="workspace-btn" onclick="insertText('5')">5</button>
                            <button class="workspace-btn" onclick="insertText('6')">6</button>
                            <button class="workspace-btn" onclick="insertText('7')">7</button>
                            <button class="workspace-btn" onclick="insertText('8')">8</button>
                            <button class="workspace-btn" onclick="insertText('9')">9</button>
                        </div>
                    </div>
                </div>
            `;

            switch(exercise.type) {
                case 'simple-operation':
                    html += renderSimpleOperation(exercise);
                    break;
                case 'comparison':
                    html += renderComparisonExercise(exercise);
                    break;
                case 'decomposition':
                    html += renderDecompositionExercise(exercise);
                    break;
                case 'multiplication':
                    html += renderMultiplicationExercise(exercise);
                    break;
                case 'division':
                    html += renderDivisionExercise(exercise);
                    break;
                case 'word-problem':
                    html += renderWordProblem(exercise);
                    break;
                case 'fraction-visual':
                    html += renderFractionVisual(exercise);
                    break;
                case 'fraction-comparison':
                    html += renderFractionComparison(exercise);
                    break;
                case 'fraction-addition':
                    html += renderFractionAddition(exercise);
                    break;
                case 'mixed-numbers':
                    html += renderMixedNumbers(exercise);
                    break;
                case 'decimal-fraction':
                    html += renderDecimalFraction(exercise);
                    break;
                // Nuevos tipos de fracciones
                case 'fraction-equivalent':
                case 'fraction-to-decimal':
                case 'decimal-to-percent':
                case 'fraction-order':
                    html += renderComparisonExercise(exercise);
                    break;
                case 'fraction-simplify':
                case 'mixed-to-improper':
                case 'fraction-of-number':
                case 'mixed-addition':
                    html += renderSimpleOperation(exercise);
                    break;
                case 'fraction-subtraction':
                    html += renderFractionAddition(exercise);
                    break;
                case 'fraction-multiplication':
                    html += renderFractionMultiplication(exercise);
                    break;
                case 'fraction-word-problem':
                    html += renderFractionWordProblem(exercise);
                    break;
                case 'shape-identification':
                    html += renderShapeIdentification(exercise);
                    break;
                case 'perimeter':
                    html += renderPerimeterExercise(exercise);
                    break;
                // Nuevos tipos de ejercicios
                case 'time-conversion':
                case 'mass-comparison':
                case 'data-organization':
                case 'probability':
                case 'time-calculation':
                case 'calendar':
                case 'length-comparison':
                case 'length-estimation':
                case 'area-comparison':
                case 'volume-comparison':
                case 'capacity-estimation':
                case 'mass-estimation':
                case 'temperature':
                case 'time-zones':
                case 'measurement-tools':
                case 'practical-measurement':
                case 'measurement-word-problem':
                case 'unit-relationships':
                    html += renderComparisonExercise(exercise);
                    break;
                case 'area':
                case 'volume':
                case 'pattern-next':
                case 'pattern-visual':
                case 'simple-equation':
                case 'balance':
                case 'function-machine':
                case 'pictogram':
                case 'frequency-table':
                case 'mode':
                case 'data-interpretation':
                case 'growing-pattern':
                case 'pattern-missing':
                case 'double-equation':
                case 'function-reverse':
                case 'input-output-table':
                case 'two-step-function':
                case 'age-problem':
                case 'money-problem':
                case 'distribution-problem':
                case 'perimeter-algebra':
                case 'number-puzzle':
                case 'sequence-sum':
                case 'mixed-operations':
                case 'pattern-multiplication':
                case 'word-equation':
                case 'comparison-algebra':
                case 'time-algebra':
                case 'pattern-skip-counting':
                case 'algebraic-thinking':
                case 'pattern-decreasing':
                case 'function-composition':
                case 'pattern-challenge':
                case 'algebra-word-problem':
                case 'time-word-problem':
                case 'length-conversion':
                case 'length-word-problem':
                case 'perimeter-measurement':
                case 'volume-word-problem':
                case 'mass-conversion':
                case 'mass-word-problem':
                case 'mixed-units':
                case 'speed-concept':
                case 'measurement-challenge':
                    html += renderSimpleOperation(exercise);
                    break;
                case 'bar-graph':
                    html += renderBarGraph(exercise);
                    break;
                case 'symmetry':
                case 'angles':
                case '3d-shapes':
                case '3d-to-2d':
                case 'volume-concept':
                case 'surface-area':
                    html += renderInteractiveGeometry(exercise);
                    break;
                case 'shape-properties':
                case 'area-concept':
                case 'perimeter-vs-area':
                case 'composite-shapes':
                case 'shape-decomposition':
                case 'geometry-word-problem':
                case 'spatial-reasoning':
                case 'tessellation':
                case 'measurement-estimation':
                case 'line-types':
                    html += renderSimpleOperation(exercise);
                    break;
                case 'shape-comparison':
                case 'transformation':
                case 'pattern-geometric':
                case 'coordinates':
                case 'pattern-rule':
                case 'pattern-table':
                case 'inequality':
                case 'coordinate-pattern':
                case 'pattern-geometric-shapes':
                case 'pattern-colors':
                case 'letter-pattern':
                    html += renderComparisonExercise(exercise);
                    break;
                // Nuevos tipos de datos y estadÃ­stica
                case 'range':
                case 'prediction':
                case 'data-word-problem':
                case 'schedule-analysis':
                case 'voting':
                case 'conclusion':
                    html += renderSimpleOperation(exercise);
                    break;
                case 'spinner':
                case 'survey-design':
                case 'data-collection':
                case 'graph-interpretation':
                case 'data-comparison':
                case 'trend-analysis':
                    html += renderComparisonExercise(exercise);
                    break;
                default:
                    html += renderGenericExercise(exercise);
            }

            container.innerHTML = html;
        }

        function renderSimpleOperation(exercise) {
            return `
                <div class="question-card">
                    <h3 style="font-size: 2.5em; text-align: center;">${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div style="text-align: center;">
                        <input type="number" class="math-input" id="simpleAnswer" 
                               style="width: 200px; font-size: 2em; text-align: center;"
                               onkeypress="if(event.key === 'Enter') checkSimpleOperation(${exercise.answer})">
                        <br><br>
                        <button class="btn" onclick="checkSimpleOperation(${exercise.answer})" 
                                style="font-size: 1.5em; padding: 15px 40px;">
                            Verificar âœ“
                        </button>
                    </div>
                </div>
            `;
        }

        function renderComparisonExercise(exercise) {
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                        ${exercise.options.map((option, index) => `
                            <button class="btn" onclick="checkAnswer(${index}, ${exercise.correct})" style="font-size: 2em; padding: 20px 40px;">
                                ${option}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderDecompositionExercise(exercise) {
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div class="math-input-container" style="flex-direction: column;">
                        <div>
                            <label>Miles:</label>
                            <input type="number" class="math-input" id="miles" style="width: 100px;">
                        </div>
                        <div>
                            <label>Centenas:</label>
                            <input type="number" class="math-input" id="centenas" style="width: 100px;">
                        </div>
                        <div>
                            <label>Decenas:</label>
                            <input type="number" class="math-input" id="decenas" style="width: 100px;">
                        </div>
                        <div>
                            <label>Unidades:</label>
                            <input type="number" class="math-input" id="unidades" style="width: 100px;">
                        </div>
                    </div>
                    <button class="btn" onclick="checkDecomposition()">Verificar âœ“</button>
                </div>
            `;
        }

        function renderMultiplicationExercise(exercise) {
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <h4>MÃ©todo Singapur - Resolvamos paso a paso:</h4>
                    <div class="step-checker">
                        ${exercise.steps.map((step, index) => `
                            <div class="step-checker" id="step${index}">
                                <p>Paso ${index + 1}: ${step.split('=')[0]} = </p>
                                <input type="number" class="math-input" id="stepInput${index}" onkeyup="checkStep(${index}, ${step.split('=')[1].trim()})">
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: 20px;">
                        <h4>Respuesta final:</h4>
                        <input type="number" class="math-input" id="finalAnswer" style="width: 150px; font-size: 1.5em;">
                        <button class="btn" onclick="checkMultiplication(${exercise.answer})">Verificar âœ“</button>
                    </div>
                </div>
            `;
        }

        function renderWordProblem(exercise) {
            console.log('Renderizando problema:', exercise.question);
            
            // Determinar si es suma o resta
            const isAddition = exercise.question.includes('llegan') || exercise.question.includes('agrega') || exercise.question.includes('mÃ¡s') || exercise.question.includes('total');
            const isSubtraction = exercise.question.includes('regala') || exercise.question.includes('quita') || exercise.question.includes('menos') || exercise.question.includes('quedan');
            
            console.log('Es suma?', isAddition, 'Es resta?', isSubtraction);
            
            // Extraer nÃºmeros y contexto
            const nums = exercise.question.match(/\d+/g);
            const num1 = parseInt(nums[0]);
            const num2 = parseInt(nums[1]);
            
            // Determinar el tipo de objeto (stickers, estudiantes, etc.)
            let objectType = 'elementos';
            if (exercise.question.includes('sticker')) objectType = 'stickers';
            if (exercise.question.includes('estudiante')) objectType = 'estudiantes';
            if (exercise.question.includes('cancion') || exercise.question.includes('canciones')) objectType = 'canciones';
            
            let barModel = '';
            if (exercise.method === 'bar-model') {
                if (isSubtraction) {
                    // Modelo para resta
                    barModel = `
                        <div style="margin-bottom: 20px;">
                            <p style="margin-bottom: 5px;">Total inicial:</p>
                            <div style="background: linear-gradient(45deg, #667eea, #764ba2); height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                ${num1} ${objectType}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <p style="margin-bottom: 5px;">Â¿CÃ³mo se divide?</p>
                            <div style="display: flex; gap: 5px;">
                                <div style="background: linear-gradient(45deg, #ff6b6b, #ee5a50); height: 50px; border-radius: 10px; flex: ${num2}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                    Se van: ${num2}
                                </div>
                                <div style="background: linear-gradient(45deg, #4ecdc4, #44a08d); height: 50px; border-radius: 10px; flex: ${num1 - num2}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                    Quedan: ?
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: #f0f0f0; padding: 15px; border-radius: 10px; margin-top: 15px;">
                            <p style="font-weight: bold;">OperaciÃ³n: ${num1} - ${num2} = ?</p>
                        </div>
                    `;
                } else if (isAddition) {
                    // Modelo para suma
                    barModel = `
                        <div style="margin-bottom: 20px;">
                            <p style="margin-bottom: 5px;">Â¿CÃ³mo se forma el total?</p>
                            <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                                <div style="background: linear-gradient(45deg, #667eea, #764ba2); height: 50px; border-radius: 10px; flex: ${num1}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                    Hay: ${num1}
                                </div>
                                <div style="background: linear-gradient(45deg, #4ecdc4, #44a08d); height: 50px; border-radius: 10px; flex: ${num2}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                    Llegan: ${num2}
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <p style="margin-bottom: 5px;">Total:</p>
                            <div style="background: linear-gradient(45deg, #ff6b6b, #ffd93d); height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                ? ${objectType} en total
                            </div>
                        </div>
                        
                        <div style="background: #f0f0f0; padding: 15px; border-radius: 10px; margin-top: 15px;">
                            <p style="font-weight: bold;">OperaciÃ³n: ${num1} + ${num2} = ?</p>
                        </div>
                    `;
                }
            }
            
            return `
                <div class="question-card">
                    <h3>Problema:</h3>
                    <p style="font-size: 1.1em;">${exercise.question}</p>
                </div>
                <div class="interactive-question">
                    ${exercise.method === 'bar-model' ? `
                        <div class="bar-canvas-container">
                            <h4>Modelo de barras - MÃ©todo Singapur:</h4>
                            <p style="margin: 10px 0;">Representemos el problema visualmente:</p>
                            <div style="background: white; padding: 20px; border-radius: 10px;">
                                ${barModel}
                            </div>
                        </div>
                    ` : ''}
                    <div style="margin-top: 20px;">
                        <h4>Tu respuesta:</h4>
                        <input type="number" class="math-input" id="problemAnswer" style="width: 150px; font-size: 1.5em;">
                        <span style="font-size: 1.2em;"> ${objectType}</span>
                        <button class="btn" onclick="checkWordProblem(${exercise.answer})">Verificar âœ“</button>
                    </div>
                </div>
            `;
        }

        function renderFractionVisual(exercise) {
            const svgId = 'fractionVisual' + Date.now();
            setTimeout(() => drawFractionVisual(svgId, exercise), 100);
            
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div id="${svgId}" style="display: flex; justify-content: center; margin: 20px 0;"></div>
                    <div>
                        <input type="text" class="math-input" id="fractionAnswer" placeholder="ej: 3/8" style="width: 100px;">
                        <button class="btn" onclick="checkFraction('${exercise.answer}')">Verificar âœ“</button>
                    </div>
                </div>
            `;
        }

        function drawFractionVisual(containerId, exercise) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (exercise.visual === 'pizza') {
                const svg = `
                    <svg width="200" height="200" viewBox="0 0 200 200">
                        ${Array.from({length: exercise.parts}).map((_, i) => {
                            const angle = (360 / exercise.parts) * i;
                            const isColored = i < exercise.colored;
                            return `
                                <path d="M 100 100 L ${100 + 80 * Math.cos((angle - 90) * Math.PI / 180)} ${100 + 80 * Math.sin((angle - 90) * Math.PI / 180)} A 80 80 0 0 1 ${100 + 80 * Math.cos((angle + 360/exercise.parts - 90) * Math.PI / 180)} ${100 + 80 * Math.sin((angle + 360/exercise.parts - 90) * Math.PI / 180)} Z"
                                      fill="${isColored ? '#ff6b6b' : '#f0f0f0'}"
                                      stroke="#333"
                                      stroke-width="2"/>
                            `;
                        }).join('')}
                    </svg>
                `;
                container.innerHTML = svg;
            }
        }

        function checkAnswer(selected, correct) {
            if (selected === correct) {
                showFeedback(true, 'correct');
                appState.correctAnswers++;
                appState.points += 10;
            } else {
                showFeedback(false, 'tryAgain');
            }
            updateUI();
            setTimeout(nextExercise, 2000);
        }

        function checkSimpleOperation(correctAnswer) {
            // Buscar el input correcto segÃºn el tipo de ejercicio
            let answer = 0;
            if (document.getElementById('simpleAnswer')) {
                answer = parseInt(document.getElementById('simpleAnswer').value);
            } else if (document.getElementById('graphAnswer')) {
                answer = parseInt(document.getElementById('graphAnswer').value);
            } else if (document.getElementById('shapesAnswer')) {
                answer = parseInt(document.getElementById('shapesAnswer').value);
            }
            
            if (answer === correctAnswer) {
                showFeedback(true, 'excellent');
                appState.correctAnswers++;
                appState.points += 10;
                setTimeout(nextExercise, 2000);
            } else if (isNaN(answer) || answer === '') {
                showFeedback(false, 'hint', 'Por favor, escribe tu respuesta');
            } else {
                showFeedback(false, 'tryAgain');
            }
            updateUI();
        }

        function checkDecomposition() {
            const exercise = appState.exercises[appState.currentExercise];
            const miles = parseInt(document.getElementById('miles').value) || 0;
            const centenas = parseInt(document.getElementById('centenas').value) || 0;
            const decenas = parseInt(document.getElementById('decenas').value) || 0;
            const unidades = parseInt(document.getElementById('unidades').value) || 0;
            
            if (miles === exercise.answer.miles && 
                centenas === exercise.answer.centenas && 
                decenas === exercise.answer.decenas && 
                unidades === exercise.answer.unidades) {
                showFeedback(true, 'excellent');
                appState.correctAnswers++;
                appState.points += 15;
                setTimeout(nextExercise, 2000);
            } else {
                showFeedback(false, 'hint', exercise.explanation);
            }
            updateUI();
        }

        function checkStep(stepIndex, correctValue) {
            const input = document.getElementById(`stepInput${stepIndex}`);
            const stepDiv = document.getElementById(`step${stepIndex}`);
            
            if (parseInt(input.value) === correctValue) {
                stepDiv.classList.add('correct');
                stepDiv.classList.remove('incorrect');
            } else if (input.value !== '') {
                stepDiv.classList.add('incorrect');
                stepDiv.classList.remove('correct');
            }
        }

        function checkMultiplication(correctAnswer) {
            const answer = parseInt(document.getElementById('finalAnswer').value);
            
            if (answer === correctAnswer) {
                showFeedback(true, 'amazing');
                appState.correctAnswers++;
                appState.points += 20;
                setTimeout(nextExercise, 2000);
            } else {
                showFeedback(false, 'tryAgain');
            }
            updateUI();
        }

        function checkWordProblem(correctAnswer) {
            const answer = parseInt(document.getElementById('problemAnswer').value);
            
            if (answer === correctAnswer) {
                showFeedback(true, 'fantastic');
                appState.correctAnswers++;
                appState.points += 25;
                setTimeout(nextExercise, 2000);
            } else {
                showFeedback(false, 'hint', 'Recuerda: Â¿QuÃ© operaciÃ³n necesitas hacer?');
            }
            updateUI();
        }

        function checkFraction(correctAnswer) {
            // Buscar el input correcto segÃºn el tipo de ejercicio
            let answer = '';
            if (document.getElementById('fractionAddAnswer')) {
                answer = document.getElementById('fractionAddAnswer').value.trim();
            } else if (document.getElementById('fractionAnswer')) {
                answer = document.getElementById('fractionAnswer').value.trim();
            } else if (document.getElementById('decimalAnswer')) {
                answer = document.getElementById('decimalAnswer').value.trim();
            }
            
            if (answer === correctAnswer) {
                showFeedback(true, 'perfect');
                appState.correctAnswers++;
                appState.points += 15;
                setTimeout(nextExercise, 2000);
            } else {
                showFeedback(false, 'hint', 'Cuenta las partes coloreadas y el total de partes');
            }
            updateUI();
        }
        
        function checkFractionProblem(stringAnswer, numAnswer) {
            const inputValue = document.getElementById('problemAnswer').value.trim();
            let isCorrect = false;
            
            if (typeof numAnswer === 'number') {
                isCorrect = parseFloat(inputValue) === numAnswer;
            } else {
                isCorrect = inputValue === stringAnswer;
            }
            
            if (isCorrect) {
                showFeedback(true, 'excellent');
                appState.correctAnswers++;
                appState.points += 15;
                setTimeout(nextExercise, 2000);
            } else {
                showFeedback(false, 'tryAgain');
            }
            updateUI();
        }

        function showFeedback(isCorrect, type, message = '') {
            const feedbackMessages = {
                correct: ['Â¡Correcto! ğŸ‘', 'Â¡Bien hecho! â­', 'Â¡Exacto! âœ¨'],
                excellent: ['Â¡Excelente! ğŸŒŸ', 'Â¡Brillante! ğŸ’«', 'Â¡FantÃ¡stico! ğŸ¯'],
                amazing: ['Â¡IncreÃ­ble! ğŸš€', 'Â¡Eres genial! ğŸŒˆ', 'Â¡Asombroso! ğŸ‰'],
                fantastic: ['Â¡Espectacular! ğŸ†', 'Â¡Maravilloso! ğŸŠ', 'Â¡Sobresaliente! ğŸ’'],
                perfect: ['Â¡Perfecto! ğŸ’¯', 'Â¡Impecable! ğŸŒŸ', 'Â¡Sin errores! ğŸ¯'],
                tryAgain: ['Intenta de nuevo ğŸ’ª', 'Casi lo tienes ğŸ¤”', 'Sigue intentando ğŸ“š'],
                hint: [message || 'Piensa un poco mÃ¡s ğŸ¤“', message || 'Revisa con cuidado ğŸ”']
            };
            
            const messages = feedbackMessages[type] || feedbackMessages.correct;
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            
            // Crear elemento de feedback
            const feedback = document.createElement('div');
            feedback.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: ${isCorrect ? 'linear-gradient(45deg, #4CAF50, #45a049)' : 'linear-gradient(45deg, #ff9800, #f57c00)'};
                color: white;
                padding: 20px 40px;
                border-radius: 20px;
                font-size: 1.5em;
                font-weight: bold;
                z-index: 1000;
                animation: ${isCorrect ? 'bounce' : 'shake'} 0.5s;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            `;
            feedback.textContent = randomMessage;
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                feedback.remove();
            }, 2000);
            
            // Agregar animaciÃ³n shake si es incorrecto
            if (!isCorrect) {
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes shake {
                        0%, 100% { transform: translate(-50%, -50%) translateX(0); }
                        25% { transform: translate(-50%, -50%) translateX(-10px); }
                        75% { transform: translate(-50%, -50%) translateX(10px); }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function nextExercise() {
            appState.currentExercise++;
            
            // Verificar si completamos una sub-etapa (cada 15 preguntas)
            const subStage = appState.subStageProgress[appState.currentUnit];
            
            // Verificar si hemos completado 15 preguntas (una sub-etapa)
            if (appState.currentExercise > 0 && appState.currentExercise % 15 === 0) {
                // Completamos una sub-etapa
                subStage.completed++;
                
                // Mostrar celebraciÃ³n de sub-etapa
                showSubStageCelebration(() => {
                    if (appState.currentExercise < appState.exercises.length) {
                        // Avanzar a la siguiente sub-etapa
                        subStage.current++;
                        subStage.questionsInStage = 0;
                        showExercise();
                    } else {
                        showResults();
                    }
                });
            } else {
                // Continuar con el siguiente ejercicio
                subStage.questionsInStage = (appState.currentExercise % 15);
                if (appState.currentExercise < appState.exercises.length) {
                    showExercise();
                } else {
                    showResults();
                }
            }
            
            saveProgress();
        }
        
        function showSubStageCelebration(callback) {
            const celebration = document.createElement('div');
            celebration.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 20px;
                padding: 40px;
                text-align: center;
                transform: scale(0);
                transition: transform 0.5s ease;
            `;
            
            const subStage = appState.subStageProgress[appState.currentUnit];
            const totalStages = Math.ceil(appState.exercises.length / 15);
            
            content.innerHTML = `
                <div style="font-size: 5em; margin-bottom: 20px;">ğŸ‰</div>
                <h2 style="color: #667eea; margin-bottom: 20px;">Â¡Sub-etapa ${subStage.completed} Completada!</h2>
                <p style="font-size: 1.2em; margin-bottom: 10px;">Â¡Excelente trabajo, Amaia!</p>
                <p style="margin-bottom: 20px;">Has completado ${subStage.completed} de ${totalStages} sub-etapas</p>
                <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 30px;">
                    ${Array.from({length: totalStages}, (_, i) => `
                        <div style="
                            width: 40px;
                            height: 40px;
                            border-radius: 50%;
                            background: ${i < subStage.completed ? 'linear-gradient(45deg, #2ecc71, #27ae60)' : '#e0e0e0'};
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: ${i < subStage.completed ? 'white' : '#999'};
                            font-weight: bold;
                        ">
                            ${i < subStage.completed ? 'âœ“' : i + 1}
                        </div>
                    `).join('')}
                </div>
                <button class="btn glow" onclick="this.parentElement.parentElement.remove(); (${callback.toString()})()">
                    Â¡Continuar! ğŸš€
                </button>
            `;
            
            celebration.appendChild(content);
            document.body.appendChild(celebration);
            
            // Animar entrada
            setTimeout(() => {
                content.style.transform = 'scale(1)';
            }, 100);
            
            // Agregar puntos bonus por completar sub-etapa
            appState.points += 50;
            updateUI();
        }

        function showResults() {
            showScreen('results');
            
            const percentage = Math.round((appState.correctAnswers / appState.totalQuestions) * 100);
            const resultTitle = document.getElementById('resultTitle');
            const resultMessage = document.getElementById('resultMessage');
            const progressBar = document.getElementById('progressBar');
            
            if (percentage >= 80) {
                resultTitle.textContent = 'Â¡Excelente trabajo, Amaia! ğŸ†';
                resultMessage.textContent = `Respondiste correctamente ${appState.correctAnswers} de ${appState.totalQuestions} preguntas. Â¡Eres una campeona!`;
                addAchievement('ğŸ† Experta');
            } else if (percentage >= 60) {
                resultTitle.textContent = 'Â¡Muy bien, Amaia! â­';
                resultMessage.textContent = `Respondiste correctamente ${appState.correctAnswers} de ${appState.totalQuestions} preguntas. Â¡Sigue asÃ­!`;
                addAchievement('â­ Aprendiz');
            } else {
                resultTitle.textContent = 'Â¡Buen intento, Amaia! ğŸ’ª';
                resultMessage.textContent = `Respondiste correctamente ${appState.correctAnswers} de ${appState.totalQuestions} preguntas. Â¡La prÃ¡ctica hace al maestro!`;
            }
            
            progressBar.style.width = percentage + '%';
            
            // Actualizar progreso de la unidad
            if (appState.currentUnit) {
                appState.progress[appState.currentUnit] = Math.min(100, appState.progress[appState.currentUnit] + 10);
                saveProgress();
            }
        }

        function addAchievement(achievement) {
            if (!appState.achievements.includes(achievement)) {
                appState.achievements.push(achievement);
                updateAchievements();
                
                // Mostrar notificaciÃ³n
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(45deg, #ffd700, #ffed4a);
                    color: #333;
                    padding: 15px 25px;
                    border-radius: 20px;
                    font-weight: bold;
                    animation: slideIn 0.5s;
                    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
                `;
                notification.textContent = 'Â¡Nuevo logro: ' + achievement + '!';
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        }

        function updateAchievements() {
            const container = document.getElementById('achievements');
            container.innerHTML = appState.achievements.map(achievement => 
                `<div class="achievement">${achievement}</div>`
            ).join('');
        }

        function updateUI() {
            document.getElementById('pointsDisplay').textContent = appState.points + ' puntos';
            updateAchievements();
        }

        function saveProgress() {
            localStorage.setItem('mathAmaiaProgress', JSON.stringify(appState));
        }

        function loadProgress() {
            const saved = localStorage.getItem('mathAmaiaProgress');
            if (saved) {
                try {
                    const savedState = JSON.parse(saved);
                    // Solo cargar ciertos campos, no todo el estado
                    appState.points = savedState.points || 0;
                    appState.achievements = savedState.achievements || [];
                    appState.progress = savedState.progress || {
                        numeros: 20,
                        fracciones: 0,
                        geometria: 0,
                        medicion: 0,
                        algebra: 0,
                        datos: 0
                    };
                    appState.hasPersonalized = savedState.hasPersonalized || false;
                    appState.interests = savedState.interests || {};
                    appState.subStageProgress = savedState.subStageProgress || {
                        numeros: { current: 1, completed: 0, questionsInStage: 0 },
                        fracciones: { current: 1, completed: 0, questionsInStage: 0 },
                        geometria: { current: 1, completed: 0, questionsInStage: 0 },
                        medicion: { current: 1, completed: 0, questionsInStage: 0 },
                        algebra: { current: 1, completed: 0, questionsInStage: 0 },
                        datos: { current: 1, completed: 0, questionsInStage: 0 }
                    };
                    updateUI();
                } catch (e) {
                    console.error('Error al cargar progreso:', e);
                }
            }
        }

        function resetProgress() {
            if (confirm('Â¿EstÃ¡s segura de que quieres reiniciar todo tu progreso? Esto borrarÃ¡ tus puntos, logros y preferencias.')) {
                localStorage.removeItem('mathAmaiaProgress');
                // Reiniciar el estado
                appState = {
                    currentScreen: 'welcome',
                    currentUnit: null,
                    currentExercise: 0,
                    points: 0,
                    achievements: [],
                    progress: {
                        numeros: 20,
                        fracciones: 0,
                        geometria: 0,
                        medicion: 0,
                        algebra: 0,
                        datos: 0
                    },
                    exercises: [],
                    correctAnswers: 0,
                    totalQuestions: 0,
                    interests: {},
                    personalizationStep: 1,
                    hasPersonalized: false,
                    feedback: {}
                };
                updateUI();
                showWelcome();
                alert('Â¡Tu progreso ha sido reiniciado! Ahora puedes empezar de nuevo.');
            }
        }

        // Funciones auxiliares para ejercicios especÃ­ficos
        function renderDivisionExercise(exercise) {
            // Extraer los nÃºmeros de la pregunta
            const nums = exercise.question.match(/\d+/g);
            const dividend = parseInt(nums[0]);
            const divisor = parseInt(nums[1]);
            
            // Calcular los pasos segÃºn el ejercicio especÃ­fico
            let steps = '';
            
            if (dividend === 156 && divisor === 12) {
                steps = `
                    <p>${dividend} Ã· ${divisor} = ?</p>
                    <p style="margin-top: 10px;">Pensemos: Â¿CuÃ¡ntas veces cabe ${divisor} en ${dividend}?</p>
                    <div style="margin: 15px 0;">
                        <p>${divisor} Ã— 10 = 120</p>
                        <p>${dividend} - 120 = 36</p>
                        <p>${divisor} Ã— 3 = 36</p>
                        <p>Entonces: 10 + 3 = 13</p>
                    </div>
                `;
            } else if (dividend === 144 && divisor === 16) {
                steps = `
                    <p>${dividend} Ã· ${divisor} = ?</p>
                    <p style="margin-top: 10px;">Pensemos: Â¿CuÃ¡ntas veces cabe ${divisor} en ${dividend}?</p>
                    <div style="margin: 15px 0;">
                        <p>${divisor} Ã— 9 = 144</p>
                        <p>${dividend} - 144 = 0</p>
                        <p>Entonces: ${divisor} cabe exactamente 9 veces en ${dividend}</p>
                    </div>
                `;
            }
            
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <h4>MÃ©todo Singapur - DivisiÃ³n por descomposiciÃ³n:</h4>
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin: 15px 0;">
                        ${steps}
                    </div>
                    <div style="margin-top: 20px;">
                        <h4>Tu respuesta:</h4>
                        <input type="number" class="math-input" id="divisionAnswer" style="width: 100px;">
                        <button class="btn" onclick="checkDivision(${exercise.answer})">Verificar âœ“</button>
                    </div>
                </div>
            `;
        }

        function renderGenericExercise(exercise) {
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <p>Este ejercicio estÃ¡ en desarrollo...</p>
                    <button class="btn" onclick="nextExercise()">Continuar</button>
                </div>
            `;
        }

        function renderBarGraph(exercise) {
            const maxValue = Math.max(...Object.values(exercise.data));
            const scale = 200 / maxValue;
            
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 10px;">
                        <h4>GrÃ¡fico de Barras:</h4>
                        <div style="display: flex; align-items: flex-end; gap: 20px; height: 250px; margin: 20px 0;">
                            ${Object.entries(exercise.data).map(([label, value]) => `
                                <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                                    <div style="background: linear-gradient(45deg, #667eea, #764ba2); width: 100%; height: ${value * scale}px; border-radius: 5px 5px 0 0; position: relative;">
                                        <span style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-weight: bold;">${value}</span>
                                    </div>
                                    <div style="padding: 10px 5px; text-align: center; font-size: 0.9em;">${label}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ${exercise.options ? `
                        <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-top: 20px;">
                            ${exercise.options.map((option, index) => `
                                <button class="btn" onclick="checkAnswer(${index}, ${exercise.correct})" style="padding: 10px 20px;">
                                    ${option}
                                </button>
                            `).join('')}
                        </div>
                    ` : `
                        <div style="text-align: center; margin-top: 20px;">
                            <input type="number" class="math-input" id="graphAnswer" style="width: 100px;">
                            <button class="btn" onclick="checkSimpleOperation(${exercise.answer})">Verificar âœ“</button>
                        </div>
                    `}
                </div>
            `;
        }

        function renderInteractiveGeometry(exercise) {
            let content = '';
            
            if (exercise.type === 'symmetry') {
                content = `
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; text-align: center;">
                        <p>ğŸ¦‹ Dibuja la lÃ­nea de simetrÃ­a en la pizarra de arriba</p>
                        <p style="margin-top: 10px;">Una mariposa tiene simetrÃ­a vertical por el centro</p>
                    </div>
                    <button class="btn" onclick="nextExercise()" style="margin-top: 20px;">Continuar</button>
                `;
            } else if (exercise.type === 'angles') {
                content = `
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 10px;">
                        <div style="text-align: center; margin: 20px 0;">
                            <svg width="200" height="200" viewBox="0 0 200 200">
                                <line x1="100" y1="100" x2="180" y2="100" stroke="#667eea" stroke-width="3"/>
                                <line x1="100" y1="100" x2="100" y2="20" stroke="#667eea" stroke-width="3"/>
                                <path d="M 130 100 A 30 30 0 0 0 100 70" stroke="#ff6b6b" stroke-width="2" fill="none"/>
                                <circle cx="100" cy="100" r="4" fill="#667eea"/>
                            </svg>
                            <p style="margin-top: 10px;">Este es un Ã¡ngulo de ${exercise.angle}Â°</p>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
                        ${exercise.options.map((option, index) => `
                            <button class="btn" onclick="checkAnswer(${index}, ${exercise.correct})">
                                ${option}
                            </button>
                        `).join('')}
                    </div>
                `;
            } else if (exercise.type === '3d-shapes') {
                content = `
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 5em; margin: 20px 0;">ğŸ²</div>
                        <p>Un cubo es una figura 3D</p>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <input type="number" class="math-input" id="shapesAnswer" style="width: 100px;">
                        <button class="btn" onclick="checkSimpleOperation(${exercise.answer})">Verificar âœ“</button>
                    </div>
                `;
            }
            
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    ${content}
                </div>
            `;
        }

        function renderFractionComparison(exercise) {
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div style="display: flex; justify-content: center; gap: 40px; margin: 20px 0;">
                        ${exercise.options.map((option, index) => `
                            <div style="text-align: center;">
                                <div id="fractionVisual${index}" style="margin-bottom: 10px;"></div>
                                <button class="btn" onclick="checkAnswer(${index}, ${exercise.correct})" style="font-size: 1.5em;">
                                    ${option}
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderFractionMultiplication(exercise) {
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div style="text-align: center;">
                        <p style="margin: 20px 0;">${exercise.explanation || ''}</p>
                        <input type="text" class="math-input" id="fractionAnswer" placeholder="respuesta" style="width: 100px;">
                        <button class="btn" onclick="checkFraction('${exercise.answer}')">Verificar âœ“</button>
                    </div>
                </div>
            `;
        }

        function renderFractionWordProblem(exercise) {
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    ${exercise.visual ? `
                        <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin: 15px 0; text-align: center;">
                            <div style="font-size: 3em;">ğŸ•</div>
                        </div>
                    ` : ''}
                    <div style="text-align: center;">
                        <input type="${exercise.answer.includes('/') ? 'text' : 'number'}" 
                               class="math-input" id="problemAnswer" style="width: 150px;">
                        <button class="btn" onclick="checkFractionProblem('${exercise.answer}', ${typeof exercise.answer === 'number' ? exercise.answer : `'${exercise.answer}'`})">
                            Verificar âœ“
                        </button>
                    </div>
                </div>
            `;
        }

        function renderFractionAddition(exercise) {
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin: 15px 0;">
                        <h4>MÃ©todo visual con barras:</h4>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin: 20px 0;">
                            <div>
                                <div style="border: 2px solid #667eea; width: 100px; height: 40px; display: flex;">
                                    ${Array.from({length: parseInt(exercise.question.split('/')[1])}).map((_, i) => 
                                        `<div style="flex: 1; background: ${i < parseInt(exercise.question.split('/')[0]) ? '#ff6b6b' : 'white'}; border-right: 1px solid #667eea;"></div>`
                                    ).join('')}
                                </div>
                                <p style="text-align: center; margin-top: 5px;">${exercise.question.split('+')[0].trim()}</p>
                            </div>
                            <span style="font-size: 2em;">+</span>
                            <div>
                                <div style="border: 2px solid #667eea; width: 100px; height: 40px; display: flex;">
                                    ${Array.from({length: parseInt(exercise.question.split('/')[1])}).map((_, i) => 
                                        `<div style="flex: 1; background: ${i < parseInt(exercise.question.split('+')[1].split('/')[0].trim()) ? '#4ecdc4' : 'white'}; border-right: 1px solid #667eea;"></div>`
                                    ).join('')}
                                </div>
                                <p style="text-align: center; margin-top: 5px;">${exercise.question.split('+')[1].split('=')[0].trim()}</p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <input type="text" class="math-input" id="fractionAddAnswer" placeholder="respuesta" style="width: 100px;">
                        <button class="btn" onclick="checkFraction('${exercise.answer}')">Verificar âœ“</button>
                    </div>
                </div>
            `;
        }

        function renderMixedNumbers(exercise) {
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin: 15px 0;">
                        <h4>Visualicemos la fracciÃ³n:</h4>
                        <p>Cuando el numerador es mayor que el denominador, tenemos una fracciÃ³n impropia que podemos convertir en nÃºmero mixto.</p>
                        <div style="margin: 20px 0;">
                            <p>${exercise.question.match(/\d+\/\d+/)[0]} = ? enteros y ?/?</p>
                        </div>
                    </div>
                    <div>
                        <input type="text" class="math-input" id="mixedAnswer" placeholder="ej: 1 2/3" style="width: 100px;">
                        <button class="btn" onclick="checkMixedNumber('${exercise.answer}')">Verificar âœ“</button>
                    </div>
                </div>
            `;
        }

        function renderDecimalFraction(exercise) {
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin: 15px 0;">
                        <p>Pista: ${exercise.explanation}</p>
                    </div>
                    <div>
                        <input type="text" class="math-input" id="decimalAnswer" placeholder="respuesta" style="width: 100px;">
                        <button class="btn" onclick="checkFraction('${exercise.answer}')">Verificar âœ“</button>
                    </div>
                </div>
            `;
        }

        function renderShapeIdentification(exercise) {
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div id="shapeVisual" style="display: flex; justify-content: center; margin: 20px 0;">
                        <!-- AquÃ­ se dibujarÃ­a la figura compleja -->
                        <svg width="300" height="300" viewBox="0 0 300 300">
                            <!-- Figura con mÃºltiples triÃ¡ngulos -->
                            <path d="M 150 50 L 100 150 L 200 150 Z" fill="#ff6b6b" stroke="#333" stroke-width="2" opacity="0.7"/>
                            <path d="M 100 150 L 50 250 L 150 250 Z" fill="#4ecdc4" stroke="#333" stroke-width="2" opacity="0.7"/>
                            <path d="M 200 150 L 150 250 L 250 250 Z" fill="#ffd93d" stroke="#333" stroke-width="2" opacity="0.7"/>
                            <path d="M 150 50 L 100 150 L 200 150 L 150 250 Z" fill="none" stroke="#333" stroke-width="3"/>
                        </svg>
                    </div>
                    <div>
                        <input type="number" class="math-input" id="shapeCount" placeholder="?" style="width: 80px;">
                        <button class="btn" onclick="checkShapeCount(${exercise.answer})">Verificar âœ“</button>
                    </div>
                </div>
            `;
        }

        function renderPerimeterExercise(exercise) {
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div style="display: flex; justify-content: center; margin: 20px 0;">
                        <svg width="200" height="150" viewBox="0 0 200 150">
                            <rect x="50" y="40" width="${exercise.width * 20}" height="${exercise.height * 20}" 
                                  fill="#e3f2fd" stroke="#2196f3" stroke-width="3"/>
                            <text x="100" y="30" text-anchor="middle" font-size="16" fill="#333">${exercise.width} cm</text>
                            <text x="100" y="130" text-anchor="middle" font-size="16" fill="#333">${exercise.width} cm</text>
                            <text x="30" y="80" text-anchor="middle" font-size="16" fill="#333">${exercise.height} cm</text>
                            <text x="170" y="80" text-anchor="middle" font-size="16" fill="#333">${exercise.height} cm</text>
                        </svg>
                    </div>
                    <div>
                        <p>PerÃ­metro = </p>
                        <input type="number" class="math-input" id="perimeterAnswer" style="width: 100px;">
                        <span> cm</span>
                        <button class="btn" onclick="checkPerimeter(${exercise.answer})">Verificar âœ“</button>
                    </div>
                </div>
            `;
        }

        function checkShapeCount(correctAnswer) {
            const answer = parseInt(document.getElementById('shapeCount').value);
            
            if (answer === correctAnswer) {
                showFeedback(true, 'excellent');
                appState.correctAnswers++;
                appState.points += 15;
                setTimeout(nextExercise, 2000);
            } else {
                showFeedback(false, 'hint', 'Observa con cuidado, algunos triÃ¡ngulos se superponen');
            }
            updateUI();
        }

        function checkPerimeter(correctAnswer) {
            const answer = parseInt(document.getElementById('perimeterAnswer').value);
            
            if (answer === correctAnswer) {
                showFeedback(true, 'perfect');
                appState.correctAnswers++;
                appState.points += 10;
                setTimeout(nextExercise, 2000);
            } else {
                showFeedback(false, 'hint', 'Recuerda: PerÃ­metro = suma de todos los lados');
            }
            updateUI();
        }

        function checkDivision(correctAnswer) {
            const answer = parseInt(document.getElementById('divisionAnswer').value);
            
            if (answer === correctAnswer) {
                showFeedback(true, 'excellent');
                appState.correctAnswers++;
                appState.points += 15;
                setTimeout(nextExercise, 2000);
            } else {
                showFeedback(false, 'hint', 'Revisa el proceso de descomposiciÃ³n paso a paso');
            }
            updateUI();
        }

        // FunciÃ³n para el modelo de barras
        function selectBarTool(tool) {
            document.querySelectorAll('.bar-tool').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function checkMixedNumber(correctAnswer) {
            const answer = document.getElementById('mixedAnswer').value.trim();
            
            if (answer === correctAnswer) {
                showFeedback(true, 'perfect');
                appState.correctAnswers++;
                appState.points += 15;
                setTimeout(nextExercise, 2000);
            } else {
                showFeedback(false, 'hint', 'Divide el numerador entre el denominador para encontrar los enteros');
            }
            updateUI();
        }

        // Funciones de personalizaciÃ³n
        function startPersonalization() {
            showScreen('personalization');
            appState.personalizationStep = 1;
            // No resetear intereses para mantener las selecciones previas
            
            // Asegurar que solo el primer paso estÃ© visible
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById(`personalizationStep${i}`);
                if (step) {
                    step.classList.toggle('hidden', i !== 1);
                }
            }
            document.getElementById('personalizationSummary').classList.add('hidden');
            
            // Restaurar las selecciones previas en los botones
            restorePreviousSelections();
        }

        function showPersonalization() {
            showScreen('personalization');
        }

        function restorePreviousSelections() {
            // Esperar un poco para que los elementos se rendericen
            setTimeout(() => {
                // Recorrer todos los intereses guardados y marcar los botones correspondientes
                Object.entries(appState.interests).forEach(([category, items]) => {
                    items.forEach(item => {
                        // Buscar el botÃ³n correspondiente y marcarlo como activo
                        const buttons = document.querySelectorAll(`button[onclick*="'${category}'"][onclick*="'${item.value}'"]`);
                        buttons.forEach(button => {
                            button.classList.add('active');
                        });
                    });
                });
            }, 100);
        }

        function toggleInterest(button, category, value, emoji) {
            // Inicializar la categorÃ­a si no existe
            if (!appState.interests[category]) {
                appState.interests[category] = [];
            }
            
            // Toggle el interÃ©s
            const index = appState.interests[category].findIndex(item => item.value === value);
            if (index > -1) {
                // Si ya existe, lo quitamos
                appState.interests[category].splice(index, 1);
                button.classList.remove('active');
            } else {
                // Si no existe, lo agregamos
                appState.interests[category].push({ value, emoji });
                button.classList.add('active');
            }
            
            console.log('Intereses actuales:', appState.interests);
        }

        function nextPersonalizationStep() {
            console.log('Avanzando del paso', appState.personalizationStep, 'al siguiente');
            
            // Ocultar paso actual
            document.getElementById(`personalizationStep${appState.personalizationStep}`).classList.add('hidden');
            
            // Incrementar paso
            appState.personalizationStep++;
            
            // Mostrar siguiente paso o resumen
            if (appState.personalizationStep <= 5) {
                document.getElementById(`personalizationStep${appState.personalizationStep}`).classList.remove('hidden');
            } else {
                showPersonalizationSummary();
            }
        }

        function showPersonalizationSummary() {
            document.getElementById('personalizationStep5').classList.add('hidden');
            document.getElementById('personalizationSummary').classList.remove('hidden');
            
            // Mostrar los intereses seleccionados
            const summaryContainer = document.getElementById('interestsSummary');
            let summaryHTML = '';
            
            Object.entries(appState.interests).forEach(([category, items]) => {
                if (items.length > 0) {
                    items.forEach(item => {
                        summaryHTML += `<div class="achievement">${item.emoji} ${item.value.charAt(0).toUpperCase() + item.value.slice(1)}</div>`;
                    });
                }
            });
            
            summaryContainer.innerHTML = summaryHTML;
        }

        function finishPersonalization() {
            appState.hasPersonalized = true;
            saveProgress();
            
            // Generar problemas personalizados
            generatePersonalizedProblems();
            
            showUnitSelector();
        }

        function generatePersonalizedProblems() {
            // Sistema avanzado de personalizaciÃ³n basado en mapeo de intereses
            const interests = appState.interests;
            console.log('Generando problemas personalizados para:', interests);
            
            // Mapeo de intereses a mÃ³dulos compatibles
            const interestMapping = {
                // DEPORTES - Compatible con tiempo, estadÃ­sticas, mediciÃ³n, operaciones bÃ¡sicas
                deportes: {
                    compatibleModules: ['numeros', 'medicion', 'datos', 'algebra'],
                    contexts: {
                        futbol: ['goles', 'partidos', 'equipos', 'entrenamientos'],
                        natacion: ['largos', 'tiempo', 'metros', 'competencias'],
                        volley: ['puntos', 'sets', 'jugadores', 'altura red'],
                        tenis: ['sets', 'juegos', 'puntos', 'torneos'],
                        basquet: ['puntos', 'canastas', 'jugadores', 'tiempo'],
                        atletismo: ['metros', 'segundos', 'saltos', 'carreras'],
                        flamenco: ['clases', 'horas', 'presentaciones', 'pasos']
                    }
                },
                
                // ANIMALES - Compatible con divisiÃ³n, multiplicaciÃ³n, fracciones, problemas verbales
                animales: {
                    compatibleModules: ['numeros', 'fracciones', 'geometria', 'datos'],
                    contexts: {
                        perros: ['comida', 'juguetes', 'paseos', 'aÃ±os perro'],
                        gatos: ['ratones', 'comida', 'siesta', 'vidas'],
                        caballos: ['heno', 'carreras', 'establos', 'herraduras'],
                        pajaros: ['huevos', 'nidos', 'vuelo', 'semillas'],
                        peces: ['peceras', 'alimento', 'agua', 'escamas'],
                        conejos: ['zanahorias', 'saltos', 'orejas', 'madrigueras']
                    }
                },
                
                // MÃšSICA - Compatible con fracciones (compases), patrones, tiempo
                hobbies: {
                    musica: {
                        compatibleModules: ['fracciones', 'algebra', 'datos', 'numeros'],
                        contexts: ['canciones', 'notas', 'compases', 'instrumentos', 'conciertos']
                    },
                    arte: {
                        compatibleModules: ['geometria', 'fracciones', 'medicion', 'numeros'],
                        contexts: ['colores', 'formas', 'pinceles', 'lienzos', 'exposiciones']
                    },
                    lectura: {
                        compatibleModules: ['numeros', 'datos', 'algebra', 'medicion'],
                        contexts: ['pÃ¡ginas', 'libros', 'capÃ­tulos', 'bibliotecas', 'autores']
                    },
                    videojuegos: {
                        compatibleModules: ['algebra', 'datos', 'numeros', 'geometria'],
                        contexts: ['niveles', 'puntos', 'vidas', 'power-ups', 'experiencia']
                    }
                },
                
                // COMIDA - Compatible con fracciones (porciones), divisiÃ³n, mediciÃ³n
                comidas: {
                    compatibleModules: ['fracciones', 'numeros', 'medicion', 'datos'],
                    contexts: {
                        pizza: ['rebanadas', 'ingredientes', 'tamaÃ±os', 'personas'],
                        helado: ['sabores', 'bolas', 'costo', 'ventas'],
                        torta: ['porciones', 'ingredientes', 'cumpleaÃ±os', 'velas'],
                        frutas: ['kilos', 'vitaminas', 'colores', 'estaciones'],
                        dulces: ['caramelos', 'paquetes', 'colores', 'repartir']
                    }
                }
            };
            
            // Generar ejercicios personalizados para cada mÃ³dulo
            Object.entries(interests).forEach(([category, items]) => {
                if (!items || items.length === 0) return;
                
                items.forEach(item => {
                    const interestValue = item.value;
                    
                    // DEPORTES
                    if (category === 'deportes' && interestMapping.deportes.contexts[interestValue]) {
                        addSportsProblems(interestValue, interestMapping.deportes.contexts[interestValue]);
                    }
                    
                    // ANIMALES
                    if (category === 'animales' && interestMapping.animales.contexts[interestValue]) {
                        addAnimalProblems(interestValue, interestMapping.animales.contexts[interestValue]);
                    }
                    
                    // HOBBIES
                    if (category === 'hobbies') {
                        const hobbyMapping = interestMapping.hobbies[interestValue];
                        if (hobbyMapping) {
                            addHobbyProblems(interestValue, hobbyMapping.contexts);
                        }
                    }
                    
                    // COMIDAS
                    if (category === 'comidas' && interestMapping.comidas.contexts[interestValue]) {
                        addFoodProblems(interestValue, interestMapping.comidas.contexts[interestValue]);
                    }
                });
            });
            
            console.log('Ejercicios personalizados generados exitosamente');
        }
        
        // Funciones auxiliares para generar problemas especÃ­ficos
        function addSportsProblems(sport, contexts) {
            switch(sport) {
                case 'futbol':
                    exerciseDatabase.numeros.push({
                        type: 'word-problem',
                        question: `En el torneo de fÃºtbol, el equipo de Amaia anotÃ³ 15 goles en 5 partidos. Â¿CuÃ¡l fue su promedio de goles por partido?`,
                        answer: 3,
                        method: 'division',
                        explanation: 'Divide el total de goles entre el nÃºmero de partidos'
                    });
                    exerciseDatabase.datos.push({
                        type: 'bar-graph',
                        question: 'SegÃºn los goles anotados, Â¿quÃ© jugador fue el mÃ¡ximo goleador?',
                        data: { 'Ana': 8, 'Luis': 12, 'Carlos': 6, 'MarÃ­a': 10 },
                        options: ['Ana', 'Luis', 'Carlos', 'MarÃ­a'],
                        correct: 1
                    });
                    break;
                    
                case 'natacion':
                    exerciseDatabase.medicion.push({
                        type: 'simple-operation',
                        question: 'Amaia nadÃ³ 8 largos de 25 metros cada uno. Â¿CuÃ¡ntos metros nadÃ³ en total?',
                        answer: 200,
                        explanation: 'Multiplica la cantidad de largos por los metros de cada largo'
                    });
                    exerciseDatabase.numeros.push({
                        type: 'time-calculation',
                        question: 'Si Amaia nada 100 metros en 2 minutos, Â¿cuÃ¡nto tardarÃ¡ en nadar 400 metros?',
                        answer: 8,
                        explanation: 'Usa proporciÃ³n: si 100m = 2min, entonces 400m = 8min'
                    });
                    break;
                    
                case 'volley':
                    exerciseDatabase.numeros.push({
                        type: 'simple-operation',
                        question: 'En volley se necesitan 25 puntos para ganar un set. Si Amaia lleva 18 puntos, Â¿cuÃ¡ntos le faltan?',
                        answer: 7,
                        explanation: 'Resta los puntos que tiene de los que necesita'
                    });
                    break;
            }
        }
        
        function addAnimalProblems(animal, contexts) {
            switch(animal) {
                case 'perros':
                    exerciseDatabase.fracciones.push({
                        type: 'fraction-visual',
                        question: 'Amaia tiene 12 galletas para su perro. Si le da 1/4, Â¿cuÃ¡ntas galletas le dio?',
                        answer: 3,
                        explanation: 'Calcula 1/4 de 12 galletas'
                    });
                    exerciseDatabase.numeros.push({
                        type: 'multiplication',
                        question: 'Si un perro tiene 4 patas, Â¿cuÃ¡ntas patas tienen 7 perros?',
                        answer: 28,
                        explanation: 'Multiplica el nÃºmero de perros por las patas de cada uno'
                    });
                    break;
                    
                case 'gatos':
                    exerciseDatabase.fracciones.push({
                        type: 'simple-operation',
                        question: 'Un gato duerme 2/3 del dÃ­a. Â¿CuÃ¡ntas horas duerme si un dÃ­a tiene 24 horas?',
                        answer: 16,
                        explanation: 'Calcula 2/3 de 24 horas'
                    });
                    break;
                    
                case 'caballos':
                    exerciseDatabase.numeros.push({
                        type: 'word-problem',
                        question: 'En el establo hay 6 caballos. Si cada caballo come 8 kg de heno al dÃ­a, Â¿cuÃ¡nto heno necesitan en una semana?',
                        answer: 336,
                        method: 'multiplication',
                        explanation: 'Multiplica: 6 caballos Ã— 8 kg Ã— 7 dÃ­as'
                    });
                    break;
            }
        }
        
        function addHobbyProblems(hobby, contexts) {
            switch(hobby) {
                case 'musica':
                    exerciseDatabase.fracciones.push({
                        type: 'simple-operation',
                        question: 'Una canciÃ³n dura 3 minutos y 1/4. Â¿CuÃ¡ntos segundos dura?',
                        answer: 195,
                        explanation: 'Convierte 3 minutos y 15 segundos a segundos totales'
                    });
                    exerciseDatabase.algebra.push({
                        type: 'pattern-next',
                        question: 'En una escala musical: Do, Re, Mi, Fa, Sol, La, ?',
                        pattern: ['Do', 'Re', 'Mi', 'Fa', 'Sol', 'La'],
                        answer: 'Si',
                        explanation: 'Sigue la secuencia de notas musicales'
                    });
                    break;
                    
                case 'arte':
                    exerciseDatabase.geometria.push({
                        type: 'shape-properties',
                        question: 'Amaia dibuja un marco cuadrado de 15 cm de lado. Â¿CuÃ¡l es su perÃ­metro?',
                        answer: 60,
                        explanation: 'PerÃ­metro del cuadrado = 4 Ã— lado'
                    });
                    exerciseDatabase.fracciones.push({
                        type: 'simple-operation',
                        question: 'Para hacer color verde, Amaia mezcla 3/4 de azul con 1/4 de amarillo. Si usa 20 ml de pintura, Â¿cuÃ¡ntos ml de azul necesita?',
                        answer: 15,
                        explanation: 'Calcula 3/4 de 20 ml'
                    });
                    break;
                    
                case 'videojuegos':
                    exerciseDatabase.algebra.push({
                        type: 'simple-equation',
                        question: 'En un videojuego, Amaia tiene 150 monedas. Si compra un power-up que cuesta X monedas y le quedan 95, Â¿cuÃ¡nto costÃ³ el power-up?',
                        answer: 55,
                        explanation: 'Resta: 150 - 95 = 55 monedas'
                    });
                    break;
            }
        }
        
        function addFoodProblems(food, contexts) {
            switch(food) {
                case 'pizza':
                    exerciseDatabase.fracciones.push({
                        type: 'fraction-visual',
                        question: 'Amaia y sus 3 amigas comparten una pizza dividida en 8 pedazos. Si cada una come 2 pedazos, Â¿quÃ© fracciÃ³n de la pizza comieron?',
                        visual: 'pizza',
                        parts: 8,
                        colored: 8,
                        answer: '8/8',
                        explanation: 'Cuenta cuÃ¡ntos pedazos comieron en total'
                    });
                    break;
                    
                case 'helado':
                    exerciseDatabase.datos.push({
                        type: 'bar-graph',
                        question: 'Â¿CuÃ¡l es el sabor de helado mÃ¡s popular?',
                        data: { 'Chocolate': 25, 'Vainilla': 18, 'Frutilla': 22, 'Menta': 15 },
                        options: ['Chocolate', 'Vainilla', 'Frutilla', 'Menta'],
                        correct: 0
                    });
                    break;
                    
                case 'frutas':
                    exerciseDatabase.medicion.push({
                        type: 'simple-operation',
                        question: 'Amaia comprÃ³ 2.5 kg de manzanas y 1.8 kg de naranjas. Â¿CuÃ¡ntos gramos de fruta comprÃ³ en total?',
                        answer: 4300,
                        explanation: 'Convierte a gramos y suma: 2500g + 1800g'
                    });
                    break;
            }
        }

        // Funciones de encuesta de satisfacciÃ³n
        function showFeedbackSurvey() {
            showScreen('feedback');
            // Resetear las selecciones previas
            document.querySelectorAll('#feedbackScreen .interest-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        function selectFeedback(category, emoji, value) {
            appState.feedback[category] = { emoji, value };
            
            // Encontrar el botÃ³n clickeado
            const clickedButton = event.currentTarget || event.target;
            
            // Actualizar botones activos
            const buttons = clickedButton.parentElement.querySelectorAll('.interest-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            clickedButton.classList.add('active');
        }

        function submitFeedback() {
            // Obtener respuestas de texto
            appState.feedback.likedMost = document.getElementById('likedMost').value;
            appState.feedback.wouldChange = document.getElementById('wouldChange').value;
            
            // Generar el resumen para copiar
            const feedbackSummary = generateFeedbackSummary();
            
            // Mostrar el resumen
            showFeedbackSummary(feedbackSummary);
        }

        function generateFeedbackSummary() {
            const fb = appState.feedback;
            let summary = "ğŸ“Š FEEDBACK DE AMAIA - MATHAMAIA PRO\n";
            summary += "=====================================\n\n";
            
            summary += "1. Â¿QuÃ© tan divertida es la app?\n";
            summary += `   ${fb.fun?.emoji || 'â“'} ${fb.fun?.value || 'No respondiÃ³'}\n\n`;
            
            summary += "2. Â¿CÃ³mo son los ejercicios?\n";
            summary += `   ${fb.difficulty?.emoji || 'â“'} ${fb.difficulty?.value || 'No respondiÃ³'}\n\n`;
            
            summary += "3. Â¿Te gustan los colores y diseÃ±o?\n";
            summary += `   ${fb.design?.emoji || 'â“'} ${fb.design?.value || 'No respondiÃ³'}\n\n`;
            
            summary += "4. Â¿QuÃ© es lo que mÃ¡s te gustÃ³?\n";
            summary += `   ${fb.likedMost || 'No respondiÃ³'}\n\n`;
            
            summary += "5. Â¿QuÃ© cambiarÃ­as o agregarÃ­as?\n";
            summary += `   ${fb.wouldChange || 'No respondiÃ³'}\n\n`;
            
            summary += "6. Â¿La recomendarÃ­as a tus amigos?\n";
            summary += `   ${fb.recommend?.emoji || 'â“'} ${fb.recommend?.value || 'No respondiÃ³'}\n\n`;
            
            summary += `ğŸ“… Fecha: ${new Date().toLocaleString('es-CL')}\n`;
            summary += `ğŸ¯ Puntos actuales: ${appState.points}\n`;
            summary += `ğŸ† Logros: ${appState.achievements.join(', ') || 'Ninguno aÃºn'}\n`;
            
            return summary;
        }

        function showFeedbackSummary(summary) {
            const summaryHTML = `
                <div style="text-align: center;">
                    <h2>Â¡Gracias por tu opiniÃ³n! ğŸŒŸ</h2>
                    <p style="margin: 20px 0;">Tu feedback nos ayudarÃ¡ a hacer MathAmaia aÃºn mejor</p>
                    
                    <div style="background: rgba(46, 204, 113, 0.1); border: 2px solid #2ecc71; 
                                border-radius: 15px; padding: 20px; margin: 20px 0; text-align: left;">
                        <h3>ğŸ“‹ Resumen de tu feedback (copia este texto):</h3>
                        <textarea readonly style="width: 100%; min-height: 300px; padding: 15px; 
                                                  border-radius: 10px; border: 1px solid #ddd; 
                                                  font-family: monospace; font-size: 0.9em; 
                                                  background: white;">${summary}</textarea>
                        <button class="btn btn-secondary" onclick="copyFeedback()" style="margin-top: 10px;">
                            ğŸ“‹ Copiar al portapapeles
                        </button>
                    </div>
                    
                    <p style="font-style: italic; color: #666;">
                        Ahora puedes pegar este texto en un email o mensaje para compartir tu opiniÃ³n
                    </p>
                    
                    <button class="btn glow" onclick="showWelcome()">
                        Volver al inicio ğŸ 
                    </button>
                </div>
            `;
            
            document.getElementById('feedbackScreen').querySelector('.interactive-question').innerHTML = summaryHTML;
        }

        function copyFeedback() {
            const textarea = event.target.parentElement.querySelector('textarea');
            textarea.select();
            document.execCommand('copy');
            
            // Feedback visual
            event.target.textContent = 'âœ… Â¡Copiado!';
            setTimeout(() => {
                event.target.textContent = 'ğŸ“‹ Copiar al portapapeles';
            }, 2000);
        }

        function confirmExitExercise() {
            if (confirm('Â¿EstÃ¡s segura que quieres salir? PerderÃ¡s el progreso de estos ejercicios.')) {
                showWelcome();
            }
        }

        // Variables del canvas
        let canvas, ctx;
        let isDrawing = false;
        let currentMode = 'draw';
        let currentColor = 'black';
        let lastX = 0;
        let lastY = 0;
        let textX = 20;
        let textY = 30;

        // Funciones del espacio de trabajo con canvas
        function initCanvas() {
            canvas = document.getElementById('workspaceCanvas');
            if (!canvas) return;
            
            ctx = canvas.getContext('2d');
            
            // Ajustar tamaÃ±o del canvas para alta resoluciÃ³n
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * 2;
            canvas.height = rect.height * 2;
            ctx.scale(2, 2);
            
            // Configurar estilos
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.font = '20px Comic Sans MS';
            
            // Event listeners para dibujar
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events para tablets
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            if (currentMode !== 'draw') return;
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
        }

        function draw(e) {
            if (!isDrawing || currentMode !== 'draw') return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.strokeStyle = currentColor;
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
            
            lastX = x;
            lastY = y;
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function clearCanvas() {
            if (!canvas || !ctx) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            textX = 20;
            textY = 30;
        }

        function changeColor(color) {
            currentColor = color;
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('drawMode').style.background = mode === 'draw' ? 
                'linear-gradient(45deg, #ff6b6b, #ffd93d)' : 'linear-gradient(45deg, #667eea, #764ba2)';
            document.getElementById('textMode').style.background = mode === 'text' ? 
                'linear-gradient(45deg, #ff6b6b, #ffd93d)' : 'linear-gradient(45deg, #667eea, #764ba2)';
        }

        function insertText(text) {
            if (!canvas || !ctx) return;
            
            ctx.fillStyle = currentColor;
            ctx.font = '20px Comic Sans MS';
            ctx.fillText(text, textX, textY);
            
            // Mover posiciÃ³n para el siguiente texto
            textX += ctx.measureText(text).width + 5;
            
            // Si llegamos al final de la lÃ­nea, saltar a la siguiente
            if (textX > canvas.width / 2 - 30) {
                textX = 20;
                textY += 30;
            }
        }

        function toggleWorkspace() {
            const workspace = document.getElementById('workspaceArea');
            const toggleText = document.getElementById('workspaceToggleText');
            
            if (workspace.style.display === 'none') {
                workspace.style.display = 'block';
                toggleText.textContent = 'ğŸ“ Ocultar pizarra de trabajo';
                // Inicializar canvas cuando se muestra
                setTimeout(initCanvas, 100);
            } else {
                workspace.style.display = 'none';
                toggleText.textContent = 'ğŸ“ Mostrar pizarra de trabajo';
            }
        }

        // InicializaciÃ³n
        window.onload = function() {
            loadProgress();
            showWelcome();
            
            // Registrar Service Worker para PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => console.log('Service Worker registrado'))
                    .catch(error => console.log('Error al registrar Service Worker:', error));
            }
        };
    </script>
</body>
</html>