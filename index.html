<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathAmaia Pro - App Educativa Matem√°ticas v2.0</title>
    
    <!-- PWA Support -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="MathAmaia">
    
    <!-- Firebase (descomentar si usas backend) -->
    <!-- <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="firebase-setup.js"></script> -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .app-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 2.5em;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .curriculum-badge {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin: 5px;
            display: inline-block;
        }

        .user-info {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }

        .level-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .level-badge {
            background: linear-gradient(45deg, #ff6b6b, #ffd93d);
            color: white;
            padding: 8px 15px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .points {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            padding: 8px 15px;
            border-radius: 25px;
            font-weight: bold;
        }

        .screen {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            min-height: 400px;
        }

        .hidden {
            display: none;
        }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ffd93d);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }

        .btn.active {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            transform: scale(1.05);
        }

        /* Selector de Unidades Tem√°ticas */
        .unit-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .unit-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .unit-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }

        .unit-card.locked {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .unit-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .unit-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .unit-description {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .unit-progress {
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            height: 8px;
            margin-top: 15px;
            overflow: hidden;
        }

        .unit-progress-fill {
            background: #4CAF50;
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* Pregunta Interactiva */
        .question-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 20px;
            margin: 10px 0;
            text-align: center;
            font-size: 1.1em;
        }

        .interactive-question {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .math-input-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .math-input {
            width: 80px;
            height: 50px;
            border: 3px solid #667eea;
            border-radius: 10px;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            background: rgba(255,255,255,0.9);
        }

        .math-input:focus {
            outline: none;
            border-color: #ff6b6b;
            background: white;
        }

        .math-symbol {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        /* Modelo de Barras Interactivo */
        .bar-canvas-container {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            min-height: 200px;
            position: relative;
        }

        .bar-tools {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .bar-tool {
            background: linear-gradient(45deg, #ff6b6b, #ffd93d);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .bar-tool:hover {
            transform: scale(1.05);
        }

        .bar-tool.active {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .drawing-bar {
            height: 40px;
            margin: 5px 0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: grab;
            position: relative;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .drawing-bar:active {
            cursor: grabbing;
        }

        .bar-flamenco { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .bar-volley { background: linear-gradient(45deg, #3498db, #2980b9); }
        .bar-caballos { background: linear-gradient(45deg, #8b4513, #654321); }
        .bar-gimnasia { background: linear-gradient(45deg, #9b59b6, #8e44ad); }
        .bar-neutral { background: linear-gradient(45deg, #95a5a6, #7f8c8d); }

        .bar-label-input {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            text-align: center;
            border: none;
            background: rgba(255,255,255,0.9);
            border-radius: 5px;
            padding: 2px;
        }

        /* Evaluaci√≥n Interactiva */
        .evaluation-container {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .step-checker {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #ffd93d;
        }

        .step-checker.correct {
            border-left-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .step-checker.incorrect {
            border-left-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }

        /* Logros y Progreso */
        .achievements {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }

        .achievement {
            background: linear-gradient(45deg, #ffd700, #ffed4a);
            color: #333;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .progress-bar {
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            height: 8px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* Curr√≠culum Tracker */
        .curriculum-tracker {
            background: rgba(46, 204, 113, 0.1);
            border: 2px solid #2ecc71;
            border-radius: 15px;
            padding: 15px;
            margin: 20px 0;
        }

        .curriculum-objective {
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .curriculum-objective.completed {
            background: rgba(46, 204, 113, 0.2);
            color: #27ae60;
        }

        .curriculum-objective.in-progress {
            background: rgba(241, 196, 15, 0.2);
            color: #f39c12;
        }

        .curriculum-objective.pending {
            background: rgba(149, 165, 166, 0.2);
            color: #7f8c8d;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .unit-selector {
                grid-template-columns: 1fr;
            }
            
            .logo {
                font-size: 2em;
            }

            .math-input-container {
                flex-direction: column;
                gap: 10px;
            }

            .bar-tools {
                flex-direction: column;
                align-items: center;
            }

            .user-info {
                flex-direction: column;
                gap: 15px;
            }
        }

        /* Animaciones */
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .bounce {
            animation: bounce 0.6s;
        }

        @keyframes glow {
            0% { box-shadow: 0 0 5px rgba(255, 107, 107, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 107, 107, 0.8); }
            100% { box-shadow: 0 0 5px rgba(255, 107, 107, 0.5); }
        }

        .glow {
            animation: glow 2s infinite;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Tooltips */
        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            white-space: nowrap;
            z-index: 1000;
            font-size: 0.8em;
        }

        /* Estilos de personalizaci√≥n */
        .personalization-step {
            animation: slideIn 0.5s ease;
        }

        .interest-btn {
            transition: all 0.3s ease;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 1em;
        }

        .interest-btn:hover {
            transform: scale(1.05);
        }

        .interest-btn.active {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        /* Estilos de feedback */
        .feedback-question {
            background: rgba(255,255,255,0.5);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .feedback-question h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .feedback-textarea {
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .feedback-textarea:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
        }

        /* Estilos para el espacio de trabajo */
        .workspace {
            background: #fffef0;
            border: 2px dashed #ffd93d;
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            position: relative;
        }

        .workspace-title {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .workspace-canvas {
            display: block;
            margin: 0 auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .workspace-tools {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .workspace-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .workspace-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .workspace-btn.clear {
            background: linear-gradient(45deg, #ff6b6b, #ee5a50);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div class="logo">üåü MathAmaia Pro üåü</div>
            <p style="color: white; font-size: 1.2em;">Curr√≠culum Nacional de Chile + M√©todo Singapur</p>
            <div>
                <span class="curriculum-badge">üìö 4¬∞ B√°sico</span>
                <span class="curriculum-badge">üá∏üá¨ M√©todo Singapur</span>
                <span class="curriculum-badge">üá®üá± MINEDUC</span>
            </div>
        </div>

        <div class="user-info">
            <div class="level-info">
                <div class="level-badge" id="levelBadge">Unidad 1</div>
                <div class="points" id="pointsDisplay">0 puntos</div>
                <div class="curriculum-badge" id="currentObjective">N√∫meros hasta 10.000</div>
            </div>
            <div class="achievements" id="achievements">
                <!-- Logros aparecer√°n aqu√≠ -->
            </div>
        </div>

        <!-- Pantalla de Bienvenida -->
        <div id="welcomeScreen" class="screen">
            <div style="text-align: center;">
                <h1>¬°Hola Amaia! üëã</h1>
                <p style="font-size: 1.2em; margin: 20px 0;">¬°Bienvenida a MathAmaia Pro! Tu asistente matem√°tico que sigue el curr√≠culum nacional de Chile.</p>
                
                <div class="curriculum-tracker">
                    <h3>üéØ Objetivos de Cuarto B√°sico</h3>
                    <p>Vamos a dominar todas las matem√°ticas que necesitas este a√±o:</p>
                    <ul style="text-align: left; margin: 15px 0;">
                        <li>‚úÖ N√∫meros hasta 10.000</li>
                        <li>‚úÖ Multiplicaci√≥n y Divisi√≥n</li>
                        <li>‚úÖ Fracciones y Decimales</li>
                        <li>‚úÖ Geometr√≠a y Medici√≥n</li>
                        <li>‚úÖ Datos y Probabilidades</li>
                    </ul>
                </div>

                <p>¬øLista para comenzar tu aventura matem√°tica?</p>
                <button class="btn glow" onclick="showUnitSelector()">¬°Empecemos! üöÄ</button>
                <button class="btn btn-secondary" onclick="startPersonalization()" style="margin-left: 10px;">
                    üé® Configurar mis gustos
                </button>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="showFeedbackSurvey()" style="font-size: 0.9em;">
                        üìù Dar mi opini√≥n sobre la app
                    </button>
                    <button class="btn btn-secondary" onclick="resetProgress()" style="font-size: 0.9em; margin-left: 10px;">
                        üîÑ Reiniciar progreso
                    </button>
                </div>
            </div>
        </div>

        <!-- Selector de Unidades Tem√°ticas -->
        <div id="unitSelectorScreen" class="screen hidden">
            <h2 style="text-align: center; margin-bottom: 30px;">Selecciona tu Unidad de Aprendizaje üìö</h2>
            
            <div class="unit-selector">
                <div class="unit-card" onclick="selectUnit('numeros')" data-unit="numeros">
                    <div class="unit-icon">üî¢</div>
                    <div class="unit-title">N√∫meros y Operaciones</div>
                    <div class="unit-description">N√∫meros hasta 10.000, multiplicaci√≥n, divisi√≥n, c√°lculo mental</div>
                    <div class="unit-progress">
                        <div class="unit-progress-fill" style="width: 20%"></div>
                    </div>
                </div>

                <div class="unit-card" onclick="selectUnit('fracciones')" data-unit="fracciones">
                    <div class="unit-icon">üçï</div>
                    <div class="unit-title">Fracciones y Decimales</div>
                    <div class="unit-description">Fracciones propias, n√∫meros mixtos, decimales hasta cent√©simas</div>
                    <div class="unit-progress">
                        <div class="unit-progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <div class="unit-card" onclick="selectUnit('geometria')" data-unit="geometria">
                    <div class="unit-icon">üìê</div>
                    <div class="unit-title">Geometr√≠a</div>
                    <div class="unit-description">Figuras 2D y 3D, simetr√≠a, √°ngulos, transformaciones</div>
                    <div class="unit-progress">
                        <div class="unit-progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <div class="unit-card" onclick="selectUnit('medicion')" data-unit="medicion">
                    <div class="unit-icon">üìè</div>
                    <div class="unit-title">Medici√≥n</div>
                    <div class="unit-description">Tiempo, longitud, √°rea, volumen, per√≠metro</div>
                    <div class="unit-progress">
                        <div class="unit-progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <div class="unit-card" onclick="selectUnit('algebra')" data-unit="algebra">
                    <div class="unit-icon">üìä</div>
                    <div class="unit-title">Patrones y √Ålgebra</div>
                    <div class="unit-description">Patrones num√©ricos, ecuaciones simples, tablas</div>
                    <div class="unit-progress">
                        <div class="unit-progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <div class="unit-card" onclick="selectUnit('datos')" data-unit="datos">
                    <div class="unit-icon">üìà</div>
                    <div class="unit-title">Datos y Probabilidades</div>
                    <div class="unit-description">Gr√°ficos, encuestas, experimentos aleatorios</div>
                    <div class="unit-progress">
                        <div class="unit-progress-fill" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-secondary" onclick="showPersonalization()">‚öôÔ∏è Configurar Perfil</button>
                <button class="btn" onclick="showWelcome()">üè† Inicio</button>
            </div>
        </div>

        <!-- Pantalla de ejercicios -->
        <div id="exerciseScreen" class="screen hidden">
            <!-- Los ejercicios se cargar√°n din√°micamente aqu√≠ -->
        </div>

        <!-- Pantalla de resultados -->
        <div id="resultsScreen" class="screen hidden">
            <div style="text-align: center;">
                <h2 id="resultTitle">¬°Felicitaciones! üéâ</h2>
                <div class="achievement" style="font-size: 3em; margin: 20px;">üèÜ</div>
                <p id="resultMessage" style="font-size: 1.2em; margin: 20px;"></p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                </div>
                <button class="btn" onclick="showUnitSelector()">Continuar Aprendiendo üìö</button>
                <button class="btn btn-secondary" onclick="showWelcome()">Volver al Inicio üè†</button>
            </div>
        </div>

        <!-- Pantalla de feedback -->
        <div id="feedbackScreen" class="screen hidden">
            <div style="text-align: center;">
                <h2>¬°Tu opini√≥n es importante! üìù</h2>
                <p style="font-size: 1.1em; margin: 20px;">Ay√∫danos a mejorar MathAmaia Pro</p>
            </div>

            <div class="interactive-question">
                <form id="feedbackForm">
                    <!-- Pregunta 1: Diversi√≥n -->
                    <div class="feedback-question">
                        <h3>1. ¬øQu√© tan divertida te parece la aplicaci√≥n? üéÆ</h3>
                        <div style="display: flex; justify-content: center; gap: 20px; margin: 20px 0;">
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('fun', 'üòç', 'Me encanta')">
                                üòç<br>Me encanta
                            </button>
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('fun', 'üòä', 'Es divertida')">
                                üòä<br>Es divertida
                            </button>
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('fun', 'üòê', 'Est√° bien')">
                                üòê<br>Est√° bien
                            </button>
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('fun', 'üòï', 'Podr√≠a mejorar')">
                                üòï<br>Podr√≠a mejorar
                            </button>
                        </div>
                    </div>

                    <!-- Pregunta 2: Dificultad -->
                    <div class="feedback-question">
                        <h3>2. ¬øC√≥mo te parecen los ejercicios? üìö</h3>
                        <div style="display: flex; justify-content: center; gap: 20px; margin: 20px 0;">
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('difficulty', 'üåü', 'Muy f√°ciles')">
                                üåü<br>Muy f√°ciles
                            </button>
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('difficulty', 'üëç', 'Perfectos')">
                                üëç<br>Perfectos
                            </button>
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('difficulty', 'ü§î', 'Un poco dif√≠ciles')">
                                ü§î<br>Un poco dif√≠ciles
                            </button>
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('difficulty', 'üò∞', 'Muy dif√≠ciles')">
                                üò∞<br>Muy dif√≠ciles
                            </button>
                        </div>
                    </div>

                    <!-- Pregunta 3: Colores y dise√±o -->
                    <div class="feedback-question">
                        <h3>3. ¬øTe gustan los colores y el dise√±o? üé®</h3>
                        <div style="display: flex; justify-content: center; gap: 20px; margin: 20px 0;">
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('design', 'üåà', 'Me encantan')">
                                üåà<br>Me encantan
                            </button>
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('design', 'üé®', 'Est√°n bien')">
                                üé®<br>Est√°n bien
                            </button>
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('design', 'üñåÔ∏è', 'Podr√≠an mejorar')">
                                üñåÔ∏è<br>Podr√≠an mejorar
                            </button>
                        </div>
                    </div>

                    <!-- Pregunta 4: Qu√© m√°s te gust√≥ -->
                    <div class="feedback-question">
                        <h3>4. ¬øQu√© es lo que m√°s te gust√≥? ‚ú®</h3>
                        <textarea id="likedMost" class="feedback-textarea" 
                                  placeholder="Cu√©ntame qu√© fue lo m√°s divertido o √∫til..."
                                  style="width: 100%; min-height: 100px; padding: 15px; border-radius: 10px; 
                                         border: 2px solid #667eea; font-size: 1em; font-family: inherit;"></textarea>
                    </div>

                    <!-- Pregunta 5: Qu√© cambiar√≠as -->
                    <div class="feedback-question">
                        <h3>5. ¬øQu√© cambiar√≠as o agregar√≠as? üöÄ</h3>
                        <textarea id="wouldChange" class="feedback-textarea" 
                                  placeholder="¬øTienes ideas para hacer la app a√∫n mejor?"
                                  style="width: 100%; min-height: 100px; padding: 15px; border-radius: 10px; 
                                         border: 2px solid #667eea; font-size: 1em; font-family: inherit;"></textarea>
                    </div>

                    <!-- Pregunta 6: Recomendar√≠as -->
                    <div class="feedback-question">
                        <h3>6. ¬øLe recomendar√≠as esta app a tus amigos? üë´</h3>
                        <div style="display: flex; justify-content: center; gap: 20px; margin: 20px 0;">
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('recommend', 'üíØ', 'S√≠, definitivamente')">
                                üíØ<br>¬°S√≠, definitivamente!
                            </button>
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('recommend', 'üëç', 'Probablemente s√≠')">
                                üëç<br>Probablemente s√≠
                            </button>
                            <button type="button" class="btn interest-btn" onclick="selectFeedback('recommend', 'ü§∑', 'No estoy segura')">
                                ü§∑<br>No estoy segura
                            </button>
                        </div>
                    </div>

                    <!-- Botones de acci√≥n -->
                    <div style="text-align: center; margin-top: 30px;">
                        <button type="button" class="btn glow" onclick="submitFeedback()">
                            Enviar mi opini√≥n üìÆ
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="showWelcome()">
                            Volver al inicio üè†
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Pantalla de personalizaci√≥n -->
        <div id="personalizationScreen" class="screen hidden">
            <div style="text-align: center;">
                <h2>¬°Personalicemos tu experiencia, Amaia! üé®</h2>
                <p style="font-size: 1.1em; margin: 20px;">Cu√©ntame sobre tus gustos para hacer las matem√°ticas m√°s divertidas</p>
            </div>

            <div class="interactive-question">
                <div id="personalizationStep1" class="personalization-step">
                    <h3>¬øCu√°les son tus actividades favoritas? üéØ</h3>
                    <p style="color: #666; font-size: 0.9em;">Puedes elegir todas las que quieras</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;">
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'deportes', 'flamenco', 'üíÉ')">
                            üíÉ Flamenco
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'deportes', 'volley', 'üèê')">
                            üèê Volley
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'deportes', 'gimnasia', 'ü§∏‚Äç‚ôÄÔ∏è')">
                            ü§∏‚Äç‚ôÄÔ∏è Gimnasia
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'deportes', 'caballos', 'üê¥')">
                            üê¥ Caballos
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'deportes', 'futbol', '‚öΩ')">
                            ‚öΩ F√∫tbol
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'deportes', 'natacion', 'üèä‚Äç‚ôÄÔ∏è')">
                            üèä‚Äç‚ôÄÔ∏è Nataci√≥n
                        </button>
                    </div>
                    <button class="btn" onclick="nextPersonalizationStep()" style="margin-top: 20px;">
                        Siguiente ‚û°Ô∏è
                    </button>
                </div>

                <div id="personalizationStep2" class="personalization-step hidden">
                    <h3>¬øQu√© otras cosas te gustan? üé®</h3>
                    <p style="color: #666; font-size: 0.9em;">Elige todas las que quieras</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;">
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'hobbies', 'musica', 'üéµ')">
                            üéµ M√∫sica
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'hobbies', 'arte', 'üé®')">
                            üé® Arte
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'hobbies', 'lectura', 'üìö')">
                            üìö Lectura
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'hobbies', 'videojuegos', 'üéÆ')">
                            üéÆ Videojuegos
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'hobbies', 'cocinar', 'üë©‚Äçüç≥')">
                            üë©‚Äçüç≥ Cocinar
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'hobbies', 'bailar', 'üíÉ')">
                            üíÉ Bailar
                        </button>
                    </div>
                    <button class="btn" onclick="nextPersonalizationStep()" style="margin-top: 20px;">
                        Siguiente ‚û°Ô∏è
                    </button>
                </div>

                <div id="personalizationStep3" class="personalization-step hidden">
                    <h3>¬øQu√© m√°s te interesa? üåü</h3>
                    <p style="color: #666; font-size: 0.9em;">Puedes elegir varias opciones</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;">
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'intereses', 'familia', 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶')">
                            üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familia
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'intereses', 'amigos', 'üë´')">
                            üë´ Amigos
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'intereses', 'naturaleza', 'üå≥')">
                            üå≥ Naturaleza
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'intereses', 'tecnologia', 'üíª')">
                            üíª Tecnolog√≠a
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'intereses', 'viajes', '‚úàÔ∏è')">
                            ‚úàÔ∏è Viajes
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'intereses', 'mascotas', 'üêæ')">
                            üêæ Mascotas
                        </button>
                    </div>
                    <button class="btn" onclick="nextPersonalizationStep()" style="margin-top: 20px;">
                        Siguiente ‚û°Ô∏è
                    </button>
                </div>

                <div id="personalizationStep4" class="personalization-step hidden">
                    <h3>¬øCu√°les son tus animales favoritos? üêæ</h3>
                    <p style="color: #666; font-size: 0.9em;">Puedes elegir todos los que te gusten</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;">
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'animales', 'perros', 'üêï')">
                            üêï Perros
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'animales', 'gatos', 'üê±')">
                            üê± Gatos
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'animales', 'caballos', 'üê¥')">
                            üê¥ Caballos
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'animales', 'delfines', 'üê¨')">
                            üê¨ Delfines
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'animales', 'pajaros', 'ü¶ú')">
                            ü¶ú P√°jaros
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'animales', 'conejos', 'üê∞')">
                            üê∞ Conejos
                        </button>
                    </div>
                    <button class="btn" onclick="nextPersonalizationStep()" style="margin-top: 20px;">
                        Siguiente ‚û°Ô∏è
                    </button>
                </div>

                <div id="personalizationStep5" class="personalization-step hidden">
                    <h3>¬øQu√© comidas te encantan? üçΩÔ∏è</h3>
                    <p style="color: #666; font-size: 0.9em;">Elige todas tus favoritas</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;">
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'comidas', 'pizza', 'üçï')">
                            üçï Pizza
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'comidas', 'helado', 'üç¶')">
                            üç¶ Helado
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'comidas', 'frutas', 'üçì')">
                            üçì Frutas
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'comidas', 'galletas', 'üç™')">
                            üç™ Galletas
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'comidas', 'pasta', 'üçù')">
                            üçù Pasta
                        </button>
                        <button type="button" class="btn interest-btn" onclick="toggleInterest(this, 'comidas', 'chocolate', 'üç´')">
                            üç´ Chocolate
                        </button>
                    </div>
                    <button class="btn" onclick="nextPersonalizationStep()" style="margin-top: 20px;">
                        Siguiente ‚û°Ô∏è
                    </button>
                </div>

                <div id="personalizationSummary" class="personalization-step hidden">
                    <h3>¬°Perfecto! Ya s√© m√°s sobre ti üåü</h3>
                    <div class="curriculum-tracker" style="text-align: left;">
                        <p>Tus intereses:</p>
                        <div id="interestsSummary" style="display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0;">
                            <!-- Los intereses seleccionados aparecer√°n aqu√≠ -->
                        </div>
                    </div>
                    <p style="margin: 20px 0;">¬°Ahora las matem√°ticas ser√°n mucho m√°s divertidas con ejemplos sobre las cosas que te gustan!</p>
                    <button class="btn glow" onclick="finishPersonalization()">¬°Empezar a Aprender! üöÄ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Estado de la aplicaci√≥n
        let appState = {
            currentScreen: 'welcome',
            currentUnit: null,
            currentExercise: 0,
            points: 0,
            achievements: [],
            progress: {
                numeros: 20,
                fracciones: 0,
                geometria: 0,
                medicion: 0,
                algebra: 0,
                datos: 0
            },
            subStageProgress: {
                numeros: { current: 1, completed: 0, questionsInStage: 0 },
                fracciones: { current: 1, completed: 0, questionsInStage: 0 },
                geometria: { current: 1, completed: 0, questionsInStage: 0 },
                medicion: { current: 1, completed: 0, questionsInStage: 0 },
                algebra: { current: 1, completed: 0, questionsInStage: 0 },
                datos: { current: 1, completed: 0, questionsInStage: 0 }
            },
            exercises: [],
            correctAnswers: 0,
            totalQuestions: 0,
            interests: {},
            personalizationStep: 1,
            hasPersonalized: false,
            feedback: {},
            currentAttempts: 0,
            showingStepByStep: false
        };

        // Ejercicios por unidad
        const exerciseDatabase = {
            numeros: [
                // Ejercicios simples de suma
                {
                    type: 'simple-operation',
                    question: '25 + 13 = ?',
                    answer: 38,
                    explanation: 'Recuerda sumar primero las unidades, luego las decenas',
                    stepByStep: [
                        'Paso 1: Suma las unidades ‚Üí 5 + 3 = 8',
                        'Paso 2: Suma las decenas ‚Üí 2 + 1 = 3',
                        'Paso 3: Junta los resultados ‚Üí 30 + 8 = 38',
                        'Respuesta: 25 + 13 = 38'
                    ]
                },
                {
                    type: 'simple-operation',
                    question: '46 + 32 = ?',
                    answer: 78,
                    explanation: 'Separa las unidades y decenas para sumar m√°s f√°cil',
                    stepByStep: [
                        'Paso 1: Identifica los n√∫meros ‚Üí 46 y 32',
                        'Paso 2: Suma las unidades ‚Üí 6 + 2 = 8',
                        'Paso 3: Suma las decenas ‚Üí 4 + 3 = 7',
                        'Paso 4: Junta el resultado ‚Üí 70 + 8 = 78'
                    ]
                },
                {
                    type: 'simple-operation',
                    question: '150 + 50 = ?',
                    answer: 200,
                    explanation: 'Cuando sumas n√∫meros redondos, es m√°s f√°cil'
                },
                // Ejercicios simples de resta
                {
                    type: 'simple-operation',
                    question: '85 - 23 = ?',
                    answer: 62,
                    explanation: 'En la resta, tambi√©n separa unidades y decenas',
                    stepByStep: [
                        'Paso 1: Identifica minuendo (85) y sustraendo (23)',
                        'Paso 2: Resta las unidades ‚Üí 5 - 3 = 2',
                        'Paso 3: Resta las decenas ‚Üí 8 - 2 = 6',
                        'Paso 4: El resultado es ‚Üí 62'
                    ]
                },
                {
                    type: 'simple-operation',
                    question: '100 - 45 = ?',
                    answer: 55,
                    explanation: 'Cuando restas de 100, piensa en cu√°nto falta para llegar a 100'
                },
                // Ejercicios simples de multiplicaci√≥n
                {
                    type: 'simple-operation',
                    question: '5 √ó 6 = ?',
                    answer: 30,
                    explanation: 'Recuerda la tabla del 5 o del 6'
                },
                {
                    type: 'simple-operation',
                    question: '7 √ó 8 = ?',
                    answer: 56,
                    explanation: 'Este es un n√∫mero de la tabla del 7 y del 8',
                    stepByStep: [
                        'Paso 1: Recuerda que 7 √ó 8 es lo mismo que 8 √ó 7',
                        'Paso 2: Puedes pensar en 7 grupos de 8',
                        'Paso 3: O tambi√©n: 8 + 8 + 8 + 8 + 8 + 8 + 8 = 56',
                        'Paso 4: Memoriza: 7 √ó 8 = 56'
                    ]
                },
                {
                    type: 'simple-operation',
                    question: '10 √ó 12 = ?',
                    answer: 120,
                    explanation: 'Multiplicar por 10 es agregar un cero'
                },
                {
                    type: 'comparison',
                    question: '¬øCu√°l n√∫mero es mayor?',
                    options: ['3.457', '3.547'],
                    correct: 1,
                    explanation: 'Compara los n√∫meros posici√≥n por posici√≥n, empezando por los d√©cimos'
                },
                {
                    type: 'comparison',
                    question: '¬øCu√°l n√∫mero es mayor?',
                    options: ['8.234', '8.243'],
                    correct: 1,
                    explanation: 'Si los d√©cimos son iguales, compara los cent√©simos'
                },
                {
                    type: 'comparison',
                    question: '¬øCu√°l n√∫mero es mayor?',
                    options: ['5.672', '5.627'],
                    correct: 0,
                    explanation: 'F√≠jate bien en la posici√≥n de los d√©cimos'
                },
                {
                    type: 'decomposition',
                    question: 'Descomp√≥n el n√∫mero 4567',
                    answer: {
                        miles: 4,
                        centenas: 5,
                        decenas: 6,
                        unidades: 7
                    },
                    explanation: 'Separa cada d√≠gito seg√∫n su valor posicional',
                    stepByStep: [
                        'Paso 1: Identifica el n√∫mero ‚Üí 4567',
                        'Paso 2: El primer d√≠gito (4) est√° en los miles ‚Üí 4000',
                        'Paso 3: El segundo (5) en las centenas ‚Üí 500',
                        'Paso 4: El tercero (6) en las decenas ‚Üí 60',
                        'Paso 5: El cuarto (7) en las unidades ‚Üí 7',
                        'Verificaci√≥n: 4000 + 500 + 60 + 7 = 4567 ‚úì'
                    ]
                },
                {
                    type: 'decomposition',
                    question: 'Descomp√≥n el n√∫mero 8203',
                    answer: {
                        miles: 8,
                        centenas: 2,
                        decenas: 0,
                        unidades: 3
                    },
                    explanation: 'No olvides que el 0 tambi√©n tiene un valor posicional'
                },
                {
                    type: 'multiplication',
                    question: '23 √ó 15 = ?',
                    method: 'singapore',
                    answer: 345,
                    steps: [
                        '23 √ó 10 = 230',
                        '23 √ó 5 = 115',
                        '230 + 115 = 345'
                    ]
                },
                {
                    type: 'multiplication',
                    question: '34 √ó 12 = ?',
                    method: 'singapore',
                    answer: 408,
                    steps: [
                        '34 √ó 10 = 340',
                        '34 √ó 2 = 68',
                        '340 + 68 = 408'
                    ]
                },
                {
                    type: 'division',
                    question: '156 √∑ 12 = ?',
                    answer: 13,
                    method: 'singapore',
                    visual: true
                },
                {
                    type: 'division',
                    question: '144 √∑ 16 = ?',
                    answer: 9,
                    method: 'singapore',
                    visual: true
                },
                {
                    type: 'word-problem',
                    question: 'Amaia tiene 2350 stickers. Si regala 478 a su amiga, ¬øcu√°ntos le quedan?',
                    answer: 1872,
                    method: 'bar-model'
                },
                {
                    type: 'word-problem',
                    question: 'En el colegio de Amaia hay 1245 estudiantes. Si llegan 356 estudiantes nuevos, ¬øcu√°ntos estudiantes hay en total?',
                    answer: 1601,
                    method: 'bar-model'
                },
                // M√°s ejercicios simples - Sub-etapa 2
                {
                    type: 'simple-operation',
                    question: '234 + 156 = ?',
                    answer: 390,
                    explanation: 'Usa el algoritmo de suma columna por columna'
                },
                {
                    type: 'simple-operation',
                    question: '678 - 234 = ?',
                    answer: 444,
                    explanation: 'Resta columna por columna, pidiendo prestado si es necesario'
                },
                {
                    type: 'simple-operation',
                    question: '9 √ó 7 = ?',
                    answer: 63,
                    explanation: 'Piensa en la tabla del 9 o del 7'
                },
                {
                    type: 'simple-operation',
                    question: '420 + 380 = ?',
                    answer: 800,
                    explanation: 'Estos n√∫meros suman exactamente 800'
                },
                {
                    type: 'simple-operation',
                    question: '1000 - 650 = ?',
                    answer: 350,
                    explanation: 'Restamos: 1000 - 650 = 350'
                },
                // Comparaci√≥n de n√∫meros - Sub-etapa 2
                {
                    type: 'comparison',
                    question: '¬øCu√°l n√∫mero es mayor?',
                    options: ['4.789', '4.798'],
                    correct: 1,
                    explanation: '4.798 es mayor porque al comparar cent√©simos: 9 > 8'
                },
                {
                    type: 'comparison',
                    question: '¬øCu√°l n√∫mero es menor?',
                    options: ['2.345', '2.354'],
                    correct: 0,
                    explanation: '2.345 es menor porque al comparar cent√©simos: 4 < 5'
                },
                // Descomposici√≥n - Sub-etapa 2
                {
                    type: 'decomposition',
                    question: 'Descomp√≥n el n√∫mero 3729',
                    answer: {
                        miles: 3,
                        centenas: 7,
                        decenas: 2,
                        unidades: 9
                    },
                    explanation: '3729 = 3000 + 700 + 20 + 9'
                },
                {
                    type: 'decomposition',
                    question: 'Descomp√≥n el n√∫mero 5046',
                    answer: {
                        miles: 5,
                        centenas: 0,
                        decenas: 4,
                        unidades: 6
                    },
                    explanation: '5046 = 5000 + 0 + 40 + 6'
                },
                // Multiplicaci√≥n m√©todo Singapur - Sub-etapa 3
                {
                    type: 'multiplication',
                    question: '18 √ó 14 = ?',
                    method: 'singapore',
                    answer: 252,
                    steps: [
                        '18 √ó 10 = 180',
                        '18 √ó 4 = 72',
                        '180 + 72 = 252'
                    ]
                },
                {
                    type: 'multiplication',
                    question: '26 √ó 13 = ?',
                    method: 'singapore',
                    answer: 338,
                    steps: [
                        '26 √ó 10 = 260',
                        '26 √ó 3 = 78',
                        '260 + 78 = 338'
                    ]
                },
                {
                    type: 'multiplication',
                    question: '45 √ó 11 = ?',
                    method: 'singapore',
                    answer: 495,
                    steps: [
                        '45 √ó 10 = 450',
                        '45 √ó 1 = 45',
                        '450 + 45 = 495'
                    ]
                },
                // Divisi√≥n m√©todo Singapur - Sub-etapa 3
                {
                    type: 'division',
                    question: '168 √∑ 14 = ?',
                    answer: 12,
                    method: 'singapore',
                    visual: true
                },
                {
                    type: 'division',
                    question: '195 √∑ 15 = ?',
                    answer: 13,
                    method: 'singapore',
                    visual: true
                },
                {
                    type: 'division',
                    question: '216 √∑ 18 = ?',
                    answer: 12,
                    method: 'singapore',
                    visual: true
                },
                // Problemas de palabras - Sub-etapa 3
                {
                    type: 'word-problem',
                    question: 'Amaia colecciona cartas. Tiene 567 cartas y su hermano le regala 234 m√°s. ¬øCu√°ntas cartas tiene ahora?',
                    answer: 801,
                    method: 'bar-model'
                },
                {
                    type: 'word-problem',
                    question: 'En una tienda hay 892 chocolates. Si venden 347, ¬øcu√°ntos chocolates quedan?',
                    answer: 545,
                    method: 'bar-model'
                },
                {
                    type: 'word-problem',
                    question: 'Un libro tiene 324 p√°ginas. Si Amaia ya ley√≥ 189 p√°ginas, ¬øcu√°ntas le faltan por leer?',
                    answer: 135,
                    method: 'bar-model'
                },
                // Ejercicios mixtos - Sub-etapa 4
                {
                    type: 'simple-operation',
                    question: '6 √ó 8 = ?',
                    answer: 48,
                    explanation: '6 √ó 8 = 48'
                },
                {
                    type: 'simple-operation',
                    question: '72 √∑ 9 = ?',
                    answer: 8,
                    explanation: '72 √∑ 9 = 8'
                },
                {
                    type: 'simple-operation',
                    question: '456 + 234 = ?',
                    answer: 690,
                    explanation: 'Sumamos: 456 + 234 = 690'
                },
                {
                    type: 'simple-operation',
                    question: '900 - 475 = ?',
                    answer: 425,
                    explanation: 'Restamos: 900 - 475 = 425'
                },
                {
                    type: 'comparison',
                    question: '¬øCu√°l n√∫mero es mayor?',
                    options: ['6.123', '6.132'],
                    correct: 1,
                    explanation: '6.132 es mayor porque al comparar cent√©simos: 3 > 2'
                },
                {
                    type: 'comparison',
                    question: '¬øCu√°l n√∫mero es menor?',
                    options: ['7.456', '7.465'],
                    correct: 0,
                    explanation: '7.456 es menor porque al comparar cent√©simos: 5 < 6'
                },
                // Descomposici√≥n avanzada - Sub-etapa 4
                {
                    type: 'decomposition',
                    question: 'Descomp√≥n el n√∫mero 9.876',
                    answer: {
                        miles: 9,
                        centenas: 8,
                        decenas: 7,
                        unidades: 6
                    },
                    explanation: '9.876 = 9000 + 800 + 70 + 6'
                },
                {
                    type: 'decomposition',
                    question: 'Descomp√≥n el n√∫mero 6.205',
                    answer: {
                        miles: 6,
                        centenas: 2,
                        decenas: 0,
                        unidades: 5
                    },
                    explanation: '6.205 = 6000 + 200 + 0 + 5'
                },
                // Multiplicaci√≥n avanzada - Sub-etapa 5
                {
                    type: 'multiplication',
                    question: '37 √ó 16 = ?',
                    method: 'singapore',
                    answer: 592,
                    steps: [
                        '37 √ó 10 = 370',
                        '37 √ó 6 = 222',
                        '370 + 222 = 592'
                    ]
                },
                {
                    type: 'multiplication',
                    question: '29 √ó 18 = ?',
                    method: 'singapore',
                    answer: 522,
                    steps: [
                        '29 √ó 10 = 290',
                        '29 √ó 8 = 232',
                        '290 + 232 = 522'
                    ]
                },
                {
                    type: 'multiplication',
                    question: '42 √ó 15 = ?',
                    method: 'singapore',
                    answer: 630,
                    steps: [
                        '42 √ó 10 = 420',
                        '42 √ó 5 = 210',
                        '420 + 210 = 630'
                    ]
                },
                // Divisi√≥n avanzada - Sub-etapa 5
                {
                    type: 'division',
                    question: '224 √∑ 16 = ?',
                    answer: 14,
                    method: 'singapore',
                    visual: true
                },
                {
                    type: 'division',
                    question: '270 √∑ 18 = ?',
                    answer: 15,
                    method: 'singapore',
                    visual: true
                },
                {
                    type: 'division',
                    question: '252 √∑ 14 = ?',
                    answer: 18,
                    method: 'singapore',
                    visual: true
                },
                // Problemas complejos - Sub-etapa 5
                {
                    type: 'word-problem',
                    question: 'En una biblioteca hay 2.456 libros. Si prestan 789 libros, ¬øcu√°ntos quedan en la biblioteca?',
                    answer: 1667,
                    method: 'bar-model'
                },
                {
                    type: 'word-problem',
                    question: 'Una escuela tiene 1.234 estudiantes. Si cada estudiante dona 2 l√°pices, ¬øcu√°ntos l√°pices recolectan en total?',
                    answer: 2468,
                    method: 'bar-model'
                },
                {
                    type: 'word-problem',
                    question: 'Amaia ahorra $345 cada mes. ¬øCu√°nto dinero habr√° ahorrado despu√©s de 6 meses?',
                    answer: 2070,
                    method: 'bar-model'
                },
                // Ejercicios de repaso - Completar 75
                {
                    type: 'simple-operation',
                    question: '789 + 211 = ?',
                    answer: 1000,
                    explanation: 'Sumamos: 789 + 211 = 1000'
                },
                {
                    type: 'simple-operation',
                    question: '1234 - 567 = ?',
                    answer: 667,
                    explanation: 'Restamos: 1234 - 567 = 667'
                },
                {
                    type: 'simple-operation',
                    question: '15 √ó 6 = ?',
                    answer: 90,
                    explanation: '15 √ó 6 = 90'
                },
                {
                    type: 'simple-operation',
                    question: '81 √∑ 9 = ?',
                    answer: 9,
                    explanation: '81 √∑ 9 = 9'
                },
                {
                    type: 'comparison',
                    question: '¬øCu√°l n√∫mero es mayor?',
                    options: ['9.876', '9.867'],
                    correct: 0,
                    explanation: '9.876 es mayor porque al comparar cent√©simos: 7 > 6'
                },
                {
                    type: 'word-problem',
                    question: 'Un autob√∫s lleva 48 pasajeros. En la primera parada bajan 17 y suben 23. ¬øCu√°ntos pasajeros hay ahora?',
                    answer: 54,
                    method: 'bar-model'
                },
                {
                    type: 'multiplication',
                    question: '53 √ó 12 = ?',
                    method: 'singapore',
                    answer: 636,
                    steps: [
                        '53 √ó 10 = 530',
                        '53 √ó 2 = 106',
                        '530 + 106 = 636'
                    ]
                },
                {
                    type: 'simple-operation',
                    question: '2500 + 1500 = ?',
                    answer: 4000,
                    explanation: 'Sumamos: 2500 + 1500 = 4000'
                },
                {
                    type: 'simple-operation',
                    question: '3000 - 1750 = ?',
                    answer: 1250,
                    explanation: 'Restamos: 3000 - 1750 = 1250'
                },
                {
                    type: 'word-problem',
                    question: 'En una granja hay 234 gallinas y 156 patos. ¬øCu√°ntas aves hay en total?',
                    answer: 390,
                    method: 'bar-model'
                }
            ],
            fracciones: [
                {
                    type: 'fraction-visual',
                    question: '¬øQu√© fracci√≥n est√° coloreada?',
                    visual: 'pizza',
                    parts: 8,
                    colored: 3,
                    answer: '3/8'
                },
                {
                    type: 'fraction-visual',
                    question: '¬øQu√© fracci√≥n est√° coloreada?',
                    visual: 'pizza',
                    parts: 6,
                    colored: 4,
                    answer: '4/6'
                },
                {
                    type: 'fraction-comparison',
                    question: '¬øCu√°l fracci√≥n es mayor?',
                    options: ['2/3', '3/4'],
                    correct: 1,
                    visual: true
                },
                {
                    type: 'fraction-comparison',
                    question: '¬øCu√°l fracci√≥n es menor?',
                    options: ['1/2', '3/5'],
                    correct: 0,
                    visual: true
                },
                {
                    type: 'fraction-addition',
                    question: '1/4 + 2/4 = ?',
                    answer: '3/4',
                    visual: 'bars'
                },
                {
                    type: 'fraction-addition',
                    question: '2/5 + 1/5 = ?',
                    answer: '3/5',
                    visual: 'bars'
                },
                {
                    type: 'mixed-numbers',
                    question: 'Convierte 7/4 a n√∫mero mixto',
                    answer: '1 3/4',
                    visual: true
                },
                {
                    type: 'mixed-numbers',
                    question: 'Convierte 11/3 a n√∫mero mixto',
                    answer: '3 2/3',
                    visual: true
                },
                {
                    type: 'decimal-fraction',
                    question: 'Escribe 0.25 como fracci√≥n',
                    answer: '1/4',
                    explanation: 'Convierte el decimal a fracci√≥n usando 100 como denominador, luego simplifica'
                },
                {
                    type: 'decimal-fraction',
                    question: 'Escribe 0.5 como fracci√≥n',
                    answer: '1/2',
                    explanation: 'Piensa: 0.5 significa 5 d√©cimos, luego simplifica la fracci√≥n'
                },
                // M√°s ejercicios de fracciones - Sub-etapa 1 continuaci√≥n
                {
                    type: 'fraction-visual',
                    question: '¬øQu√© fracci√≥n est√° coloreada?',
                    visual: 'pizza',
                    parts: 4,
                    colored: 1,
                    answer: '1/4'
                },
                {
                    type: 'fraction-visual',
                    question: '¬øQu√© fracci√≥n est√° coloreada?',
                    visual: 'pizza',
                    parts: 5,
                    colored: 2,
                    answer: '2/5'
                },
                {
                    type: 'fraction-comparison',
                    question: '¬øCu√°l fracci√≥n es mayor?',
                    options: ['1/3', '1/4'],
                    correct: 0,
                    visual: true
                },
                {
                    type: 'fraction-comparison',
                    question: '¬øCu√°l fracci√≥n es menor?',
                    options: ['2/5', '3/5'],
                    correct: 0,
                    visual: true
                },
                {
                    type: 'fraction-addition',
                    question: '1/3 + 1/3 = ?',
                    answer: '2/3',
                    visual: 'bars'
                },
                // Sub-etapa 2: Fracciones equivalentes
                {
                    type: 'fraction-equivalent',
                    question: '¬øCu√°l es equivalente a 1/2?',
                    options: ['2/4', '1/3', '2/3', '1/4'],
                    correct: 0,
                    explanation: '1/2 = 2/4 porque 1√ó2=2 y 2√ó2=4'
                },
                {
                    type: 'fraction-equivalent',
                    question: '¬øCu√°l es equivalente a 2/3?',
                    options: ['4/6', '3/4', '2/5', '1/3'],
                    correct: 0,
                    explanation: '2/3 = 4/6 porque 2√ó2=4 y 3√ó2=6'
                },
                {
                    type: 'fraction-equivalent',
                    question: '¬øCu√°l es equivalente a 3/4?',
                    options: ['6/8', '4/6', '3/5', '2/4'],
                    correct: 0,
                    explanation: '3/4 = 6/8 porque 3√ó2=6 y 4√ó2=8'
                },
                {
                    type: 'fraction-simplify',
                    question: 'Simplifica 4/8',
                    answer: '1/2',
                    explanation: '4/8 = 1/2 (dividimos por 4)'
                },
                {
                    type: 'fraction-simplify',
                    question: 'Simplifica 6/9',
                    answer: '2/3',
                    explanation: '6/9 = 2/3 (dividimos por 3)'
                },
                {
                    type: 'fraction-simplify',
                    question: 'Simplifica 10/15',
                    answer: '2/3',
                    explanation: '10/15 = 2/3 (dividimos por 5)'
                },
                {
                    type: 'fraction-addition',
                    question: '1/6 + 2/6 = ?',
                    answer: '3/6',
                    visual: 'bars'
                },
                {
                    type: 'fraction-addition',
                    question: '3/8 + 2/8 = ?',
                    answer: '5/8',
                    visual: 'bars'
                },
                {
                    type: 'fraction-subtraction',
                    question: '3/4 - 1/4 = ?',
                    answer: '2/4',
                    visual: 'bars'
                },
                {
                    type: 'fraction-subtraction',
                    question: '5/6 - 2/6 = ?',
                    answer: '3/6',
                    visual: 'bars'
                },
                // Sub-etapa 3: N√∫meros mixtos
                {
                    type: 'mixed-numbers',
                    question: 'Convierte 9/4 a n√∫mero mixto',
                    answer: '2 1/4',
                    visual: true
                },
                {
                    type: 'mixed-numbers',
                    question: 'Convierte 13/5 a n√∫mero mixto',
                    answer: '2 3/5',
                    visual: true
                },
                {
                    type: 'mixed-numbers',
                    question: 'Convierte 17/6 a n√∫mero mixto',
                    answer: '2 5/6',
                    visual: true
                },
                {
                    type: 'mixed-to-improper',
                    question: 'Convierte 1 2/3 a fracci√≥n impropia',
                    answer: '5/3',
                    explanation: '1 2/3 = (1√ó3+2)/3 = 5/3'
                },
                {
                    type: 'mixed-to-improper',
                    question: 'Convierte 2 1/4 a fracci√≥n impropia',
                    answer: '9/4',
                    explanation: '2 1/4 = (2√ó4+1)/4 = 9/4'
                },
                {
                    type: 'mixed-to-improper',
                    question: 'Convierte 3 2/5 a fracci√≥n impropia',
                    answer: '17/5',
                    explanation: '3 2/5 = (3√ó5+2)/5 = 17/5'
                },
                {
                    type: 'decimal-fraction',
                    question: 'Escribe 0.75 como fracci√≥n',
                    answer: '3/4',
                    explanation: '0.75 = 75/100 = 3/4'
                },
                {
                    type: 'decimal-fraction',
                    question: 'Escribe 0.2 como fracci√≥n',
                    answer: '1/5',
                    explanation: '0.2 = 2/10 = 1/5'
                },
                {
                    type: 'decimal-fraction',
                    question: 'Escribe 0.4 como fracci√≥n',
                    answer: '2/5',
                    explanation: '0.4 = 4/10 = 2/5'
                },
                {
                    type: 'fraction-to-decimal',
                    question: 'Escribe 1/4 como decimal',
                    answer: 0.25,
                    explanation: '1/4 = 0.25'
                },
                // Sub-etapa 4: Fracciones en contexto
                {
                    type: 'fraction-word-problem',
                    question: 'Amaia comi√≥ 2/8 de una pizza y su hermano 3/8. ¬øCu√°nto comieron en total?',
                    answer: '5/8',
                    visual: 'pizza'
                },
                {
                    type: 'fraction-word-problem',
                    question: 'De 12 l√°pices, 3 son rojos. ¬øQu√© fracci√≥n de los l√°pices son rojos?',
                    answer: '3/12',
                    simplifiedAnswer: '1/4'
                },
                {
                    type: 'fraction-word-problem',
                    question: 'En una clase hay 20 estudiantes. Si 5 usan lentes, ¬øqu√© fracci√≥n usa lentes?',
                    answer: '5/20',
                    simplifiedAnswer: '1/4'
                },
                {
                    type: 'fraction-comparison',
                    question: '¬øCu√°l es mayor: 3/5 o 2/3?',
                    options: ['3/5', '2/3'],
                    correct: 1,
                    visual: true
                },
                {
                    type: 'fraction-comparison',
                    question: '¬øCu√°l es menor: 4/7 o 3/5?',
                    options: ['4/7', '3/5'],
                    correct: 0,
                    visual: true
                },
                {
                    type: 'fraction-addition',
                    question: '2/7 + 3/7 = ?',
                    answer: '5/7',
                    visual: 'bars'
                },
                {
                    type: 'fraction-addition',
                    question: '1/9 + 4/9 = ?',
                    answer: '5/9',
                    visual: 'bars'
                },
                {
                    type: 'fraction-subtraction',
                    question: '7/8 - 3/8 = ?',
                    answer: '4/8',
                    visual: 'bars'
                },
                {
                    type: 'fraction-subtraction',
                    question: '6/7 - 2/7 = ?',
                    answer: '4/7',
                    visual: 'bars'
                },
                {
                    type: 'mixed-numbers',
                    question: 'Convierte 15/4 a n√∫mero mixto',
                    answer: '3 3/4',
                    visual: true
                },
                // Sub-etapa 5: Fracciones avanzadas
                {
                    type: 'fraction-multiplication',
                    question: '1/2 √ó 1/3 = ?',
                    answer: '1/6',
                    explanation: '1√ó1=1, 2√ó3=6, entonces 1/6'
                },
                {
                    type: 'fraction-multiplication',
                    question: '2/3 √ó 1/4 = ?',
                    answer: '2/12',
                    simplifiedAnswer: '1/6'
                },
                {
                    type: 'fraction-multiplication',
                    question: '3/4 √ó 2/5 = ?',
                    answer: '6/20',
                    simplifiedAnswer: '3/10'
                },
                {
                    type: 'fraction-of-number',
                    question: '¬øCu√°nto es 1/2 de 20?',
                    answer: 10,
                    explanation: '1/2 √ó 20 = 10'
                },
                {
                    type: 'fraction-of-number',
                    question: '¬øCu√°nto es 1/4 de 16?',
                    answer: 4,
                    explanation: '1/4 √ó 16 = 4'
                },
                {
                    type: 'fraction-of-number',
                    question: '¬øCu√°nto es 2/3 de 12?',
                    answer: 8,
                    explanation: '2/3 √ó 12 = 8'
                },
                {
                    type: 'fraction-of-number',
                    question: '¬øCu√°nto es 3/5 de 15?',
                    answer: 9,
                    explanation: '3/5 √ó 15 = 9'
                },
                {
                    type: 'decimal-to-percent',
                    question: 'Convierte 0.5 a porcentaje',
                    answer: '50%',
                    explanation: '0.5 √ó 100 = 50%'
                },
                {
                    type: 'decimal-to-percent',
                    question: 'Convierte 0.25 a porcentaje',
                    answer: '25%',
                    explanation: '0.25 √ó 100 = 25%'
                },
                {
                    type: 'decimal-to-percent',
                    question: 'Convierte 0.75 a porcentaje',
                    answer: '75%',
                    explanation: '0.75 √ó 100 = 75%'
                },
                {
                    type: 'fraction-order',
                    question: 'Ordena de menor a mayor: 1/2, 1/3, 1/4',
                    answer: '1/4, 1/3, 1/2',
                    explanation: 'Cuando el numerador es 1, menor denominador = mayor fracci√≥n'
                },
                {
                    type: 'fraction-order',
                    question: 'Ordena de mayor a menor: 2/5, 3/5, 1/5',
                    answer: '3/5, 2/5, 1/5',
                    explanation: 'Con igual denominador, mayor numerador = mayor fracci√≥n'
                },
                {
                    type: 'mixed-addition',
                    question: '1 1/2 + 1/2 = ?',
                    answer: '2',
                    explanation: '1 1/2 + 1/2 = 1 2/2 = 2'
                },
                {
                    type: 'mixed-addition',
                    question: '2 1/3 + 1/3 = ?',
                    answer: '2 2/3',
                    explanation: '2 1/3 + 1/3 = 2 2/3'
                },
                {
                    type: 'fraction-word-problem',
                    question: 'Si Amaia ley√≥ 3/4 de un libro de 80 p√°ginas, ¬øcu√°ntas p√°ginas ley√≥?',
                    answer: 60,
                    explanation: '3/4 √ó 80 = 60 p√°ginas'
                },
                // Ejercicios de repaso para completar 75
                {
                    type: 'fraction-visual',
                    question: '¬øQu√© fracci√≥n est√° coloreada?',
                    visual: 'pizza',
                    parts: 10,
                    colored: 3,
                    answer: '3/10'
                },
                {
                    type: 'fraction-visual',
                    question: '¬øQu√© fracci√≥n est√° coloreada?',
                    visual: 'pizza',
                    parts: 12,
                    colored: 4,
                    answer: '4/12'
                },
                {
                    type: 'fraction-simplify',
                    question: 'Simplifica 8/12',
                    answer: '2/3',
                    explanation: '8/12 = 2/3 (dividimos por 4)'
                },
                {
                    type: 'fraction-simplify',
                    question: 'Simplifica 15/20',
                    answer: '3/4',
                    explanation: '15/20 = 3/4 (dividimos por 5)'
                },
                {
                    type: 'decimal-fraction',
                    question: 'Escribe 0.6 como fracci√≥n',
                    answer: '3/5',
                    explanation: '0.6 = 6/10 = 3/5'
                },
                {
                    type: 'decimal-fraction',
                    question: 'Escribe 0.8 como fracci√≥n',
                    answer: '4/5',
                    explanation: '0.8 = 8/10 = 4/5'
                },
                {
                    type: 'mixed-numbers',
                    question: 'Convierte 19/6 a n√∫mero mixto',
                    answer: '3 1/6',
                    visual: true
                },
                {
                    type: 'mixed-numbers',
                    question: 'Convierte 23/7 a n√∫mero mixto',
                    answer: '3 2/7',
                    visual: true
                },
                {
                    type: 'fraction-addition',
                    question: '4/9 + 2/9 = ?',
                    answer: '6/9',
                    visual: 'bars'
                },
                {
                    type: 'fraction-subtraction',
                    question: '8/9 - 5/9 = ?',
                    answer: '3/9',
                    visual: 'bars'
                },
                {
                    type: 'fraction-comparison',
                    question: '¬øCu√°l fracci√≥n es mayor?',
                    options: ['5/6', '4/5'],
                    correct: 0,
                    visual: true
                },
                {
                    type: 'fraction-word-problem',
                    question: 'En una bolsa hay 24 dulces. Si 1/3 son de fresa, ¬øcu√°ntos dulces de fresa hay?',
                    answer: 8,
                    explanation: '1/3 √ó 24 = 8 dulces'
                },
                {
                    type: 'fraction-word-problem',
                    question: 'Un tanque tiene capacidad para 60 litros. Si est√° lleno a 2/5, ¬øcu√°ntos litros tiene?',
                    answer: 24,
                    explanation: '2/5 √ó 60 = 24 litros'
                }
            ],
            geometria: [
                {
                    type: 'shape-identification',
                    question: '¬øCu√°ntos tri√°ngulos ves en esta figura?',
                    visual: 'complex-shape',
                    answer: 5
                },
                {
                    type: 'symmetry',
                    question: 'Dibuja la l√≠nea de simetr√≠a',
                    interactive: true,
                    shape: 'butterfly'
                },
                {
                    type: 'angles',
                    question: '¬øQu√© tipo de √°ngulo es este?',
                    angle: 90,
                    options: ['Agudo', 'Recto', 'Obtuso'],
                    correct: 1
                },
                {
                    type: '3d-shapes',
                    question: '¬øCu√°ntas caras tiene un cubo?',
                    answer: 6,
                    visual: true
                },
                {
                    type: 'perimeter',
                    question: 'Calcula el per√≠metro del rect√°ngulo',
                    width: 5,
                    height: 3,
                    answer: 16
                },
                // Sub-etapa 1 continuaci√≥n - Identificaci√≥n de figuras
                {
                    type: 'shape-identification',
                    question: '¬øCu√°ntos cuadrados ves en esta figura?',
                    visual: 'grid-pattern',
                    answer: 9
                },
                {
                    type: 'shape-identification',
                    question: '¬øCu√°ntos c√≠rculos hay en total?',
                    visual: 'circle-pattern',
                    answer: 7
                },
                {
                    type: 'shape-properties',
                    question: '¬øCu√°ntos lados tiene un pent√°gono?',
                    answer: 5,
                    explanation: 'Recuerda que "penta" significa 5 en griego'
                },
                {
                    type: 'shape-properties',
                    question: '¬øCu√°ntos v√©rtices tiene un tri√°ngulo?',
                    answer: 3,
                    explanation: 'Cuenta las esquinas o puntos donde se unen las l√≠neas'
                },
                {
                    type: 'shape-properties',
                    question: '¬øCu√°ntos lados tiene un hex√°gono?',
                    answer: 6,
                    explanation: 'Piensa en el significado de "hexa" para recordar'
                },
                {
                    type: 'shape-comparison',
                    question: '¬øQu√© figura tiene m√°s lados?',
                    options: ['Tri√°ngulo', 'Cuadrado', 'Pent√°gono', 'C√≠rculo'],
                    correct: 2,
                    explanation: 'Compara cu√°ntos lados tiene cada figura'
                },
                {
                    type: 'shape-comparison',
                    question: '¬øCu√°l figura NO tiene lados rectos?',
                    options: ['Cuadrado', 'Tri√°ngulo', 'C√≠rculo', 'Rect√°ngulo'],
                    correct: 2,
                    explanation: 'Piensa en qu√© figura es completamente curva'
                },
                {
                    type: 'angles',
                    question: '¬øQu√© tipo de √°ngulo es este?',
                    angle: 45,
                    options: ['Agudo', 'Recto', 'Obtuso'],
                    correct: 0
                },
                {
                    type: 'angles',
                    question: '¬øQu√© tipo de √°ngulo es este?',
                    angle: 120,
                    options: ['Agudo', 'Recto', 'Obtuso'],
                    correct: 2
                },
                // Sub-etapa 2 - Simetr√≠a y transformaciones
                {
                    type: 'symmetry',
                    question: '¬øCu√°ntas l√≠neas de simetr√≠a tiene un cuadrado?',
                    answer: 4,
                    visual: 'square'
                },
                {
                    type: 'symmetry',
                    question: '¬øCu√°ntas l√≠neas de simetr√≠a tiene un c√≠rculo?',
                    answer: 'infinitas',
                    options: ['1', '2', '4', 'infinitas'],
                    correct: 3
                },
                {
                    type: 'symmetry',
                    question: '¬øEsta letra tiene simetr√≠a vertical?',
                    letter: 'A',
                    options: ['S√≠', 'No'],
                    correct: 0
                },
                {
                    type: 'symmetry',
                    question: '¬øEsta letra tiene simetr√≠a horizontal?',
                    letter: 'C',
                    options: ['S√≠', 'No'],
                    correct: 0
                },
                {
                    type: 'transformation',
                    question: 'Si giras un cuadrado 90¬∞, ¬øqu√© figura obtienes?',
                    options: ['Tri√°ngulo', 'Cuadrado', 'Rect√°ngulo', 'Rombo'],
                    correct: 1,
                    explanation: 'Cuando giras una figura, su forma b√°sica no cambia'
                },
                {
                    type: 'transformation',
                    question: '¬øQu√© transformaci√≥n se aplic√≥: mover, rotar o reflejar?',
                    visual: 'translation',
                    options: ['Mover', 'Rotar', 'Reflejar'],
                    correct: 0
                },
                {
                    type: 'pattern-geometric',
                    question: '¬øQu√© figura sigue en el patr√≥n? ‚óã ‚ñ° ‚ñ≥ ‚óã ‚ñ° ?',
                    options: ['‚óã', '‚ñ°', '‚ñ≥', '‚óá'],
                    correct: 2
                },
                {
                    type: 'pattern-geometric',
                    question: '¬øQu√© figura falta? ‚ñ° ‚ñ° ‚óã ‚ñ° ‚ñ° ‚óã ‚ñ° ? ‚óã',
                    options: ['‚ñ°', '‚óã', '‚ñ≥', '‚óá'],
                    correct: 0
                },
                {
                    type: 'coordinates',
                    question: 'En una cuadr√≠cula, ¬øqu√© est√° en la posici√≥n (2,3)?',
                    visual: 'grid-with-objects',
                    options: ['üåü', 'üè†', 'üå≥', 'üöó'],
                    correct: 0
                },
                {
                    type: 'coordinates',
                    question: 'Si te mueves 2 a la derecha y 1 arriba desde (1,1), ¬ød√≥nde est√°s?',
                    answer: '(3,2)',
                    options: ['(2,3)', '(3,2)', '(3,3)', '(2,2)'],
                    correct: 1
                },
                // Sub-etapa 3 - Figuras 3D
                {
                    type: '3d-shapes',
                    question: '¬øCu√°ntas caras tiene una pir√°mide de base cuadrada?',
                    answer: 5,
                    visual: true
                },
                {
                    type: '3d-shapes',
                    question: '¬øCu√°ntos v√©rtices tiene un cubo?',
                    answer: 8,
                    visual: true
                },
                {
                    type: '3d-shapes',
                    question: '¬øCu√°ntas aristas tiene un cubo?',
                    answer: 12,
                    visual: true
                },
                {
                    type: '3d-shapes',
                    question: '¬øQu√© forma tienen las caras de un cubo?',
                    options: ['Tri√°ngulos', 'Cuadrados', 'C√≠rculos', 'Rect√°ngulos'],
                    correct: 1
                },
                {
                    type: '3d-shapes',
                    question: '¬øCu√°ntas bases tiene un cilindro?',
                    answer: 2,
                    visual: true
                },
                {
                    type: '3d-shapes',
                    question: '¬øQu√© figura 3D puede rodar?',
                    options: ['Cubo', 'Pir√°mide', 'Cilindro', 'Prisma'],
                    correct: 2
                },
                {
                    type: '3d-to-2d',
                    question: 'Si despliegas un cubo, ¬øcu√°ntos cuadrados obtienes?',
                    answer: 6,
                    visual: 'cube-net'
                },
                {
                    type: '3d-to-2d',
                    question: '¬øQu√© figura 2D forma la base de un cono?',
                    options: ['Cuadrado', 'Tri√°ngulo', 'C√≠rculo', 'Rect√°ngulo'],
                    correct: 2
                },
                {
                    type: 'volume-concept',
                    question: '¬øCu√°l figura puede contener m√°s agua?',
                    options: ['Cubo peque√±o', 'Cubo grande', 'Hoja de papel', 'Moneda'],
                    correct: 1
                },
                {
                    type: 'surface-area',
                    question: 'Si pintas todas las caras de un cubo, ¬øcu√°ntas caras pintas?',
                    answer: 6
                },
                // Sub-etapa 4 - Per√≠metros y √°reas
                {
                    type: 'perimeter',
                    question: 'Calcula el per√≠metro del cuadrado de lado 7 cm',
                    side: 7,
                    answer: 28
                },
                {
                    type: 'perimeter',
                    question: 'Calcula el per√≠metro del rect√°ngulo',
                    width: 8,
                    height: 4,
                    answer: 24
                },
                {
                    type: 'perimeter',
                    question: 'El per√≠metro de un cuadrado es 20 cm. ¬øCu√°nto mide cada lado?',
                    answer: 5
                },
                {
                    type: 'perimeter',
                    question: 'Calcula el per√≠metro del tri√°ngulo equil√°tero de lado 6 cm',
                    side: 6,
                    answer: 18
                },
                {
                    type: 'area-concept',
                    question: '¬øCu√°ntos cuadrados de 1 cm caben en un rect√°ngulo de 3√ó4 cm?',
                    answer: 12
                },
                {
                    type: 'area-concept',
                    question: '¬øQu√© figura tiene mayor √°rea?',
                    options: ['Cuadrado de 5√ó5', 'Rect√°ngulo de 4√ó6', 'Cuadrado de 4√ó4'],
                    correct: 0,
                    explanation: '5√ó5=25, 4√ó6=24, 4√ó4=16'
                },
                {
                    type: 'perimeter-vs-area',
                    question: 'Dos rect√°ngulos tienen el mismo per√≠metro. ¬øTienen la misma √°rea?',
                    options: ['Siempre', 'Nunca', 'A veces'],
                    correct: 2
                },
                {
                    type: 'composite-shapes',
                    question: 'Si unes dos cuadrados de lado 3 cm, ¬øcu√°l es el per√≠metro de la figura?',
                    answer: 18,
                    explanation: 'Al unir los cuadrados, comparten un lado'
                },
                {
                    type: 'shape-decomposition',
                    question: '¬øEn cu√°ntos tri√°ngulos puedes dividir un hex√°gono?',
                    answer: 6,
                    explanation: 'Desde el centro a cada v√©rtice se forman 6 tri√°ngulos',
                    visual: 'hexagon'
                },
                {
                    type: 'shape-decomposition',
                    question: '¬øCu√°ntos rect√°ngulos puedes formar con 12 cuadrados?',
                    options: ['2', '3', '4', '5'],
                    correct: 2,
                    explanation: '1√ó12, 2√ó6, 3√ó4, 4√ó3'
                },
                // Sub-etapa 5 - Problemas y aplicaciones
                {
                    type: 'geometry-word-problem',
                    question: 'Amaia quiere poner una cerca alrededor de su jard√≠n cuadrado de 5 m de lado. ¬øCu√°ntos metros de cerca necesita?',
                    answer: 20
                },
                {
                    type: 'geometry-word-problem',
                    question: 'Una ventana rectangular mide 2 m de alto y 1 m de ancho. ¬øCu√°l es su per√≠metro?',
                    answer: 6
                },
                {
                    type: 'geometry-word-problem',
                    question: 'Un cuadro tiene forma de hex√°gono regular con lados de 10 cm. ¬øCu√°l es su per√≠metro?',
                    answer: 60
                },
                {
                    type: 'geometry-word-problem',
                    question: 'Si cortas una pizza circular en 8 partes iguales, ¬øqu√© forma tiene cada pedazo?',
                    options: ['Cuadrado', 'Tri√°ngulo', 'Sector circular', 'Rect√°ngulo'],
                    correct: 2
                },
                {
                    type: 'spatial-reasoning',
                    question: 'Si doblas un papel cuadrado por la mitad, ¬øqu√© figura obtienes?',
                    options: ['Tri√°ngulo', 'Rect√°ngulo', 'Cuadrado m√°s peque√±o', 'C√≠rculo'],
                    correct: 1
                },
                {
                    type: 'spatial-reasoning',
                    question: '¬øCu√°ntos cubos de 1 cm¬≥ necesitas para llenar una caja de 2√ó3√ó4 cm?',
                    answer: 24
                },
                {
                    type: 'tessellation',
                    question: '¬øCu√°l figura puede cubrir completamente un piso sin dejar espacios?',
                    options: ['C√≠rculos', 'Pent√°gonos', 'Cuadrados', '√ìvalos'],
                    correct: 2
                },
                {
                    type: 'tessellation',
                    question: '¬øPueden los tri√°ngulos equil√°teros cubrir un piso sin espacios?',
                    options: ['S√≠', 'No'],
                    correct: 0
                },
                {
                    type: 'measurement-estimation',
                    question: '¬øCu√°l es aproximadamente el largo de tu l√°piz?',
                    options: ['15 mm', '15 cm', '15 m', '15 km'],
                    correct: 1
                },
                {
                    type: 'measurement-estimation',
                    question: '¬øCu√°l es aproximadamente el ancho de una puerta?',
                    options: ['80 mm', '80 cm', '80 m', '80 km'],
                    correct: 1
                },
                // Ejercicios adicionales para completar 75
                {
                    type: 'shape-properties',
                    question: '¬øTodos los lados de un rombo son iguales?',
                    options: ['S√≠', 'No'],
                    correct: 0
                },
                {
                    type: 'shape-properties',
                    question: '¬øUn rect√°ngulo puede ser un cuadrado?',
                    options: ['S√≠', 'No'],
                    correct: 0,
                    explanation: 'Un cuadrado es un rect√°ngulo especial con todos los lados iguales'
                },
                {
                    type: 'angles',
                    question: '¬øCu√°ntos √°ngulos rectos tiene un rect√°ngulo?',
                    answer: 4
                },
                {
                    type: 'angles',
                    question: 'La suma de los √°ngulos de un tri√°ngulo es:',
                    options: ['90¬∞', '180¬∞', '270¬∞', '360¬∞'],
                    correct: 1
                },
                {
                    type: 'line-types',
                    question: '¬øC√≥mo se llaman las l√≠neas que nunca se cruzan?',
                    options: ['Perpendiculares', 'Paralelas', 'Diagonales', 'Curvas'],
                    correct: 1
                },
                {
                    type: 'line-types',
                    question: '¬øC√≥mo se llaman las l√≠neas que forman un √°ngulo de 90¬∞?',
                    options: ['Perpendiculares', 'Paralelas', 'Diagonales', 'Horizontales'],
                    correct: 0
                },
                {
                    type: 'shape-identification',
                    question: '¬øCu√°ntos rect√°ngulos hay en una ventana con cruz en el medio?',
                    visual: 'window-cross',
                    answer: 5
                },
                {
                    type: 'perimeter',
                    question: 'Si el per√≠metro de un tri√°ngulo equil√°tero es 21 cm, ¬øcu√°nto mide cada lado?',
                    answer: 7
                },
                {
                    type: 'composite-shapes',
                    question: 'Si unes 5 cuadrados en l√≠nea, ¬øcu√°ntos lados tiene el per√≠metro de la figura?',
                    answer: 12
                },
                {
                    type: 'geometry-word-problem',
                    question: 'Amaia camina alrededor de una cancha rectangular 2 veces. Si la cancha mide 20m √ó 10m, ¬øcu√°nto camina?',
                    answer: 120,
                    explanation: 'Per√≠metro = 2√ó(20+10) = 60m, dos vueltas = 120m'
                }
            ],
            medicion: [
                // Ejercicios de tiempo
                {
                    type: 'simple-operation',
                    question: '¬øCu√°ntos minutos hay en 2 horas?',
                    answer: 120,
                    explanation: '1 hora = 60 minutos, entonces 2 horas = 2 √ó 60 = 120 minutos'
                },
                {
                    type: 'simple-operation',
                    question: '¬øCu√°ntos segundos hay en 3 minutos?',
                    answer: 180,
                    explanation: 'Recuerda: 1 minuto = 60 segundos. Multiplica por 3'
                },
                {
                    type: 'time-conversion',
                    question: 'Si son las 14:30, ¬øqu√© hora es en formato de 12 horas?',
                    answer: '2:30 PM',
                    options: ['2:30 AM', '2:30 PM', '4:30 PM', '12:30 PM'],
                    correct: 1
                },
                // Ejercicios de longitud
                {
                    type: 'simple-operation',
                    question: '¬øCu√°ntos cent√≠metros hay en 3 metros?',
                    answer: 300,
                    explanation: 'Piensa: 1 metro = 100 cm. ¬øC√≥mo convertir 3 metros?'
                },
                {
                    type: 'simple-operation',
                    question: '¬øCu√°ntos mil√≠metros hay en 5 cent√≠metros?',
                    answer: 50,
                    explanation: 'Recuerda la relaci√≥n: 1 cm = 10 mm'
                },
                // Ejercicios de √°rea
                {
                    type: 'area',
                    question: 'Calcula el √°rea de un cuadrado de 4 cm de lado',
                    side: 4,
                    answer: 16,
                    unit: 'cm¬≤'
                },
                {
                    type: 'area',
                    question: 'Calcula el √°rea de un rect√°ngulo de 6 cm de largo y 3 cm de ancho',
                    length: 6,
                    width: 3,
                    answer: 18,
                    unit: 'cm¬≤'
                },
                // Ejercicios de volumen
                {
                    type: 'volume',
                    question: '¬øCu√°ntos litros hay en 2000 mililitros?',
                    answer: 2,
                    explanation: 'Piensa en cu√°ntos grupos de 1000 ml hay en 2000 ml'
                },
                // Ejercicios de masa
                {
                    type: 'simple-operation',
                    question: '¬øCu√°ntos gramos hay en 3 kilogramos?',
                    answer: 3000,
                    explanation: 'Usa la conversi√≥n b√°sica: 1 kg = 1000 g'
                },
                {
                    type: 'mass-comparison',
                    question: '¬øQu√© es m√°s pesado?',
                    options: ['500 gramos', '1 kilogramo'],
                    correct: 1,
                    explanation: 'Compara 1 kg con 500 g usando la conversi√≥n'
                },
                // Sub-etapa 2 - Tiempo y calendario
                {
                    type: 'simple-operation',
                    question: '¬øCu√°ntas horas hay en un d√≠a?',
                    answer: 24,
                    explanation: 'Este es un dato que debes memorizar'
                },
                {
                    type: 'simple-operation',
                    question: '¬øCu√°ntos d√≠as hay en una semana?',
                    answer: 7,
                    explanation: 'Cuenta los d√≠as desde lunes hasta domingo'
                },
                {
                    type: 'simple-operation',
                    question: '¬øCu√°ntos meses tiene un a√±o?',
                    answer: 12,
                    explanation: 'Cuenta desde enero hasta diciembre'
                },
                {
                    type: 'time-calculation',
                    question: 'Si son las 9:30 AM y pasan 2 horas, ¬øqu√© hora ser√°?',
                    answer: '11:30 AM',
                    options: ['10:30 AM', '11:30 AM', '12:30 PM', '1:30 PM'],
                    correct: 1
                },
                {
                    type: 'time-calculation',
                    question: 'Una pel√≠cula dura 90 minutos. ¬øCu√°ntas horas y minutos son?',
                    answer: '1 hora 30 minutos',
                    options: ['1 hora', '1 hora 30 minutos', '2 horas', '2 horas 30 minutos'],
                    correct: 1
                },
                {
                    type: 'calendar',
                    question: 'Si hoy es lunes 15, ¬øqu√© d√≠a ser√° el lunes pr√≥ximo?',
                    answer: 22,
                    explanation: 'Suma 7 d√≠as a la fecha actual'
                },
                {
                    type: 'calendar',
                    question: '¬øCu√°ntos d√≠as tiene febrero en un a√±o normal?',
                    answer: 28,
                    explanation: 'Febrero es el mes m√°s corto del a√±o'
                },
                {
                    type: 'calendar',
                    question: '¬øCu√°les meses tienen 31 d√≠as?',
                    options: ['Enero, Marzo, Mayo', 'Febrero, Abril, Junio', 'Todos los meses', 'Ning√∫n mes'],
                    correct: 0,
                    explanation: 'Usa la regla de los nudillos para recordar'
                },
                {
                    type: 'time-word-problem',
                    question: 'Amaia estudia 45 minutos cada d√≠a. ¬øCu√°ntos minutos estudia en 4 d√≠as?',
                    answer: 180,
                    explanation: 'Multiplica los minutos diarios por el n√∫mero de d√≠as'
                },
                {
                    type: 'time-word-problem',
                    question: 'Un partido de f√∫tbol dura 90 minutos. Si hay 15 minutos de descanso, ¬øcu√°nto dura en total?',
                    answer: 105,
                    explanation: 'Suma el tiempo del partido m√°s el descanso'
                },
                // Sub-etapa 3 - Longitud avanzada
                {
                    type: 'simple-operation',
                    question: '¬øCu√°ntos metros hay en 1 kil√≥metro?',
                    answer: 1000,
                    explanation: 'Kilo significa 1000'
                },
                {
                    type: 'simple-operation',
                    question: '¬øCu√°ntos cent√≠metros hay en 2.5 metros?',
                    answer: 250,
                    explanation: 'Para convertir metros a cm, multiplica por 100'
                },
                {
                    type: 'length-conversion',
                    question: 'Convierte 3500 metros a kil√≥metros',
                    answer: 3.5,
                    explanation: 'Para convertir metros a km, divide por 1000'
                },
                {
                    type: 'length-conversion',
                    question: 'Convierte 45 mil√≠metros a cent√≠metros',
                    answer: 4.5,
                    explanation: 'Para convertir mm a cm, divide por 10'
                },
                {
                    type: 'length-comparison',
                    question: '¬øQu√© es m√°s largo?',
                    options: ['2.5 metros', '240 cent√≠metros', '2450 mil√≠metros', 'Son iguales'],
                    correct: 2,
                    explanation: 'Convierte todo a la misma unidad para comparar'
                },
                {
                    type: 'length-estimation',
                    question: '¬øCu√°l es la altura aproximada de una puerta?',
                    options: ['50 cm', '2 metros', '5 metros', '10 metros'],
                    correct: 1
                },
                {
                    type: 'length-estimation',
                    question: '¬øCu√°l es el ancho aproximado de un libro?',
                    options: ['20 mm', '20 cm', '20 m', '20 km'],
                    correct: 1
                },
                {
                    type: 'length-word-problem',
                    question: 'Una cuerda mide 5 metros. Si cortas 175 cent√≠metros, ¬øcu√°ntos cent√≠metros quedan?',
                    answer: 325,
                    explanation: 'Convierte a cent√≠metros y luego resta'
                },
                {
                    type: 'length-word-problem',
                    question: 'Amaia camina 250 metros hasta la escuela. ¬øCu√°ntos metros camina en 5 d√≠as (ida y vuelta)?',
                    answer: 2500,
                    explanation: 'Ida y vuelta = √ó 2, durante 5 d√≠as = √ó 5'
                },
                {
                    type: 'perimeter-measurement',
                    question: 'Una mesa cuadrada tiene lados de 80 cm. ¬øCu√°l es su per√≠metro en metros?',
                    answer: 3.2,
                    explanation: 'Per√≠metro = suma de todos los lados, luego convierte a metros'
                },
                // Sub-etapa 4 - √Årea y volumen
                {
                    type: 'area',
                    question: 'Calcula el √°rea de un cuadrado de 5 cm de lado',
                    side: 5,
                    answer: 25,
                    unit: 'cm¬≤'
                },
                {
                    type: 'area',
                    question: 'Calcula el √°rea de un rect√°ngulo de 7 cm de largo y 4 cm de ancho',
                    length: 7,
                    width: 4,
                    answer: 28,
                    unit: 'cm¬≤'
                },
                {
                    type: 'area',
                    question: 'Un piso cuadrado tiene √°rea de 36 m¬≤. ¬øCu√°nto mide cada lado?',
                    answer: 6,
                    explanation: '6 √ó 6 = 36'
                },
                {
                    type: 'area-comparison',
                    question: '¬øQu√© tiene mayor √°rea?',
                    options: ['Cuadrado de 6√ó6', 'Rect√°ngulo de 5√ó8', 'Rect√°ngulo de 4√ó9', 'Son iguales'],
                    correct: 1,
                    explanation: '6√ó6=36, 5√ó8=40, 4√ó9=36'
                },
                {
                    type: 'volume',
                    question: '¬øCu√°ntos mililitros hay en 1.5 litros?',
                    answer: 1500,
                    explanation: '1.5 √ó 1000 = 1500 mililitros'
                },
                {
                    type: 'volume',
                    question: '¬øCu√°ntos litros hay en 3000 mililitros?',
                    answer: 3,
                    explanation: '3000 √∑ 1000 = 3 litros'
                },
                {
                    type: 'volume-comparison',
                    question: '¬øQu√© contiene m√°s l√≠quido?',
                    options: ['2 litros', '1500 ml', '2.5 litros', '2200 ml'],
                    correct: 2,
                    explanation: '2.5 litros = 2500 ml, es el mayor'
                },
                {
                    type: 'capacity-estimation',
                    question: '¬øCu√°l es la capacidad aproximada de una botella de agua?',
                    options: ['50 ml', '500 ml', '5 litros', '50 litros'],
                    correct: 1
                },
                {
                    type: 'capacity-estimation',
                    question: '¬øCu√°l es la capacidad aproximada de una tina de ba√±o?',
                    options: ['20 litros', '200 litros', '2000 litros', '20000 litros'],
                    correct: 1
                },
                {
                    type: 'volume-word-problem',
                    question: 'Una jarra tiene 2 litros de jugo. Si sirves 250 ml en cada vaso, ¬øcu√°ntos vasos puedes llenar?',
                    answer: 8,
                    explanation: '2 litros = 2000 ml, 2000 √∑ 250 = 8 vasos'
                },
                // Sub-etapa 5 - Masa y peso avanzado
                {
                    type: 'simple-operation',
                    question: '¬øCu√°ntos gramos hay en 2.5 kilogramos?',
                    answer: 2500,
                    explanation: '2.5 √ó 1000 = 2500 gramos'
                },
                {
                    type: 'simple-operation',
                    question: '¬øCu√°ntos kilogramos son 4500 gramos?',
                    answer: 4.5,
                    explanation: '4500 √∑ 1000 = 4.5 kilogramos'
                },
                {
                    type: 'mass-conversion',
                    question: '¬øCu√°ntos gramos hay en 3 kg 250 g?',
                    answer: 3250,
                    explanation: '3000 + 250 = 3250 gramos'
                },
                {
                    type: 'mass-comparison',
                    question: '¬øQu√© pesa m√°s?',
                    options: ['3.2 kg', '3150 g', '3 kg 180 g', 'Son iguales'],
                    correct: 0,
                    explanation: '3.2 kg = 3200 g, es el mayor'
                },
                {
                    type: 'mass-estimation',
                    question: '¬øCu√°l es el peso aproximado de un l√°piz?',
                    options: ['10 g', '100 g', '1 kg', '10 kg'],
                    correct: 0
                },
                {
                    type: 'mass-estimation',
                    question: '¬øCu√°l es el peso aproximado de una mochila escolar llena?',
                    options: ['300 g', '3 kg', '30 kg', '300 kg'],
                    correct: 1
                },
                {
                    type: 'mass-word-problem',
                    question: 'Una bolsa de manzanas pesa 2.5 kg. Si cada manzana pesa 250 g, ¬øcu√°ntas manzanas hay?',
                    answer: 10,
                    explanation: '2.5 kg = 2500 g, 2500 √∑ 250 = 10 manzanas'
                },
                {
                    type: 'mass-word-problem',
                    question: 'Amaia compra 750 g de queso y 1.25 kg de jam√≥n. ¬øCu√°nto pesan en total en gramos?',
                    answer: 2000,
                    explanation: 'Convierte todo a gramos y suma'
                },
                {
                    type: 'temperature',
                    question: '¬øCu√°l es la temperatura normal del cuerpo humano?',
                    options: ['27¬∞C', '37¬∞C', '47¬∞C', '57¬∞C'],
                    correct: 1
                },
                {
                    type: 'temperature',
                    question: '¬øA qu√© temperatura hierve el agua?',
                    options: ['0¬∞C', '50¬∞C', '100¬∞C', '200¬∞C'],
                    correct: 2
                },
                // Ejercicios mixtos para completar 75
                {
                    type: 'mixed-units',
                    question: 'Un marat√≥n mide 42 km 195 m. ¬øCu√°ntos metros son en total?',
                    answer: 42195,
                    explanation: 'Convierte kil√≥metros a metros y suma'
                },
                {
                    type: 'mixed-units',
                    question: 'Una receta necesita 1 L 250 ml de leche. ¬øCu√°ntos mililitros son?',
                    answer: 1250,
                    explanation: 'Convierte litros a mililitros y suma'
                },
                {
                    type: 'time-zones',
                    question: 'Si en Chile son las 3:00 PM, y en Espa√±a son 5 horas m√°s, ¬øqu√© hora es all√°?',
                    answer: '8:00 PM',
                    options: ['6:00 PM', '7:00 PM', '8:00 PM', '9:00 PM'],
                    correct: 2
                },
                {
                    type: 'speed-concept',
                    question: 'Si caminas 4 km en 1 hora, ¬øcu√°ntos km caminas en 3 horas?',
                    answer: 12,
                    explanation: 'Multiplica velocidad por tiempo'
                },
                {
                    type: 'measurement-tools',
                    question: '¬øCon qu√© instrumento mides la temperatura?',
                    options: ['Regla', 'Balanza', 'Term√≥metro', 'Reloj'],
                    correct: 2
                },
                {
                    type: 'measurement-tools',
                    question: '¬øCon qu√© instrumento mides el peso?',
                    options: ['Regla', 'Balanza', 'Term√≥metro', 'Reloj'],
                    correct: 1
                },
                {
                    type: 'practical-measurement',
                    question: 'Para medir el largo de tu escritorio, ¬øqu√© unidad usar√≠as?',
                    options: ['Mil√≠metros', 'Cent√≠metros', 'Metros', 'Kil√≥metros'],
                    correct: 1
                },
                {
                    type: 'practical-measurement',
                    question: 'Para medir la distancia entre ciudades, ¬øqu√© unidad usar√≠as?',
                    options: ['Mil√≠metros', 'Cent√≠metros', 'Metros', 'Kil√≥metros'],
                    correct: 3
                },
                {
                    type: 'measurement-word-problem',
                    question: 'La clase de Amaia empieza a las 8:00 AM y termina a las 1:30 PM. ¬øCu√°nto dura?',
                    answer: '5 horas 30 minutos',
                    options: ['4 horas 30 minutos', '5 horas', '5 horas 30 minutos', '6 horas'],
                    correct: 2
                },
                {
                    type: 'measurement-word-problem',
                    question: 'Un tanque vac√≠o pesa 5 kg. Lleno de agua pesa 25 kg. ¬øCu√°ntos kg de agua contiene?',
                    answer: 20,
                    explanation: 'Resta el peso vac√≠o del peso lleno'
                },
                {
                    type: 'unit-relationships',
                    question: '1 metro c√∫bico de agua pesa aproximadamente:',
                    options: ['10 kg', '100 kg', '1000 kg', '10000 kg'],
                    correct: 2,
                    explanation: 'Recuerda: 1 metro c√∫bico de agua es muy pesado'
                },
                {
                    type: 'measurement-challenge',
                    question: 'Si un paso tuyo mide 60 cm, ¬øcu√°ntos pasos necesitas para recorrer 30 metros?',
                    answer: 50,
                    explanation: 'Convierte a cent√≠metros y divide por el tama√±o del paso'
                },
                {
                    type: 'measurement-challenge',
                    question: 'Una piscina mide 25 m de largo. Si nadas 8 largos, ¬øcu√°ntos metros nadaste?',
                    answer: 200,
                    explanation: 'Multiplica la longitud por el n√∫mero de largos'
                },
                {
                    type: 'measurement-challenge',
                    question: 'Si un beb√© nace pesando 3 kg 200 g y aumenta 800 g, ¬øcu√°ntos kg pesa ahora?',
                    answer: 4,
                    explanation: 'Convierte a gramos, suma y convierte de vuelta a kilogramos'
                }
            ],
            algebra: [
                // Patrones num√©ricos
                {
                    type: 'pattern-next',
                    question: 'Completa el patr√≥n: 2, 4, 6, 8, ?',
                    pattern: [2, 4, 6, 8],
                    answer: 10,
                    explanation: 'Busca qu√© se le suma a cada n√∫mero para obtener el siguiente'
                },
                {
                    type: 'pattern-next',
                    question: 'Completa el patr√≥n: 5, 10, 15, 20, ?',
                    pattern: [5, 10, 15, 20],
                    answer: 25,
                    explanation: 'Observa c√≥mo crecen los n√∫meros'
                },
                {
                    type: 'pattern-next',
                    question: 'Completa el patr√≥n: 100, 90, 80, 70, ?',
                    pattern: [100, 90, 80, 70],
                    answer: 60,
                    explanation: 'Nota que los n√∫meros van disminuyendo'
                },
                // Patrones geom√©tricos
                {
                    type: 'pattern-visual',
                    question: '¬øCu√°ntos c√≠rculos habr√° en la figura 5?',
                    description: 'Figura 1: üîµ, Figura 2: üîµüîµ, Figura 3: üîµüîµüîµ',
                    answer: 5,
                    explanation: 'Observa la relaci√≥n entre el n√∫mero de figura y la cantidad'
                },
                // Ecuaciones simples
                {
                    type: 'simple-equation',
                    question: 'Si 3 + __ = 8, ¬øcu√°l es el n√∫mero que falta?',
                    answer: 5,
                    explanation: 'Piensa: ¬øqu√© n√∫mero sumado a 3 da 8?'
                },
                {
                    type: 'simple-equation',
                    question: 'Si __ - 4 = 6, ¬øcu√°l es el n√∫mero que falta?',
                    answer: 10,
                    explanation: 'Piensa: ¬øde qu√© n√∫mero resto 4 para obtener 6?'
                },
                {
                    type: 'simple-equation',
                    question: 'Si 5 √ó __ = 20, ¬øcu√°l es el n√∫mero que falta?',
                    answer: 4,
                    explanation: 'Piensa: ¬øqu√© n√∫mero multiplicado por 5 da 20?'
                },
                // Problemas de balanza
                {
                    type: 'balance',
                    question: 'Si 2 manzanas pesan lo mismo que 6 naranjas, y 1 manzana pesa 150g, ¬øcu√°nto pesa 1 naranja?',
                    answer: 50,
                    unit: 'gramos'
                },
                // Funciones simples
                {
                    type: 'function-machine',
                    question: 'La m√°quina suma 3. Si entra 7, ¬øqu√© sale?',
                    input: 7,
                    operation: '+3',
                    answer: 10
                },
                {
                    type: 'function-machine',
                    question: 'La m√°quina multiplica por 2. Si entra 6, ¬øqu√© sale?',
                    input: 6,
                    operation: '√ó2',
                    answer: 12
                },
                // Sub-etapa 2 - M√°s patrones
                {
                    type: 'pattern-next',
                    question: 'Completa el patr√≥n: 3, 6, 9, 12, ?',
                    pattern: [3, 6, 9, 12],
                    answer: 15,
                    explanation: 'F√≠jate en la diferencia entre n√∫meros consecutivos'
                },
                {
                    type: 'pattern-next',
                    question: 'Completa el patr√≥n: 1, 2, 4, 8, ?',
                    pattern: [1, 2, 4, 8],
                    answer: 16,
                    explanation: 'Observa c√≥mo cada n√∫mero se relaciona con el anterior'
                },
                {
                    type: 'pattern-next',
                    question: 'Completa el patr√≥n: 50, 45, 40, 35, ?',
                    pattern: [50, 45, 40, 35],
                    answer: 30,
                    explanation: 'Los n√∫meros disminuyen de manera regular'
                },
                {
                    type: 'pattern-next',
                    question: 'Completa el patr√≥n: 1, 4, 7, 10, ?',
                    pattern: [1, 4, 7, 10],
                    answer: 13,
                    explanation: 'El patr√≥n suma 3 cada vez'
                },
                {
                    type: 'pattern-rule',
                    question: '¬øCu√°l es la regla del patr√≥n? 7, 14, 21, 28',
                    options: ['Sumar 7', 'Multiplicar por 2', 'Sumar 14', 'Restar 7'],
                    correct: 0,
                    explanation: 'Cada n√∫mero suma 7 al anterior'
                },
                {
                    type: 'pattern-visual',
                    question: '¬øCu√°ntos tri√°ngulos habr√° en la figura 6?',
                    description: 'Figura 1: ‚ñ≥, Figura 2: ‚ñ≥‚ñ≥, Figura 3: ‚ñ≥‚ñ≥‚ñ≥',
                    answer: 6,
                    explanation: 'Cada figura tiene tantos tri√°ngulos como su n√∫mero'
                },
                {
                    type: 'pattern-visual',
                    question: '¬øCu√°ntos cuadrados habr√° en la figura 4?',
                    description: 'Figura 1: ‚ñ°‚ñ°, Figura 2: ‚ñ°‚ñ°‚ñ°‚ñ°, Figura 3: ‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°',
                    answer: 8,
                    explanation: 'Cada figura tiene el doble de cuadrados que su n√∫mero'
                },
                {
                    type: 'growing-pattern',
                    question: 'Los palitos forman figuras: Fig 1: 3 palitos, Fig 2: 5 palitos, Fig 3: 7 palitos. ¬øCu√°ntos en Fig 4?',
                    answer: 9,
                    explanation: 'Cada figura agrega 2 palitos m√°s'
                },
                {
                    type: 'pattern-table',
                    question: 'Si la entrada es 5 y la salida es 15, ¬øcu√°l es la regla?',
                    options: ['√ó2', '√ó3', '+10', '√ó4'],
                    correct: 1,
                    explanation: '5 √ó 3 = 15'
                },
                {
                    type: 'pattern-missing',
                    question: 'Encuentra el n√∫mero que falta: 2, 5, __, 11, 14',
                    answer: 8,
                    explanation: 'El patr√≥n suma 3 cada vez: 2+3=5, 5+3=8, 8+3=11'
                },
                // Sub-etapa 3 - Ecuaciones y relaciones
                {
                    type: 'simple-equation',
                    question: 'Si 7 + __ = 15, ¬øcu√°l es el n√∫mero que falta?',
                    answer: 8,
                    explanation: '7 + 8 = 15'
                },
                {
                    type: 'simple-equation',
                    question: 'Si __ - 9 = 11, ¬øcu√°l es el n√∫mero que falta?',
                    answer: 20,
                    explanation: '20 - 9 = 11'
                },
                {
                    type: 'simple-equation',
                    question: 'Si 4 √ó __ = 24, ¬øcu√°l es el n√∫mero que falta?',
                    answer: 6,
                    explanation: '4 √ó 6 = 24'
                },
                {
                    type: 'simple-equation',
                    question: 'Si __ √∑ 3 = 9, ¬øcu√°l es el n√∫mero que falta?',
                    answer: 27,
                    explanation: '27 √∑ 3 = 9'
                },
                {
                    type: 'balance',
                    question: 'Si 3 canicas pesan lo mismo que 9 clips, y 1 canica pesa 6g, ¬øcu√°nto pesa 1 clip?',
                    answer: 2,
                    unit: 'gramos'
                },
                {
                    type: 'balance',
                    question: 'En una balanza: 2 cubos = 10 esferas. Si 1 esfera pesa 3g, ¬øcu√°nto pesa 1 cubo?',
                    answer: 15,
                    unit: 'gramos'
                },
                {
                    type: 'double-equation',
                    question: 'Si A + B = 10 y A = 6, ¬øcu√°nto vale B?',
                    answer: 4,
                    explanation: '6 + B = 10, entonces B = 4'
                },
                {
                    type: 'double-equation',
                    question: 'Si X - Y = 5 y X = 12, ¬øcu√°nto vale Y?',
                    answer: 7,
                    explanation: '12 - Y = 5, entonces Y = 7'
                },
                {
                    type: 'inequality',
                    question: '¬øQu√© n√∫mero hace verdadera la expresi√≥n? __ < 7',
                    options: ['5', '7', '8', '9'],
                    correct: 0,
                    explanation: '5 es menor que 7'
                },
                {
                    type: 'inequality',
                    question: '¬øQu√© n√∫mero hace verdadera la expresi√≥n? 15 > __',
                    options: ['20', '18', '15', '12'],
                    correct: 3,
                    explanation: '15 es mayor que 12'
                },
                // Sub-etapa 4 - Funciones y relaciones
                {
                    type: 'function-machine',
                    question: 'La m√°quina resta 4. Si entra 11, ¬øqu√© sale?',
                    input: 11,
                    operation: '-4',
                    answer: 7
                },
                {
                    type: 'function-machine',
                    question: 'La m√°quina multiplica por 3. Si entra 5, ¬øqu√© sale?',
                    input: 5,
                    operation: '√ó3',
                    answer: 15
                },
                {
                    type: 'function-machine',
                    question: 'La m√°quina divide por 2. Si entra 16, ¬øqu√© sale?',
                    input: 16,
                    operation: '√∑2',
                    answer: 8
                },
                {
                    type: 'function-machine',
                    question: 'La m√°quina suma 7. Si entra 8, ¬øqu√© sale?',
                    input: 8,
                    operation: '+7',
                    answer: 15
                },
                {
                    type: 'function-reverse',
                    question: 'Una m√°quina suma 5. Si sale 13, ¬øqu√© entr√≥?',
                    output: 13,
                    operation: '+5',
                    answer: 8
                },
                {
                    type: 'function-reverse',
                    question: 'Una m√°quina multiplica por 4. Si sale 20, ¬øqu√© entr√≥?',
                    output: 20,
                    operation: '√ó4',
                    answer: 5
                },
                {
                    type: 'coordinate-pattern',
                    question: 'Los puntos siguen un patr√≥n: (1,2), (2,4), (3,6). ¬øCu√°l es el siguiente?',
                    answer: '(4,8)',
                    options: ['(4,7)', '(4,8)', '(5,8)', '(4,9)'],
                    correct: 1
                },
                {
                    type: 'input-output-table',
                    question: 'Entrada: 3‚Üí9, 4‚Üí12, 5‚Üí15. ¬øQu√© sale si entra 7?',
                    answer: 21,
                    explanation: 'La regla es multiplicar por 3'
                },
                {
                    type: 'two-step-function',
                    question: 'La m√°quina multiplica por 2 y luego suma 1. Si entra 4, ¬øqu√© sale?',
                    answer: 9,
                    explanation: '4√ó2=8, 8+1=9'
                },
                {
                    type: 'two-step-function',
                    question: 'La m√°quina suma 3 y luego divide por 2. Si entra 5, ¬øqu√© sale?',
                    answer: 4,
                    explanation: '5+3=8, 8√∑2=4'
                },
                // Sub-etapa 5 - Problemas algebraicos
                {
                    type: 'age-problem',
                    question: 'Juan tiene 8 a√±os. Su hermana tiene 3 a√±os m√°s. ¬øCu√°ntos a√±os tiene su hermana?',
                    answer: 11,
                    explanation: '8 + 3 = 11 a√±os'
                },
                {
                    type: 'age-problem',
                    question: 'Mar√≠a tiene 12 a√±os. Es 4 a√±os mayor que Pedro. ¬øCu√°ntos a√±os tiene Pedro?',
                    answer: 8,
                    explanation: '12 - 4 = 8 a√±os'
                },
                {
                    type: 'money-problem',
                    question: 'Tienes $50. Gastas $23. ¬øCu√°nto te queda?',
                    answer: 27,
                    explanation: '50 - 23 = 27'
                },
                {
                    type: 'money-problem',
                    question: 'Ahorras $15 cada semana. ¬øCu√°nto tendr√°s en 4 semanas?',
                    answer: 60,
                    explanation: 'Multiplica cantidad por tiempo'
                },
                {
                    type: 'distribution-problem',
                    question: '24 dulces se reparten entre 6 ni√±os por igual. ¬øCu√°ntos recibe cada uno?',
                    answer: 4,
                    explanation: 'Divide la cantidad total entre el n√∫mero de personas'
                },
                {
                    type: 'distribution-problem',
                    question: 'Si 5 amigos comparten 35 stickers por igual, ¬øcu√°ntos recibe cada uno?',
                    answer: 7,
                    explanation: 'Usa la divisi√≥n para repartir equitativamente'
                },
                {
                    type: 'perimeter-algebra',
                    question: 'Un rect√°ngulo tiene ancho 5 cm y per√≠metro 24 cm. ¬øCu√°l es su largo?',
                    answer: 7,
                    explanation: 'Usa la f√≥rmula del per√≠metro y despeja el largo'
                },
                {
                    type: 'number-puzzle',
                    question: 'Piensa un n√∫mero. Si lo duplicas y sumas 6, obtienes 20. ¬øCu√°l es el n√∫mero?',
                    answer: 7,
                    explanation: 'Traduce las palabras a n√∫meros y resuelve'
                },
                {
                    type: 'sequence-sum',
                    question: '¬øCu√°l es la suma de los primeros 5 n√∫meros pares? (2+4+6+8+10)',
                    answer: 30,
                    explanation: 'Suma todos los n√∫meros pares'
                },
                {
                    type: 'sequence-sum',
                    question: '¬øCu√°l es la suma de los n√∫meros del 1 al 5?',
                    answer: 15,
                    explanation: 'Suma todos los n√∫meros consecutivos'
                },
                // Ejercicios adicionales para completar 75
                {
                    type: 'pattern-geometric-shapes',
                    question: 'El patr√≥n es: estrella, c√≠rculo, estrella, c√≠rculo, estrella, ?',
                    options: ['Estrella', 'C√≠rculo', 'Cuadrado', 'Tri√°ngulo'],
                    correct: 1
                },
                {
                    type: 'pattern-colors',
                    question: 'El patr√≥n es: rojo, azul, verde, rojo, azul, ?',
                    options: ['Rojo', 'Azul', 'Verde', 'Amarillo'],
                    correct: 2
                },
                {
                    type: 'letter-pattern',
                    question: 'Completa el patr√≥n: A, C, E, G, ?',
                    options: ['H', 'I', 'J', 'K'],
                    correct: 1,
                    explanation: 'Observa qu√© letras se omiten en el patr√≥n'
                },
                {
                    type: 'mixed-operations',
                    question: 'Si 3 √ó __ + 2 = 14, ¬øcu√°l es el n√∫mero?',
                    answer: 4,
                    explanation: 'Primero multiplica, luego suma 2'
                },
                {
                    type: 'pattern-multiplication',
                    question: 'Completa: 3√ó1=3, 3√ó2=6, 3√ó3=9, 3√ó4=?',
                    answer: 12,
                    explanation: 'Contin√∫a la tabla del 3'
                },
                {
                    type: 'word-equation',
                    question: 'El doble de un n√∫mero m√°s 5 es 13. ¬øCu√°l es el n√∫mero?',
                    answer: 4,
                    explanation: 'El doble de un n√∫mero significa multiplicar por 2'
                },
                {
                    type: 'comparison-algebra',
                    question: 'Ana tiene X dulces. Luis tiene 3 m√°s que Ana. Si Luis tiene 10, ¬øcu√°ntos tiene Ana?',
                    answer: 7,
                    explanation: 'Si Luis tiene 3 m√°s que Ana, resta 3 a lo que tiene Luis'
                },
                {
                    type: 'time-algebra',
                    question: 'Un viaje dura X horas. Si sales a las 9 AM y llegas a las 2 PM, ¬øcu√°nto dur√≥?',
                    answer: 5,
                    explanation: 'Cuenta las horas desde la salida hasta la llegada'
                },
                {
                    type: 'pattern-skip-counting',
                    question: 'Cuenta de 4 en 4: 4, 8, 12, 16, ?',
                    answer: 20,
                    explanation: 'Agrega 4 al √∫ltimo n√∫mero'
                },
                {
                    type: 'algebraic-thinking',
                    question: 'Si todos los gatos tienen 4 patas, ¬øcu√°ntas patas tienen 5 gatos?',
                    answer: 20,
                    explanation: 'Multiplica el n√∫mero de gatos por las patas de cada uno'
                },
                {
                    type: 'algebraic-thinking',
                    question: 'Si cada caja tiene 6 l√°pices, ¬øcu√°ntos l√°pices hay en 8 cajas?',
                    answer: 48,
                    explanation: 'Multiplica el n√∫mero de cajas por los l√°pices en cada una'
                },
                {
                    type: 'pattern-decreasing',
                    question: 'Completa el patr√≥n: 40, 32, 24, 16, ?',
                    answer: 8,
                    explanation: 'Los n√∫meros disminuyen de forma constante'
                },
                {
                    type: 'function-composition',
                    question: 'Primero suma 2, luego multiplica por 3. Si entra 4, ¬øqu√© sale?',
                    answer: 18,
                    explanation: 'Aplica las operaciones en orden: primero suma, luego multiplica'
                },
                {
                    type: 'pattern-challenge',
                    question: 'Completa: 1, 1, 2, 3, 5, 8, ?',
                    answer: 13,
                    explanation: 'Observa c√≥mo se forma cada n√∫mero usando los anteriores'
                },
                {
                    type: 'algebra-word-problem',
                    question: 'En una fila hay ni√±os y ni√±as. Hay 5 ni√±as m√°s que ni√±os. Si hay 8 ni√±os, ¬øcu√°ntas ni√±as hay?',
                    answer: 13,
                    explanation: 'Si hay 5 m√°s ni√±as que ni√±os, suma 5 al n√∫mero de ni√±os'
                }
            ],
            datos: [
                // Gr√°ficos de barras
                {
                    type: 'bar-graph',
                    question: 'Seg√∫n el gr√°fico, ¬øcu√°ntos estudiantes prefieren el f√∫tbol?',
                    data: {
                        'F√∫tbol': 8,
                        'B√°squetbol': 5,
                        'Tenis': 3,
                        'Nataci√≥n': 4
                    },
                    answer: 8
                },
                {
                    type: 'bar-graph',
                    question: '¬øCu√°l es el deporte menos preferido?',
                    data: {
                        'F√∫tbol': 8,
                        'B√°squetbol': 5,
                        'Tenis': 3,
                        'Nataci√≥n': 4
                    },
                    options: ['F√∫tbol', 'B√°squetbol', 'Tenis', 'Nataci√≥n'],
                    correct: 2
                },
                // Pictogramas
                {
                    type: 'pictogram',
                    question: 'Si cada üçé representa 2 manzanas, ¬øcu√°ntas manzanas hay en total? üçéüçéüçéüçéüçé',
                    symbol: 'üçé',
                    value: 2,
                    count: 5,
                    answer: 10
                },
                // Tablas de frecuencia
                {
                    type: 'frequency-table',
                    question: '¬øCu√°ntos estudiantes sacaron nota 6?',
                    table: {
                        'Nota 7': 5,
                        'Nota 6': 8,
                        'Nota 5': 3,
                        'Nota 4': 2
                    },
                    answer: 8
                },
                // Media, mediana y moda
                {
                    type: 'simple-operation',
                    question: 'Calcula el promedio de: 4, 6, 8',
                    answer: 6,
                    explanation: 'Suma todos los n√∫meros y divide por cu√°ntos hay'
                },
                {
                    type: 'mode',
                    question: '¬øCu√°l es la moda en: 2, 3, 3, 4, 3, 5?',
                    data: [2, 3, 3, 4, 3, 5],
                    answer: 3,
                    explanation: 'Busca el n√∫mero que aparece m√°s veces en la lista'
                },
                // Probabilidad simple
                {
                    type: 'probability',
                    question: 'Si lanzas una moneda, ¬øcu√°l es la probabilidad de obtener cara?',
                    options: ['1/2', '1/3', '1/4', '2/3'],
                    correct: 0,
                    explanation: 'En una moneda hay dos opciones igualmente probables'
                },
                {
                    type: 'probability',
                    question: 'En una bolsa hay 3 bolas rojas y 2 azules. ¬øQu√© color es m√°s probable sacar?',
                    options: ['Rojo', 'Azul', 'Igual probabilidad'],
                    correct: 0,
                    explanation: 'Compara cu√°ntas bolas de cada color hay'
                },
                // Organizaci√≥n de datos
                {
                    type: 'data-organization',
                    question: 'Ordena de menor a mayor: 15, 8, 23, 12, 19',
                    answer: '8, 12, 15, 19, 23',
                    options: ['8, 12, 15, 19, 23', '23, 19, 15, 12, 8', '8, 15, 12, 19, 23', '12, 8, 15, 23, 19'],
                    correct: 0
                },
                // Interpretaci√≥n de datos
                {
                    type: 'data-interpretation',
                    question: 'Si 20 estudiantes respondieron una encuesta y 12 dijeron que les gusta la pizza, ¬øcu√°ntos NO les gusta?',
                    answer: 8,
                    explanation: 'Resta los que les gusta del total'
                },
                // Sub-etapa 1 continuaci√≥n - Interpretaci√≥n de gr√°ficos
                {
                    type: 'bar-graph',
                    question: 'Seg√∫n el gr√°fico, ¬øcu√°ntos estudiantes prefieren helado de chocolate?',
                    data: {
                        'Chocolate': 12,
                        'Vainilla': 7,
                        'Frutilla': 5,
                        'Lim√≥n': 3
                    },
                    answer: 12
                },
                {
                    type: 'bar-graph',
                    question: '¬øCu√°l es la diferencia entre el sabor m√°s y menos preferido?',
                    data: {
                        'Chocolate': 12,
                        'Vainilla': 7,
                        'Frutilla': 5,
                        'Lim√≥n': 3
                    },
                    answer: 9,
                    explanation: 'Resta el mayor n√∫mero del menor'
                },
                {
                    type: 'simple-operation',
                    question: '¬øCu√°ntos estudiantes fueron encuestados en total?',
                    answer: 27,
                    explanation: 'Suma todos los valores del gr√°fico'
                },
                {
                    type: 'pictogram',
                    question: 'Si cada üèÄ representa 3 pelotas, ¬øcu√°ntas hay? üèÄüèÄüèÄüèÄ',
                    symbol: 'üèÄ',
                    value: 3,
                    count: 4,
                    answer: 12
                },
                {
                    type: 'pictogram',
                    question: 'Si cada ‚≠ê vale 5 puntos, ¬øcu√°ntos puntos hay? ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê',
                    symbol: '‚≠ê',
                    value: 5,
                    count: 6,
                    answer: 30
                },
                // Sub-etapa 2 - Tablas y organizaci√≥n de datos
                {
                    type: 'frequency-table',
                    question: '¬øCu√°ntos d√≠as llovi√≥ en la semana?',
                    table: {
                        'Lunes': 'Sol',
                        'Martes': 'Lluvia',
                        'Mi√©rcoles': 'Sol',
                        'Jueves': 'Lluvia',
                        'Viernes': 'Lluvia',
                        'S√°bado': 'Sol',
                        'Domingo': 'Sol'
                    },
                    answer: 3,
                    explanation: 'Cuenta cu√°ntos d√≠as aparece "Lluvia"'
                },
                {
                    type: 'frequency-table',
                    question: '¬øCu√°l es el color favorito m√°s popular?',
                    table: {
                        'Azul': 9,
                        'Rojo': 6,
                        'Verde': 4,
                        'Amarillo': 5
                    },
                    options: ['Azul', 'Rojo', 'Verde', 'Amarillo'],
                    correct: 0
                },
                {
                    type: 'data-organization',
                    question: 'Ordena de mayor a menor: 45, 23, 67, 34, 56',
                    answer: '67, 56, 45, 34, 23',
                    options: ['67, 56, 45, 34, 23', '23, 34, 45, 56, 67', '45, 23, 67, 34, 56', '56, 67, 45, 23, 34'],
                    correct: 0
                },
                {
                    type: 'data-organization',
                    question: 'Ordena alfab√©ticamente: perro, gato, conejo, ave',
                    answer: 'ave, conejo, gato, perro',
                    options: ['ave, conejo, gato, perro', 'perro, gato, conejo, ave', 'gato, ave, perro, conejo', 'conejo, ave, gato, perro'],
                    correct: 0
                },
                {
                    type: 'simple-operation',
                    question: 'Si en una tabla hay 5 filas y 4 columnas, ¬øcu√°ntas celdas hay?',
                    answer: 20,
                    explanation: 'Multiplica filas por columnas'
                },
                {
                    type: 'bar-graph',
                    question: '¬øCu√°ntos libros ley√≥ Mar√≠a?',
                    data: {
                        'Juan': 5,
                        'Mar√≠a': 8,
                        'Pedro': 6,
                        'Ana': 7
                    },
                    answer: 8
                },
                {
                    type: 'bar-graph',
                    question: '¬øQui√©n ley√≥ menos libros?',
                    data: {
                        'Juan': 5,
                        'Mar√≠a': 8,
                        'Pedro': 6,
                        'Ana': 7
                    },
                    options: ['Juan', 'Mar√≠a', 'Pedro', 'Ana'],
                    correct: 0
                },
                {
                    type: 'simple-operation',
                    question: '¬øCu√°ntos libros leyeron entre todos?',
                    answer: 26,
                    explanation: 'Suma todos los libros le√≠dos por cada persona'
                },
                {
                    type: 'pictogram',
                    question: 'Si cada üå≥ representa 10 √°rboles, ¬øcu√°ntos hay? üå≥üå≥üå≥üå≥üå≥üå≥üå≥',
                    symbol: 'üå≥',
                    value: 10,
                    count: 7,
                    answer: 70
                },
                // Sub-etapa 3 - Medidas de tendencia central
                {
                    type: 'simple-operation',
                    question: 'Calcula el promedio de: 10, 20, 30',
                    answer: 20,
                    explanation: 'Suma todos los n√∫meros y divide por cu√°ntos hay'
                },
                {
                    type: 'simple-operation',
                    question: 'Calcula el promedio de: 5, 7, 9, 11',
                    answer: 8,
                    explanation: 'El promedio se calcula sumando y dividiendo por la cantidad'
                },
                {
                    type: 'mode',
                    question: '¬øCu√°l es la moda en: 4, 5, 5, 6, 5, 7, 8?',
                    data: [4, 5, 5, 6, 5, 7, 8],
                    answer: 5,
                    explanation: 'Cuenta cu√°ntas veces aparece cada n√∫mero'
                },
                {
                    type: 'mode',
                    question: '¬øCu√°l es la moda en: 10, 12, 12, 15, 15, 15, 20?',
                    data: [10, 12, 12, 15, 15, 15, 20],
                    answer: 15,
                    explanation: 'Busca el n√∫mero que m√°s se repite'
                },
                {
                    type: 'simple-operation',
                    question: 'Encuentra la mediana de: 3, 5, 7, 9, 11',
                    answer: 7,
                    explanation: 'La mediana es el valor del centro cuando est√°n ordenados'
                },
                {
                    type: 'simple-operation',
                    question: 'Encuentra la mediana de: 2, 4, 6, 8',
                    answer: 5,
                    explanation: 'Con cantidad par de datos, promedia los dos del centro'
                },
                {
                    type: 'data-interpretation',
                    question: 'Si el promedio de 4 notas es 6, ¬øcu√°l es la suma de las notas?',
                    answer: 24,
                    explanation: 'Si conoces el promedio, multiplica por la cantidad de datos'
                },
                {
                    type: 'simple-operation',
                    question: 'El promedio de edad de 3 hermanos es 10 a√±os. ¬øCu√°ntos a√±os suman entre todos?',
                    answer: 30,
                    explanation: 'Multiplica el promedio por la cantidad de personas'
                },
                {
                    type: 'frequency-table',
                    question: '¬øCu√°l es la temperatura m√°s frecuente?',
                    table: {
                        '20¬∞C': 3,
                        '22¬∞C': 5,
                        '24¬∞C': 2,
                        '25¬∞C': 1
                    },
                    options: ['20¬∞C', '22¬∞C', '24¬∞C', '25¬∞C'],
                    correct: 1
                },
                {
                    type: 'data-organization',
                    question: 'Si ordenas estos n√∫meros, ¬øcu√°l queda en el medio? 15, 8, 23, 12, 19',
                    answer: 15,
                    explanation: 'Ordena los n√∫meros y encuentra el del centro'
                },
                {
                    type: 'range',
                    question: '¬øCu√°l es el rango de: 3, 7, 2, 9, 5?',
                    answer: 7,
                    explanation: 'El rango es la diferencia entre el mayor y menor valor'
                },
                {
                    type: 'range',
                    question: '¬øCu√°l es el rango de temperaturas: 18¬∞C, 25¬∞C, 20¬∞C, 30¬∞C?',
                    answer: 12,
                    explanation: 'Resta la temperatura m√°s baja de la m√°s alta'
                },
                {
                    type: 'simple-operation',
                    question: 'Si 5 amigos tienen estas edades: 9, 10, 11, 10, 10. ¬øCu√°l es la edad m√°s com√∫n?',
                    answer: 10,
                    explanation: 'Busca la edad que m√°s se repite'
                },
                {
                    type: 'data-interpretation',
                    question: 'En una clase de 30 estudiantes, si el promedio de altura es 140 cm, ¬øcu√°l es la suma de todas las alturas?',
                    answer: 4200,
                    explanation: 'Multiplica el promedio por el n√∫mero de estudiantes'
                },
                {
                    type: 'comparison',
                    question: '¬øQu√© conjunto tiene mayor promedio: [4,6,8] o [5,5,5]?',
                    options: ['[4,6,8]', '[5,5,5]', 'Son iguales'],
                    correct: 0,
                    explanation: 'Calcula el promedio de cada conjunto y compara'
                },
                // Sub-etapa 4 - Probabilidad y predicciones
                {
                    type: 'probability',
                    question: 'Si lanzas un dado, ¬øcu√°l es la probabilidad de sacar un 6?',
                    options: ['1/6', '1/3', '1/2', '2/6'],
                    correct: 0,
                    explanation: 'En un dado hay 6 posibilidades, una favorable'
                },
                {
                    type: 'probability',
                    question: 'En una bolsa hay 4 canicas rojas y 6 azules. ¬øQu√© fracci√≥n representa las rojas?',
                    options: ['4/10', '6/10', '4/6', '10/4'],
                    correct: 0,
                    explanation: 'Cuenta las canicas rojas y divide por el total'
                },
                {
                    type: 'probability',
                    question: 'Si giras una ruleta dividida en 4 partes iguales (rojo, azul, verde, amarillo), ¬øqu√© probabilidad hay de caer en rojo?',
                    options: ['1/4', '1/2', '1/3', '2/4'],
                    correct: 0
                },
                {
                    type: 'simple-operation',
                    question: 'Si lanzas 2 monedas, ¬øcu√°ntos resultados posibles hay?',
                    answer: 4,
                    explanation: 'Cuenta todas las combinaciones posibles'
                },
                {
                    type: 'data-interpretation',
                    question: 'Si de 50 personas, 30 usan lentes, ¬øqu√© porcentaje NO usa lentes?',
                    answer: 40,
                    explanation: 'Calcula qu√© porcentaje representa 20 de 50'
                },
                {
                    type: 'prediction',
                    question: 'Si en 10 lanzamientos sali√≥ cara 6 veces, ¬øcu√°ntas caras esperar√≠as en 20 lanzamientos?',
                    answer: 12,
                    explanation: 'Usa la proporci√≥n observada para predecir'
                },
                {
                    type: 'probability',
                    question: '¬øQu√© es m√°s probable al lanzar un dado: sacar par o impar?',
                    options: ['Par', 'Impar', 'Igual probabilidad'],
                    correct: 2,
                    explanation: 'Cuenta cu√°ntos n√∫meros pares e impares hay'
                },
                {
                    type: 'simple-operation',
                    question: 'Si la probabilidad de lluvia es 3/4, ¬øqu√© probabilidad hay de que NO llueva?',
                    answer: '1/4',
                    options: ['1/4', '3/4', '1/2', '2/4'],
                    correct: 0
                },
                {
                    type: 'data-interpretation',
                    question: 'Si 8 de cada 10 estudiantes aprueban, ¬øcu√°ntos aprobar√≠an de 30 estudiantes?',
                    answer: 24,
                    explanation: 'Aplica la misma proporci√≥n al nuevo grupo'
                },
                {
                    type: 'probability',
                    question: 'En una caja hay 5 chocolates con leche y 5 sin leche. Si sacas uno sin mirar, ¬øqu√© probabilidad hay de que sea con leche?',
                    options: ['1/2', '1/5', '5/5', '5/10'],
                    correct: 0
                },
                {
                    type: 'spinner',
                    question: 'Una ruleta tiene 3 secciones rojas y 1 azul. ¬øEs m√°s probable caer en rojo o azul?',
                    options: ['Rojo', 'Azul', 'Igual probabilidad'],
                    correct: 0,
                    explanation: 'Compara cu√°ntas secciones tiene cada color'
                },
                {
                    type: 'data-interpretation',
                    question: 'Si el 25% de 40 estudiantes usa mochila azul, ¬øcu√°ntos estudiantes son?',
                    answer: 10,
                    explanation: 'Calcula el 25% de 40 estudiantes'
                },
                {
                    type: 'probability',
                    question: 'Si sacas una carta de una baraja de 52, ¬øqu√© es m√°s probable: sacar un coraz√≥n o un as?',
                    options: ['Coraz√≥n', 'As', 'Igual probabilidad'],
                    correct: 0,
                    explanation: 'Compara cu√°ntas cartas de cada tipo hay'
                },
                {
                    type: 'simple-operation',
                    question: 'Si la probabilidad de ganar es 2/5, ¬øcu√°l es la probabilidad de perder?',
                    answer: '3/5',
                    options: ['3/5', '2/5', '1/5', '4/5'],
                    correct: 0
                },
                {
                    type: 'prediction',
                    question: 'Si una planta crece 2 cm por semana, ¬øcu√°nto crecer√° en 6 semanas?',
                    answer: 12,
                    explanation: 'Multiplica el crecimiento semanal por las semanas'
                },
                // Sub-etapa 5 - Problemas y aplicaciones
                {
                    type: 'data-word-problem',
                    question: 'Amaia hizo una encuesta sobre mascotas. 15 tienen perro, 8 tienen gato y 5 tienen ambos. ¬øCu√°ntos tienen solo perro?',
                    answer: 10,
                    explanation: 'Resta los que tienen ambos del total de perros'
                },
                {
                    type: 'data-word-problem',
                    question: 'En un campeonato, el equipo A anot√≥: 3, 2, 4, 5, 1 goles. ¬øCu√°l fue su promedio de goles?',
                    answer: 3,
                    explanation: 'Suma todos los goles y divide por los partidos'
                },
                {
                    type: 'survey-design',
                    question: 'Para saber el deporte favorito de tu curso, ¬øcu√°ntas preguntas necesitas hacer a cada estudiante?',
                    answer: 1,
                    options: ['1', '2', '5', '10'],
                    correct: 0
                },
                {
                    type: 'data-collection',
                    question: '¬øCu√°l es la mejor forma de registrar las respuestas de una encuesta?',
                    options: ['Memoria', 'Tabla', 'Adivinar', 'No registrar'],
                    correct: 1
                },
                {
                    type: 'graph-interpretation',
                    question: 'Si un gr√°fico muestra ventas crecientes cada mes, ¬øqu√© conclusi√≥n puedes sacar?',
                    options: ['El negocio va mal', 'El negocio va bien', 'No se puede saber', 'Las ventas bajan'],
                    correct: 1
                },
                {
                    type: 'data-word-problem',
                    question: 'Una tienda vendi√≥: Lunes 20, Martes 25, Mi√©rcoles 15, Jueves 30, Viernes 35 helados. ¬øQu√© d√≠a vendi√≥ m√°s?',
                    options: ['Lunes', 'Martes', 'Jueves', 'Viernes'],
                    correct: 3
                },
                {
                    type: 'simple-operation',
                    question: '¬øCu√°ntos helados vendi√≥ la tienda en total la semana?',
                    answer: 125,
                    explanation: 'Suma las ventas de todos los d√≠as'
                },
                {
                    type: 'data-comparison',
                    question: 'Equipo A: 45, 50, 48 puntos. Equipo B: 46, 47, 49 puntos. ¬øQu√© equipo tiene mejor promedio?',
                    options: ['Equipo A', 'Equipo B', 'Empate'],
                    correct: 0,
                    explanation: 'Calcula el promedio de cada equipo y compara'
                },
                {
                    type: 'simple-operation',
                    question: 'Si graficas las edades de 5 amigos (8, 9, 9, 10, 11), ¬øcu√°l edad aparecer√≠a m√°s alta en un gr√°fico de barras?',
                    answer: 9,
                    explanation: 'En un gr√°fico de barras, busca la barra m√°s alta'
                },
                {
                    type: 'data-interpretation',
                    question: 'En un pictograma de flores, si cada üåª = 5 flores y hay 8 s√≠mbolos, ¬øcu√°ntas flores hay?',
                    answer: 40,
                    explanation: 'Multiplica el n√∫mero de s√≠mbolos por el valor de cada uno'
                },
                {
                    type: 'schedule-analysis',
                    question: 'Si practicas piano: L-15min, M-20min, X-15min, J-25min, V-20min. ¬øCu√°l es tu tiempo promedio?',
                    answer: 19,
                    explanation: 'Suma todos los tiempos y divide por los d√≠as'
                },
                {
                    type: 'voting',
                    question: 'En una votaci√≥n: Pizza-12, Hamburguesa-8, Tacos-5. ¬øCu√°ntos votos de diferencia hay entre el 1¬∞ y 2¬∞ lugar?',
                    answer: 4,
                    explanation: 'Resta los votos del segundo lugar del primero'
                },
                {
                    type: 'trend-analysis',
                    question: 'Las temperaturas de la semana: 20¬∞, 22¬∞, 24¬∞, 26¬∞, 28¬∞. ¬øQu√© tendencia observas?',
                    options: ['Aumenta', 'Disminuye', 'Se mantiene', 'Variable'],
                    correct: 0
                },
                {
                    type: 'data-word-problem',
                    question: 'En la biblioteca hay 100 libros. 40% son cuentos, 30% son c√≥mics y el resto son revistas. ¬øCu√°ntas revistas hay?',
                    answer: 30,
                    explanation: 'Resta los porcentajes conocidos del total'
                },
                {
                    type: 'conclusion',
                    question: 'Si 9 de 10 estudiantes prefieren recreo largo, ¬øqu√© deber√≠as recomendar al director?',
                    options: ['Recreo m√°s corto', 'Recreo m√°s largo', 'Sin recreo', 'No cambiar'],
                    correct: 1
                }
            ]
        };

        // Funciones de navegaci√≥n
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(screenId + 'Screen').classList.remove('hidden');
            appState.currentScreen = screenId;
            updateUI();
        }

        function showWelcome() {
            showScreen('welcome');
        }

        function showUnitSelector() {
            showScreen('unitSelector');
        }

        function selectUnit(unit) {
            appState.currentUnit = unit;
            appState.currentExercise = 0;
            appState.correctAnswers = 0;
            appState.exercises = exerciseDatabase[unit] || [];
            appState.totalQuestions = appState.exercises.length;
            
            // Inicializar o actualizar el progreso de sub-etapas
            if (!appState.subStageProgress[unit]) {
                appState.subStageProgress[unit] = { current: 1, completed: 0, questionsInStage: 0 };
            }
            
            // Calcular en qu√© sub-etapa estamos basado en el progreso guardado
            const exercisesPerStage = 15;
            const completedExercises = Math.floor((appState.progress[unit] / 100) * appState.totalQuestions);
            appState.subStageProgress[unit].current = Math.floor(completedExercises / exercisesPerStage) + 1;
            appState.subStageProgress[unit].questionsInStage = completedExercises % exercisesPerStage;
            
            if (appState.exercises.length > 0) {
                showExercise();
            }
        }

        function showExercise() {
            showScreen('exercise');
            appState.currentAttempts = 0;
            appState.showingStepByStep = false;
            const exercise = appState.exercises[appState.currentExercise];
            renderExercise(exercise);
            // El canvas se inicializa solo cuando el usuario muestra la pizarra
        }

        function renderExercise(exercise) {
            const container = document.getElementById('exerciseScreen');
            const subStage = appState.subStageProgress[appState.currentUnit];
            const currentQuestionInStage = (appState.currentExercise % 15) + 1;
            const totalStages = Math.ceil(appState.totalQuestions / 15);
            
            let html = `
                <div class="exercise-header" style="text-align: center; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <button class="btn btn-secondary" onclick="confirmExitExercise()" style="font-size: 0.8em; padding: 6px 12px;">
                            üè† Inicio
                        </button>
                        <div style="text-align: center;">
                            <h3 style="margin: 0; font-size: 1.2em;">Sub-etapa ${subStage.current} de ${totalStages}</h3>
                            <p style="margin: 2px 0; font-size: 0.8em; color: #667eea;">
                                Pregunta ${currentQuestionInStage} de 15
                            </p>
                        </div>
                        <div style="width: 100px;"></div>
                    </div>
                    <div class="sub-stage-indicator" style="display: flex; gap: 5px; justify-content: center; margin-bottom: 10px;">
                        ${Array.from({length: totalStages}, (_, i) => `
                            <div style="
                                width: 25px; 
                                height: 25px; 
                                border-radius: 50%; 
                                display: flex; 
                                align-items: center; 
                                justify-content: center;
                                font-weight: bold;
                                font-size: 0.8em;
                                background: ${i < subStage.completed ? 'linear-gradient(45deg, #2ecc71, #27ae60)' : 
                                            i === subStage.current - 1 ? 'linear-gradient(45deg, #667eea, #764ba2)' : 
                                            '#e0e0e0'};
                                color: ${i <= subStage.current - 1 ? 'white' : '#999'};
                            ">
                                ${i + 1}
                            </div>
                        `).join('')}
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${(currentQuestionInStage / 15) * 100}%"></div>
                    </div>
                </div>
                
                <!-- Espacio de trabajo para Amaia (colapsable) -->
                <div class="workspace-container" style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="toggleWorkspace()" style="width: 100%; margin-bottom: 10px;">
                        <span id="workspaceToggleText">üìù Mostrar pizarra de trabajo</span>
                    </button>
                    <div class="workspace" id="workspaceArea" style="display: none;">
                        <div class="workspace-title">
                            <span>‚úèÔ∏è Mi pizarra de trabajo</span>
                            <div>
                                <button class="workspace-btn" onclick="changeColor('black')" style="background: #333;">üñ§</button>
                                <button class="workspace-btn" onclick="changeColor('blue')" style="background: #4169E1;">üíô</button>
                                <button class="workspace-btn" onclick="changeColor('red')" style="background: #DC143C;">‚ù§Ô∏è</button>
                                <button class="workspace-btn" onclick="changeColor('green')" style="background: #228B22;">üíö</button>
                                <button class="workspace-btn clear" onclick="clearCanvas()">üóëÔ∏è Limpiar</button>
                            </div>
                        </div>
                        <canvas id="workspaceCanvas" class="workspace-canvas" 
                                width="1000" height="400"
                                style="background: white; border-radius: 10px; cursor: crosshair; width: 100%; height: 400px; touch-action: none;">
                        </canvas>
                        <div class="workspace-tools">
                            <button class="workspace-btn" onclick="setMode('draw')" id="drawMode" style="background: linear-gradient(45deg, #667eea, #764ba2);">‚úèÔ∏è Dibujar</button>
                            <button class="workspace-btn" onclick="setMode('text')" id="textMode">üìù Texto</button>
                            <button class="workspace-btn" onclick="insertText('+')">+</button>
                            <button class="workspace-btn" onclick="insertText('-')">‚àí</button>
                            <button class="workspace-btn" onclick="insertText('√ó')">√ó</button>
                            <button class="workspace-btn" onclick="insertText('√∑')">√∑</button>
                            <button class="workspace-btn" onclick="insertText('=')">Ôºù</button>
                            <button class="workspace-btn" onclick="newLine()" style="background: linear-gradient(45deg, #3498db, #2980b9);">‚Üµ Nueva l√≠nea</button>
                        </div>
                        <div class="workspace-tools" style="margin-top: 5px;">
                            <button class="workspace-btn" onclick="insertText('0')">0</button>
                            <button class="workspace-btn" onclick="insertText('1')">1</button>
                            <button class="workspace-btn" onclick="insertText('2')">2</button>
                            <button class="workspace-btn" onclick="insertText('3')">3</button>
                            <button class="workspace-btn" onclick="insertText('4')">4</button>
                            <button class="workspace-btn" onclick="insertText('5')">5</button>
                            <button class="workspace-btn" onclick="insertText('6')">6</button>
                            <button class="workspace-btn" onclick="insertText('7')">7</button>
                            <button class="workspace-btn" onclick="insertText('8')">8</button>
                            <button class="workspace-btn" onclick="insertText('9')">9</button>
                            <button class="workspace-btn" onclick="insertText('  ')" style="background: linear-gradient(45deg, #95a5a6, #7f8c8d);">‚éµ Espacio</button>
                        </div>
                    </div>
                </div>
            `;

            switch(exercise.type) {
                case 'simple-operation':
                    html += renderSimpleOperation(exercise);
                    break;
                case 'comparison':
                    html += renderComparisonExercise(exercise);
                    break;
                case 'decomposition':
                    html += renderDecompositionExercise(exercise);
                    break;
                case 'multiplication':
                    html += renderMultiplicationExercise(exercise);
                    break;
                case 'division':
                    html += renderDivisionExercise(exercise);
                    break;
                case 'word-problem':
                    html += renderWordProblem(exercise);
                    break;
                case 'fraction-visual':
                    html += renderFractionVisual(exercise);
                    break;
                case 'fraction-comparison':
                    html += renderFractionComparison(exercise);
                    break;
                case 'fraction-addition':
                    html += renderFractionAddition(exercise);
                    break;
                case 'mixed-numbers':
                    html += renderMixedNumbers(exercise);
                    break;
                case 'decimal-fraction':
                    html += renderDecimalFraction(exercise);
                    break;
                // Nuevos tipos de fracciones
                case 'fraction-equivalent':
                case 'fraction-to-decimal':
                case 'decimal-to-percent':
                case 'fraction-order':
                    html += renderComparisonExercise(exercise);
                    break;
                case 'fraction-simplify':
                case 'mixed-to-improper':
                case 'fraction-of-number':
                case 'mixed-addition':
                    html += renderSimpleOperation(exercise);
                    break;
                case 'fraction-subtraction':
                    html += renderFractionAddition(exercise);
                    break;
                case 'fraction-multiplication':
                    html += renderFractionMultiplication(exercise);
                    break;
                case 'fraction-word-problem':
                    html += renderFractionWordProblem(exercise);
                    break;
                case 'shape-identification':
                    html += renderShapeIdentification(exercise);
                    break;
                case 'perimeter':
                    html += renderPerimeterExercise(exercise);
                    break;
                // Nuevos tipos de ejercicios
                case 'time-conversion':
                case 'mass-comparison':
                case 'data-organization':
                case 'probability':
                case 'time-calculation':
                case 'calendar':
                case 'length-comparison':
                case 'length-estimation':
                case 'area-comparison':
                case 'volume-comparison':
                case 'capacity-estimation':
                case 'mass-estimation':
                case 'temperature':
                case 'time-zones':
                case 'measurement-tools':
                case 'practical-measurement':
                case 'measurement-word-problem':
                case 'unit-relationships':
                    html += renderComparisonExercise(exercise);
                    break;
                case 'area':
                case 'volume':
                case 'pattern-next':
                case 'pattern-visual':
                case 'simple-equation':
                case 'balance':
                case 'function-machine':
                case 'pictogram':
                    html += renderSimpleOperation(exercise);
                    break;
                case 'frequency-table':
                    html += renderFrequencyTable(exercise);
                    break;
                case 'mode':
                case 'data-interpretation':
                case 'growing-pattern':
                case 'pattern-missing':
                case 'double-equation':
                case 'function-reverse':
                case 'input-output-table':
                case 'two-step-function':
                case 'age-problem':
                case 'money-problem':
                case 'distribution-problem':
                case 'perimeter-algebra':
                case 'number-puzzle':
                case 'sequence-sum':
                case 'mixed-operations':
                case 'pattern-multiplication':
                case 'word-equation':
                case 'comparison-algebra':
                case 'time-algebra':
                case 'pattern-skip-counting':
                case 'algebraic-thinking':
                case 'pattern-decreasing':
                case 'function-composition':
                case 'pattern-challenge':
                case 'algebra-word-problem':
                case 'time-word-problem':
                case 'length-conversion':
                case 'length-word-problem':
                case 'perimeter-measurement':
                case 'volume-word-problem':
                case 'mass-conversion':
                case 'mass-word-problem':
                case 'mixed-units':
                case 'speed-concept':
                case 'measurement-challenge':
                    html += renderSimpleOperation(exercise);
                    break;
                case 'bar-graph':
                    html += renderBarGraph(exercise);
                    break;
                case 'spinner':
                    html += renderSpinner(exercise);
                    break;
                case 'coordinates':
                    html += renderCoordinateGrid(exercise);
                    break;
                case 'transformation':
                    html += renderTransformation(exercise);
                    break;
                case 'pattern-geometric':
                    html += renderPatternGeometric(exercise);
                    break;
                case 'measurement-tools':
                    html += renderMeasurementTools(exercise);
                    break;
                case 'symmetry':
                case 'angles':
                case '3d-shapes':
                case '3d-to-2d':
                case 'volume-concept':
                case 'surface-area':
                    html += renderInteractiveGeometry(exercise);
                    break;
                case 'shape-properties':
                case 'area-concept':
                case 'perimeter-vs-area':
                case 'composite-shapes':
                case 'shape-decomposition':
                case 'geometry-word-problem':
                case 'spatial-reasoning':
                case 'tessellation':
                case 'measurement-estimation':
                case 'line-types':
                    html += renderSimpleOperation(exercise);
                    break;
                case 'shape-comparison':
                case 'pattern-rule':
                case 'pattern-table':
                case 'inequality':
                case 'coordinate-pattern':
                case 'pattern-geometric-shapes':
                case 'pattern-colors':
                case 'letter-pattern':
                    html += renderComparisonExercise(exercise);
                    break;
                // Nuevos tipos de datos y estad√≠stica
                case 'range':
                case 'prediction':
                case 'data-word-problem':
                case 'schedule-analysis':
                case 'voting':
                case 'conclusion':
                    html += renderSimpleOperation(exercise);
                    break;
                case 'spinner':
                case 'survey-design':
                case 'data-collection':
                case 'graph-interpretation':
                case 'data-comparison':
                case 'trend-analysis':
                    html += renderComparisonExercise(exercise);
                    break;
                default:
                    html += renderGenericExercise(exercise);
            }

            container.innerHTML = html;
        }

        function renderSimpleOperation(exercise) {
            // Si el ejercicio tiene una descripci√≥n visual, mostrarla
            const descriptionSection = exercise.description ? `
                <div style="background: #f8f9fa; padding: 20px; margin: 15px 0; border-radius: 10px; text-align: center; font-size: 1.5em;">
                    ${exercise.description}
                </div>
            ` : '';
            
            return `
                <div class="question-card">
                    <h3 style="font-size: 2em; text-align: center;">${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    ${descriptionSection}
                    <div style="text-align: center;">
                        <input type="number" class="math-input" id="simpleAnswer" 
                               style="width: 150px; font-size: 1.5em; text-align: center;"
                               onkeypress="if(event.key === 'Enter') checkSimpleOperation(${exercise.answer})">
                        <br><br>
                        <button class="btn" onclick="checkSimpleOperation(${exercise.answer})" 
                                style="font-size: 1.2em; padding: 10px 30px;">
                            Verificar ‚úì
                        </button>
                    </div>
                </div>
            `;
        }

        function renderComparisonExercise(exercise) {
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                        ${exercise.options.map((option, index) => `
                            <button class="btn" onclick="checkAnswer(${index}, ${exercise.correct})" style="font-size: 2em; padding: 20px 40px;">
                                ${option}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderDecompositionExercise(exercise) {
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div class="math-input-container" style="flex-direction: column;">
                        <div>
                            <label>Miles:</label>
                            <input type="number" class="math-input" id="miles" style="width: 100px;">
                        </div>
                        <div>
                            <label>Centenas:</label>
                            <input type="number" class="math-input" id="centenas" style="width: 100px;">
                        </div>
                        <div>
                            <label>Decenas:</label>
                            <input type="number" class="math-input" id="decenas" style="width: 100px;">
                        </div>
                        <div>
                            <label>Unidades:</label>
                            <input type="number" class="math-input" id="unidades" style="width: 100px;">
                        </div>
                    </div>
                    <button class="btn" onclick="checkDecomposition()">Verificar ‚úì</button>
                </div>
            `;
        }

        function renderMultiplicationExercise(exercise) {
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <h4>M√©todo Singapur - Resolvamos paso a paso:</h4>
                    <div class="step-checker">
                        ${exercise.steps.map((step, index) => `
                            <div class="step-checker" id="step${index}">
                                <p>Paso ${index + 1}: ${step.split('=')[0]} = </p>
                                <input type="number" class="math-input" id="stepInput${index}" onkeyup="checkStep(${index}, ${step.split('=')[1].trim()})">
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: 20px;">
                        <h4>Respuesta final:</h4>
                        <input type="number" class="math-input" id="finalAnswer" style="width: 150px; font-size: 1.5em;">
                        <button class="btn" onclick="checkMultiplication(${exercise.answer})">Verificar ‚úì</button>
                    </div>
                </div>
            `;
        }

        function renderWordProblem(exercise) {
            console.log('Renderizando problema:', exercise.question);
            
            // Determinar si es suma o resta
            const isAddition = exercise.question.includes('llegan') || exercise.question.includes('agrega') || exercise.question.includes('m√°s') || exercise.question.includes('total');
            const isSubtraction = exercise.question.includes('regala') || exercise.question.includes('quita') || exercise.question.includes('menos') || exercise.question.includes('quedan');
            
            console.log('Es suma?', isAddition, 'Es resta?', isSubtraction);
            
            // Extraer n√∫meros y contexto
            const nums = exercise.question.match(/\d+/g);
            const num1 = parseInt(nums[0]);
            const num2 = parseInt(nums[1]);
            
            // Determinar el tipo de objeto (stickers, estudiantes, etc.)
            let objectType = 'elementos';
            if (exercise.question.includes('sticker')) objectType = 'stickers';
            if (exercise.question.includes('estudiante')) objectType = 'estudiantes';
            if (exercise.question.includes('cancion') || exercise.question.includes('canciones')) objectType = 'canciones';
            
            let barModel = '';
            if (exercise.method === 'bar-model') {
                if (isSubtraction) {
                    // Modelo para resta
                    barModel = `
                        <div style="margin-bottom: 20px;">
                            <p style="margin-bottom: 5px;">Total inicial:</p>
                            <div style="background: linear-gradient(45deg, #667eea, #764ba2); height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                ${num1} ${objectType}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <p style="margin-bottom: 5px;">¬øC√≥mo se divide?</p>
                            <div style="display: flex; gap: 5px;">
                                <div style="background: linear-gradient(45deg, #ff6b6b, #ee5a50); height: 50px; border-radius: 10px; flex: ${num2}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                    Se van: ${num2}
                                </div>
                                <div style="background: linear-gradient(45deg, #4ecdc4, #44a08d); height: 50px; border-radius: 10px; flex: ${num1 - num2}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                    Quedan: ?
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: #f0f0f0; padding: 15px; border-radius: 10px; margin-top: 15px;">
                            <p style="font-weight: bold;">Operaci√≥n: ${num1} - ${num2} = ?</p>
                        </div>
                    `;
                } else if (isAddition) {
                    // Modelo para suma
                    barModel = `
                        <div style="margin-bottom: 20px;">
                            <p style="margin-bottom: 5px;">¬øC√≥mo se forma el total?</p>
                            <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                                <div style="background: linear-gradient(45deg, #667eea, #764ba2); height: 50px; border-radius: 10px; flex: ${num1}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                    Hay: ${num1}
                                </div>
                                <div style="background: linear-gradient(45deg, #4ecdc4, #44a08d); height: 50px; border-radius: 10px; flex: ${num2}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                    Llegan: ${num2}
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <p style="margin-bottom: 5px;">Total:</p>
                            <div style="background: linear-gradient(45deg, #ff6b6b, #ffd93d); height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                ? ${objectType} en total
                            </div>
                        </div>
                        
                        <div style="background: #f0f0f0; padding: 15px; border-radius: 10px; margin-top: 15px;">
                            <p style="font-weight: bold;">Operaci√≥n: ${num1} + ${num2} = ?</p>
                        </div>
                    `;
                }
            }
            
            return `
                <div class="question-card">
                    <h3>Problema:</h3>
                    <p style="font-size: 1.1em;">${exercise.question}</p>
                </div>
                <div class="interactive-question">
                    ${exercise.method === 'bar-model' ? `
                        <div class="bar-canvas-container">
                            <h4>Modelo de barras - M√©todo Singapur:</h4>
                            <p style="margin: 10px 0;">Representemos el problema visualmente:</p>
                            <div style="background: white; padding: 20px; border-radius: 10px;">
                                ${barModel}
                            </div>
                        </div>
                    ` : ''}
                    <div style="margin-top: 20px;">
                        <h4>Tu respuesta:</h4>
                        <input type="number" class="math-input" id="problemAnswer" style="width: 150px; font-size: 1.5em;">
                        <span style="font-size: 1.2em;"> ${objectType}</span>
                        <button class="btn" onclick="checkWordProblem(${exercise.answer})">Verificar ‚úì</button>
                    </div>
                </div>
            `;
        }

        function renderFractionVisual(exercise) {
            const svgId = 'fractionVisual' + Date.now();
            setTimeout(() => drawFractionVisual(svgId, exercise), 100);
            
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div id="${svgId}" style="display: flex; justify-content: center; margin: 20px 0;"></div>
                    <div>
                        <input type="text" class="math-input" id="fractionAnswer" placeholder="ej: 3/8" style="width: 100px;">
                        <button class="btn" onclick="checkFraction('${exercise.answer}')">Verificar ‚úì</button>
                    </div>
                </div>
            `;
        }

        function drawFractionVisual(containerId, exercise) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (exercise.visual === 'pizza') {
                const svg = `
                    <svg width="200" height="200" viewBox="0 0 200 200">
                        ${Array.from({length: exercise.parts}).map((_, i) => {
                            const angle = (360 / exercise.parts) * i;
                            const isColored = i < exercise.colored;
                            return `
                                <path d="M 100 100 L ${100 + 80 * Math.cos((angle - 90) * Math.PI / 180)} ${100 + 80 * Math.sin((angle - 90) * Math.PI / 180)} A 80 80 0 0 1 ${100 + 80 * Math.cos((angle + 360/exercise.parts - 90) * Math.PI / 180)} ${100 + 80 * Math.sin((angle + 360/exercise.parts - 90) * Math.PI / 180)} Z"
                                      fill="${isColored ? '#ff6b6b' : '#f0f0f0'}"
                                      stroke="#333"
                                      stroke-width="2"/>
                            `;
                        }).join('')}
                    </svg>
                `;
                container.innerHTML = svg;
            }
        }

        function checkAnswer(selected, correct) {
            if (selected === correct) {
                showFeedback(true, 'correct');
                appState.correctAnswers++;
                appState.points += 10;
                appState.currentAttempts = 0;
                appState.showingStepByStep = false;
                setTimeout(nextExercise, 2000);
            } else {
                appState.currentAttempts++;
                
                if (appState.currentAttempts >= 3 && !appState.showingStepByStep) {
                    showStepByStepOption();
                } else if (appState.currentAttempts === 2) {
                    const exercise = appState.exercises[appState.currentExercise];
                    showFeedback(false, 'hint', exercise.explanation || '¬°Piensa bien en las opciones!');
                } else {
                    showFeedback(false, 'tryAgain');
                }
            }
            updateUI();
        }

        function checkSimpleOperation(correctAnswer) {
            // Buscar el input correcto seg√∫n el tipo de ejercicio
            let answer = 0;
            if (document.getElementById('simpleAnswer')) {
                answer = parseInt(document.getElementById('simpleAnswer').value);
            } else if (document.getElementById('graphAnswer')) {
                answer = parseInt(document.getElementById('graphAnswer').value);
            } else if (document.getElementById('shapesAnswer')) {
                answer = parseInt(document.getElementById('shapesAnswer').value);
            } else if (document.getElementById('tableAnswer')) {
                answer = parseInt(document.getElementById('tableAnswer').value);
            }
            
            if (answer === correctAnswer) {
                showFeedback(true, 'excellent');
                appState.correctAnswers++;
                appState.points += 10;
                appState.currentAttempts = 0;
                appState.showingStepByStep = false;
                setTimeout(nextExercise, 2000);
            } else if (isNaN(answer) || answer === '') {
                showFeedback(false, 'hint', 'Por favor, escribe tu respuesta');
            } else {
                appState.currentAttempts++;
                
                if (appState.currentAttempts >= 3 && !appState.showingStepByStep) {
                    // Despu√©s de 3 intentos, ofrecer ayuda paso a paso
                    showStepByStepOption();
                } else if (appState.currentAttempts === 2) {
                    // En el segundo intento, dar una pista
                    const exercise = appState.exercises[appState.currentExercise];
                    showFeedback(false, 'hint', exercise.explanation || '¬°Sigue intentando! Puedes hacerlo');
                } else {
                    showFeedback(false, 'tryAgain');
                }
            }
            updateUI();
        }

        function checkDecomposition() {
            const exercise = appState.exercises[appState.currentExercise];
            const miles = parseInt(document.getElementById('miles').value) || 0;
            const centenas = parseInt(document.getElementById('centenas').value) || 0;
            const decenas = parseInt(document.getElementById('decenas').value) || 0;
            const unidades = parseInt(document.getElementById('unidades').value) || 0;
            
            if (miles === exercise.answer.miles && 
                centenas === exercise.answer.centenas && 
                decenas === exercise.answer.decenas && 
                unidades === exercise.answer.unidades) {
                showFeedback(true, 'excellent');
                appState.correctAnswers++;
                appState.points += 15;
                appState.currentAttempts = 0;
                appState.showingStepByStep = false;
                setTimeout(nextExercise, 2000);
            } else {
                appState.currentAttempts++;
                
                if (appState.currentAttempts >= 3 && !appState.showingStepByStep) {
                    showStepByStepOption();
                } else if (appState.currentAttempts === 2) {
                    showFeedback(false, 'hint', exercise.explanation || 'Piensa en cada posici√≥n del n√∫mero');
                } else {
                    showFeedback(false, 'hint', exercise.explanation);
                }
            }
            updateUI();
        }

        function checkStep(stepIndex, correctValue) {
            const input = document.getElementById(`stepInput${stepIndex}`);
            const stepDiv = document.getElementById(`step${stepIndex}`);
            
            if (parseInt(input.value) === correctValue) {
                stepDiv.classList.add('correct');
                stepDiv.classList.remove('incorrect');
            } else if (input.value !== '') {
                stepDiv.classList.add('incorrect');
                stepDiv.classList.remove('correct');
            }
        }

        function checkMultiplication(correctAnswer) {
            const answer = parseInt(document.getElementById('finalAnswer').value);
            
            if (answer === correctAnswer) {
                showFeedback(true, 'amazing');
                appState.correctAnswers++;
                appState.points += 20;
                appState.currentAttempts = 0;
                appState.showingStepByStep = false;
                setTimeout(nextExercise, 2000);
            } else {
                appState.currentAttempts++;
                
                if (appState.currentAttempts >= 3 && !appState.showingStepByStep) {
                    showStepByStepOption();
                } else if (appState.currentAttempts === 2) {
                    const exercise = appState.exercises[appState.currentExercise];
                    showFeedback(false, 'hint', exercise.explanation || 'Revisa cada paso de la multiplicaci√≥n');
                } else {
                    showFeedback(false, 'tryAgain');
                }
            }
            updateUI();
        }

        function checkWordProblem(correctAnswer) {
            const answer = parseInt(document.getElementById('problemAnswer').value);
            
            if (answer === correctAnswer) {
                showFeedback(true, 'fantastic');
                appState.correctAnswers++;
                appState.points += 25;
                appState.currentAttempts = 0;
                appState.showingStepByStep = false;
                setTimeout(nextExercise, 2000);
            } else {
                appState.currentAttempts++;
                
                if (appState.currentAttempts >= 3 && !appState.showingStepByStep) {
                    showStepByStepOption();
                } else if (appState.currentAttempts === 2) {
                    const exercise = appState.exercises[appState.currentExercise];
                    showFeedback(false, 'hint', exercise.explanation || '¬øQu√© operaci√≥n necesitas hacer?');
                } else {
                    showFeedback(false, 'hint', 'Recuerda: ¬øQu√© operaci√≥n necesitas hacer?');
                }
            }
            updateUI();
        }

        function checkFraction(correctAnswer) {
            // Buscar el input correcto seg√∫n el tipo de ejercicio
            let answer = '';
            if (document.getElementById('fractionAddAnswer')) {
                answer = document.getElementById('fractionAddAnswer').value.trim();
            } else if (document.getElementById('fractionAnswer')) {
                answer = document.getElementById('fractionAnswer').value.trim();
            } else if (document.getElementById('decimalAnswer')) {
                answer = document.getElementById('decimalAnswer').value.trim();
            }
            
            if (answer === correctAnswer) {
                showFeedback(true, 'perfect');
                appState.correctAnswers++;
                appState.points += 15;
                appState.currentAttempts = 0;
                appState.showingStepByStep = false;
                setTimeout(nextExercise, 2000);
            } else {
                appState.currentAttempts++;
                
                if (appState.currentAttempts >= 3 && !appState.showingStepByStep) {
                    showStepByStepOption();
                } else if (appState.currentAttempts === 2) {
                    const exercise = appState.exercises[appState.currentExercise];
                    showFeedback(false, 'hint', exercise.explanation || 'Revisa numerador y denominador');
                } else {
                    showFeedback(false, 'hint', 'Cuenta las partes coloreadas y el total de partes');
                }
            }
            updateUI();
        }
        
        function checkFractionProblem(stringAnswer, numAnswer) {
            const inputValue = document.getElementById('problemAnswer').value.trim();
            let isCorrect = false;
            
            if (typeof numAnswer === 'number') {
                isCorrect = parseFloat(inputValue) === numAnswer;
            } else {
                isCorrect = inputValue === stringAnswer;
            }
            
            if (isCorrect) {
                showFeedback(true, 'excellent');
                appState.correctAnswers++;
                appState.points += 15;
                appState.currentAttempts = 0;
                appState.showingStepByStep = false;
                setTimeout(nextExercise, 2000);
            } else {
                appState.currentAttempts++;
                
                if (appState.currentAttempts >= 3 && !appState.showingStepByStep) {
                    showStepByStepOption();
                } else if (appState.currentAttempts === 2) {
                    const exercise = appState.exercises[appState.currentExercise];
                    showFeedback(false, 'hint', exercise.explanation || 'Piensa en qu√© fracci√≥n representa');
                } else {
                    showFeedback(false, 'tryAgain');
                }
            }
            updateUI();
        }

        function showFeedback(isCorrect, type, message = '') {
            const feedbackMessages = {
                correct: ['¬°Correcto! üëç', '¬°Bien hecho! ‚≠ê', '¬°Exacto! ‚ú®'],
                excellent: ['¬°Excelente! üåü', '¬°Brillante! üí´', '¬°Fant√°stico! üéØ'],
                amazing: ['¬°Incre√≠ble! üöÄ', '¬°Eres genial! üåà', '¬°Asombroso! üéâ'],
                fantastic: ['¬°Espectacular! üèÜ', '¬°Maravilloso! üéä', '¬°Sobresaliente! üíé'],
                perfect: ['¬°Perfecto! üíØ', '¬°Impecable! üåü', '¬°Sin errores! üéØ'],
                tryAgain: ['Intenta de nuevo üí™', 'Casi lo tienes ü§î', 'Sigue intentando üìö'],
                hint: [message || 'Piensa un poco m√°s ü§ì', message || 'Revisa con cuidado üîç']
            };
            
            const messages = feedbackMessages[type] || feedbackMessages.correct;
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            
            // Crear elemento de feedback
            const feedback = document.createElement('div');
            feedback.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: ${isCorrect ? 'linear-gradient(45deg, #4CAF50, #45a049)' : 'linear-gradient(45deg, #ff9800, #f57c00)'};
                color: white;
                padding: 20px 40px;
                border-radius: 20px;
                font-size: 1.5em;
                font-weight: bold;
                z-index: 1000;
                animation: ${isCorrect ? 'bounce' : 'shake'} 0.5s;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            `;
            feedback.textContent = randomMessage;
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                feedback.remove();
            }, 2000);
            
            // Agregar animaci√≥n shake si es incorrecto
            if (!isCorrect) {
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes shake {
                        0%, 100% { transform: translate(-50%, -50%) translateX(0); }
                        25% { transform: translate(-50%, -50%) translateX(-10px); }
                        75% { transform: translate(-50%, -50%) translateX(10px); }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function showStepByStepOption() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 20px;
                padding: 30px;
                text-align: center;
                max-width: 500px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            `;
            
            content.innerHTML = `
                <h2 style="color: #667eea; margin-bottom: 20px;">¬øNecesitas ayuda? ü§î</h2>
                <p style="font-size: 1.1em; margin-bottom: 20px;">
                    Has intentado 3 veces. ¬øTe gustar√≠a ver la soluci√≥n paso a paso?
                </p>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn" style="background: linear-gradient(45deg, #4CAF50, #45a049);" 
                            onclick="showStepByStepSolution(); this.parentElement.parentElement.parentElement.remove();">
                        S√≠, mu√©strame los pasos üìù
                    </button>
                    <button class="btn" style="background: linear-gradient(45deg, #ff9800, #f57c00);" 
                            onclick="this.parentElement.parentElement.parentElement.remove();">
                        No, seguir√© intentando üí™
                    </button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        function showStepByStepSolution() {
            appState.showingStepByStep = true;
            const exercise = appState.exercises[appState.currentExercise];
            
            // Si el ejercicio no tiene pasos definidos, generar autom√°ticamente
            if (!exercise.stepByStep) {
                exercise.stepByStep = generateStepByStep(exercise);
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                overflow-y: auto;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 20px;
                padding: 30px;
                max-width: 600px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            `;
            
            const stepsHTML = exercise.stepByStep.map((step, index) => `
                <div style="
                    background: #f8f9fa;
                    border-left: 4px solid #667eea;
                    padding: 15px;
                    margin-bottom: 15px;
                    border-radius: 5px;
                    animation: fadeIn 0.5s ease-in-out ${index * 0.2}s both;
                ">
                    <strong style="color: #667eea;">Paso ${index + 1}:</strong> ${step}
                </div>
            `).join('');
            
            content.innerHTML = `
                <h2 style="color: #667eea; margin-bottom: 20px;">Soluci√≥n Paso a Paso üìö</h2>
                <div style="margin-bottom: 20px;">
                    <strong>Pregunta:</strong> ${exercise.question}
                </div>
                ${stepsHTML}
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn glow" onclick="this.parentElement.parentElement.parentElement.remove();">
                        Entendido, lo intentar√© ‚ú®
                    </button>
                </div>
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; transform: translateY(10px); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                </style>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Reiniciar los intentos para que pueda intentar nuevamente
            appState.currentAttempts = 0;
        }

        function generateStepByStep(exercise) {
            // Generar pasos autom√°ticamente seg√∫n el tipo de ejercicio
            const steps = [];
            
            if (exercise.type === 'simple-operation') {
                const match = exercise.question.match(/(\d+)\s*([\+\-\√ó√∑])\s*(\d+)/);
                if (match) {
                    const num1 = parseInt(match[1]);
                    const operator = match[2];
                    const num2 = parseInt(match[3]);
                    
                    switch(operator) {
                        case '+':
                            if (num1 + num2 > 100) {
                                steps.push(`Identifica los n√∫meros: ${num1} y ${num2}`);
                                const unidades = (num1 % 10) + (num2 % 10);
                                steps.push(`Suma las unidades: ${num1 % 10} + ${num2 % 10} = ${unidades}`);
                                if (unidades >= 10) {
                                    steps.push(`Como ${unidades} es mayor que 10, llevamos 1 a las decenas`);
                                }
                                const decenas = Math.floor(num1/10) + Math.floor(num2/10) + (unidades >= 10 ? 1 : 0);
                                steps.push(`Suma las decenas: ${Math.floor(num1/10)} + ${Math.floor(num2/10)}${unidades >= 10 ? ' + 1' : ''} = ${decenas}`);
                                steps.push(`Respuesta final: ${num1} + ${num2} = ${num1 + num2}`);
                            } else {
                                steps.push(`Identifica los n√∫meros: ${num1} y ${num2}`);
                                steps.push(`Suma directamente: ${num1} + ${num2} = ${num1 + num2}`);
                            }
                            break;
                        case '-':
                            steps.push(`Identifica los n√∫meros: ${num1} (minuendo) y ${num2} (sustraendo)`);
                            if (num1 > 100 && num2 > 10) {
                                steps.push(`Resta las unidades: ${num1 % 10} - ${num2 % 10} = ${(num1 % 10) - (num2 % 10)}`);
                                steps.push(`Resta las decenas: ${Math.floor(num1/10)} - ${Math.floor(num2/10)} = ${Math.floor(num1/10) - Math.floor(num2/10)}`);
                            }
                            steps.push(`Resultado: ${num1} - ${num2} = ${num1 - num2}`);
                            break;
                        case '√ó':
                            steps.push(`Identifica los n√∫meros: ${num1} y ${num2}`);
                            if (num2 === 10) {
                                steps.push(`Multiplicar por 10: agrega un cero al final de ${num1}`);
                            } else if (num1 > 10 || num2 > 10) {
                                steps.push(`Puedes descomponer: ${num1} √ó ${num2}`);
                            }
                            steps.push(`Resultado: ${num1} √ó ${num2} = ${num1 * num2}`);
                            break;
                        case '√∑':
                            steps.push(`Identifica los n√∫meros: ${num1} (dividendo) y ${num2} (divisor)`);
                            steps.push(`Piensa: ¬øCu√°ntas veces cabe ${num2} en ${num1}?`);
                            const cociente = Math.floor(num1 / num2);
                            const resto = num1 % num2;
                            steps.push(`${num2} √ó ${cociente} = ${num2 * cociente}`);
                            if (resto > 0) {
                                steps.push(`Sobran ${resto}`);
                            }
                            steps.push(`Respuesta: ${num1} √∑ ${num2} = ${cociente}${resto > 0 ? ` con resto ${resto}` : ''}`);
                            break;
                    }
                }
            } else if (exercise.type === 'decomposition') {
                const num = exercise.number || exercise.answer;
                steps.push(`El n√∫mero a descomponer es: ${num}`);
                steps.push(`Miles: ${Math.floor(num/1000)} (${Math.floor(num/1000) * 1000})`);
                steps.push(`Centenas: ${Math.floor((num%1000)/100)} (${Math.floor((num%1000)/100) * 100})`);
                steps.push(`Decenas: ${Math.floor((num%100)/10)} (${Math.floor((num%100)/10) * 10})`);
                steps.push(`Unidades: ${num%10}`);
                steps.push(`Verificaci√≥n: ${Math.floor(num/1000)*1000} + ${Math.floor((num%1000)/100)*100} + ${Math.floor((num%100)/10)*10} + ${num%10} = ${num}`);
            } else if (exercise.type === 'multiplication' && exercise.steps) {
                steps.push(`Multiplicaci√≥n: ${exercise.question}`);
                exercise.steps.forEach(step => steps.push(step));
            } else if (exercise.type === 'word-problem') {
                steps.push('Lee el problema cuidadosamente');
                steps.push('Identifica los datos importantes');
                steps.push('Decide qu√© operaci√≥n usar');
                steps.push('Realiza el c√°lculo');
                steps.push(`Respuesta: ${exercise.answer}`);
            } else if (exercise.type === 'comparison') {
                steps.push('Para comparar n√∫meros:');
                steps.push('1. Compara primero la parte entera');
                steps.push('2. Si son iguales, compara los d√©cimos');
                steps.push('3. Si son iguales, compara los cent√©simos');
                steps.push(`El mayor es: ${exercise.options[exercise.correct]}`);
            } else if (exercise.type === 'fraction-visual') {
                steps.push('Observa la figura coloreada');
                steps.push('Cuenta las partes pintadas (numerador)');
                steps.push('Cuenta el total de partes (denominador)');
                steps.push(`Escribe: partes pintadas/total de partes`);
                steps.push(`Respuesta: ${exercise.answer}`);
            } else if (exercise.type === 'perimeter') {
                steps.push(`Figura: ${exercise.question}`);
                steps.push('El per√≠metro es la suma de todos los lados');
                if (exercise.width && exercise.height) {
                    steps.push(`Lados: ${exercise.width} + ${exercise.height} + ${exercise.width} + ${exercise.height}`);
                    steps.push(`Per√≠metro = 2 √ó (${exercise.width} + ${exercise.height})`);
                }
                steps.push(`Resultado: ${exercise.answer} cm`);
            } else {
                // Pasos gen√©ricos mejorados
                steps.push('Lee la pregunta con atenci√≥n');
                if (exercise.explanation) {
                    steps.push(`Pista: ${exercise.explanation}`);
                }
                steps.push('Piensa en lo que has aprendido sobre este tema');
                steps.push(`La respuesta correcta es: ${exercise.answer || exercise.options?.[exercise.correct] || 'Ver opciones'}`);
            }
            
            return steps;
        }

        function nextExercise() {
            appState.currentExercise++;
            appState.currentAttempts = 0;
            appState.showingStepByStep = false;
            
            // Verificar si completamos una sub-etapa (cada 15 preguntas)
            const subStage = appState.subStageProgress[appState.currentUnit];
            
            // Verificar si hemos completado 15 preguntas (una sub-etapa)
            if (appState.currentExercise > 0 && appState.currentExercise % 15 === 0) {
                // Completamos una sub-etapa
                subStage.completed++;
                
                // Mostrar celebraci√≥n de sub-etapa
                showSubStageCelebration(() => {
                    if (appState.currentExercise < appState.exercises.length) {
                        // Avanzar a la siguiente sub-etapa
                        subStage.current++;
                        subStage.questionsInStage = 0;
                        showExercise();
                    } else {
                        showResults();
                    }
                });
            } else {
                // Continuar con el siguiente ejercicio
                subStage.questionsInStage = (appState.currentExercise % 15);
                if (appState.currentExercise < appState.exercises.length) {
                    showExercise();
                } else {
                    showResults();
                }
            }
            
            saveProgress();
        }
        
        function showSubStageCelebration(callback) {
            const celebration = document.createElement('div');
            celebration.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 20px;
                padding: 40px;
                text-align: center;
                transform: scale(0);
                transition: transform 0.5s ease;
            `;
            
            const subStage = appState.subStageProgress[appState.currentUnit];
            const totalStages = Math.ceil(appState.exercises.length / 15);
            
            content.innerHTML = `
                <div style="font-size: 5em; margin-bottom: 20px;">üéâ</div>
                <h2 style="color: #667eea; margin-bottom: 20px;">¬°Sub-etapa ${subStage.completed} Completada!</h2>
                <p style="font-size: 1.2em; margin-bottom: 10px;">¬°Excelente trabajo, Amaia!</p>
                <p style="margin-bottom: 20px;">Has completado ${subStage.completed} de ${totalStages} sub-etapas</p>
                <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 30px;">
                    ${Array.from({length: totalStages}, (_, i) => `
                        <div style="
                            width: 40px;
                            height: 40px;
                            border-radius: 50%;
                            background: ${i < subStage.completed ? 'linear-gradient(45deg, #2ecc71, #27ae60)' : '#e0e0e0'};
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: ${i < subStage.completed ? 'white' : '#999'};
                            font-weight: bold;
                        ">
                            ${i < subStage.completed ? '‚úì' : i + 1}
                        </div>
                    `).join('')}
                </div>
                <button class="btn glow" onclick="this.parentElement.parentElement.remove(); (${callback.toString()})()">
                    ¬°Continuar! üöÄ
                </button>
            `;
            
            celebration.appendChild(content);
            document.body.appendChild(celebration);
            
            // Animar entrada
            setTimeout(() => {
                content.style.transform = 'scale(1)';
            }, 100);
            
            // Agregar puntos bonus por completar sub-etapa
            appState.points += 50;
            updateUI();
        }

        function showResults() {
            showScreen('results');
            
            const percentage = Math.round((appState.correctAnswers / appState.totalQuestions) * 100);
            const resultTitle = document.getElementById('resultTitle');
            const resultMessage = document.getElementById('resultMessage');
            const progressBar = document.getElementById('progressBar');
            
            if (percentage >= 80) {
                resultTitle.textContent = '¬°Excelente trabajo, Amaia! üèÜ';
                resultMessage.textContent = `Respondiste correctamente ${appState.correctAnswers} de ${appState.totalQuestions} preguntas. ¬°Eres una campeona!`;
                addAchievement('üèÜ Experta');
            } else if (percentage >= 60) {
                resultTitle.textContent = '¬°Muy bien, Amaia! ‚≠ê';
                resultMessage.textContent = `Respondiste correctamente ${appState.correctAnswers} de ${appState.totalQuestions} preguntas. ¬°Sigue as√≠!`;
                addAchievement('‚≠ê Aprendiz');
            } else {
                resultTitle.textContent = '¬°Buen intento, Amaia! üí™';
                resultMessage.textContent = `Respondiste correctamente ${appState.correctAnswers} de ${appState.totalQuestions} preguntas. ¬°La pr√°ctica hace al maestro!`;
            }
            
            progressBar.style.width = percentage + '%';
            
            // Actualizar progreso de la unidad
            if (appState.currentUnit) {
                appState.progress[appState.currentUnit] = Math.min(100, appState.progress[appState.currentUnit] + 10);
                saveProgress();
            }
        }

        function addAchievement(achievement) {
            if (!appState.achievements.includes(achievement)) {
                appState.achievements.push(achievement);
                updateAchievements();
                
                // Mostrar notificaci√≥n
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(45deg, #ffd700, #ffed4a);
                    color: #333;
                    padding: 15px 25px;
                    border-radius: 20px;
                    font-weight: bold;
                    animation: slideIn 0.5s;
                    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
                `;
                notification.textContent = '¬°Nuevo logro: ' + achievement + '!';
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        }

        function updateAchievements() {
            const container = document.getElementById('achievements');
            container.innerHTML = appState.achievements.map(achievement => 
                `<div class="achievement">${achievement}</div>`
            ).join('');
        }

        function updateUI() {
            document.getElementById('pointsDisplay').textContent = appState.points + ' puntos';
            updateAchievements();
        }

        function saveProgress() {
            localStorage.setItem('mathAmaiaProgress', JSON.stringify(appState));
        }

        function loadProgress() {
            const saved = localStorage.getItem('mathAmaiaProgress');
            if (saved) {
                try {
                    const savedState = JSON.parse(saved);
                    // Solo cargar ciertos campos, no todo el estado
                    appState.points = savedState.points || 0;
                    appState.achievements = savedState.achievements || [];
                    appState.progress = savedState.progress || {
                        numeros: 20,
                        fracciones: 0,
                        geometria: 0,
                        medicion: 0,
                        algebra: 0,
                        datos: 0
                    };
                    appState.hasPersonalized = savedState.hasPersonalized || false;
                    appState.interests = savedState.interests || {};
                    appState.subStageProgress = savedState.subStageProgress || {
                        numeros: { current: 1, completed: 0, questionsInStage: 0 },
                        fracciones: { current: 1, completed: 0, questionsInStage: 0 },
                        geometria: { current: 1, completed: 0, questionsInStage: 0 },
                        medicion: { current: 1, completed: 0, questionsInStage: 0 },
                        algebra: { current: 1, completed: 0, questionsInStage: 0 },
                        datos: { current: 1, completed: 0, questionsInStage: 0 }
                    };
                    updateUI();
                } catch (e) {
                    console.error('Error al cargar progreso:', e);
                }
            }
        }

        function resetProgress() {
            if (confirm('¬øEst√°s segura de que quieres reiniciar todo tu progreso? Esto borrar√° tus puntos, logros y preferencias.')) {
                localStorage.removeItem('mathAmaiaProgress');
                // Reiniciar el estado
                appState = {
                    currentScreen: 'welcome',
                    currentUnit: null,
                    currentExercise: 0,
                    points: 0,
                    achievements: [],
                    progress: {
                        numeros: 20,
                        fracciones: 0,
                        geometria: 0,
                        medicion: 0,
                        algebra: 0,
                        datos: 0
                    },
                    exercises: [],
                    correctAnswers: 0,
                    totalQuestions: 0,
                    interests: {},
                    personalizationStep: 1,
                    hasPersonalized: false,
                    feedback: {}
                };
                updateUI();
                showWelcome();
                alert('¬°Tu progreso ha sido reiniciado! Ahora puedes empezar de nuevo.');
            }
        }

        // Funciones auxiliares para ejercicios espec√≠ficos
        function renderDivisionExercise(exercise) {
            // Extraer los n√∫meros de la pregunta
            const nums = exercise.question.match(/\d+/g);
            const dividend = parseInt(nums[0]);
            const divisor = parseInt(nums[1]);
            
            // Calcular los pasos seg√∫n el ejercicio espec√≠fico
            let steps = '';
            
            if (dividend === 156 && divisor === 12) {
                steps = `
                    <p>${dividend} √∑ ${divisor} = ?</p>
                    <p style="margin-top: 10px;">Pensemos: ¬øCu√°ntas veces cabe ${divisor} en ${dividend}?</p>
                    <div style="margin: 15px 0;">
                        <p>${divisor} √ó 10 = 120</p>
                        <p>${dividend} - 120 = 36</p>
                        <p>${divisor} √ó 3 = 36</p>
                        <p>Entonces: 10 + 3 = 13</p>
                    </div>
                `;
            } else if (dividend === 144 && divisor === 16) {
                steps = `
                    <p>${dividend} √∑ ${divisor} = ?</p>
                    <p style="margin-top: 10px;">Pensemos: ¬øCu√°ntas veces cabe ${divisor} en ${dividend}?</p>
                    <div style="margin: 15px 0;">
                        <p>${divisor} √ó 9 = 144</p>
                        <p>${dividend} - 144 = 0</p>
                        <p>Entonces: ${divisor} cabe exactamente 9 veces en ${dividend}</p>
                    </div>
                `;
            }
            
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <h4>M√©todo Singapur - Divisi√≥n por descomposici√≥n:</h4>
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin: 15px 0;">
                        ${steps}
                    </div>
                    <div style="margin-top: 20px;">
                        <h4>Tu respuesta:</h4>
                        <input type="number" class="math-input" id="divisionAnswer" style="width: 100px;">
                        <button class="btn" onclick="checkDivision(${exercise.answer})">Verificar ‚úì</button>
                    </div>
                </div>
            `;
        }

        function renderGenericExercise(exercise) {
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <p>Este ejercicio est√° en desarrollo...</p>
                    <button class="btn" onclick="nextExercise()">Continuar</button>
                </div>
            `;
        }

        function renderBarGraph(exercise) {
            const maxValue = Math.max(...Object.values(exercise.data));
            const scale = 200 / maxValue;
            
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 10px;">
                        <h4>Gr√°fico de Barras:</h4>
                        <div style="display: flex; align-items: flex-end; gap: 20px; height: 250px; margin: 20px 0;">
                            ${Object.entries(exercise.data).map(([label, value]) => `
                                <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                                    <div style="background: linear-gradient(45deg, #667eea, #764ba2); width: 100%; height: ${value * scale}px; border-radius: 5px 5px 0 0; position: relative;">
                                        <span style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-weight: bold;">${value}</span>
                                    </div>
                                    <div style="padding: 10px 5px; text-align: center; font-size: 0.9em;">${label}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ${exercise.options ? `
                        <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-top: 20px;">
                            ${exercise.options.map((option, index) => `
                                <button class="btn" onclick="checkAnswer(${index}, ${exercise.correct})" style="padding: 10px 20px;">
                                    ${option}
                                </button>
                            `).join('')}
                        </div>
                    ` : `
                        <div style="text-align: center; margin-top: 20px;">
                            <input type="number" class="math-input" id="graphAnswer" style="width: 100px;">
                            <button class="btn" onclick="checkSimpleOperation(${exercise.answer})">Verificar ‚úì</button>
                        </div>
                    `}
                </div>
            `;
        }

        function renderFrequencyTable(exercise) {
            const table = exercise.table;
            
            // Determinar si es una tabla de conteo o una tabla de valores
            const isCountingTable = Object.values(table).some(v => typeof v === 'string');
            let tableContent = '';
            
            if (isCountingTable) {
                // Para tablas donde hay que contar ocurrencias
                const counts = {};
                Object.values(table).forEach(value => {
                    counts[value] = (counts[value] || 0) + 1;
                });
                
                tableContent = `
                    <table style="border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <thead>
                            <tr style="background: linear-gradient(45deg, #667eea, #764ba2); color: white;">
                                <th style="border: 1px solid #ddd; padding: 12px;">D√≠a</th>
                                <th style="border: 1px solid #ddd; padding: 12px;">Clima</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(table).map(([day, weather]) => `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 10px;">${day}</td>
                                    <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">
                                        ${weather === 'Sol' ? '‚òÄÔ∏è' : 'üåßÔ∏è'} ${weather}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <p style="margin-top: 10px; font-style: italic;">Cuenta cu√°ntas veces aparece cada tipo</p>
                `;
            } else {
                // Para tablas con valores num√©ricos
                tableContent = `
                    <table style="border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: linear-gradient(45deg, #667eea, #764ba2); color: white;">
                                <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">Categor√≠a</th>
                                <th style="border: 1px solid #ddd; padding: 12px; text-align: center;">Cantidad</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(table).map(([label, value]) => `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 10px; text-align: left;">${label}</td>
                                    <td style="border: 1px solid #ddd; padding: 10px; text-align: center; font-weight: bold;">${value}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            let inputSection = '';
            if (exercise.options) {
                // Opci√≥n m√∫ltiple
                inputSection = `
                    <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                        ${exercise.options.map((option, index) => `
                            <button class="btn" onclick="checkAnswer(${index}, ${exercise.correct})">
                                ${option}
                            </button>
                        `).join('')}
                    </div>
                `;
            } else {
                // Respuesta num√©rica
                inputSection = `
                    <div style="text-align: center;">
                        <input type="number" class="math-input" id="tableAnswer" placeholder="?" style="width: 100px;">
                        <button class="btn" onclick="checkSimpleOperation(${exercise.answer})">Verificar ‚úì</button>
                    </div>
                `;
            }
            
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div style="display: flex; justify-content: center; margin: 20px 0;">
                        ${tableContent}
                    </div>
                    ${inputSection}
                </div>
            `;
        }

        function renderSpinner(exercise) {
            // Extraer informaci√≥n de la ruleta de la pregunta
            const match = exercise.question.match(/(\d+)\s*secciones?\s*rojas?\s*y\s*(\d+)\s*azul/i);
            const redSections = match ? parseInt(match[1]) : 3;
            const blueSections = match ? parseInt(match[2]) : 1;
            const totalSections = redSections + blueSections;
            
            // Crear SVG de la ruleta
            const centerX = 150;
            const centerY = 150;
            const radius = 120;
            const anglePerSection = (2 * Math.PI) / totalSections;
            
            let svgPaths = '';
            let currentAngle = -Math.PI / 2; // Empezar desde arriba
            
            for (let i = 0; i < totalSections; i++) {
                const isRed = i < redSections;
                const x1 = centerX + radius * Math.cos(currentAngle);
                const y1 = centerY + radius * Math.sin(currentAngle);
                const x2 = centerX + radius * Math.cos(currentAngle + anglePerSection);
                const y2 = centerY + radius * Math.sin(currentAngle + anglePerSection);
                
                svgPaths += `
                    <path d="M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 0 1 ${x2} ${y2} Z"
                          fill="${isRed ? '#ff6b6b' : '#4ecdc4'}"
                          stroke="#333"
                          stroke-width="2"/>
                `;
                currentAngle += anglePerSection;
            }
            
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div style="display: flex; justify-content: center; margin: 20px 0;">
                        <svg width="300" height="300" viewBox="0 0 300 300">
                            ${svgPaths}
                            <circle cx="${centerX}" cy="${centerY}" r="10" fill="#333"/>
                            <line x1="${centerX}" y1="${centerY}" x2="${centerX}" y2="${centerY - radius + 10}" 
                                  stroke="#333" stroke-width="4" marker-end="url(#arrowhead)"/>
                            <defs>
                                <marker id="arrowhead" markerWidth="10" markerHeight="10" 
                                        refX="0" refY="3" orient="auto">
                                    <polygon points="0 0, 10 3, 0 6" fill="#333"/>
                                </marker>
                            </defs>
                        </svg>
                    </div>
                    <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
                        ${exercise.options.map((option, index) => `
                            <button class="btn" onclick="checkAnswer(${index}, ${exercise.correct})">
                                ${option}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderCoordinateGrid(exercise) {
            const gridSize = 5;
            const cellSize = 50;
            
            // Objetos en la cuadr√≠cula
            const objects = {
                'üåü': {x: 2, y: 3},
                'üè†': {x: 1, y: 1},
                'üå≥': {x: 4, y: 2},
                'üöó': {x: 3, y: 4}
            };
            
            let gridContent = '';
            
            // Crear l√≠neas de la cuadr√≠cula
            for (let i = 0; i <= gridSize; i++) {
                // L√≠neas horizontales
                gridContent += `<line x1="0" y1="${i * cellSize}" x2="${gridSize * cellSize}" y2="${i * cellSize}" 
                                     stroke="#ddd" stroke-width="1"/>`;
                // L√≠neas verticales
                gridContent += `<line x1="${i * cellSize}" y1="0" x2="${i * cellSize}" y2="${gridSize * cellSize}" 
                                     stroke="#ddd" stroke-width="1"/>`;
            }
            
            // N√∫meros en los ejes
            for (let i = 1; i <= gridSize; i++) {
                gridContent += `<text x="${i * cellSize - cellSize/2}" y="${gridSize * cellSize + 20}" 
                                     text-anchor="middle" font-size="14" fill="#666">${i}</text>`;
                gridContent += `<text x="-20" y="${(gridSize - i + 1) * cellSize - cellSize/2}" 
                                     text-anchor="middle" font-size="14" fill="#666">${i}</text>`;
            }
            
            // Colocar objetos
            Object.entries(objects).forEach(([emoji, pos]) => {
                const x = pos.x * cellSize - cellSize/2;
                const y = (gridSize - pos.y) * cellSize + cellSize/2;
                gridContent += `<text x="${x}" y="${y}" text-anchor="middle" font-size="30">${emoji}</text>`;
            });
            
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div style="display: flex; justify-content: center; margin: 20px 0;">
                        <svg width="300" height="300" viewBox="-30 -30 310 310">
                            ${gridContent}
                        </svg>
                    </div>
                    ${exercise.options ? `
                        <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
                            ${exercise.options.map((option, index) => `
                                <button class="btn" onclick="checkAnswer(${index}, ${exercise.correct})" style="font-size: 1.5em;">
                                    ${option}
                                </button>
                            `).join('')}
                        </div>
                    ` : `
                        <div style="text-align: center;">
                            <input type="text" class="math-input" id="coordinateAnswer" placeholder="(x,y)" style="width: 100px;">
                            <button class="btn" onclick="checkSimpleOperation('${exercise.answer}')">Verificar ‚úì</button>
                        </div>
                    `}
                </div>
            `;
        }

        function renderTransformation(exercise) {
            // Crear visualizaci√≥n de transformaciones geom√©tricas
            const transformationType = exercise.transformation || 'translation';
            
            let svgContent = '';
            
            if (transformationType === 'translation') {
                svgContent = `
                    <g>
                        <!-- Figura original -->
                        <rect x="50" y="50" width="60" height="60" fill="#4ecdc4" opacity="0.5" stroke="#333" stroke-width="2"/>
                        <text x="80" y="85" text-anchor="middle" font-size="14">Original</text>
                        
                        <!-- Flecha de transformaci√≥n -->
                        <line x1="110" y1="80" x2="140" y2="80" stroke="#666" stroke-width="2" marker-end="url(#arrow)"/>
                        
                        <!-- Figura transformada -->
                        <rect x="140" y="50" width="60" height="60" fill="#ff6b6b" opacity="0.5" stroke="#333" stroke-width="2"/>
                        <text x="170" y="85" text-anchor="middle" font-size="14">Movida</text>
                    </g>
                `;
            }
            
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div style="display: flex; justify-content: center; margin: 20px 0;">
                        <svg width="300" height="200" viewBox="0 0 300 200">
                            <defs>
                                <marker id="arrow" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto">
                                    <polygon points="0 0, 10 3, 0 6" fill="#666"/>
                                </marker>
                            </defs>
                            ${svgContent}
                        </svg>
                    </div>
                    <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
                        ${exercise.options.map((option, index) => `
                            <button class="btn" onclick="checkAnswer(${index}, ${exercise.correct})">
                                ${option}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderPatternGeometric(exercise) {
            // Extraer el patr√≥n de la pregunta
            const patternMatch = exercise.question.match(/([‚óã‚ñ°‚ñ≥‚óá\s]+)\?/);
            const pattern = patternMatch ? patternMatch[1].trim().split(' ') : [];
            
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div style="background: #f8f9fa; padding: 30px; margin: 20px 0; border-radius: 10px; text-align: center;">
                        <div style="font-size: 3em; letter-spacing: 20px;">
                            ${pattern.map((shape, index) => 
                                `<span style="color: ${index % 3 === 0 ? '#ff6b6b' : index % 3 === 1 ? '#4ecdc4' : '#ffd93d'};">${shape}</span>`
                            ).join(' ')}
                            <span style="color: #667eea;">?</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
                        ${exercise.options.map((option, index) => `
                            <button class="btn" onclick="checkAnswer(${index}, ${exercise.correct})" 
                                    style="font-size: 2.5em; padding: 20px 40px;">
                                ${option}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderMeasurementTools(exercise) {
            const toolType = exercise.tool || 'ruler';
            let svgContent = '';
            
            if (toolType === 'ruler') {
                svgContent = `
                    <rect x="50" y="100" width="200" height="40" fill="#f4e4c1" stroke="#8b4513" stroke-width="2"/>
                    ${[...Array(11)].map((_, i) => `
                        <line x1="${50 + i * 20}" y1="100" x2="${50 + i * 20}" y2="${i % 5 === 0 ? 115 : 110}" 
                              stroke="#8b4513" stroke-width="${i % 5 === 0 ? 2 : 1}"/>
                        ${i % 5 === 0 ? `<text x="${50 + i * 20}" y="130" text-anchor="middle" font-size="12">${i * 2}</text>` : ''}
                    `).join('')}
                    <text x="150" y="90" text-anchor="middle" font-size="14" fill="#666">Regla (cm)</text>
                `;
            }
            
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div style="display: flex; justify-content: center; margin: 20px 0;">
                        <svg width="300" height="200" viewBox="0 0 300 200">
                            ${svgContent}
                        </svg>
                    </div>
                    <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
                        ${exercise.options.map((option, index) => `
                            <button class="btn" onclick="checkAnswer(${index}, ${exercise.correct})">
                                ${option}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderInteractiveGeometry(exercise) {
            let content = '';
            
            if (exercise.type === 'symmetry') {
                content = `
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; text-align: center;">
                        <p>ü¶ã Dibuja la l√≠nea de simetr√≠a en la pizarra de arriba</p>
                        <p style="margin-top: 10px;">Una mariposa tiene simetr√≠a vertical por el centro</p>
                    </div>
                    <button class="btn" onclick="nextExercise()" style="margin-top: 20px;">Continuar</button>
                `;
            } else if (exercise.type === 'angles') {
                content = `
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 10px;">
                        <div style="text-align: center; margin: 20px 0;">
                            <svg width="200" height="200" viewBox="0 0 200 200">
                                <line x1="100" y1="100" x2="180" y2="100" stroke="#667eea" stroke-width="3"/>
                                <line x1="100" y1="100" x2="100" y2="20" stroke="#667eea" stroke-width="3"/>
                                <path d="M 130 100 A 30 30 0 0 0 100 70" stroke="#ff6b6b" stroke-width="2" fill="none"/>
                                <circle cx="100" cy="100" r="4" fill="#667eea"/>
                            </svg>
                            <p style="margin-top: 10px;">Este es un √°ngulo de ${exercise.angle}¬∞</p>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
                        ${exercise.options.map((option, index) => `
                            <button class="btn" onclick="checkAnswer(${index}, ${exercise.correct})">
                                ${option}
                            </button>
                        `).join('')}
                    </div>
                `;
            } else if (exercise.type === '3d-shapes') {
                content = `
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 5em; margin: 20px 0;">üé≤</div>
                        <p>Un cubo es una figura 3D</p>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <input type="number" class="math-input" id="shapesAnswer" style="width: 100px;">
                        <button class="btn" onclick="checkSimpleOperation(${exercise.answer})">Verificar ‚úì</button>
                    </div>
                `;
            }
            
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    ${content}
                </div>
            `;
        }

        function renderFractionComparison(exercise) {
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div style="display: flex; justify-content: center; gap: 40px; margin: 20px 0;">
                        ${exercise.options.map((option, index) => `
                            <div style="text-align: center;">
                                <div id="fractionVisual${index}" style="margin-bottom: 10px;"></div>
                                <button class="btn" onclick="checkAnswer(${index}, ${exercise.correct})" style="font-size: 1.5em;">
                                    ${option}
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderFractionMultiplication(exercise) {
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div style="text-align: center;">
                        <p style="margin: 20px 0;">${exercise.explanation || ''}</p>
                        <input type="text" class="math-input" id="fractionAnswer" placeholder="respuesta" style="width: 100px;">
                        <button class="btn" onclick="checkFraction('${exercise.answer}')">Verificar ‚úì</button>
                    </div>
                </div>
            `;
        }

        function renderFractionWordProblem(exercise) {
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    ${exercise.visual ? `
                        <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin: 15px 0; text-align: center;">
                            <div style="font-size: 3em;">üçï</div>
                        </div>
                    ` : ''}
                    <div style="text-align: center;">
                        <input type="${exercise.answer.includes('/') ? 'text' : 'number'}" 
                               class="math-input" id="problemAnswer" style="width: 150px;">
                        <button class="btn" onclick="checkFractionProblem('${exercise.answer}', ${typeof exercise.answer === 'number' ? exercise.answer : `'${exercise.answer}'`})">
                            Verificar ‚úì
                        </button>
                    </div>
                </div>
            `;
        }

        function renderFractionAddition(exercise) {
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin: 15px 0;">
                        <h4>M√©todo visual con barras:</h4>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin: 20px 0;">
                            <div>
                                <div style="border: 2px solid #667eea; width: 100px; height: 40px; display: flex;">
                                    ${Array.from({length: parseInt(exercise.question.split('/')[1])}).map((_, i) => 
                                        `<div style="flex: 1; background: ${i < parseInt(exercise.question.split('/')[0]) ? '#ff6b6b' : 'white'}; border-right: 1px solid #667eea;"></div>`
                                    ).join('')}
                                </div>
                                <p style="text-align: center; margin-top: 5px;">${exercise.question.split('+')[0].trim()}</p>
                            </div>
                            <span style="font-size: 2em;">+</span>
                            <div>
                                <div style="border: 2px solid #667eea; width: 100px; height: 40px; display: flex;">
                                    ${Array.from({length: parseInt(exercise.question.split('/')[1])}).map((_, i) => 
                                        `<div style="flex: 1; background: ${i < parseInt(exercise.question.split('+')[1].split('/')[0].trim()) ? '#4ecdc4' : 'white'}; border-right: 1px solid #667eea;"></div>`
                                    ).join('')}
                                </div>
                                <p style="text-align: center; margin-top: 5px;">${exercise.question.split('+')[1].split('=')[0].trim()}</p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <input type="text" class="math-input" id="fractionAddAnswer" placeholder="respuesta" style="width: 100px;">
                        <button class="btn" onclick="checkFraction('${exercise.answer}')">Verificar ‚úì</button>
                    </div>
                </div>
            `;
        }

        function renderMixedNumbers(exercise) {
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin: 15px 0;">
                        <h4>Visualicemos la fracci√≥n:</h4>
                        <p>Cuando el numerador es mayor que el denominador, tenemos una fracci√≥n impropia que podemos convertir en n√∫mero mixto.</p>
                        <div style="margin: 20px 0;">
                            <p>${exercise.question.match(/\d+\/\d+/)[0]} = ? enteros y ?/?</p>
                        </div>
                    </div>
                    <div>
                        <input type="text" class="math-input" id="mixedAnswer" placeholder="ej: 1 2/3" style="width: 100px;">
                        <button class="btn" onclick="checkMixedNumber('${exercise.answer}')">Verificar ‚úì</button>
                    </div>
                </div>
            `;
        }

        function renderDecimalFraction(exercise) {
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin: 15px 0;">
                        <p>Pista: ${exercise.explanation}</p>
                    </div>
                    <div>
                        <input type="text" class="math-input" id="decimalAnswer" placeholder="respuesta" style="width: 100px;">
                        <button class="btn" onclick="checkFraction('${exercise.answer}')">Verificar ‚úì</button>
                    </div>
                </div>
            `;
        }

        function renderShapeIdentification(exercise) {
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div id="shapeVisual" style="display: flex; justify-content: center; margin: 20px 0;">
                        <!-- Aqu√≠ se dibujar√≠a la figura compleja -->
                        <svg width="300" height="300" viewBox="0 0 300 300">
                            <!-- Figura con m√∫ltiples tri√°ngulos -->
                            <path d="M 150 50 L 100 150 L 200 150 Z" fill="#ff6b6b" stroke="#333" stroke-width="2" opacity="0.7"/>
                            <path d="M 100 150 L 50 250 L 150 250 Z" fill="#4ecdc4" stroke="#333" stroke-width="2" opacity="0.7"/>
                            <path d="M 200 150 L 150 250 L 250 250 Z" fill="#ffd93d" stroke="#333" stroke-width="2" opacity="0.7"/>
                            <path d="M 150 50 L 100 150 L 200 150 L 150 250 Z" fill="none" stroke="#333" stroke-width="3"/>
                        </svg>
                    </div>
                    <div>
                        <input type="number" class="math-input" id="shapeCount" placeholder="?" style="width: 80px;">
                        <button class="btn" onclick="checkShapeCount(${exercise.answer})">Verificar ‚úì</button>
                    </div>
                </div>
            `;
        }

        function renderPerimeterExercise(exercise) {
            return `
                <div class="question-card">
                    <h3>${exercise.question}</h3>
                </div>
                <div class="interactive-question">
                    <div style="display: flex; justify-content: center; margin: 20px 0;">
                        <svg width="200" height="150" viewBox="0 0 200 150">
                            <rect x="50" y="40" width="${exercise.width * 20}" height="${exercise.height * 20}" 
                                  fill="#e3f2fd" stroke="#2196f3" stroke-width="3"/>
                            <text x="100" y="30" text-anchor="middle" font-size="16" fill="#333">${exercise.width} cm</text>
                            <text x="100" y="130" text-anchor="middle" font-size="16" fill="#333">${exercise.width} cm</text>
                            <text x="30" y="80" text-anchor="middle" font-size="16" fill="#333">${exercise.height} cm</text>
                            <text x="170" y="80" text-anchor="middle" font-size="16" fill="#333">${exercise.height} cm</text>
                        </svg>
                    </div>
                    <div>
                        <p>Per√≠metro = </p>
                        <input type="number" class="math-input" id="perimeterAnswer" style="width: 100px;">
                        <span> cm</span>
                        <button class="btn" onclick="checkPerimeter(${exercise.answer})">Verificar ‚úì</button>
                    </div>
                </div>
            `;
        }

        function checkShapeCount(correctAnswer) {
            const answer = parseInt(document.getElementById('shapeCount').value);
            
            if (answer === correctAnswer) {
                showFeedback(true, 'excellent');
                appState.correctAnswers++;
                appState.points += 15;
                appState.currentAttempts = 0;
                appState.showingStepByStep = false;
                setTimeout(nextExercise, 2000);
            } else {
                appState.currentAttempts++;
                
                if (appState.currentAttempts >= 3 && !appState.showingStepByStep) {
                    showStepByStepOption();
                } else if (appState.currentAttempts === 2) {
                    const exercise = appState.exercises[appState.currentExercise];
                    showFeedback(false, 'hint', exercise.explanation || 'Cuenta cada figura cuidadosamente');
                } else {
                    showFeedback(false, 'hint', 'Observa con cuidado, algunos tri√°ngulos se superponen');
                }
            }
            updateUI();
        }

        function checkPerimeter(correctAnswer) {
            const answer = parseInt(document.getElementById('perimeterAnswer').value);
            
            if (answer === correctAnswer) {
                showFeedback(true, 'perfect');
                appState.correctAnswers++;
                appState.points += 10;
                appState.currentAttempts = 0;
                appState.showingStepByStep = false;
                setTimeout(nextExercise, 2000);
            } else {
                appState.currentAttempts++;
                
                if (appState.currentAttempts >= 3 && !appState.showingStepByStep) {
                    showStepByStepOption();
                } else if (appState.currentAttempts === 2) {
                    const exercise = appState.exercises[appState.currentExercise];
                    showFeedback(false, 'hint', exercise.explanation || 'Suma todos los lados de la figura');
                } else {
                    showFeedback(false, 'hint', 'Recuerda: Per√≠metro = suma de todos los lados');
                }
            }
            updateUI();
        }

        function checkDivision(correctAnswer) {
            const answer = parseInt(document.getElementById('divisionAnswer').value);
            
            if (answer === correctAnswer) {
                showFeedback(true, 'excellent');
                appState.correctAnswers++;
                appState.points += 15;
                appState.currentAttempts = 0;
                appState.showingStepByStep = false;
                setTimeout(nextExercise, 2000);
            } else {
                appState.currentAttempts++;
                
                if (appState.currentAttempts >= 3 && !appState.showingStepByStep) {
                    showStepByStepOption();
                } else if (appState.currentAttempts === 2) {
                    const exercise = appState.exercises[appState.currentExercise];
                    showFeedback(false, 'hint', exercise.explanation || 'Piensa en grupos o multiplicaci√≥n inversa');
                } else {
                    showFeedback(false, 'hint', 'Revisa el proceso de descomposici√≥n paso a paso');
                }
            }
            updateUI();
        }

        // Funci√≥n para el modelo de barras
        function selectBarTool(tool) {
            document.querySelectorAll('.bar-tool').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function checkMixedNumber(correctAnswer) {
            const answer = document.getElementById('mixedAnswer').value.trim();
            
            if (answer === correctAnswer) {
                showFeedback(true, 'perfect');
                appState.correctAnswers++;
                appState.points += 15;
                appState.currentAttempts = 0;
                appState.showingStepByStep = false;
                setTimeout(nextExercise, 2000);
            } else {
                appState.currentAttempts++;
                
                if (appState.currentAttempts >= 3 && !appState.showingStepByStep) {
                    showStepByStepOption();
                } else if (appState.currentAttempts === 2) {
                    const exercise = appState.exercises[appState.currentExercise];
                    showFeedback(false, 'hint', exercise.explanation || 'Divide y encuentra enteros y fracci√≥n restante');
                } else {
                    showFeedback(false, 'hint', 'Divide el numerador entre el denominador para encontrar los enteros');
                }
            }
            updateUI();
        }

        // Funciones de personalizaci√≥n
        function startPersonalization() {
            showScreen('personalization');
            appState.personalizationStep = 1;
            // No resetear intereses para mantener las selecciones previas
            
            // Asegurar que solo el primer paso est√© visible
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById(`personalizationStep${i}`);
                if (step) {
                    step.classList.toggle('hidden', i !== 1);
                }
            }
            document.getElementById('personalizationSummary').classList.add('hidden');
            
            // Restaurar las selecciones previas en los botones
            restorePreviousSelections();
        }

        function showPersonalization() {
            showScreen('personalization');
        }

        function restorePreviousSelections() {
            // Esperar un poco para que los elementos se rendericen
            setTimeout(() => {
                // Recorrer todos los intereses guardados y marcar los botones correspondientes
                Object.entries(appState.interests).forEach(([category, items]) => {
                    items.forEach(item => {
                        // Buscar el bot√≥n correspondiente y marcarlo como activo
                        const buttons = document.querySelectorAll(`button[onclick*="'${category}'"][onclick*="'${item.value}'"]`);
                        buttons.forEach(button => {
                            button.classList.add('active');
                        });
                    });
                });
            }, 100);
        }

        function toggleInterest(button, category, value, emoji) {
            // Inicializar la categor√≠a si no existe
            if (!appState.interests[category]) {
                appState.interests[category] = [];
            }
            
            // Toggle el inter√©s
            const index = appState.interests[category].findIndex(item => item.value === value);
            if (index > -1) {
                // Si ya existe, lo quitamos
                appState.interests[category].splice(index, 1);
                button.classList.remove('active');
            } else {
                // Si no existe, lo agregamos
                appState.interests[category].push({ value, emoji });
                button.classList.add('active');
            }
            
            console.log('Intereses actuales:', appState.interests);
        }

        function nextPersonalizationStep() {
            console.log('Avanzando del paso', appState.personalizationStep, 'al siguiente');
            
            // Ocultar paso actual
            document.getElementById(`personalizationStep${appState.personalizationStep}`).classList.add('hidden');
            
            // Incrementar paso
            appState.personalizationStep++;
            
            // Mostrar siguiente paso o resumen
            if (appState.personalizationStep <= 5) {
                document.getElementById(`personalizationStep${appState.personalizationStep}`).classList.remove('hidden');
            } else {
                showPersonalizationSummary();
            }
        }

        function showPersonalizationSummary() {
            document.getElementById('personalizationStep5').classList.add('hidden');
            document.getElementById('personalizationSummary').classList.remove('hidden');
            
            // Mostrar los intereses seleccionados
            const summaryContainer = document.getElementById('interestsSummary');
            let summaryHTML = '';
            
            Object.entries(appState.interests).forEach(([category, items]) => {
                if (items.length > 0) {
                    items.forEach(item => {
                        summaryHTML += `<div class="achievement">${item.emoji} ${item.value.charAt(0).toUpperCase() + item.value.slice(1)}</div>`;
                    });
                }
            });
            
            summaryContainer.innerHTML = summaryHTML;
        }

        function finishPersonalization() {
            appState.hasPersonalized = true;
            saveProgress();
            
            // Generar problemas personalizados
            generatePersonalizedProblems();
            
            showUnitSelector();
        }

        function generatePersonalizedProblems() {
            // Sistema avanzado de personalizaci√≥n basado en mapeo de intereses
            const interests = appState.interests;
            console.log('Generando problemas personalizados para:', interests);
            
            // Mapeo de intereses a m√≥dulos compatibles
            const interestMapping = {
                // DEPORTES - Compatible con tiempo, estad√≠sticas, medici√≥n, operaciones b√°sicas
                deportes: {
                    compatibleModules: ['numeros', 'medicion', 'datos', 'algebra'],
                    contexts: {
                        futbol: ['goles', 'partidos', 'equipos', 'entrenamientos'],
                        natacion: ['largos', 'tiempo', 'metros', 'competencias'],
                        volley: ['puntos', 'sets', 'jugadores', 'altura red'],
                        tenis: ['sets', 'juegos', 'puntos', 'torneos'],
                        basquet: ['puntos', 'canastas', 'jugadores', 'tiempo'],
                        atletismo: ['metros', 'segundos', 'saltos', 'carreras'],
                        flamenco: ['clases', 'horas', 'presentaciones', 'pasos']
                    }
                },
                
                // ANIMALES - Compatible con divisi√≥n, multiplicaci√≥n, fracciones, problemas verbales
                animales: {
                    compatibleModules: ['numeros', 'fracciones', 'geometria', 'datos'],
                    contexts: {
                        perros: ['comida', 'juguetes', 'paseos', 'a√±os perro'],
                        gatos: ['ratones', 'comida', 'siesta', 'vidas'],
                        caballos: ['heno', 'carreras', 'establos', 'herraduras'],
                        pajaros: ['huevos', 'nidos', 'vuelo', 'semillas'],
                        peces: ['peceras', 'alimento', 'agua', 'escamas'],
                        conejos: ['zanahorias', 'saltos', 'orejas', 'madrigueras']
                    }
                },
                
                // M√öSICA - Compatible con fracciones (compases), patrones, tiempo
                hobbies: {
                    musica: {
                        compatibleModules: ['fracciones', 'algebra', 'datos', 'numeros'],
                        contexts: ['canciones', 'notas', 'compases', 'instrumentos', 'conciertos']
                    },
                    arte: {
                        compatibleModules: ['geometria', 'fracciones', 'medicion', 'numeros'],
                        contexts: ['colores', 'formas', 'pinceles', 'lienzos', 'exposiciones']
                    },
                    lectura: {
                        compatibleModules: ['numeros', 'datos', 'algebra', 'medicion'],
                        contexts: ['p√°ginas', 'libros', 'cap√≠tulos', 'bibliotecas', 'autores']
                    },
                    videojuegos: {
                        compatibleModules: ['algebra', 'datos', 'numeros', 'geometria'],
                        contexts: ['niveles', 'puntos', 'vidas', 'power-ups', 'experiencia']
                    }
                },
                
                // COMIDA - Compatible con fracciones (porciones), divisi√≥n, medici√≥n
                comidas: {
                    compatibleModules: ['fracciones', 'numeros', 'medicion', 'datos'],
                    contexts: {
                        pizza: ['rebanadas', 'ingredientes', 'tama√±os', 'personas'],
                        helado: ['sabores', 'bolas', 'costo', 'ventas'],
                        torta: ['porciones', 'ingredientes', 'cumplea√±os', 'velas'],
                        frutas: ['kilos', 'vitaminas', 'colores', 'estaciones'],
                        dulces: ['caramelos', 'paquetes', 'colores', 'repartir']
                    }
                }
            };
            
            // Generar ejercicios personalizados para cada m√≥dulo
            Object.entries(interests).forEach(([category, items]) => {
                if (!items || items.length === 0) return;
                
                items.forEach(item => {
                    const interestValue = item.value;
                    
                    // DEPORTES
                    if (category === 'deportes' && interestMapping.deportes.contexts[interestValue]) {
                        addSportsProblems(interestValue, interestMapping.deportes.contexts[interestValue]);
                    }
                    
                    // ANIMALES
                    if (category === 'animales' && interestMapping.animales.contexts[interestValue]) {
                        addAnimalProblems(interestValue, interestMapping.animales.contexts[interestValue]);
                    }
                    
                    // HOBBIES
                    if (category === 'hobbies') {
                        const hobbyMapping = interestMapping.hobbies[interestValue];
                        if (hobbyMapping) {
                            addHobbyProblems(interestValue, hobbyMapping.contexts);
                        }
                    }
                    
                    // COMIDAS
                    if (category === 'comidas' && interestMapping.comidas.contexts[interestValue]) {
                        addFoodProblems(interestValue, interestMapping.comidas.contexts[interestValue]);
                    }
                });
            });
            
            console.log('Ejercicios personalizados generados exitosamente');
        }
        
        // Funciones auxiliares para generar problemas espec√≠ficos
        function addSportsProblems(sport, contexts) {
            switch(sport) {
                case 'futbol':
                    exerciseDatabase.numeros.push({
                        type: 'word-problem',
                        question: `En el torneo de f√∫tbol, el equipo de Amaia anot√≥ 15 goles en 5 partidos. ¬øCu√°l fue su promedio de goles por partido?`,
                        answer: 3,
                        method: 'division',
                        explanation: 'Divide el total de goles entre el n√∫mero de partidos'
                    });
                    exerciseDatabase.datos.push({
                        type: 'bar-graph',
                        question: 'Seg√∫n los goles anotados, ¬øqu√© jugador fue el m√°ximo goleador?',
                        data: { 'Ana': 8, 'Luis': 12, 'Carlos': 6, 'Mar√≠a': 10 },
                        options: ['Ana', 'Luis', 'Carlos', 'Mar√≠a'],
                        correct: 1
                    });
                    break;
                    
                case 'natacion':
                    exerciseDatabase.medicion.push({
                        type: 'simple-operation',
                        question: 'Amaia nad√≥ 8 largos de 25 metros cada uno. ¬øCu√°ntos metros nad√≥ en total?',
                        answer: 200,
                        explanation: 'Multiplica la cantidad de largos por los metros de cada largo'
                    });
                    exerciseDatabase.numeros.push({
                        type: 'time-calculation',
                        question: 'Si Amaia nada 100 metros en 2 minutos, ¬øcu√°nto tardar√° en nadar 400 metros?',
                        answer: 8,
                        explanation: 'Usa proporci√≥n: si 100m = 2min, entonces 400m = 8min'
                    });
                    break;
                    
                case 'volley':
                    exerciseDatabase.numeros.push({
                        type: 'simple-operation',
                        question: 'En volley se necesitan 25 puntos para ganar un set. Si Amaia lleva 18 puntos, ¬øcu√°ntos le faltan?',
                        answer: 7,
                        explanation: 'Resta los puntos que tiene de los que necesita'
                    });
                    break;
            }
        }
        
        function addAnimalProblems(animal, contexts) {
            switch(animal) {
                case 'perros':
                    exerciseDatabase.fracciones.push({
                        type: 'fraction-visual',
                        question: 'Amaia tiene 12 galletas para su perro. Si le da 1/4, ¬øcu√°ntas galletas le dio?',
                        answer: 3,
                        explanation: 'Calcula 1/4 de 12 galletas'
                    });
                    exerciseDatabase.numeros.push({
                        type: 'multiplication',
                        question: 'Si un perro tiene 4 patas, ¬øcu√°ntas patas tienen 7 perros?',
                        answer: 28,
                        explanation: 'Multiplica el n√∫mero de perros por las patas de cada uno'
                    });
                    break;
                    
                case 'gatos':
                    exerciseDatabase.fracciones.push({
                        type: 'simple-operation',
                        question: 'Un gato duerme 2/3 del d√≠a. ¬øCu√°ntas horas duerme si un d√≠a tiene 24 horas?',
                        answer: 16,
                        explanation: 'Calcula 2/3 de 24 horas'
                    });
                    break;
                    
                case 'caballos':
                    exerciseDatabase.numeros.push({
                        type: 'word-problem',
                        question: 'En el establo hay 6 caballos. Si cada caballo come 8 kg de heno al d√≠a, ¬øcu√°nto heno necesitan en una semana?',
                        answer: 336,
                        method: 'multiplication',
                        explanation: 'Multiplica: 6 caballos √ó 8 kg √ó 7 d√≠as'
                    });
                    break;
            }
        }
        
        function addHobbyProblems(hobby, contexts) {
            switch(hobby) {
                case 'musica':
                    exerciseDatabase.fracciones.push({
                        type: 'simple-operation',
                        question: 'Una canci√≥n dura 3 minutos y 1/4. ¬øCu√°ntos segundos dura?',
                        answer: 195,
                        explanation: 'Convierte 3 minutos y 15 segundos a segundos totales'
                    });
                    exerciseDatabase.algebra.push({
                        type: 'pattern-next',
                        question: 'En una escala musical: Do, Re, Mi, Fa, Sol, La, ?',
                        pattern: ['Do', 'Re', 'Mi', 'Fa', 'Sol', 'La'],
                        answer: 'Si',
                        explanation: 'Sigue la secuencia de notas musicales'
                    });
                    break;
                    
                case 'arte':
                    exerciseDatabase.geometria.push({
                        type: 'shape-properties',
                        question: 'Amaia dibuja un marco cuadrado de 15 cm de lado. ¬øCu√°l es su per√≠metro?',
                        answer: 60,
                        explanation: 'Per√≠metro del cuadrado = 4 √ó lado'
                    });
                    exerciseDatabase.fracciones.push({
                        type: 'simple-operation',
                        question: 'Para hacer color verde, Amaia mezcla 3/4 de azul con 1/4 de amarillo. Si usa 20 ml de pintura, ¬øcu√°ntos ml de azul necesita?',
                        answer: 15,
                        explanation: 'Calcula 3/4 de 20 ml'
                    });
                    break;
                    
                case 'videojuegos':
                    exerciseDatabase.algebra.push({
                        type: 'simple-equation',
                        question: 'En un videojuego, Amaia tiene 150 monedas. Si compra un power-up que cuesta X monedas y le quedan 95, ¬øcu√°nto cost√≥ el power-up?',
                        answer: 55,
                        explanation: 'Resta: 150 - 95 = 55 monedas'
                    });
                    break;
            }
        }
        
        function addFoodProblems(food, contexts) {
            switch(food) {
                case 'pizza':
                    exerciseDatabase.fracciones.push({
                        type: 'fraction-visual',
                        question: 'Amaia y sus 3 amigas comparten una pizza dividida en 8 pedazos. Si cada una come 2 pedazos, ¬øqu√© fracci√≥n de la pizza comieron?',
                        visual: 'pizza',
                        parts: 8,
                        colored: 8,
                        answer: '8/8',
                        explanation: 'Cuenta cu√°ntos pedazos comieron en total'
                    });
                    break;
                    
                case 'helado':
                    exerciseDatabase.datos.push({
                        type: 'bar-graph',
                        question: '¬øCu√°l es el sabor de helado m√°s popular?',
                        data: { 'Chocolate': 25, 'Vainilla': 18, 'Frutilla': 22, 'Menta': 15 },
                        options: ['Chocolate', 'Vainilla', 'Frutilla', 'Menta'],
                        correct: 0
                    });
                    break;
                    
                case 'frutas':
                    exerciseDatabase.medicion.push({
                        type: 'simple-operation',
                        question: 'Amaia compr√≥ 2.5 kg de manzanas y 1.8 kg de naranjas. ¬øCu√°ntos gramos de fruta compr√≥ en total?',
                        answer: 4300,
                        explanation: 'Convierte a gramos y suma: 2500g + 1800g'
                    });
                    break;
            }
        }

        // Funciones de encuesta de satisfacci√≥n
        function showFeedbackSurvey() {
            showScreen('feedback');
            // Resetear las selecciones previas
            document.querySelectorAll('#feedbackScreen .interest-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        function selectFeedback(category, emoji, value) {
            appState.feedback[category] = { emoji, value };
            
            // Encontrar el bot√≥n clickeado
            const clickedButton = event.currentTarget || event.target;
            
            // Actualizar botones activos
            const buttons = clickedButton.parentElement.querySelectorAll('.interest-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            clickedButton.classList.add('active');
        }

        function submitFeedback() {
            // Obtener respuestas de texto
            appState.feedback.likedMost = document.getElementById('likedMost').value;
            appState.feedback.wouldChange = document.getElementById('wouldChange').value;
            
            // Generar el resumen para copiar
            const feedbackSummary = generateFeedbackSummary();
            
            // Mostrar el resumen
            showFeedbackSummary(feedbackSummary);
        }

        function generateFeedbackSummary() {
            const fb = appState.feedback;
            let summary = "üìä FEEDBACK DE AMAIA - MATHAMAIA PRO\n";
            summary += "=====================================\n\n";
            
            summary += "1. ¬øQu√© tan divertida es la app?\n";
            summary += `   ${fb.fun?.emoji || '‚ùì'} ${fb.fun?.value || 'No respondi√≥'}\n\n`;
            
            summary += "2. ¬øC√≥mo son los ejercicios?\n";
            summary += `   ${fb.difficulty?.emoji || '‚ùì'} ${fb.difficulty?.value || 'No respondi√≥'}\n\n`;
            
            summary += "3. ¬øTe gustan los colores y dise√±o?\n";
            summary += `   ${fb.design?.emoji || '‚ùì'} ${fb.design?.value || 'No respondi√≥'}\n\n`;
            
            summary += "4. ¬øQu√© es lo que m√°s te gust√≥?\n";
            summary += `   ${fb.likedMost || 'No respondi√≥'}\n\n`;
            
            summary += "5. ¬øQu√© cambiar√≠as o agregar√≠as?\n";
            summary += `   ${fb.wouldChange || 'No respondi√≥'}\n\n`;
            
            summary += "6. ¬øLa recomendar√≠as a tus amigos?\n";
            summary += `   ${fb.recommend?.emoji || '‚ùì'} ${fb.recommend?.value || 'No respondi√≥'}\n\n`;
            
            summary += `üìÖ Fecha: ${new Date().toLocaleString('es-CL')}\n`;
            summary += `üéØ Puntos actuales: ${appState.points}\n`;
            summary += `üèÜ Logros: ${appState.achievements.join(', ') || 'Ninguno a√∫n'}\n`;
            
            return summary;
        }

        function showFeedbackSummary(summary) {
            const summaryHTML = `
                <div style="text-align: center;">
                    <h2>¬°Gracias por tu opini√≥n! üåü</h2>
                    <p style="margin: 20px 0;">Tu feedback nos ayudar√° a hacer MathAmaia a√∫n mejor</p>
                    
                    <div style="background: rgba(46, 204, 113, 0.1); border: 2px solid #2ecc71; 
                                border-radius: 15px; padding: 20px; margin: 20px 0; text-align: left;">
                        <h3>üìã Resumen de tu feedback (copia este texto):</h3>
                        <textarea readonly style="width: 100%; min-height: 300px; padding: 15px; 
                                                  border-radius: 10px; border: 1px solid #ddd; 
                                                  font-family: monospace; font-size: 0.9em; 
                                                  background: white;">${summary}</textarea>
                        <button class="btn btn-secondary" onclick="copyFeedback()" style="margin-top: 10px;">
                            üìã Copiar al portapapeles
                        </button>
                    </div>
                    
                    <p style="font-style: italic; color: #666;">
                        Ahora puedes pegar este texto en un email o mensaje para compartir tu opini√≥n
                    </p>
                    
                    <button class="btn glow" onclick="showWelcome()">
                        Volver al inicio üè†
                    </button>
                </div>
            `;
            
            document.getElementById('feedbackScreen').querySelector('.interactive-question').innerHTML = summaryHTML;
        }

        function copyFeedback() {
            const textarea = event.target.parentElement.querySelector('textarea');
            textarea.select();
            document.execCommand('copy');
            
            // Feedback visual
            event.target.textContent = '‚úÖ ¬°Copiado!';
            setTimeout(() => {
                event.target.textContent = 'üìã Copiar al portapapeles';
            }, 2000);
        }

        function confirmExitExercise() {
            if (confirm('¬øEst√°s segura que quieres salir? Perder√°s el progreso de estos ejercicios.')) {
                showWelcome();
            }
        }

        // Variables del canvas
        let canvas, ctx;
        let isDrawing = false;
        let currentMode = 'draw';
        let currentColor = 'black';
        let lastX = 0;
        let lastY = 0;
        let textX = 20;
        let textY = 30;

        // Funciones del espacio de trabajo con canvas
        function initCanvas() {
            canvas = document.getElementById('workspaceCanvas');
            if (!canvas) return;
            
            ctx = canvas.getContext('2d');
            
            // Ajustar tama√±o del canvas para alta resoluci√≥n
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * 2;
            canvas.height = rect.height * 2;
            ctx.scale(2, 2);
            
            // Configurar estilos
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.font = '24px Comic Sans MS';
            
            // Event listeners para dibujar
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events para tablets
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            if (currentMode !== 'draw') return;
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
        }

        function draw(e) {
            if (!isDrawing || currentMode !== 'draw') return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.strokeStyle = currentColor;
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
            
            lastX = x;
            lastY = y;
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function clearCanvas() {
            if (!canvas || !ctx) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            textX = 20;
            textY = 30;
        }

        function changeColor(color) {
            currentColor = color;
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('drawMode').style.background = mode === 'draw' ? 
                'linear-gradient(45deg, #ff6b6b, #ffd93d)' : 'linear-gradient(45deg, #667eea, #764ba2)';
            document.getElementById('textMode').style.background = mode === 'text' ? 
                'linear-gradient(45deg, #ff6b6b, #ffd93d)' : 'linear-gradient(45deg, #667eea, #764ba2)';
        }

        function insertText(text) {
            if (!canvas || !ctx) return;
            
            ctx.fillStyle = currentColor;
            ctx.font = '24px Comic Sans MS';
            ctx.fillText(text, textX, textY);
            
            // Mover posici√≥n para el siguiente texto
            textX += ctx.measureText(text).width + 5;
            
            // Si llegamos al final de la l√≠nea, saltar a la siguiente autom√°ticamente
            if (textX > canvas.width / 2 - 50) {
                newLine();
            }
        }
        
        function newLine() {
            textX = 20;
            textY += 35;
            
            // Si llegamos al final del canvas, volver arriba
            if (textY > canvas.height / 2 - 20) {
                textY = 30;
            }
        }

        function toggleWorkspace() {
            const workspace = document.getElementById('workspaceArea');
            const toggleText = document.getElementById('workspaceToggleText');
            
            if (workspace.style.display === 'none') {
                workspace.style.display = 'block';
                toggleText.textContent = 'üìù Ocultar pizarra de trabajo';
                // Inicializar canvas cuando se muestra
                setTimeout(initCanvas, 100);
            } else {
                workspace.style.display = 'none';
                toggleText.textContent = 'üìù Mostrar pizarra de trabajo';
            }
        }

        // Inicializaci√≥n
        window.onload = function() {
            loadProgress();
            showWelcome();
            
            // Registrar Service Worker para PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => console.log('Service Worker registrado'))
                    .catch(error => console.log('Error al registrar Service Worker:', error));
            }
        };
    </script>
</body>
</html>
